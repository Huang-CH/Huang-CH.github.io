<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="MySQL相关产品介绍#   Oracle MySQL Cloud Service（Commercial）
商业付费软件，基于MySQL企业版和Oracle云服务提供企业级的MySQL数据库服务。
  MySQL Enterprise Edition（Commercial）
商业付费软件，除了提供MySQL数据库服务之外，又包含了connector（程序连接接口）、partition（分区表）、企业级的monitor（监控）、HA（高可用）、backup（备份）、Scalability（扩展）等服务。
  MySQL Cluster CGE（Commercial）
商业付费软件，基于MySQL Cluster和企业版拥有的各项功能提供企业级的高并发、高吞吐量的数据库服务。
  MySQL Community Edition（Free）
免费社区版，提供基础的数据库服务和其他衍生服务。
  MySQL Cluster（但市场中很少使用，口碑不好）
基于MySQL数据库而实现的集群服务，自身能提供高并发、高负载等特性。
  MySQL Fabric
官方提供的关于MySQL数据库高可用和数据分片的解决方案。
  MySQL Connectors
为应用程序提供JDBC/ODBC等访问MySQL数据库的接口服务。
     MySQL版本介绍# 各操作系统与MySQL版本兼容性参照表：https://www.mysql.com/support/supportedplatforms/database.html
 MySQL安装# 安装版本的选择#  首先需要考虑生产环境中的其他MySQL数据库的版本，优先部署与生产其他MySQL一致的版本。 如果是全新部署，则一般会选择安装最新版本。 生产环境不要选择Development Release，应该选择General Availability Release。   二进制文件安装#  官方文档链接：https://dev.">
<meta name="theme-color" content="#FFFFFF">
<meta name="color-scheme" content="light dark"><meta property="og:title" content="MySQL" />
<meta property="og:description" content="MySQL相关产品介绍#   Oracle MySQL Cloud Service（Commercial）
商业付费软件，基于MySQL企业版和Oracle云服务提供企业级的MySQL数据库服务。
  MySQL Enterprise Edition（Commercial）
商业付费软件，除了提供MySQL数据库服务之外，又包含了connector（程序连接接口）、partition（分区表）、企业级的monitor（监控）、HA（高可用）、backup（备份）、Scalability（扩展）等服务。
  MySQL Cluster CGE（Commercial）
商业付费软件，基于MySQL Cluster和企业版拥有的各项功能提供企业级的高并发、高吞吐量的数据库服务。
  MySQL Community Edition（Free）
免费社区版，提供基础的数据库服务和其他衍生服务。
  MySQL Cluster（但市场中很少使用，口碑不好）
基于MySQL数据库而实现的集群服务，自身能提供高并发、高负载等特性。
  MySQL Fabric
官方提供的关于MySQL数据库高可用和数据分片的解决方案。
  MySQL Connectors
为应用程序提供JDBC/ODBC等访问MySQL数据库的接口服务。
     MySQL版本介绍# 各操作系统与MySQL版本兼容性参照表：https://www.mysql.com/support/supportedplatforms/database.html
 MySQL安装# 安装版本的选择#  首先需要考虑生产环境中的其他MySQL数据库的版本，优先部署与生产其他MySQL一致的版本。 如果是全新部署，则一般会选择安装最新版本。 生产环境不要选择Development Release，应该选择General Availability Release。   二进制文件安装#  官方文档链接：https://dev." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://Huang-CH.github.io/docs/MySQL/MySQL/" /><meta property="article:section" content="docs" />



<title>MySQL | 黄 超 | H&amp;C</title>
<link rel="manifest" href="/manifest.json">
<link rel="icon" href="/favicon.png" type="image/x-icon">
<link rel="stylesheet" href="/book.min.95d69eb6bad8b9707ff2b5d8d9e31ce70a1b84f2ed7ffaf665ffcf00aa7993bd.css" integrity="sha256-ldaetrrYuXB/8rXY2eMc5wobhPLtf/r2Zf/PAKp5k70=" crossorigin="anonymous">
  <script defer src="/flexsearch.min.js"></script>
  <script defer src="/en.search.min.8fd3bd4eae3c5070bb143973d80bfde1fd89792aae9e8a879efee29ca325c1af.js" integrity="sha256-j9O9Tq48UHC7FDlz2Av94f2JeSqunoqHnv7inKMlwa8=" crossorigin="anonymous"></script>

  <script defer src="/sw.min.6f6f90fcb8eb1c49ec389838e6b801d0de19430b8e516902f8d75c3c8bd98739.js" integrity="sha256-b2&#43;Q/LjrHEnsOJg45rgB0N4ZQwuOUWkC&#43;NdcPIvZhzk=" crossorigin="anonymous"></script>
<!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->
  
</head>
<body dir="ltr">
  <input type="checkbox" class="hidden toggle" id="menu-control" />
  <input type="checkbox" class="hidden toggle" id="toc-control" />
  <main class="container flex">
    <aside class="book-menu">
      <div class="book-menu-content">
        
  <nav>
<h2 class="book-brand">
  <a class="flex align-center" href="/"><span>黄 超 | H&amp;C</span>
  </a>
</h2>


<div class="book-search">
  <input type="text" id="book-search-input" placeholder="Search" aria-label="Search" maxlength="64" data-hotkeys="s/" />
  <div class="book-search-spinner hidden"></div>
  <ul id="book-search-results"></ul>
</div>












  



  
  <ul>
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-3ca9a5c09bd1884bf69ade02a8e53628" class="toggle"  />
    <label for="section-3ca9a5c09bd1884bf69ade02a8e53628" class="flex justify-between">
      <a role="button" class="">Linux</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-b8ab17e00886c44c945c0ebf9036be5e" class="toggle"  />
    <label for="section-b8ab17e00886c44c945c0ebf9036be5e" class="flex justify-between">
      <a role="button" class="">CentOS</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Linux/CentOS/CentOS-7%E5%80%9F%E5%8A%A9%E7%B3%BB%E7%BB%9F%E5%AD%98%E5%82%A8%E7%AE%A1%E7%90%86%E5%99%A8%E7%AE%A1%E7%90%86LVM/" class="">CentOS 7借助系统存储管理器管理LVM</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Linux/CentOS/CentOS-7%E6%90%AD%E5%BB%BAFTP%E6%9C%8D%E5%8A%A1%E5%99%A8/" class="">CentOS 7搭建FTP服务器</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Linux/CentOS/CentOS-7%E6%90%AD%E5%BB%BAGit%E6%9C%8D%E5%8A%A1%E5%99%A8/" class="">CentOS 7搭建Git服务器</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Linux/CentOS/CentOS-7%E6%90%AD%E5%BB%BASamba%E6%9C%8D%E5%8A%A1%E5%99%A8/" class="">CentOS 7搭建Samba服务器</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-35013df187ba109d617f6614b484064f" class="toggle"  />
    <label for="section-35013df187ba109d617f6614b484064f" class="flex justify-between">
      <a role="button" class="">Debian</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Linux/Debian/Debian%E7%B3%BB%E7%BB%9F%E5%B8%B8%E7%94%A8%E9%85%8D%E7%BD%AE/" class="">Debian系统常用配置</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-8ca541663a7d7fd63c79c6ce40ab5b81" class="toggle"  />
    <label for="section-8ca541663a7d7fd63c79c6ce40ab5b81" class="flex justify-between">
      <a role="button" class="">Python</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Python/Python%E4%B9%8B%E5%9F%BA%E7%A1%80%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B/" class="">Python之基础数据类型</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Python/Python%E4%B9%8B%E5%AD%97%E7%AC%A6%E7%BC%96%E7%A0%81/" class="">Python之字符编码</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Python/Python%E4%B9%8B%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C/" class="">Python之文件操作</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Python/Python%E4%B9%8B%E5%90%8D%E7%A7%B0%E7%A9%BA%E9%97%B4%E4%B8%8E%E4%BD%9C%E7%94%A8%E5%9F%9F/" class="">Python之名称空间与作用域</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Python/Python%E4%B9%8B%E5%87%BD%E6%95%B0/" class="">Python之函数</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Python/Python%E4%B9%8B%E8%BF%AD%E4%BB%A3%E5%99%A8/" class="">Python之迭代器</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Python/Python%E4%B9%8B%E7%94%9F%E6%88%90%E5%99%A8/" class="">Python之生成器</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Python/Python%E4%B9%8B%E6%A8%A1%E5%9D%97/" class="">Python之模块</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Python/Python%E4%B9%8B%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/" class="">Python之正则表达式</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Python/Python%E4%B9%8Bre%E6%A8%A1%E5%9D%97/" class="">Python之re模块</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Python/%E9%9D%A2%E5%90%91%E8%BF%87%E7%A8%8B%E4%B8%8E%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1/" class="">面向过程与面向对象</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Python/Python%E4%B9%8B%E7%B1%BB%E4%B8%8E%E5%AF%B9%E8%B1%A1/" class="">Python之类与对象</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Python/Python%E4%B9%8B%E7%BB%84%E5%90%88/" class="">Python之组合</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Python/Python%E4%B9%8B%E7%BB%A7%E6%89%BF%E5%B0%81%E8%A3%85%E5%92%8C%E5%A4%9A%E6%80%81/" class="">Python之继承、封装和多态</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Python/Python%E4%B9%8B%E5%8F%8D%E5%B0%84/" class="">Python之反射</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Python/Python%E4%B9%8B%E5%85%83%E7%B1%BB/" class="">Python之元类</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Python/Python%E4%B9%8B%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86/" class="">Python之异常处理</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Python/Python%E5%86%85%E7%BD%AE%E7%9A%84%E9%AD%94%E6%9C%AF%E6%96%B9%E6%B3%95/" class="">Python内置的魔术方法</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Python/Python%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/" class="">Python网络编程</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Python/Python%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B%E4%B9%8Bsocketserver%E6%A8%A1%E5%9D%97/" class="">Python网络编程之socketserver模块</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Python/Python%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8B%E8%BF%9B%E7%A8%8B/" class="">Python并发编程之进程</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Python/Python%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8B%E7%BA%BF%E7%A8%8B/" class="">Python并发编程之线程</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Python/Python%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8B%E5%8D%8F%E7%A8%8B/" class="">Python并发编程之协程</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Python/%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B%E5%92%8C%E5%8D%8F%E7%A8%8B%E7%9A%84%E5%AF%B9%E6%AF%94/" class="">进程、线程和协程的对比</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Python/%E7%94%9F%E4%BA%A7%E8%80%85%E6%B6%88%E8%B4%B9%E8%80%85%E6%A8%A1%E5%9E%8B%E8%BF%9B%E7%A8%8B/" class="">生产者消费者模型（进程）</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Python/Python%E4%B9%8B%E6%93%8D%E4%BD%9CMySQL%E6%95%B0%E6%8D%AE%E5%BA%93/" class="">Python之操作MySQL数据库</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-ab6241a9c9348727e1ed30d9d7253a0e" class="toggle"  />
    <label for="section-ab6241a9c9348727e1ed30d9d7253a0e" class="flex justify-between">
      <a role="button" class="">Golang</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Golang/Go%E8%AF%AD%E8%A8%80%E7%BC%96%E7%A8%8B%E5%9F%BA%E7%A1%80/" class="">Go语言编程基础</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Golang/Go%E8%AF%AD%E8%A8%80WEB%E5%BC%80%E5%8F%91/" class="">Go语言WEB开发</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Golang/Go%E8%AF%AD%E8%A8%80%E7%9A%84ORM%E6%A1%86%E6%9E%B6/" class="">Go语言的ORM框架</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-a6af99c5c0ad1c9aeaecde8920e3b5e8" class="toggle"  />
    <label for="section-a6af99c5c0ad1c9aeaecde8920e3b5e8" class="flex justify-between">
      <a role="button" class="">C&#43;&#43;</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/C&#43;&#43;/C&#43;&#43;%E7%BC%96%E7%A8%8B%E5%9F%BA%E7%A1%80/" class="">C&#43;&#43;编程基础</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-270a210b43b4f0ee7cd55855f0b534f3" class="toggle" checked />
    <label for="section-270a210b43b4f0ee7cd55855f0b534f3" class="flex justify-between">
      <a role="button" class="">MySQL</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/MySQL/MySQL/" class=" active">MySQL</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-9fdacdda397d9ceae1a912b9128fe9e2" class="toggle"  />
    <label for="section-9fdacdda397d9ceae1a912b9128fe9e2" class="flex justify-between">
      <a role="button" class="">PostgreSQL</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/PostgreSQL/PostgreSQL/" class="">PostgreSQL</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-42f4d133c66bcfbca3d930dc56eb7d01" class="toggle"  />
    <label for="section-42f4d133c66bcfbca3d930dc56eb7d01" class="flex justify-between">
      <a href="https://Huang-CH.github.io/docs/OceanBase/" class="">OceanBase</a>
    </label>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-0f85b1f743da7f4e4cb9fca119fef7be" class="toggle"  />
    <label for="section-0f85b1f743da7f4e4cb9fca119fef7be" class="flex justify-between">
      <a role="button" class="">Docker</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Docker/Docker%E5%8D%83%E9%94%8B%E6%95%99%E8%82%B2/" class="">Docker基础</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-6e638f9230da561f7c487c298451b1ed" class="toggle"  />
    <label for="section-6e638f9230da561f7c487c298451b1ed" class="flex justify-between">
      <a role="button" class="">Kubernetes</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Kubernetes/Kubernetes/" class="">Kubernetes</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-ec36ec3492308dbc4bfcaa14eb72fa33" class="toggle"  />
    <label for="section-ec36ec3492308dbc4bfcaa14eb72fa33" class="flex justify-between">
      <a role="button" class="">Git</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Git/git%E5%9F%BA%E7%A1%80/" class="">Git基础</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>











  
<ul>
  
  <li>
    <a href="https://github.com/Huang-CH" target="_blank" rel="noopener">
        My Github
      </a>
  </li>
  
</ul>






</nav>




  <script>(function(){var a=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(b){localStorage.setItem("menu.scrollTop",a.scrollTop)}),a.scrollTop=localStorage.getItem("menu.scrollTop")})()</script>


 
      </div>
    </aside>

    <div class="book-page">
      <header class="book-header">
        
  <div class="flex align-center justify-between">
  <label for="menu-control">
    <img src="/svg/menu.svg" class="book-icon" alt="Menu" />
  </label>

  <strong>MySQL</strong>

  <label for="toc-control">
    
    <img src="/svg/toc.svg" class="book-icon" alt="Table of Contents" />
    
  </label>
</div>


  
  <aside class="hidden clearfix">
    
  
<nav id="TableOfContents">
  <ul>
    <li><a href="#mysql相关产品介绍">MySQL相关产品介绍</a></li>
    <li><a href="#mysql版本介绍">MySQL版本介绍</a></li>
    <li><a href="#mysql安装">MySQL安装</a>
      <ul>
        <li><a href="#安装版本的选择">安装版本的选择</a></li>
        <li><a href="#二进制文件安装">二进制文件安装</a></li>
        <li><a href="#环境准备">环境准备</a>
          <ul>
            <li><a href="#清理历史环境">清理历史环境</a></li>
            <li><a href="#安装mysql依赖">安装MySQL依赖</a></li>
            <li><a href="#创建用户和组">创建用户和组</a></li>
            <li><a href="#创建相关目录">创建相关目录</a></li>
          </ul>
        </li>
        <li><a href="#安装软件">安装软件</a>
          <ul>
            <li><a href="#软件下载">软件下载</a></li>
            <li><a href="#设置环境变量">设置环境变量</a></li>
            <li><a href="#初始化mysql">初始化MySQL</a></li>
            <li><a href="#配置文件">配置文件</a></li>
          </ul>
        </li>
        <li><a href="#启动服务">启动服务</a>
          <ul>
            <li><a href="#准备mysql的启动脚本">准备MySQL的启动脚本</a></li>
            <li><a href="#启动mysql服务">启动MySQL服务</a></li>
            <li><a href="#修改mysql初始密码">修改MySQL初始密码</a></li>
            <li><a href="#允许root用户远程访问">允许ROOT用户远程访问</a></li>
            <li><a href="#关闭mysql服务">关闭MySQL服务</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#mysql体系结构">MySQL体系结构</a>
      <ul>
        <li><a href="#mysql登录方式">MySQL登录方式</a></li>
        <li><a href="#mysql实例">MySQL实例</a></li>
        <li><a href="#管理工具和服务management-serveices--utilities">管理工具和服务（Management Serveices &amp; Utilities）</a></li>
        <li><a href="#连接池connection-pool">连接池（Connection Pool）</a></li>
        <li><a href="#sql接口sql-interface">SQL接口（SQL Interface）</a></li>
        <li><a href="#解析器parser">解析器（Parser）</a></li>
        <li><a href="#查询优化器optimizer">查询优化器（Optimizer）</a></li>
        <li><a href="#缓存器caches--buffers">缓存器（Caches &amp; Buffers）</a></li>
        <li><a href="#存储引擎pluggable-storage-engines">存储引擎（Pluggable Storage Engines）</a></li>
        <li><a href="#文件系统file-system">文件系统（File System）</a></li>
      </ul>
    </li>
    <li><a href="#mysql基础管理">MySQL基础管理</a>
      <ul>
        <li><a href="#用户管理">用户管理</a></li>
        <li><a href="#用户授权">用户授权</a>
          <ul>
            <li><a href="#查看系统权限">查看系统权限</a></li>
            <li><a href="#对用户授权">对用户授权</a></li>
            <li><a href="#破解管理员密码">破解管理员密码</a></li>
          </ul>
        </li>
        <li><a href="#连接管理">连接管理</a>
          <ul>
            <li><a href="#本地连接">本地连接</a></li>
            <li><a href="#远程连接">远程连接</a></li>
            <li><a href="#免交互执行sql语句">免交互执行SQL语句</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#mysql多实例">MySQL多实例</a>
      <ul>
        <li><a href="#相同mysql版本的多实例">相同MySQL版本的多实例</a>
          <ul>
            <li><a href="#规划">规划</a></li>
            <li><a href="#配置过程">配置过程</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#mysql基础语句">MySQL基础语句</a>
      <ul>
        <li><a href="#mysql语言结构">MySQL语言结构</a></li>
        <li><a href="#mysql中字符集和排序规则">MySQL中字符集和排序规则</a></li>
        <li><a href="#mysql数据类型">MySQL数据类型</a></li>
        <li><a href="#mysql约束">MySQL约束</a></li>
        <li><a href="#mysql数据类型默认值和注释">MySQL数据类型默认值和注释</a></li>
        <li><a href="#ddl数据定义语言">DDL：数据定义语言</a>
          <ul>
            <li><a href="#数据库定义">数据库定义</a></li>
            <li><a href="#数据表定义">数据表定义</a></li>
          </ul>
        </li>
        <li><a href="#dcl数据控制语言">DCL：数据控制语言</a></li>
        <li><a href="#dml数据操作语言">DML：数据操作语言</a></li>
        <li><a href="#dql数据查询语言">DQL：数据查询语言</a>
          <ul>
            <li><a href="#select">SELECT</a></li>
            <li><a href="#show">SHOW</a></li>
            <li><a href="#union和union-all">UNION和UNION ALL</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#mysql索引">MySQL索引</a>
      <ul>
        <li><a href="#主键索引">主键索引</a></li>
        <li><a href="#辅助索引">辅助索引</a>
          <ul>
            <li><a href="#普通索引">普通索引</a></li>
            <li><a href="#联合索引">联合索引</a></li>
            <li><a href="#前缀索引">前缀索引</a></li>
            <li><a href="#唯一索引">唯一索引</a></li>
          </ul>
        </li>
        <li><a href="#执行计划">执行计划</a>
          <ul>
            <li><a href="#查看执行计划">查看执行计划</a></li>
            <li><a href="#执行计划结果">执行计划结果</a></li>
          </ul>
        </li>
        <li><a href="#索引应用规范">索引应用规范</a></li>
        <li><a href="#创建索引的原则">创建索引的原则</a></li>
        <li><a href="#导致索引失效的常见原因">导致索引失效的常见原因</a></li>
        <li><a href="#优化器针对索引的算法介绍">优化器针对索引的算法介绍</a>
          <ul>
            <li><a href="#ahiadaptive-hash-index-自适应-hash-索引">AHI（Adaptive Hash Index） 自适应 Hash 索引</a></li>
            <li><a href="#change-buffer">Change Buffer</a></li>
            <li><a href="#icpindex-condition-pushdown索引下推">ICP（Index Condition Pushdown）索引下推</a></li>
            <li><a href="#mrr算法">MRR算法</a></li>
            <li><a href="#snlj算法">SNLJ算法</a></li>
            <li><a href="#bnlj算法">BNLJ算法</a></li>
            <li><a href="#bka算法">BKA算法</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#mysql存储引擎">MySQL存储引擎</a>
      <ul>
        <li><a href="#innodb的特性">InnoDB的特性</a></li>
      </ul>
    </li>
    <li><a href="#mysql日志管理">MySQL日志管理</a>
      <ul>
        <li><a href="#错误日志">错误日志</a></li>
        <li><a href="#二进制日志binlog">二进制日志（binlog）</a>
          <ul>
            <li><a href="#配置方法">配置方法</a></li>
            <li><a href="#维护操作">维护操作</a></li>
          </ul>
        </li>
        <li><a href="#慢日志slowlog">慢日志（slowlog）</a>
          <ul>
            <li><a href="#配置方法-1">配置方法</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#mysql备份与恢复">MySQL备份与恢复</a>
      <ul>
        <li><a href="#dba备份与恢复的职责">DBA备份与恢复的职责</a></li>
        <li><a href="#mysql常用备份工具">MySQL常用备份工具</a>
          <ul>
            <li><a href="#逻辑备份方式">逻辑备份方式</a></li>
            <li><a href="#物理备份方式">物理备份方式</a></li>
          </ul>
        </li>
        <li><a href="#mysql备份恢复">MySQL备份恢复</a>
          <ul>
            <li><a href="#检查全备">检查全备</a></li>
            <li><a href="#恢复全备">恢复全备</a></li>
            <li><a href="#截取二进制日志binlog">截取二进制日志（binlog）</a></li>
            <li><a href="#恢复二进制日志binlog">恢复二进制日志（binlog）</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#主从复制">主从复制</a>
      <ul>
        <li><a href="#部署主从复制">部署主从复制</a></li>
        <li><a href="#清空主从复制">清空主从复制</a></li>
        <li><a href="#主从复制原理">主从复制原理</a>
          <ul>
            <li><a href="#主从复制的中涉及到的资源">主从复制的中涉及到的资源</a></li>
            <li><a href="#主从复制工作原理的描述">主从复制工作原理的描述</a></li>
          </ul>
        </li>
        <li><a href="#主从复制的状态监控">主从复制的状态监控</a></li>
        <li><a href="#主从故障分析及处理">主从故障分析及处理</a>
          <ul>
            <li><a href="#io线程故障">IO线程故障</a></li>
            <li><a href="#sql线程故障">SQL线程故障</a></li>
          </ul>
        </li>
        <li><a href="#主从延迟分析及处理">主从延迟分析及处理</a>
          <ul>
            <li><a href="#主库master原因">主库（master）原因</a></li>
            <li><a href="#从库slave原因">从库（slave）原因</a></li>
          </ul>
        </li>
        <li><a href="#特殊从库的应用">特殊从库的应用</a>
          <ul>
            <li><a href="#延时从库">延时从库</a></li>
            <li><a href="#半同步复制">半同步复制</a></li>
            <li><a href="#过滤复制">过滤复制</a></li>
            <li><a href="#gtid复制">GTID复制</a></li>
          </ul>
        </li>
        <li><a href="#主从复制架构演变">主从复制架构演变</a></li>
        <li><a href="#高可用架构">高可用架构</a>
          <ul>
            <li><a href="#mha高可用架构软件构成">MHA高可用架构软件构成</a></li>
            <li><a href="#mha高可用架构工作原理">MHA高可用架构工作原理</a></li>
            <li><a href="#部署mha高可用架构">部署MHA高可用架构</a></li>
            <li><a href="#mha的应用透明vip">MHA的应用透明（VIP）</a></li>
            <li><a href="#mha故障提醒">MHA故障提醒</a></li>
            <li><a href="#二次数据补偿">二次数据补偿</a></li>
          </ul>
        </li>
        <li><a href="#高性能架构读写分离">高性能架构（读写分离）</a></li>
        <li><a href="#分布式架构">分布式架构</a></li>
      </ul>
    </li>
  </ul>
</nav>



  </aside>
  
 
      </header>

      
      
  <article class="markdown"><h1 id="mysql相关产品介绍">
  MySQL相关产品介绍
  <a class="anchor" href="#mysql%e7%9b%b8%e5%85%b3%e4%ba%a7%e5%93%81%e4%bb%8b%e7%bb%8d">#</a>
</h1>
<hr>
<ul>
<li>
<p>Oracle MySQL Cloud Service（Commercial）</p>
<p>商业付费软件，基于MySQL企业版和Oracle云服务提供企业级的MySQL数据库服务。</p>
</li>
<li>
<p>MySQL Enterprise Edition（Commercial）</p>
<p>商业付费软件，除了提供MySQL数据库服务之外，又包含了<code>connector</code>（程序连接接口）、<code>partition</code>（分区表）、企业级的<code>monitor</code>（监控）、HA（高可用）、<code>backup</code>（备份）、Scalability（扩展）等服务。</p>
</li>
<li>
<p>MySQL Cluster CGE（Commercial）</p>
<p>商业付费软件，基于MySQL Cluster和企业版拥有的各项功能提供企业级的高并发、高吞吐量的数据库服务。</p>
</li>
<li>
<p>MySQL Community Edition（Free）</p>
<p>免费社区版，提供基础的数据库服务和其他衍生服务。</p>
<ul>
<li>
<p>MySQL Cluster（但市场中很少使用，口碑不好）</p>
<p>基于MySQL数据库而实现的集群服务，自身能提供高并发、高负载等特性。</p>
</li>
<li>
<p>MySQL Fabric</p>
<p>官方提供的关于MySQL数据库高可用和数据分片的解决方案。</p>
</li>
<li>
<p>MySQL Connectors</p>
<p>为应用程序提供JDBC/ODBC等访问MySQL数据库的接口服务。</p>
</li>
</ul>
</li>
</ul>
<hr>
<h1 id="mysql版本介绍">
  MySQL版本介绍
  <a class="anchor" href="#mysql%e7%89%88%e6%9c%ac%e4%bb%8b%e7%bb%8d">#</a>
</h1>
<hr>
<p>各操作系统与MySQL版本兼容性参照表：https://www.mysql.com/support/supportedplatforms/database.html</p>
<hr>
<h1 id="mysql安装">
  MySQL安装
  <a class="anchor" href="#mysql%e5%ae%89%e8%a3%85">#</a>
</h1>
<hr>
<h2 id="安装版本的选择">
  安装版本的选择
  <a class="anchor" href="#%e5%ae%89%e8%a3%85%e7%89%88%e6%9c%ac%e7%9a%84%e9%80%89%e6%8b%a9">#</a>
</h2>
<hr>
<ul>
<li>首先需要考虑生产环境中的其他MySQL数据库的版本，优先部署与生产其他MySQL一致的版本。</li>
<li>如果是全新部署，则一般会选择安装最新版本。</li>
<li>生产环境不要选择<code>Development Release</code>，应该选择<code>General Availability Release</code>。</li>
</ul>
<hr>
<h2 id="二进制文件安装">
  二进制文件安装
  <a class="anchor" href="#%e4%ba%8c%e8%bf%9b%e5%88%b6%e6%96%87%e4%bb%b6%e5%ae%89%e8%a3%85">#</a>
</h2>
<hr>
<blockquote>
<p>官方文档链接：https://dev.mysql.com/doc/refman/8.0/en/binary-installation.html</p>
<p><strong>警告</strong></p>
<ul>
<li>
<p>如果您之前使用操作系统原生软件包管理系统（如Yum或APT）安装过MySQL，您可能会在使用本机二进制文件安装时遇到问题。确保您之前的MySQL安装已完全删除（使用您的软件包管理系统），并且任何其他文件，如旧版数据文件，也已删除。您还应该检查/etc/my.cnf或/etc/mysql目录等配置文件并删除它们。</p>
<p>有关将第三方软件包替换为官方MySQL软件包的信息，请参阅相关的
  <a href="https://dev.mysql.com/doc/mysql-apt-repo-quick-guide/en/">APT指南</a>或
  <a href="https://dev.mysql.com/doc/refman/5.7/en/replace-third-party-yum.html">Yum指南</a>。</p>
</li>
<li>
<p>MySQL依赖于libaio库。如果没有在本地安装此库，数据目录初始化和后续服务器启动步骤失败。如有必要，请使用适当的软件包管理器进行安装。</p>
</li>
</ul>
</blockquote>
<p>要安装压缩文件的二进制发行版，请在您选择的安装位置（通常是<code>/usr/local/mysql</code>）解压它。这将创建下表中显示的目录。</p>
<table>
<thead>
<tr>
<th style="text-align:center">Directory</th>
<th style="text-align:center">Contents of Directory</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><code>bin</code></td>
<td style="text-align:center">
  <a href="https://dev.mysql.com/doc/refman/8.0/en/mysqld.html"><strong>mysqld</strong></a> server, client and utility programs</td>
</tr>
<tr>
<td style="text-align:center"><code>docs</code></td>
<td style="text-align:center">MySQL manual in Info format</td>
</tr>
<tr>
<td style="text-align:center"><code>man</code></td>
<td style="text-align:center">Unix manual pages</td>
</tr>
<tr>
<td style="text-align:center"><code>include</code></td>
<td style="text-align:center">Include (header) files</td>
</tr>
<tr>
<td style="text-align:center"><code>lib</code></td>
<td style="text-align:center">Libraries</td>
</tr>
<tr>
<td style="text-align:center"><code>share</code></td>
<td style="text-align:center">Error messages, dictionary, and SQL for database installation</td>
</tr>
<tr>
<td style="text-align:center"><code>support-files</code></td>
<td style="text-align:center">Miscellaneous support files</td>
</tr>
</tbody>
</table>
<h2 id="环境准备">
  环境准备
  <a class="anchor" href="#%e7%8e%af%e5%a2%83%e5%87%86%e5%a4%87">#</a>
</h2>
<hr>
<h3 id="清理历史环境">
  清理历史环境
  <a class="anchor" href="#%e6%b8%85%e7%90%86%e5%8e%86%e5%8f%b2%e7%8e%af%e5%a2%83">#</a>
</h3>
<ul>
<li>RedHat/CentOS系下：</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$&gt; rpm -qa | grep mariadb       <span style="color:#75715e"># 搜索是否安装了 MariaDB</span>
$&gt; yum remove -y mariadb-libs   <span style="color:#75715e"># 卸载 MariaDB</span>
</code></pre></div><ul>
<li>Debian/Ubuntu系下：</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$&gt; dpkg -l | grep mariadb      <span style="color:#75715e"># 搜索是否安装了 MariaDB</span>
$&gt; apt remove -y mariadb-libs  <span style="color:#75715e"># 卸载MariaDB</span>
</code></pre></div><hr>
<h3 id="安装mysql依赖">
  安装MySQL依赖
  <a class="anchor" href="#%e5%ae%89%e8%a3%85mysql%e4%be%9d%e8%b5%96">#</a>
</h3>
<ul>
<li>RedHat/CentOS系下：</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$&gt; yum search libaio      <span style="color:#75715e"># 搜索 library</span>
$&gt; yum install -y libaio  <span style="color:#75715e"># 安装 library</span>
</code></pre></div><ul>
<li>Debian/Ubuntu系下：</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$&gt; apt-cache search libaio      <span style="color:#75715e"># 搜索 library</span>
$&gt; apt install -y libaio1       <span style="color:#75715e"># 安装 library</span>
$&gt; apt install -y libncurses5   <span style="color:#75715e"># 安装 libncurses5</span>
$&gt; apt install -y numactl       <span style="color:#75715e"># 安装 numactl,解决 libraries: libnuma.so.1 报错</span>
</code></pre></div><hr>
<h3 id="创建用户和组">
  创建用户和组
  <a class="anchor" href="#%e5%88%9b%e5%bb%ba%e7%94%a8%e6%88%b7%e5%92%8c%e7%bb%84">#</a>
</h3>
<p>如果您的系统还没有用于运行
  <a href="https://dev.mysql.com/doc/refman/8.0/en/mysqld.html"><strong>mysqld</strong></a>的用户和组，您可能需要创建它们。以下命令添加了<code>mysql</code>组和<code>mysql</code>用户。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$&gt; groupadd mysql                              <span style="color:#75715e"># 创建组</span>
$&gt; useradd -r -g mysql -s /bin/false mysql     <span style="color:#75715e"># 创建用户，并设置 mysql 用户不能登录，注意：/bin/false 相比 /bin/nologin 更为严格，禁用一切服务</span>
$&gt; id mysql                                    <span style="color:#75715e"># 验证 mysql 账户</span>
</code></pre></div><hr>
<h3 id="创建相关目录">
  创建相关目录
  <a class="anchor" href="#%e5%88%9b%e5%bb%ba%e7%9b%b8%e5%85%b3%e7%9b%ae%e5%bd%95">#</a>
</h3>
<blockquote>
<p>注意：在生产环境中，一般软件目录、数据目录和日志目录需要分别放在不同的磁盘上</p>
</blockquote>
<ul>
<li>软件目录</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$&gt; /usr/local   <span style="color:#75715e"># 官方推荐的软件安装路径</span>
</code></pre></div><ul>
<li>数据目录</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$&gt; mkdir -p /opt/mysql/3306/data               <span style="color:#75715e"># 在 /home/mysql/ 下创建数据目录data</span>
$&gt; chown -R mysql:mysql /opt/mysql/3306/data   <span style="color:#75715e"># 更改数据目录属主和属组</span>
$&gt; chmod -R <span style="color:#ae81ff">750</span> /opt/mysql/3306/data           <span style="color:#75715e"># 设置数据目录权限</span>
</code></pre></div><ul>
<li>日志目录</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$&gt; mkdir -p /opt/mysql/3306/log                <span style="color:#75715e"># 在 /home/mysql/ 下创建日志目录mysql-log</span>
$&gt; chown -R mysql:mysql /opt/mysql/3306/log    <span style="color:#75715e"># 更改日志目录属主和属组</span>
$&gt; chmod -R <span style="color:#ae81ff">750</span> /opt/mysql/3306/log            <span style="color:#75715e"># 设置日志目录权限</span>
</code></pre></div><hr>
<h2 id="安装软件">
  安装软件
  <a class="anchor" href="#%e5%ae%89%e8%a3%85%e8%bd%af%e4%bb%b6">#</a>
</h2>
<hr>
<h3 id="软件下载">
  软件下载
  <a class="anchor" href="#%e8%bd%af%e4%bb%b6%e4%b8%8b%e8%bd%bd">#</a>
</h3>
<blockquote>
<p>
  <a href="https://dev.mysql.com/downloads/mysql/">MySQL : Download MySQL Community Server</a></p>
</blockquote>
<ul>
<li>解压软件</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$&gt; tar -xvf mysql-VERSION-OS.tar
$&gt; tar -xvf mysql-VERSION-OS.tar.xz
</code></pre></div><ul>
<li>将软件移至安装目录并添加软连接</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$&gt; mv mysql-VERSION-OS /usr/local
$&gt; cd /usr/local
$&gt; ln -s full-path-to-mysql-VERSION-OS mysql
</code></pre></div><hr>
<h3 id="设置环境变量">
  设置环境变量
  <a class="anchor" href="#%e8%ae%be%e7%bd%ae%e7%8e%af%e5%a2%83%e5%8f%98%e9%87%8f">#</a>
</h3>
<p>为了避免在使用MySQL时始终键入客户端程序的路径名称，您可以将<code>/usr/local/mysql/bin</code>目录添加到<code>PATH</code>变量中：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$&gt; vim /etc/profile
<span style="color:#75715e"># 添加以下内容</span>
export PATH<span style="color:#f92672">=</span>$PATH:/usr/local/mysql/bin    <span style="color:#75715e"># 告诉系统 mysql 命令的路径</span>
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$&gt; source /etc/profile     <span style="color:#75715e"># 使环境变量配置生效</span>
</code></pre></div><hr>
<h3 id="初始化mysql">
  初始化MySQL
  <a class="anchor" href="#%e5%88%9d%e5%a7%8b%e5%8c%96mysql">#</a>
</h3>
<blockquote>
<p>要初始化数据目录，请使用<code>--initialize</code>或&ndash;initialize-insecure选项调用<code>mysqld</code>，具体取决于您是希望服务器为<code>'root'@'localhost'</code>帐户生成随机初始密码，还是在没有密码的情况下创建该帐户：</p>
<ul>
<li>使用<code>--initialize</code>进行“默认安全”安装（即包括生成随机初始root密码）。在这种情况下，密码被标记为过期，您必须选择新的密码。</li>
<li>使用<code>--initialize-insecure</code>，不会生成root密码。这是不安全的；假设您打算在将服务器投入生产使用之前及时为帐户分配密码。</li>
</ul>
</blockquote>
<p>数据库目录和文件必须归<code>mysql</code>登录帐户所有，这样服务器在您稍后运行时就可以对它们进行读写访问。为了确保这一点，请从系统<code>root</code>帐户启动
  <a href="https://dev.mysql.com/doc/refman/8.0/en/mysqld.html"><strong><code>mysqld</code></strong></a>，并包含
  <a href="https://dev.mysql.com/doc/refman/8.0/en/server-options.html#option_mysqld_user"><code>--user</code></a>选项，如下所示：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$&gt; cd /usr/local/mysql/bin
$&gt; mysqld --initialize-insecure --user<span style="color:#f92672">=</span>mysql --basedir<span style="color:#f92672">=</span>/usr/local/mysql --datadir<span style="color:#f92672">=</span>/opt/mysql/3306/data/
</code></pre></div><hr>
<h3 id="配置文件">
  配置文件
  <a class="anchor" href="#%e9%85%8d%e7%bd%ae%e6%96%87%e4%bb%b6">#</a>
</h3>
<blockquote>
<p>通过命令：<code>mysqld --help --verbose | grep my.cnf</code> 可以查看到运行 <code>mysqld</code> 时都加载了哪些路径下的 <code>my.cnf</code> ，有就读取，没有就跳过。</p>
<p>MySQL配置文件的读取顺序为：<code>/etc/my.cnf</code> &mdash;&gt; <code>/etc/mysql/my.cnf</code> &mdash;&gt; <code>/usr/local/mysql/etc/my.cnf</code> &mdash;&gt; <code>~/.my.cnf</code></p>
<p>如果需要自定义MySQL的配置文件路径，例如：多实例从不同端口启动MySQL的时候，则需要通过直接调用<code>mysqld</code>服务并增加启动参数的方式启动MySQL</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$&gt; mysqld --default-file<span style="color:#f92672">=</span>/opt/my.cnf &amp;      <span style="color:#75715e"># &#34;&amp;&#34;符号表示让这条命令在系统后台运行</span>
</code></pre></div><p>MySQL配置文件中有两种标签，<code>[服务器端]</code>标签负责设定数据库服务端参数，<code>[客户端]</code>标签负责设定本地客户端连接参数（不影响远程连接）</p>
<p>MySQL配置文件中都要用小写字母，大写字母不被识别，切记！</p>
</blockquote>
<p>在<code>/etc/my.cnf</code>文件中添加一下内容：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#f92672">[</span>mysql<span style="color:#f92672">]</span>                                      <span style="color:#75715e"># 客户端标签</span>
socket<span style="color:#f92672">=</span>/tmp/mysql.sock                       <span style="color:#75715e"># 客户端读取套接字文件的路径（多实例时不要写这个）</span>

<span style="color:#f92672">[</span>mysqld<span style="color:#f92672">]</span>                                     <span style="color:#75715e"># 服务器端标签</span>
user<span style="color:#f92672">=</span>mysql                                   <span style="color:#75715e"># 负责管理数据库的用户</span>
basedir<span style="color:#f92672">=</span>/usr/local/mysql                     <span style="color:#75715e"># 软件的安装位置</span>
datadir<span style="color:#f92672">=</span>/opt/mysql/3306/data                 <span style="color:#75715e"># 数据的存放位置</span>
port<span style="color:#f92672">=</span><span style="color:#ae81ff">3306</span>                                    <span style="color:#75715e"># 端口号</span>
server_id<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>                                  <span style="color:#75715e"># 表示节点的唯一编号（主从复制的时候需要用到，单机下无用）</span>
socket<span style="color:#f92672">=</span>/tmp/mysql.sock                       <span style="color:#75715e"># 套接字文件</span>
log_error<span style="color:#f92672">=</span>/opt/mysql/3306/log/mysql.log      <span style="color:#75715e"># 错误日志的存放路径（需要提前创建mysql.log文件并授权）</span>
log_bin<span style="color:#f92672">=</span>/opt/mysql/3306/log/mysql-bin        <span style="color:#75715e"># 二进制日志的存放路径</span>
sync_binlog<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>                                <span style="color:#75715e"># binlog日志落盘策略，含义为：每次事务提交，立即将binlog落盘</span>
binlog_format<span style="color:#f92672">=</span>row                            <span style="color:#75715e"># binlog日志记录格式为row</span>
gtid-mode<span style="color:#f92672">=</span>on                                 <span style="color:#75715e"># 开启GTID模式</span>
enforce-gtid-consistency<span style="color:#f92672">=</span>true                <span style="color:#75715e"># 强制GTID的一致性</span>
slow_query_log<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>                             <span style="color:#75715e"># 开启慢日志查询</span>
slow_query_log_file<span style="color:#f92672">=</span>/opt/mysql/3306/log/mysql-slow.log    <span style="color:#75715e">#配置慢日志文件路径</span>
long_query_time<span style="color:#f92672">=</span><span style="color:#ae81ff">10</span>                           <span style="color:#75715e"># 定义慢语句时间标准</span>
log_queries_not_using_indexes<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>              <span style="color:#75715e"># 开启未使用索引语句记录到慢日志</span>

</code></pre></div><hr>
<h2 id="启动服务">
  启动服务
  <a class="anchor" href="#%e5%90%af%e5%8a%a8%e6%9c%8d%e5%8a%a1">#</a>
</h2>
<hr>
<h3 id="准备mysql的启动脚本">
  准备MySQL的启动脚本
  <a class="anchor" href="#%e5%87%86%e5%a4%87mysql%e7%9a%84%e5%90%af%e5%8a%a8%e8%84%9a%e6%9c%ac">#</a>
</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$&gt; cp /usr/local/mysql/support-files/mysql.server /etc/init.d/mysqld
$&gt; cp /usr/local/mysql/support-files/mysql.server /etc/systemd/system/mysqld        -- 将服务添加到 systemctl
$&gt; systemctl daemon-reload                                                          -- 刷新 systemctl
</code></pre></div><hr>
<h3 id="启动mysql服务">
  启动MySQL服务
  <a class="anchor" href="#%e5%90%af%e5%8a%a8mysql%e6%9c%8d%e5%8a%a1">#</a>
</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$&gt; systemctl enable mysql.server       -- 将 mysql 服务添加到开机启动
$&gt; systemctl start mysql.service       -- 启动 mysql 服务
</code></pre></div><blockquote>
<p><code>mysql.server</code> 调用的 <code>mysqld_safe</code>, <code>mysqld_safe</code> 调用的 <code>mysqld</code></p>
<p>直接运行 <code>mysqld</code> 或者 <code>mysqld_safe</code>时可以添加启动参数，例如：<code>--skip-grant-tables</code> 、<code>--skip-networking</code>、<code>--default-file=/opt/my.cnf</code> 等</p>
</blockquote>
<hr>
<h3 id="修改mysql初始密码">
  修改MySQL初始密码
  <a class="anchor" href="#%e4%bf%ae%e6%94%b9mysql%e5%88%9d%e5%a7%8b%e5%af%86%e7%a0%81">#</a>
</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$&gt; mysqladmin -h 127.0.0.1 -u root -p password
</code></pre></div><hr>
<h3 id="允许root用户远程访问">
  允许ROOT用户远程访问
  <a class="anchor" href="#%e5%85%81%e8%ae%b8root%e7%94%a8%e6%88%b7%e8%bf%9c%e7%a8%8b%e8%ae%bf%e9%97%ae">#</a>
</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql">mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">USER</span> <span style="color:#e6db74">&#39;root&#39;</span><span style="color:#f92672">@</span><span style="color:#e6db74">&#39;%&#39;</span> <span style="color:#66d9ef">IDENTIFIED</span> <span style="color:#66d9ef">BY</span> <span style="color:#e6db74">&#39;123&#39;</span>;
mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">GRANT</span> <span style="color:#66d9ef">ALL</span> <span style="color:#66d9ef">PRIVILEGES</span> <span style="color:#66d9ef">ON</span> <span style="color:#f92672">*</span>.<span style="color:#f92672">*</span> <span style="color:#66d9ef">TO</span> <span style="color:#e6db74">&#39;root&#39;</span><span style="color:#f92672">@</span><span style="color:#e6db74">&#39;%&#39;</span> <span style="color:#66d9ef">WITH</span> <span style="color:#66d9ef">GRANT</span> <span style="color:#66d9ef">OPTION</span>;
mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">FLUSH</span> <span style="color:#66d9ef">PRIVILEGES</span>;
</code></pre></div><hr>
<h3 id="关闭mysql服务">
  关闭MySQL服务
  <a class="anchor" href="#%e5%85%b3%e9%97%admysql%e6%9c%8d%e5%8a%a1">#</a>
</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$&gt; systemctl stop mysqld      -- 关闭 mysql 服务
</code></pre></div><blockquote>
<p>通过 <code>/usr/local/bin/mysqld</code> 的方式启动的MySQL服务，需要连接MySQL后使用 <code>shutdown</code> 命令关闭服务，或者通过 <code>mysql -u root -p -e &quot;shutdown&quot;</code> 命令来关闭服务</p>
</blockquote>
<hr>
<h1 id="mysql体系结构">
  MySQL体系结构
  <a class="anchor" href="#mysql%e4%bd%93%e7%b3%bb%e7%bb%93%e6%9e%84">#</a>
</h1>
<hr>
<h2 id="mysql登录方式">
  MySQL登录方式
  <a class="anchor" href="#mysql%e7%99%bb%e5%bd%95%e6%96%b9%e5%bc%8f">#</a>
</h2>
<hr>
<ul>
<li>Socket方式</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$&gt; mysql -S /tmp/mysql.sock -u root -p <span style="color:#ae81ff">123456</span> 
</code></pre></div><ul>
<li>TCP/IP方式（远程、本地）</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$&gt; mysql -h 127.0.0.1 -u root -p password <span style="color:#ae81ff">123456</span>
</code></pre></div><hr>
<h2 id="mysql实例">
  MySQL实例
  <a class="anchor" href="#mysql%e5%ae%9e%e4%be%8b">#</a>
</h2>
<hr>
<p><code>实例</code> = <code>mysqld后台守护进程</code> + <code>主线程（master thread）</code>+ <code>工作线程（worker thread）</code> + <code>预分配内存</code></p>
<hr>
<h2 id="管理工具和服务management-serveices--utilities">
  管理工具和服务（Management Serveices &amp; Utilities）
  <a class="anchor" href="#%e7%ae%a1%e7%90%86%e5%b7%a5%e5%85%b7%e5%92%8c%e6%9c%8d%e5%8a%a1management-serveices--utilities">#</a>
</h2>
<hr>
<blockquote>
<p>系统管理和控制工具，例如：备份、恢复、MySQL复制、集群等</p>
</blockquote>
<hr>
<h2 id="连接池connection-pool">
  连接池（Connection Pool）
  <a class="anchor" href="#%e8%bf%9e%e6%8e%a5%e6%b1%a0connection-pool">#</a>
</h2>
<hr>
<blockquote>
<p>数据库连接是一种关键的、有限的、昂贵的资源，这一点在多用户的网页应用程序中体现得尤为突出。对数据库连接的管理能显著影响到整个应用程序的伸缩性和健壮性，影响到程序的性能指标。数据库连接池正是针对这个问题提出来的。</p>
<p>连接池基本的思想是在系统初始化的时候，将数据库连接作为对象存储在内存中，当用户需要访问数据库时，并非建立一个新的连接，而是从连接池中取出一个已建立的空闲连接对象。使用完毕后，用户也并非将连接关闭，而是将连接放回连接池中，以供下一个请求访问使用。而连接的建立、断开都由连接池自身来管理。同时，还可以通过设置连接池的参数来控制连接池中的初始连接数、连接的上下限数以及每个连接的最大使用次数、最大空闲时间等等。也可以通过其自身的管理机制来监视数据库连接的数量、使用情况等。</p>
</blockquote>
<ul>
<li>
<p>提供连接协议：TCP/IP、Unix SOCKET</p>
</li>
<li>
<p>加载授权表（<code>mysql.user</code>、<code>mysql.db</code>、<code>mysql.table_priv</code>、<code>mysql.columns_priv</code>、<code>mysql.table_proc</code>、<code>mysql.table_proxy</code>），对连接进行身份认证：用户名、密码、IP、SOCKET</p>
</li>
<li>
<p>提供专用连接线程</p>
<blockquote>
<p>MySQL中可以通过 <code>show processlist;</code> 命令查询已建立的连接</p>
</blockquote>
</li>
</ul>
<hr>
<h2 id="sql接口sql-interface">
  SQL接口（SQL Interface）
  <a class="anchor" href="#sql%e6%8e%a5%e5%8f%a3sql-interface">#</a>
</h2>
<hr>
<p>接收用户的SQL命令，并且返回用户需要查询的结果。</p>
<hr>
<h2 id="解析器parser">
  解析器（Parser）
  <a class="anchor" href="#%e8%a7%a3%e6%9e%90%e5%99%a8parser">#</a>
</h2>
<hr>
<p>SQL命令传递到解析器的时候会被解析器验证和解析。解析器是由Lex和YACC实现的，是一个很长的脚本。
主要功能：</p>
<ul>
<li>
<p>检查所接收的SQL语法是否满足 <code>SQL_MODE</code></p>
</li>
<li>
<p>语义检查：判断SQL的语句类型</p>
<ul>
<li>DDL：数据定义语句</li>
<li>DCL：数据控制语句</li>
<li>DML：数据操作语句</li>
<li>DQL：数据查询语句</li>
</ul>
</li>
<li>
<p>对用户的权限进行校验，检查用户对数据库、数据表有没有操作权限</p>
</li>
<li>
<p>进行SQL的预处理，生成解析树（执行计划）并统计执行代价</p>
<blockquote>
<p>统计信息表：</p>
<p><code>innodb_index_stats</code></p>
<p><code>innodb_table_stats</code></p>
</blockquote>
</li>
</ul>
<hr>
<h2 id="查询优化器optimizer">
  查询优化器（Optimizer）
  <a class="anchor" href="#%e6%9f%a5%e8%af%a2%e4%bc%98%e5%8c%96%e5%99%a8optimizer">#</a>
</h2>
<hr>
<p>根据解析器生成的多种执行计划，判断并选择出最优的执行计划</p>
<p>查询优化器，SQL语句在查询之前会使用查询优化器对查询进行优化，他使用的是 “选取-投影-联接” 策略进行查询</p>
<blockquote>
<p>根据资源（CUP、IO、MEM）的损耗进行选择执行计划</p>
</blockquote>
<hr>
<h2 id="缓存器caches--buffers">
  缓存器（Caches &amp; Buffers）
  <a class="anchor" href="#%e7%bc%93%e5%ad%98%e5%99%a8caches--buffers">#</a>
</h2>
<hr>
<p>MySQL 8.0已经去掉此功能。可以使用Redis代替。</p>
<hr>
<h2 id="存储引擎pluggable-storage-engines">
  存储引擎（Pluggable Storage Engines）
  <a class="anchor" href="#%e5%ad%98%e5%82%a8%e5%bc%95%e6%93%8epluggable-storage-engines">#</a>
</h2>
<hr>
<p>负责 MySQL 中数据的存储与提取。 服务器中的查询执行引擎通过 API 与存储引擎进行通信，通过接口屏蔽了不同存储引擎之间的差异。MySQL 采用插件式的存储引擎。MySQL 为我们提供了许多存储引擎，每种存储引擎有不同的特点。我们可以根据不同的业务特点，选择最适合的存储引擎。如果对于存储引擎的性能不满意，可以通过修改源码来得到自己想要达到的性能。</p>
<p>特点：</p>
<ul>
<li>MySQL 采用插件式的存储引擎</li>
<li>存储引擎是针对于表的而不是针对库的（一个库中不同表可以使用不同的存储引擎），服务器通过 API 与存储引擎进行通信，用来屏蔽不同存储引擎之间的差异</li>
<li>不管表采用什么样的存储引擎，都会在数据区，产生对应的 <code>frm</code> 文件（表结构定义描述文件）</li>
</ul>
<hr>
<h2 id="文件系统file-system">
  文件系统（File System）
  <a class="anchor" href="#%e6%96%87%e4%bb%b6%e7%b3%bb%e7%bb%9ffile-system">#</a>
</h2>
<hr>
<p>操作系统的文件系统</p>
<hr>
<h1 id="mysql基础管理">
  MySQL基础管理
  <a class="anchor" href="#mysql%e5%9f%ba%e7%a1%80%e7%ae%a1%e7%90%86">#</a>
</h1>
<hr>
<h2 id="用户管理">
  用户管理
  <a class="anchor" href="#%e7%94%a8%e6%88%b7%e7%ae%a1%e7%90%86">#</a>
</h2>
<hr>
<ul>
<li>增</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#75715e"># 创建用户
</span><span style="color:#75715e"></span><span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">USER</span> guest<span style="color:#f92672">@</span><span style="color:#e6db74">&#39;localhost&#39;</span>;
<span style="color:#75715e"># 创建用户的同时创建密码
</span><span style="color:#75715e"></span><span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">USER</span> guest<span style="color:#f92672">@</span><span style="color:#e6db74">&#39;localhost&#39;</span> <span style="color:#66d9ef">IDENTIFIED</span> <span style="color:#66d9ef">BY</span> <span style="color:#e6db74">&#39;123&#39;</span>;
</code></pre></div><hr>
<ul>
<li>删</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#66d9ef">DROP</span> <span style="color:#66d9ef">USER</span> guest<span style="color:#f92672">@</span><span style="color:#e6db74">&#39;localhost&#39;</span>;
</code></pre></div><hr>
<ul>
<li>改</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#66d9ef">ALTER</span> <span style="color:#66d9ef">USER</span> guest<span style="color:#f92672">@</span><span style="color:#e6db74">&#39;localhost&#39;</span> <span style="color:#66d9ef">IDENTIFIED</span> <span style="color:#66d9ef">BY</span> <span style="color:#e6db74">&#39;123&#39;</span>;
</code></pre></div><hr>
<ul>
<li>查</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#66d9ef">SELECT</span> Host, <span style="color:#66d9ef">User</span>, authentication_string <span style="color:#66d9ef">FROM</span> mysql.<span style="color:#66d9ef">user</span>;
</code></pre></div><hr>
<h2 id="用户授权">
  用户授权
  <a class="anchor" href="#%e7%94%a8%e6%88%b7%e6%8e%88%e6%9d%83">#</a>
</h2>
<hr>
<h3 id="查看系统权限">
  查看系统权限
  <a class="anchor" href="#%e6%9f%a5%e7%9c%8b%e7%b3%bb%e7%bb%9f%e6%9d%83%e9%99%90">#</a>
</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#66d9ef">SHOW</span> <span style="color:#66d9ef">PRIVILEGES</span>;
</code></pre></div><hr>
<h3 id="对用户授权">
  对用户授权
  <a class="anchor" href="#%e5%af%b9%e7%94%a8%e6%88%b7%e6%8e%88%e6%9d%83">#</a>
</h3>
<blockquote>
<p>MySQL 8.0开始必须先创建用户，才能对用户进行授权</p>
<p>MySQL授权表：</p>
<p><code>user</code>：存放全局实例级别权限的用户信息</p>
<p><code>db</code>：存放数据库级别权限的用户信息</p>
<p><code>tables_priv</code>：存放表级别权限的用户信息</p>
<p><code>columns_priv</code>：存放字段级别权限的用户信息</p>
<p><code>procs_priv</code>：存放存储过程权限的用户信息</p>
</blockquote>
<ul>
<li>语法</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#66d9ef">GRANT</span> <span style="color:#960050;background-color:#1e0010">权限</span> <span style="color:#66d9ef">ON</span> <span style="color:#960050;background-color:#1e0010">数据库</span>.<span style="color:#960050;background-color:#1e0010">表</span> <span style="color:#66d9ef">TO</span> <span style="color:#e6db74">&#39;用户名&#39;</span><span style="color:#f92672">@</span><span style="color:#e6db74">&#39;IP地址&#39;</span>;
</code></pre></div><ul>
<li>给用户授权db数据库的查询、插入和更改的权限</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#66d9ef">GRANT</span> <span style="color:#66d9ef">SELECT</span>,<span style="color:#66d9ef">INSERT</span>,<span style="color:#66d9ef">UPDATE</span> <span style="color:#66d9ef">ON</span> db.<span style="color:#f92672">*</span> <span style="color:#66d9ef">TO</span> <span style="color:#e6db74">&#39;用户名&#39;</span><span style="color:#f92672">@</span><span style="color:#e6db74">&#39;%&#39;</span>;
</code></pre></div><ul>
<li>给用户授予除grant权限外的所有权限</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#66d9ef">GRANT</span> <span style="color:#66d9ef">ALL</span> <span style="color:#66d9ef">PRIVILEGES</span> <span style="color:#66d9ef">ON</span> <span style="color:#f92672">*</span>.<span style="color:#f92672">*</span> <span style="color:#66d9ef">TO</span> <span style="color:#e6db74">&#39;用户名&#39;</span><span style="color:#f92672">@</span><span style="color:#e6db74">&#39;%&#39;</span>;
</code></pre></div><blockquote>
<p>权限中的<code>ALL</code>表示除<code>GRANT</code>权限之外的所有权限</p>
</blockquote>
<ul>
<li>给用户授予所有权限</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#66d9ef">GRANT</span> <span style="color:#66d9ef">ALL</span> <span style="color:#66d9ef">PRIVILEGES</span> <span style="color:#66d9ef">ON</span> <span style="color:#f92672">*</span>.<span style="color:#f92672">*</span> <span style="color:#66d9ef">TO</span> root<span style="color:#f92672">@</span><span style="color:#e6db74">&#39;%&#39;</span> <span style="color:#66d9ef">WITH</span> <span style="color:#66d9ef">GRANT</span> <span style="color:#66d9ef">OPTION</span>;
</code></pre></div><ul>
<li>查看授权</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#66d9ef">SHOW</span> GRANTS <span style="color:#66d9ef">FOR</span> <span style="color:#e6db74">&#39;用户名&#39;</span><span style="color:#f92672">@</span><span style="color:#e6db74">&#39;IP地址&#39;</span>;
</code></pre></div><ul>
<li>回收授权</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-MYSQL" data-lang="MYSQL"><span style="color:#66d9ef">REVOKE</span> <span style="color:#960050;background-color:#1e0010">权限</span> <span style="color:#66d9ef">ON</span> <span style="color:#960050;background-color:#1e0010">数据库</span>.<span style="color:#960050;background-color:#1e0010">表</span> <span style="color:#66d9ef">FROM</span> <span style="color:#e6db74">&#39;用户名&#39;</span><span style="color:#f92672">@</span><span style="color:#e6db74">&#39;IP地址&#39;</span>;
</code></pre></div><ul>
<li>刷新权限</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#66d9ef">FLUSH</span> <span style="color:#66d9ef">PRIVILEGES</span>;
</code></pre></div><hr>
<h3 id="破解管理员密码">
  破解管理员密码
  <a class="anchor" href="#%e7%a0%b4%e8%a7%a3%e7%ae%a1%e7%90%86%e5%91%98%e5%af%86%e7%a0%81">#</a>
</h3>
<ul>
<li>先关闭mysqld服务</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$&gt; /etc/init.d/mysqld stop
</code></pre></div><ul>
<li>使用安全模式启动</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$&gt; mysqld_safe --skip-grant-tables --skip-networking &amp;      <span style="color:#75715e"># 跳过授权表并跳过TCP/IP连接</span>
</code></pre></div><blockquote>
<p><code>service mysqld start --skip-grant-tables --skip-networking</code> 也可以跳过密码登陆</p>
</blockquote>
<ul>
<li>客户端直接以无密码的方式登录root用户</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$&gt; mysql -u root -p
</code></pre></div><ul>
<li>修改密码</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#66d9ef">FLUSH</span> <span style="color:#66d9ef">PRIVILEGES</span>;      <span style="color:#75715e"># 手动加载授权
</span><span style="color:#75715e"></span><span style="color:#66d9ef">ALTER</span> <span style="color:#66d9ef">USER</span> root<span style="color:#f92672">@</span><span style="color:#e6db74">&#39;localhost&#39;</span> INDENTIFIED <span style="color:#66d9ef">BY</span> <span style="color:#e6db74">&#39;123&#39;</span>;     <span style="color:#75715e"># 修改root用户密码为123
</span></code></pre></div><ul>
<li>用户权限相关数据保存在MySQL数据库的<code>user</code>表中，可以直接对其操作（不建议）</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#66d9ef">UPDATE</span> mysql.<span style="color:#66d9ef">user</span> <span style="color:#66d9ef">SET</span> PASSWORD<span style="color:#f92672">=</span><span style="color:#a6e22e">password</span>(<span style="color:#e6db74">&#34;123&#34;</span>) <span style="color:#66d9ef">WHERE</span> <span style="color:#66d9ef">USER</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;root&#34;</span> <span style="color:#66d9ef">AND</span> host<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;localhost&#34;</span>;
<span style="color:#66d9ef">FLUSH</span> <span style="color:#66d9ef">PRIVILEGES</span>;
</code></pre></div><ul>
<li>重启数据到正常模式</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$&gt; service mysqld restart
</code></pre></div><ul>
<li>在Windows命令行中用taskkill杀死mysqld服务，然后正常启动mysqld</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$&gt; tasklist | findstr mysqld
$&gt; taskkill /F /PID 进程号
</code></pre></div><hr>
<h2 id="连接管理">
  连接管理
  <a class="anchor" href="#%e8%bf%9e%e6%8e%a5%e7%ae%a1%e7%90%86">#</a>
</h2>
<hr>
<blockquote>
<p>MySQL 8.0以后的版本，必须提前创建好用户，才可以进行远程连接</p>
</blockquote>
<hr>
<h3 id="本地连接">
  本地连接
  <a class="anchor" href="#%e6%9c%ac%e5%9c%b0%e8%bf%9e%e6%8e%a5">#</a>
</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$&gt; mysql -h /temp/mysql.sock -P <span style="color:#ae81ff">3306</span> -u root -p
</code></pre></div><hr>
<h3 id="远程连接">
  远程连接
  <a class="anchor" href="#%e8%bf%9c%e7%a8%8b%e8%bf%9e%e6%8e%a5">#</a>
</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$&gt; mysql -h 127.0.0.1 -P <span style="color:#ae81ff">3306</span> -u root -p
</code></pre></div><hr>
<h3 id="免交互执行sql语句">
  免交互执行SQL语句
  <a class="anchor" href="#%e5%85%8d%e4%ba%a4%e4%ba%92%e6%89%a7%e8%a1%8csql%e8%af%ad%e5%8f%a5">#</a>
</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$&gt; mysql -h 127.0.0.1 -P <span style="color:#ae81ff">3306</span> -u root -p123456 -e <span style="color:#e6db74">&#34;SELECT * FROM mysql.user&#34;</span>
</code></pre></div><hr>
<h1 id="mysql多实例">
  MySQL多实例
  <a class="anchor" href="#mysql%e5%a4%9a%e5%ae%9e%e4%be%8b">#</a>
</h1>
<hr>
<p>简而言之，MySQL的多实例就是在一台服务器上启动多个MySQL服务，由于MySQL是单进程多线程的方式运行，因此，也可以说MySQL的多实例是在一台服务器上启动多个MySQL进程</p>
<hr>
<h2 id="相同mysql版本的多实例">
  相同MySQL版本的多实例
  <a class="anchor" href="#%e7%9b%b8%e5%90%8cmysql%e7%89%88%e6%9c%ac%e7%9a%84%e5%a4%9a%e5%ae%9e%e4%be%8b">#</a>
</h2>
<hr>
<h3 id="规划">
  规划
  <a class="anchor" href="#%e8%a7%84%e5%88%92">#</a>
</h3>
<p>在同一台服务器上启动两个实例</p>
<ul>
<li>端口： <code>33061</code> 、 <code>33062</code></li>
<li>server_id： <code>1</code> 、 <code>2</code></li>
<li>数据目录： <code>/opt/mysql/33061/data</code>  、 <code>/opt/mysql/33062/data</code></li>
<li>日志目录： <code>/opt/mysql/33061/binlog</code> 、 <code>/opt/mysql/33062/binlog</code></li>
<li>配置文件： <code>/opt/mysql/33061/my.cnf</code> 、  <code>/opt/mysql/33062/my.cnf</code></li>
<li>socket文件： <code>/tmp/mysql_33061.socket</code> 、<code>/tmp/mysql_33062.socket</code></li>
</ul>
<hr>
<h3 id="配置过程">
  配置过程
  <a class="anchor" href="#%e9%85%8d%e7%bd%ae%e8%bf%87%e7%a8%8b">#</a>
</h3>
<ul>
<li>创建数据目录</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$&gt; mkdir -p /opt/mysql/33061/data /opt/mysql/33061/data
</code></pre></div><ul>
<li>创建日志目录</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$&gt; mkdir -p /opt/mysql/33061/binlog /opt/mysql/33062/binlog
</code></pre></div><ul>
<li>变更目录的属主属组</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$&gt; chown mysql:mysql -R /opt/mysql
</code></pre></div><ul>
<li>创建配置文件</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$&gt; vim /opt/mysql/33061/my.cnf
<span style="color:#75715e"># 添加以下内容</span>

<span style="color:#f92672">[</span>mysqld<span style="color:#f92672">]</span>                                     <span style="color:#75715e"># 服务器端标签</span>
user<span style="color:#f92672">=</span>mysql                                   <span style="color:#75715e"># 负责管理数据库的用户</span>
basedir<span style="color:#f92672">=</span>/usr/local/mysql                     <span style="color:#75715e"># 软件的安装位置</span>
datadir<span style="color:#f92672">=</span>/opt/mysql/33061/data                <span style="color:#75715e"># 数据的存放位置</span>
log_error<span style="color:#f92672">=</span>/opt/mysql/33061/binlog/mysql.log  <span style="color:#75715e"># 错误日志的存放路径</span>
log_bin<span style="color:#f92672">=</span>/opt/mysql/33061/binlog/mysql-bin    <span style="color:#75715e"># 二进制日志的存放路径</span>
sync_binlog<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>                                <span style="color:#75715e"># binlog日志落盘策略，含义为：每次事务提交，立即将binlog落盘，双一中的第二个一</span>
binlog_format<span style="color:#f92672">=</span>row                            <span style="color:#75715e"># binlog日志记录格式为row</span>
server_id<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>                                  <span style="color:#75715e"># 表示节点的唯一编号（主从复制的时候需要用到，单机下无用）</span>
port<span style="color:#f92672">=</span><span style="color:#ae81ff">33061</span>                                   <span style="color:#75715e"># 端口号</span>
socket<span style="color:#f92672">=</span>/tmp/mysql_33061.sock                 <span style="color:#75715e"># 套接字文件</span>

<span style="color:#f92672">[</span>mysql<span style="color:#f92672">]</span>                                      <span style="color:#75715e"># 客户端标签</span>
socket<span style="color:#f92672">=</span>/tmp/mysql_33061.sock                 <span style="color:#75715e"># 客户端读取套接字文件的路径（多实例时不要写这个）</span>
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$&gt; vim /opt/mysql/33062/my.cnf
<span style="color:#75715e"># 添加以下内容</span>

<span style="color:#f92672">[</span>mysqld<span style="color:#f92672">]</span>                                     <span style="color:#75715e"># 服务器端标签</span>
user<span style="color:#f92672">=</span>mysql                                   <span style="color:#75715e"># 负责管理数据库的用户</span>
basedir<span style="color:#f92672">=</span>/usr/local/mysql                     <span style="color:#75715e"># 软件的安装位置</span>
datadir<span style="color:#f92672">=</span>/opt/mysql/33061/data                <span style="color:#75715e"># 数据的存放位置</span>
log_error<span style="color:#f92672">=</span>/opt/mysql/33061/binlog/mysql.log  <span style="color:#75715e"># 错误日志的存放路径</span>
log_bin<span style="color:#f92672">=</span>/opt/mysql/33061/binlog/mysql-bin    <span style="color:#75715e"># 二进制日志的存放路径</span>
sync_binlog<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>                                <span style="color:#75715e"># binlog日志落盘策略，含义为：每次事务提交，立即将binlog落盘，双一中的第二个一</span>
binlog_format<span style="color:#f92672">=</span>row                            <span style="color:#75715e"># binlog日志记录格式为row</span>
server_id<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>                                  <span style="color:#75715e"># 表示节点的唯一编号（主从复制的时候需要用到，单机下无用）</span>
port<span style="color:#f92672">=</span><span style="color:#ae81ff">33061</span>                                   <span style="color:#75715e"># 端口号</span>
socket<span style="color:#f92672">=</span>/tmp/mysql_33062.sock                 <span style="color:#75715e"># 套接字文件</span>

<span style="color:#f92672">[</span>mysql<span style="color:#f92672">]</span>                                      <span style="color:#75715e"># 客户端标签</span>
socket<span style="color:#f92672">=</span>/tmp/mysql_33062.sock                 <span style="color:#75715e"># 客户端读取套接字文件的路径（多实例时不要写这个）</span>
</code></pre></div><ul>
<li>跳过<code>/etc/my.cnf</code>文件的读取</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$&gt; mv /etc/my.cnf /etc/my.cnf.bak
</code></pre></div><ul>
<li>初始化数据</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$&gt; cd /usr/local/bin
mysqld --initialize-insecure --user<span style="color:#f92672">=</span>mysql --basedir<span style="color:#f92672">=</span>/usr/local/mysql --datadir<span style="color:#f92672">=</span>/opt/mysql/33061/data
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$&gt; cd /usr/local/bin
mysqld --initialize-insecure --user<span style="color:#f92672">=</span>mysql --basedir<span style="color:#f92672">=</span>/usr/local/mysql --datadir<span style="color:#f92672">=</span>/opt/mysql/33062/data
</code></pre></div><ul>
<li>
<p>准备启动脚本</p>
<blockquote>
<p>
  <a href="https://dev.mysql.com/doc/refman/8.0/en/using-systemd.html">MySQL :: MySQL 8.0 Reference Manual :: 2.5.9 Managing MySQL Server with systemd</a></p>
</blockquote>
</li>
</ul>
<hr>
<h1 id="mysql基础语句">
  MySQL基础语句
  <a class="anchor" href="#mysql%e5%9f%ba%e7%a1%80%e8%af%ad%e5%8f%a5">#</a>
</h1>
<hr>
<p>MySQL开发规范：
  <a href="https://www.sqlstyle.guide/zh/">SQL样式指南 · SQL style guide by Simon Holywell</a></p>
<p>客户端命令帮助信息：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql">help
</code></pre></div><p>服务器端命令分类信息：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql">help contents
</code></pre></div><hr>
<h2 id="mysql语言结构">
  MySQL语言结构
  <a class="anchor" href="#mysql%e8%af%ad%e8%a8%80%e7%bb%93%e6%9e%84">#</a>
</h2>
<hr>
<blockquote>
<p>MySQL官网对于语言结构的介绍：https://dev.mysql.com/doc/refman/8.0/en/language-structure.html</p>
</blockquote>
<hr>
<h2 id="mysql中字符集和排序规则">
  MySQL中字符集和排序规则
  <a class="anchor" href="#mysql%e4%b8%ad%e5%ad%97%e7%ac%a6%e9%9b%86%e5%92%8c%e6%8e%92%e5%ba%8f%e8%a7%84%e5%88%99">#</a>
</h2>
<hr>
<p><code>sql_mode</code>：SQL模式，用于规范SQL语句的书写方式，使SQL语句不能违背现实常识的一种约束，例如：数学运算中除数不能为0，日期中的0年0月0日等写法</p>
<p><code>charset</code> ：字符集，影响数据是否能正常显示，MySQL 5.7以后默认使用<code>utf8mb4</code></p>
<p><code>collation</code>：校对（排序）规则，影响到数据的排序规则，在数据库中查询字符ASCII的命令：<code>SELECT ASCII('字符');</code></p>
<blockquote>
<p>MySQL官网对于字符集和校对的介绍：https://dev.mysql.com/doc/refman/8.0/en/charset.html</p>
</blockquote>
<hr>
<h2 id="mysql数据类型">
  MySQL数据类型
  <a class="anchor" href="#mysql%e6%95%b0%e6%8d%ae%e7%b1%bb%e5%9e%8b">#</a>
</h2>
<blockquote>
<p>MySQl官网对于数据类型的介绍：https://dev.mysql.com/doc/refman/8.0/en/data-types.html</p>
</blockquote>
<hr>
<h2 id="mysql约束">
  MySQL约束
  <a class="anchor" href="#mysql%e7%ba%a6%e6%9d%9f">#</a>
</h2>
<hr>
<p><code>Primary Key</code>：主键约束，要求非空且唯一，每张表只能有一个主键，用于聚簇索引。</p>
<p><code>Not Null</code>：非空约束，要求必须非空，建议将每个列都设置成非空</p>
<p><code>Unique Key</code>：唯一约束，要求唯一不能重复</p>
<p><code>Unsigned</code>：非负数约束，针对数字类型的字段，要求数字不能为负数</p>
<hr>
<h2 id="mysql数据类型默认值和注释">
  MySQL数据类型默认值和注释
  <a class="anchor" href="#mysql%e6%95%b0%e6%8d%ae%e7%b1%bb%e5%9e%8b%e9%bb%98%e8%ae%a4%e5%80%bc%e5%92%8c%e6%b3%a8%e9%87%8a">#</a>
</h2>
<hr>
<p><code>default</code>：默认值</p>
<p><code>comment</code>：注释（别名）</p>
<hr>
<h2 id="ddl数据定义语言">
  DDL：数据定义语言
  <a class="anchor" href="#ddl%e6%95%b0%e6%8d%ae%e5%ae%9a%e4%b9%89%e8%af%ad%e8%a8%80">#</a>
</h2>
<hr>
<blockquote>
<p>数据定义语言（DDL）：<code>DROP</code>、<code>CREATE</code>、<code>ALTER</code>等操作</p>
<p>在MySQL中，DDL语句在对表进行操作时，是要锁元数据表的，此时所有修改类的语句无法在此期间执行</p>
</blockquote>
<hr>
<h3 id="数据库定义">
  数据库定义
  <a class="anchor" href="#%e6%95%b0%e6%8d%ae%e5%ba%93%e5%ae%9a%e4%b9%89">#</a>
</h3>
<ul>
<li>增</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">DATABASE</span> <span style="color:#f92672">`</span><span style="color:#960050;background-color:#1e0010">数据库名称</span><span style="color:#f92672">`</span> <span style="color:#66d9ef">CHARACTER</span> <span style="color:#66d9ef">SET</span> <span style="color:#e6db74">&#39;utf8mb4&#39;</span>;
</code></pre></div><ul>
<li>
<p>删</p>
<blockquote>
<p>生产中禁止任何用户拥有数据库的删除权限</p>
</blockquote>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#66d9ef">DROP</span> <span style="color:#66d9ef">DATABASE</span> <span style="color:#960050;background-color:#1e0010">数据库名称</span>;
</code></pre></div><ul>
<li>
<p>改</p>
<blockquote>
<p>数据库不能更改名称，更改字符集时字符集一般都是从小往大改</p>
</blockquote>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#66d9ef">ALTER</span> <span style="color:#66d9ef">DATABASE</span> <span style="color:#960050;background-color:#1e0010">数据库名称</span> <span style="color:#66d9ef">CHARACTER</span> <span style="color:#66d9ef">SET</span> utf8;
</code></pre></div><ul>
<li>查</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#66d9ef">SHOW</span> <span style="color:#66d9ef">DATABASES</span>;
</code></pre></div><blockquote>
<p>查看创建数据库语句：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#66d9ef">SHOW</span> <span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">DATABASE</span> <span style="color:#960050;background-color:#1e0010">数据库名称</span>;
</code></pre></div></blockquote>
<hr>
<h3 id="数据表定义">
  数据表定义
  <a class="anchor" href="#%e6%95%b0%e6%8d%ae%e8%a1%a8%e5%ae%9a%e4%b9%89">#</a>
</h3>
<ul>
<li>
<p>增</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">TABLE</span> <span style="color:#f92672">`</span>testdb<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span>Untitled<span style="color:#f92672">`</span>  (
  <span style="color:#f92672">`</span>userid<span style="color:#f92672">`</span> <span style="color:#66d9ef">int</span> <span style="color:#66d9ef">UNSIGNED</span> <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span> <span style="color:#66d9ef">AUTO_INCREMENT</span> COMMENT <span style="color:#e6db74">&#39;用户ID&#39;</span>,
  <span style="color:#f92672">`</span>username<span style="color:#f92672">`</span> <span style="color:#66d9ef">varchar</span>(<span style="color:#ae81ff">255</span>) <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span> COMMENT <span style="color:#e6db74">&#39;用户名称&#39;</span>,
  <span style="color:#f92672">`</span>password<span style="color:#f92672">`</span> <span style="color:#66d9ef">varchar</span>(<span style="color:#ae81ff">255</span>) <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span> COMMENT <span style="color:#e6db74">&#39;用户密码&#39;</span>,
  <span style="color:#f92672">`</span>gender<span style="color:#f92672">`</span> <span style="color:#66d9ef">char</span>(<span style="color:#ae81ff">1</span>) <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span> <span style="color:#66d9ef">DEFAULT</span> <span style="color:#e6db74">&#39;男&#39;</span> COMMENT <span style="color:#e6db74">&#39;性别&#39;</span>,
  <span style="color:#f92672">`</span>age<span style="color:#f92672">`</span> <span style="color:#66d9ef">tinyint</span> <span style="color:#66d9ef">UNSIGNED</span> <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span> COMMENT <span style="color:#e6db74">&#39;年龄&#39;</span>,
  <span style="color:#66d9ef">PRIMARY</span> <span style="color:#66d9ef">KEY</span> (<span style="color:#f92672">`</span>userid<span style="color:#f92672">`</span>)
) <span style="color:#66d9ef">ENGINE</span> <span style="color:#f92672">=</span> InnoDB <span style="color:#66d9ef">CHARACTER</span> <span style="color:#66d9ef">SET</span> <span style="color:#f92672">=</span> utf8mb4;
</code></pre></div><blockquote>
<p>建表规范：</p>
<ul>
<li>使用集合名称，或在不那么理想的情况下使用复数形式。如 <code>staff</code>（建议使用）和 <code>employees</code>。</li>
<li>不要使用类似 <code>tbl</code> 或其他的描述性的前缀或匈牙利命名法。</li>
<li>表不应该同它的列同名，反之亦然。</li>
<li>尽量避免连接两个表的名字作为关系表（relationship table）的名字。与其使用 <code>cars_mechanics</code> 做表名不如使用 <code>services</code>。</li>
</ul>
<p>建列规范：</p>
<ul>
<li>总是使用单数形式。</li>
<li>避免直接使用 <code>id</code> 做表的主标识符。</li>
<li>避免列名和表名同名，反之亦然。</li>
<li>总是使用小写字母，除非是特殊情况，如专有名词。</li>
</ul>
</blockquote>
</li>
<li>
<p>删</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#66d9ef">DROP</span> <span style="color:#66d9ef">TABLE</span> <span style="color:#f92672">`</span><span style="color:#66d9ef">user</span><span style="color:#f92672">`</span>;
</code></pre></div></li>
<li>
<p>改</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#66d9ef">ALTER</span> <span style="color:#66d9ef">TABLE</span> <span style="color:#f92672">`</span>test<span style="color:#f92672">`</span>.<span style="color:#f92672">`</span><span style="color:#66d9ef">user</span><span style="color:#f92672">`</span> 
MODIFY <span style="color:#66d9ef">COLUMN</span> <span style="color:#f92672">`</span>email<span style="color:#f92672">`</span> <span style="color:#66d9ef">varchar</span>(<span style="color:#ae81ff">200</span>) <span style="color:#66d9ef">CHARACTER</span> <span style="color:#66d9ef">SET</span> utf8mb4 <span style="color:#66d9ef">COLLATE</span> utf8mb4_0900_ai_ci <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span> COMMENT <span style="color:#e6db74">&#39;电子邮箱&#39;</span> AFTER <span style="color:#f92672">`</span>city<span style="color:#f92672">`</span>;
</code></pre></div></li>
<li>
<p>查</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#66d9ef">SHOW</span> <span style="color:#66d9ef">TABLES</span>;               <span style="color:#75715e">-- 查看数据库中有哪些表
</span><span style="color:#75715e"></span><span style="color:#66d9ef">DESC</span> <span style="color:#f92672">`</span><span style="color:#66d9ef">user</span><span style="color:#f92672">`</span>;               <span style="color:#75715e">-- 查看user表中有哪些字段（表结构）
</span><span style="color:#75715e"></span><span style="color:#66d9ef">SHOW</span> <span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">TABLE</span> <span style="color:#f92672">`</span><span style="color:#66d9ef">user</span><span style="color:#f92672">`</span>;  <span style="color:#75715e">-- 查看创建user表时的SQL语句
</span></code></pre></div></li>
</ul>
<hr>
<h2 id="dcl数据控制语言">
  DCL：数据控制语言
  <a class="anchor" href="#dcl%e6%95%b0%e6%8d%ae%e6%8e%a7%e5%88%b6%e8%af%ad%e8%a8%80">#</a>
</h2>
<hr>
<blockquote>
<p>数据控制语言（DCL）：<code>GRANT</code>、<code>REVOKE</code>、<code>COMMIT</code>、<code>ROLLBACK</code>语句。</p>
</blockquote>
<hr>
<h2 id="dml数据操作语言">
  DML：数据操作语言
  <a class="anchor" href="#dml%e6%95%b0%e6%8d%ae%e6%93%8d%e4%bd%9c%e8%af%ad%e8%a8%80">#</a>
</h2>
<hr>
<blockquote>
<p>数据库操作语言（DML）：<code>INSERT</code>、<code>UPDATE</code>、<code>DELETE</code>语句。</p>
<p>DML主要针对数据表中的<strong>数据行</strong>进行增、删、改、查的操作</p>
</blockquote>
<hr>
<ul>
<li>
<p>插入数据（<code>INSERT</code>）</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#75715e"># 查看表结构
</span><span style="color:#75715e"></span><span style="color:#66d9ef">DESC</span> <span style="color:#960050;background-color:#1e0010">表名称</span>
<span style="color:#75715e"># 标准insert语句
</span><span style="color:#75715e"></span><span style="color:#66d9ef">INSERT</span> <span style="color:#66d9ef">INTO</span> <span style="color:#960050;background-color:#1e0010">表名称</span>(<span style="color:#960050;background-color:#1e0010">字段</span><span style="color:#ae81ff">1</span>, <span style="color:#960050;background-color:#1e0010">字段</span><span style="color:#ae81ff">2</span>, <span style="color:#960050;background-color:#1e0010">字段</span><span style="color:#ae81ff">3</span>, ......) <span style="color:#66d9ef">VALUES</span>(<span style="color:#960050;background-color:#1e0010">值</span><span style="color:#ae81ff">1</span>, <span style="color:#960050;background-color:#1e0010">值</span><span style="color:#ae81ff">2</span>, <span style="color:#960050;background-color:#1e0010">值</span><span style="color:#ae81ff">3</span>, ......);
</code></pre></div><blockquote>
<p>具有自增或默认值的字段可以不录入</p>
</blockquote>
</li>
<li>
<p>更新数据（<code>UPDATE</code>）</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#66d9ef">UPDATE</span> <span style="color:#960050;background-color:#1e0010">表名称</span> <span style="color:#66d9ef">SET</span> <span style="color:#960050;background-color:#1e0010">字段名称</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#39;需要更新后的值&#39;</span> <span style="color:#66d9ef">WHERE</span> <span style="color:#960050;background-color:#1e0010">条件</span>;
</code></pre></div><blockquote>
<p>必须要明确修改哪些行的数据，一般<code>update</code>语句都会跟随<code>where</code>条件</p>
</blockquote>
</li>
<li>
<p>删除数据（<code>DELETE</code>）</p>
<blockquote>
<p>必须要明确删除哪些行的数据，一般<code>delete</code>语句都会跟随<code>where</code>条件</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#66d9ef">DELETE</span> <span style="color:#66d9ef">FROM</span> <span style="color:#960050;background-color:#1e0010">表名称</span> <span style="color:#66d9ef">WHERE</span> <span style="color:#960050;background-color:#1e0010">条件</span>;
</code></pre></div><blockquote>
<p>扩展：</p>
<ol>
<li>伪删除：修改表结构，加入状态列，例如：状态<code>0</code>为存在，状态<code>1</code>为删除，需要删除数据的时候，更改数据状态</li>
<li><code>delete</code>、<code>drop table</code>、<code>truncate table</code> 都可以将全表的数据删除，区别在于：
<ul>
<li><code>delete</code>是逐行删除，属于逻辑性操作，并不会真正从磁盘上删除数据，只是在存储层面打上标记，磁盘空间不会立即释放，自增的HWM（高水位线）不会降低，数据行多的话，这条语句非常慢；</li>
<li><code>drop table</code>将表结构（元数据）和物理层面的数据行进行删除；恢复数据只能靠备份；</li>
<li><code>truncate table</code>清空表段中的所有数据页，属于物理层面的删除，磁盘空间会立即释放，自增的HWM（高水位线）会降低。</li>
</ul>
</li>
</ol>
</blockquote>
</li>
</ul>
<hr>
<h2 id="dql数据查询语言">
  DQL：数据查询语言
  <a class="anchor" href="#dql%e6%95%b0%e6%8d%ae%e6%9f%a5%e8%af%a2%e8%af%ad%e8%a8%80">#</a>
</h2>
<hr>
<blockquote>
<p>数据查询语句（DQL）：<code>SELECT</code>语句。</p>
<p>从官方来讲，查询语句属于DML，但由于查询语句非常重要，所以单独归类为DQL</p>
</blockquote>
<hr>
<h3 id="select">
  SELECT
  <a class="anchor" href="#select">#</a>
</h3>
<blockquote>
<p>获取数据表中的数据行</p>
</blockquote>
<ul>
<li>
<p>SELECT配合内置函数单独查询（MySQL独有的方式）</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#75715e"># 通过内置函数查看MySQL版本
</span><span style="color:#75715e"></span><span style="color:#66d9ef">SELECT</span> <span style="color:#a6e22e">version</span>();

<span style="color:#75715e"># 通过内置函数查看当前使用的表
</span><span style="color:#75715e"></span><span style="color:#66d9ef">SELECT</span> <span style="color:#66d9ef">database</span>();

<span style="color:#75715e"># 通过内置函数查看当前登录的用户
</span><span style="color:#75715e"></span><span style="color:#66d9ef">SELECT</span> <span style="color:#66d9ef">user</span>();

<span style="color:#75715e"># 通过内置函数查看当前时间
</span><span style="color:#75715e"></span><span style="color:#66d9ef">SELECT</span> <span style="color:#a6e22e">now</span>();

<span style="color:#75715e"># 通过内置函数进行字符串拼接
</span><span style="color:#75715e"></span><span style="color:#66d9ef">SELECT</span> <span style="color:#a6e22e">concat</span>();
</code></pre></div><blockquote>
<p>通过 <code>help contents;</code> &mdash;&gt; <code>help Function;</code> 查看MySQL内置函数</p>
</blockquote>
</li>
<li>
<p>SELECT用于计算（MySQL独有的方式）</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#66d9ef">SELECT</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">+</span><span style="color:#ae81ff">2</span>;
</code></pre></div></li>
<li>
<p>SELECT查询数据库的参数（MySQL独有的方式）</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#75715e"># 查询数据库端口
</span><span style="color:#75715e"></span><span style="color:#66d9ef">SELECT</span> <span style="color:#f92672">@@</span>port;

<span style="color:#75715e"># 查询数据存储路径
</span><span style="color:#75715e"></span><span style="color:#66d9ef">SELECT</span> <span style="color:#f92672">@@</span>datadir;
</code></pre></div></li>
</ul>
<hr>
<h3 id="show">
  SHOW
  <a class="anchor" href="#show">#</a>
</h3>
<blockquote>
<p><code>SHOW variables;</code>：查看所有数据库参数</p>
</blockquote>
<hr>
<h3 id="union和union-all">
  UNION和UNION ALL
  <a class="anchor" href="#union%e5%92%8cunion-all">#</a>
</h3>
<blockquote>
<p><code>UNION</code>：对两个结果集进行并集操作，不包括重复行，同时进行默认规则的排序。</p>
<p><code>UNION All</code>：对两个结果集进行并集操作，包括重复行，不进行排序。</p>
</blockquote>
<hr>
<h1 id="mysql索引">
  MySQL索引
  <a class="anchor" href="#mysql%e7%b4%a2%e5%bc%95">#</a>
</h1>
<hr>
<blockquote>
<p>索引提供了类似于书中目录的作用，目的是为了优化查询，索引并不是越多越好，索引过多时，索引的频繁更新会导致业务阻塞，并且还会导致优化器选择偏差。因此，需要分析业务语句创建核实的索引。</p>
<p>那些经常、高频次出现在<code>WHERE</code>、<code>GROUP BY</code>、<code>ORDER BY</code>、<code>JOIN ON</code>语句后面的字段比较适合作为索引。</p>
<p>MySQL中索引的算法：</p>
<ul>
<li>B树索引</li>
<li>Hash索引</li>
<li>R树</li>
<li>Full text</li>
<li>GIS</li>
</ul>
</blockquote>
<hr>
<h2 id="主键索引">
  主键索引
  <a class="anchor" href="#%e4%b8%bb%e9%94%ae%e7%b4%a2%e5%bc%95">#</a>
</h2>
<hr>
<blockquote>
<p>InnoDB主键索引又称为聚簇索引，它不是一种单独的索引类型，而是一种数据存储方式。比如，InnoDB的聚簇索引使用B+Tree的数据结构<strong>有序的</strong>存储索引和数据。当表有聚簇索引时，它的数据行实际上存放在索引的叶子页(leaf page)中。因为无法同时把数据行存放在两个不同的地方，所以一个表只能有一个聚簇索引（不过，覆盖索引可以模拟多个聚簇索引的情况）。</p>
<p>增、删、改数据表时，主键索引会立即更新。</p>
</blockquote>
<p>生成聚簇索引的条件：</p>
<ul>
<li>表中设置了主键,主键列就会自动被作为聚集索引</li>
<li>如果没有主键，会选择唯一键作为聚簇索引</li>
<li>聚簇索引必须在建表时才有意义,一般是表的无关列(ID)</li>
</ul>
<p>查询表的索引</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#66d9ef">DESC</span> <span style="color:#960050;background-color:#1e0010">数据表名称</span>;
<span style="color:#75715e"># PRI表示主键索引、MUL表示辅助索引、UNI表示唯一索引
</span></code></pre></div><p>显示索引信息</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#66d9ef">SHOW</span> <span style="color:#66d9ef">INDEX</span> <span style="color:#66d9ef">FROM</span> <span style="color:#960050;background-color:#1e0010">数据表名称</span>;
</code></pre></div><hr>
<h2 id="辅助索引">
  辅助索引
  <a class="anchor" href="#%e8%be%85%e5%8a%a9%e7%b4%a2%e5%bc%95">#</a>
</h2>
<hr>
<blockquote>
<p>辅助索引又分为：普通索引、联合索引、前缀索引、唯一索引。</p>
<p>在InnoDB中增、删、改数据表时，辅助索引不会立即更新，而是将要更新的索引内容放到<code>Change Buffer</code>中，在查询到<code>Change Buffer</code>时，会将<code>changebuffer</code>的索引与内存中的索引进行<code>merge</code>（合并）操作，然后将<code>merge</code>后的索引进行落盘。</p>
</blockquote>
<hr>
<h3 id="普通索引">
  普通索引
  <a class="anchor" href="#%e6%99%ae%e9%80%9a%e7%b4%a2%e5%bc%95">#</a>
</h3>
<blockquote>
<p>以单个字段生成的索引</p>
</blockquote>
<p>创建普通索引命令</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#66d9ef">ALTER</span> <span style="color:#66d9ef">TABLE</span> <span style="color:#f92672">`</span><span style="color:#960050;background-color:#1e0010">数据库名称</span><span style="color:#f92672">`</span>.<span style="color:#f92672">`</span><span style="color:#960050;background-color:#1e0010">数据表名称</span><span style="color:#f92672">`</span> <span style="color:#66d9ef">ADD</span> <span style="color:#66d9ef">INDEX</span> <span style="color:#f92672">`</span><span style="color:#960050;background-color:#1e0010">索引名称</span><span style="color:#f92672">`</span>(<span style="color:#f92672">`</span><span style="color:#960050;background-color:#1e0010">字段名称</span><span style="color:#f92672">`</span>) <span style="color:#66d9ef">USING</span> BTREE COMMENT <span style="color:#e6db74">&#39;索引注释&#39;</span>;
</code></pre></div><p>删除索引命令</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#66d9ef">ALTER</span> <span style="color:#66d9ef">TABLE</span> <span style="color:#f92672">`</span><span style="color:#960050;background-color:#1e0010">数据库名称</span><span style="color:#f92672">`</span>.<span style="color:#f92672">`</span><span style="color:#960050;background-color:#1e0010">数据表名称</span><span style="color:#f92672">`</span> <span style="color:#66d9ef">DROP</span> <span style="color:#66d9ef">INDEX</span> <span style="color:#f92672">`</span><span style="color:#960050;background-color:#1e0010">索引名称</span><span style="color:#f92672">`</span>;
</code></pre></div><hr>
<h3 id="联合索引">
  联合索引
  <a class="anchor" href="#%e8%81%94%e5%90%88%e7%b4%a2%e5%bc%95">#</a>
</h3>
<blockquote>
<p>以多个字段生成的索引。联合索引注意最左原则。建立联合索引时需要选择重复值最少的字段作为最左列。</p>
</blockquote>
<p>创建联合索引命令</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#66d9ef">ALTER</span> <span style="color:#66d9ef">TABLE</span> <span style="color:#f92672">`</span><span style="color:#960050;background-color:#1e0010">数据库名称</span><span style="color:#f92672">`</span>.<span style="color:#f92672">`</span><span style="color:#960050;background-color:#1e0010">数据表名称</span><span style="color:#f92672">`</span> <span style="color:#66d9ef">ADD</span> <span style="color:#66d9ef">INDEX</span> <span style="color:#f92672">`</span><span style="color:#960050;background-color:#1e0010">索引名称</span><span style="color:#f92672">`</span>(<span style="color:#f92672">`</span><span style="color:#960050;background-color:#1e0010">字段名称</span><span style="color:#ae81ff">1</span><span style="color:#f92672">`</span>, <span style="color:#f92672">`</span><span style="color:#960050;background-color:#1e0010">字段名称</span><span style="color:#ae81ff">2</span><span style="color:#f92672">`</span>) <span style="color:#66d9ef">USING</span> BTREE COMMENT <span style="color:#e6db74">&#39;索引名称注释&#39;</span>;
</code></pre></div><p>删除联合索引命令</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#66d9ef">ALTER</span> <span style="color:#66d9ef">TABLE</span> <span style="color:#f92672">`</span><span style="color:#960050;background-color:#1e0010">数据库名称</span><span style="color:#f92672">`</span>.<span style="color:#f92672">`</span><span style="color:#960050;background-color:#1e0010">数据表名称</span><span style="color:#f92672">`</span> <span style="color:#66d9ef">DROP</span> <span style="color:#66d9ef">INDEX</span> <span style="color:#f92672">`</span><span style="color:#960050;background-color:#1e0010">索引名称</span><span style="color:#f92672">`</span>;
</code></pre></div><hr>
<h3 id="前缀索引">
  前缀索引
  <a class="anchor" href="#%e5%89%8d%e7%bc%80%e7%b4%a2%e5%bc%95">#</a>
</h3>
<blockquote>
<p>通过索引开始的部分字符，提高索引效率且可以节约索引空间，但会降低索引的选择性(选择性:不重复的索引值和数据表的记录总数)，索引选择性越高则查询效率越高。</p>
</blockquote>
<p>创建前缀索引命令</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#66d9ef">ALTER</span> <span style="color:#66d9ef">TABLE</span> <span style="color:#f92672">`</span><span style="color:#960050;background-color:#1e0010">数据库名称</span><span style="color:#f92672">`</span>.<span style="color:#f92672">`</span><span style="color:#960050;background-color:#1e0010">数据表名称</span><span style="color:#f92672">`</span> <span style="color:#66d9ef">ADD</span> <span style="color:#66d9ef">INDEX</span> <span style="color:#f92672">`</span><span style="color:#960050;background-color:#1e0010">索引名称</span><span style="color:#f92672">`</span>(<span style="color:#f92672">`</span><span style="color:#960050;background-color:#1e0010">字段名称</span><span style="color:#f92672">`</span>(<span style="color:#ae81ff">6</span>)) <span style="color:#66d9ef">USING</span> BTREE COMMENT <span style="color:#e6db74">&#39;索引注释&#39;</span>;
</code></pre></div><p>删除前缀索引命令</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#66d9ef">ALTER</span> <span style="color:#66d9ef">TABLE</span> <span style="color:#f92672">`</span><span style="color:#960050;background-color:#1e0010">数据库名称</span><span style="color:#f92672">`</span>.<span style="color:#f92672">`</span><span style="color:#960050;background-color:#1e0010">数据表名称</span><span style="color:#f92672">`</span> <span style="color:#66d9ef">DROP</span> <span style="color:#66d9ef">INDEX</span> <span style="color:#f92672">`</span><span style="color:#960050;background-color:#1e0010">索引名称</span><span style="color:#f92672">`</span>;
</code></pre></div><hr>
<h3 id="唯一索引">
  唯一索引
  <a class="anchor" href="#%e5%94%af%e4%b8%80%e7%b4%a2%e5%bc%95">#</a>
</h3>
<blockquote>
<p>以具有唯一属性字段建立的索引，例如：手机号、身份证号等。</p>
</blockquote>
<p>创建前缀索引命令</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#66d9ef">ALTER</span> <span style="color:#66d9ef">TABLE</span> <span style="color:#f92672">`</span><span style="color:#960050;background-color:#1e0010">数据库名称</span><span style="color:#f92672">`</span>.<span style="color:#f92672">`</span><span style="color:#960050;background-color:#1e0010">数据表名称</span><span style="color:#f92672">`</span> <span style="color:#66d9ef">ADD</span> <span style="color:#66d9ef">UNIQUE</span> <span style="color:#66d9ef">INDEX</span> <span style="color:#f92672">`</span><span style="color:#960050;background-color:#1e0010">索引名称</span><span style="color:#f92672">`</span>(<span style="color:#f92672">`</span><span style="color:#960050;background-color:#1e0010">字段名称</span><span style="color:#f92672">`</span>) <span style="color:#66d9ef">USING</span> BTREE COMMENT <span style="color:#e6db74">&#39;索引注释&#39;</span>;
</code></pre></div><p>删除前缀索引命令</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#66d9ef">ALTER</span> <span style="color:#66d9ef">TABLE</span> <span style="color:#f92672">`</span><span style="color:#960050;background-color:#1e0010">数据库名称</span><span style="color:#f92672">`</span>.<span style="color:#f92672">`</span><span style="color:#960050;background-color:#1e0010">数据表名称</span><span style="color:#f92672">`</span> <span style="color:#66d9ef">DROP</span> <span style="color:#66d9ef">INDEX</span> <span style="color:#f92672">`</span><span style="color:#960050;background-color:#1e0010">索引名称</span><span style="color:#f92672">`</span>;
</code></pre></div><hr>
<h2 id="执行计划">
  执行计划
  <a class="anchor" href="#%e6%89%a7%e8%a1%8c%e8%ae%a1%e5%88%92">#</a>
</h2>
<hr>
<h3 id="查看执行计划">
  查看执行计划
  <a class="anchor" href="#%e6%9f%a5%e7%9c%8b%e6%89%a7%e8%a1%8c%e8%ae%a1%e5%88%92">#</a>
</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#66d9ef">EXPLAIN</span> <span style="color:#66d9ef">SELECT</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">FROM</span> <span style="color:#960050;background-color:#1e0010">数据库名称</span>.<span style="color:#960050;background-color:#1e0010">数据表名称</span> <span style="color:#66d9ef">WHERE</span> <span style="color:#960050;background-color:#1e0010">条件</span>;
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#66d9ef">DESC</span> <span style="color:#66d9ef">SELECT</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">FROM</span> <span style="color:#960050;background-color:#1e0010">数据库名称</span>.<span style="color:#960050;background-color:#1e0010">数据表名称</span> <span style="color:#66d9ef">WHERE</span> <span style="color:#960050;background-color:#1e0010">条件</span>;
</code></pre></div><blockquote>
<p>以上两条命令都可以查看执行计划，效果等同</p>
</blockquote>
<hr>
<h3 id="执行计划结果">
  执行计划结果
  <a class="anchor" href="#%e6%89%a7%e8%a1%8c%e8%ae%a1%e5%88%92%e7%bb%93%e6%9e%9c">#</a>
</h3>
<table>
<thead>
<tr>
<th style="text-align:center">字段名称</th>
<th style="text-align:center">含义</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">table</td>
<td style="text-align:center">此次查询涉及到的表</td>
</tr>
<tr>
<td style="text-align:center">type</td>
<td style="text-align:center">查询类型：全表扫描（all）、索引扫描（index、range、ref、eq_ref、const）</td>
</tr>
<tr>
<td style="text-align:center">possible_keys</td>
<td style="text-align:center">可能用到的索引</td>
</tr>
<tr>
<td style="text-align:center">key</td>
<td style="text-align:center">最后选择的索引</td>
</tr>
<tr>
<td style="text-align:center">key_len</td>
<td style="text-align:center">索引覆盖长度</td>
</tr>
<tr>
<td style="text-align:center">rows</td>
<td style="text-align:center">此次查询需要扫描的行数</td>
</tr>
<tr>
<td style="text-align:center">Extra</td>
<td style="text-align:center">额外的信息</td>
</tr>
</tbody>
</table>
<blockquote>
<p>索引扫描类型：<code>index</code>（全索引扫描）、<code>range</code>（索引范围扫描，例如：&lt;、&lt;=、&gt;、&gt;=、like、in、or、between and）</p>
<p>索引扫描类型的性能：<code>const</code> &gt; <code>eq_ref</code> &gt; <code>ref</code> &gt; <code>range</code> &gt; <code>index</code></p>
</blockquote>
<hr>
<h2 id="索引应用规范">
  索引应用规范
  <a class="anchor" href="#%e7%b4%a2%e5%bc%95%e5%ba%94%e7%94%a8%e8%a7%84%e8%8c%83">#</a>
</h2>
<hr>
<blockquote>
<p>为了使索引命中率更高，在创建索引时，必须考虑哪些字段上创建索引以及创建什么类型的索引</p>
</blockquote>
<hr>
<ul>
<li>
<p>建表时一定要有主键，一般是个无关列</p>
</li>
<li>
<p>选择唯一性索引（唯一性索引的值时唯一的，可以更快的通过该索引找到某条数据）</p>
<blockquote>
<p>优化方案：</p>
<ul>
<li>
<p>如果非得使用重复值较多的列作为查询条件，例如性别：男，女，可以将表逻辑拆分为“男”和“女”</p>
</li>
<li>
<p>还可以将此列和其他列作为联合索引</p>
</li>
</ul>
</blockquote>
</li>
<li>
<p>限制索引的数目</p>
<blockquote>
<p>索引的数目并不是越多越好，索引过多可能会产生以下问题：</p>
<ul>
<li>占用磁盘空间，每个索引都需要占用磁盘空间，索引越多，需要的磁盘空间越大</li>
<li>在对表进行增删改等操作时，过多的索引在更新和重构时可能会造成业务阻塞</li>
<li>过多的索引会影响到优化器的的选择</li>
</ul>
</blockquote>
</li>
<li>
<p>删除不再使用或者很少使用的索引</p>
<blockquote>
<p>percona-toolkit中有个工具，专门分析索引是否有用</p>
</blockquote>
</li>
<li>
<p>大表加索引，要在业务不繁忙的时候进行操作</p>
</li>
<li>
<p>尽量少在频繁更新的列上创建索引</p>
</li>
</ul>
<hr>
<h2 id="创建索引的原则">
  创建索引的原则
  <a class="anchor" href="#%e5%88%9b%e5%bb%ba%e7%b4%a2%e5%bc%95%e7%9a%84%e5%8e%9f%e5%88%99">#</a>
</h2>
<hr>
<ul>
<li>必须要有主键，如有没有作为主键条件的列，那么就创建一个无关列作为主键</li>
<li>高频次出现在<code>WHERE</code>、<code>GROUP BY</code>、<code>ORDER BY</code>、<code>JOIN ON</code>语句后面的字段比较适合作为索引</li>
<li>最好使用唯一值多的列作为索引，如果索引列重复值较多，可以考虑使用联合索引</li>
<li>列值较长的索引列，建议使用前缀索引</li>
<li>降低索引条目，不要创建无用的索引，清理不再使用或不常使用的索引</li>
<li>索引维护要避开业务繁忙时期</li>
</ul>
<hr>
<h2 id="导致索引失效的常见原因">
  导致索引失效的常见原因
  <a class="anchor" href="#%e5%af%bc%e8%87%b4%e7%b4%a2%e5%bc%95%e5%a4%b1%e6%95%88%e7%9a%84%e5%b8%b8%e8%a7%81%e5%8e%9f%e5%9b%a0">#</a>
</h2>
<hr>
<p>索引查询失效有以下几种情况：</p>
<ul>
<li><code>like</code>以<code>%</code>开头，索引无效；当<code>like</code>前缀没有<code>%</code>，后缀有<code>%</code>时，索引有效</li>
<li><code>or</code>语句前后条件没有同时使用索引。当<code>or</code>左右查询字段只有一个是索引，该索引失效，只有当<code>or</code>左右查询字段均为索引时，索引才会生效</li>
<li>联合索引，不是使用第一列索引，索引失效</li>
<li>数据类型出现隐式转化。如<code>varchar</code>不加单引号的话可能会自动转换为<code>int</code>型，使索引无效，产生全表扫描</li>
<li>在索引字段上使用<code>not</code>、<code>&lt;&gt;</code>、<code>!=</code>。<code>!=</code>操作符是永远不会用到索引的，对它的处理只会产生全表扫描。 优化方法： key&lt;&gt;0 改为 key&gt;0 or key&lt;0</li>
<li>对索引字段进行计算操作、字段上使用函数。（索引为 emp(ename,empno,sal)）</li>
<li>当全表扫描速度比索引速度快时，mysql会使用全表扫描，此时索引失效</li>
</ul>
<hr>
<h2 id="优化器针对索引的算法介绍">
  优化器针对索引的算法介绍
  <a class="anchor" href="#%e4%bc%98%e5%8c%96%e5%99%a8%e9%92%88%e5%af%b9%e7%b4%a2%e5%bc%95%e7%9a%84%e7%ae%97%e6%b3%95%e4%bb%8b%e7%bb%8d">#</a>
</h2>
<hr>
<h3 id="ahiadaptive-hash-index-自适应-hash-索引">
  AHI（Adaptive Hash Index） 自适应 Hash 索引
  <a class="anchor" href="#ahiadaptive-hash-index-%e8%87%aa%e9%80%82%e5%ba%94-hash-%e7%b4%a2%e5%bc%95">#</a>
</h3>
<p>MySQL的InnoDB引擎，能够创建的只有BTree索引，即使创建时选择的是Hash类型的索引，最终还是BTree。Hash索引只能创建于In-Memory Structures中。</p>
<p>AHI会自动评估内存索引的Page，生成Hash索引表，帮助InnoDB快速读取索引页，加快索引读取的速度。相当于索引的索引。</p>
<hr>
<h3 id="change-buffer">
  Change Buffer
  <a class="anchor" href="#change-buffer">#</a>
</h3>
<p>在InnoDB中增、删、改数据表时，辅助索引不会立即更新，而是将要更新的索引内容放到<code>Change Buffer</code>中，在查询到<code>Change Buffer</code>时，会将<code>Change Buffer</code>的索引与内存中的索引进行<code>merge</code>（合并）操作，然后将<code>merge</code>后的索引进行落盘。</p>
<hr>
<h3 id="icpindex-condition-pushdown索引下推">
  ICP（Index Condition Pushdown）索引下推
  <a class="anchor" href="#icpindex-condition-pushdown%e7%b4%a2%e5%bc%95%e4%b8%8b%e6%8e%a8">#</a>
</h3>
<p>在InnoDB中，筛选条件先在Server层做索引优化，未匹配到索引的筛选条件会在engine层先进行筛选，然后在筛选的结果中通过索引获取结果。</p>
<hr>
<h3 id="mrr算法">
  MRR算法
  <a class="anchor" href="#mrr%e7%ae%97%e6%b3%95">#</a>
</h3>
<p>略</p>
<hr>
<h3 id="snlj算法">
  SNLJ算法
  <a class="anchor" href="#snlj%e7%ae%97%e6%b3%95">#</a>
</h3>
<p>略</p>
<hr>
<h3 id="bnlj算法">
  BNLJ算法
  <a class="anchor" href="#bnlj%e7%ae%97%e6%b3%95">#</a>
</h3>
<p>略</p>
<hr>
<h3 id="bka算法">
  BKA算法
  <a class="anchor" href="#bka%e7%ae%97%e6%b3%95">#</a>
</h3>
<p>略</p>
<hr>
<h1 id="mysql存储引擎">
  MySQL存储引擎
  <a class="anchor" href="#mysql%e5%ad%98%e5%82%a8%e5%bc%95%e6%93%8e">#</a>
</h1>
<hr>
<p>存储引擎是数据库的核心，对于MySQL来说，存储引擎是以插件的形式运行的。通俗来说，MySQL的存储引擎相当于MySQL内置的文件系统。</p>
<ul>
<li>查看当前MySQL支持的存储引擎种类</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#66d9ef">SHOW</span> ENGINES;
</code></pre></div><ul>
<li>查看当前MySQL的默认存储引擎</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#66d9ef">SELECT</span> <span style="color:#f92672">@@</span>default_storage_engine;
</code></pre></div><ul>
<li>查看当前表的存储引擎</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#66d9ef">SHOW</span> <span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">TABLE</span> <span style="color:#e6db74">&#39;表名称&#39;</span>; 
<span style="color:#75715e"># 或
</span><span style="color:#75715e"></span><span style="color:#66d9ef">SHOW</span> <span style="color:#66d9ef">TABLE</span> STATUS <span style="color:#66d9ef">LIKE</span> <span style="color:#e6db74">&#39;表名称&#39;</span>;
</code></pre></div><ul>
<li>将当前会话的存储引擎更改为InnoDB（仅影响当前会话，生产中禁止使用这种方式）</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#66d9ef">SET</span> default_storage_engine<span style="color:#f92672">=</span>innodb;
</code></pre></div><ul>
<li>将全局会话的存储引擎更改为InnoDB（仅影响新会话，生产中禁止使用这种方式）</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#66d9ef">SET</span> GLOBAL default_storage_engine<span style="color:#f92672">=</span>innodb;
</code></pre></div><ul>
<li>修改数据表的存储引擎为Innodb</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#66d9ef">ALTER</span> <span style="color:#66d9ef">TABLE</span> <span style="color:#e6db74">&#39;表名称&#39;</span> <span style="color:#66d9ef">engine</span><span style="color:#f92672">=</span>innodb;
</code></pre></div><blockquote>
<p>注意：此命令除了有修改数据表存储引擎的功能，还有整理InnoDB表碎片的功能，因此在生产中经常用到。</p>
<p>查看数据表碎片命令</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#66d9ef">DESC</span> information_schema.<span style="color:#66d9ef">tables</span>;      <span style="color:#75715e"># 查看DATA_FREE项
</span></code></pre></div></blockquote>
<ul>
<li>生产中要变更默认存储引擎，需要修改<code>/etc/my.cnf</code>配置文件</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#f92672">[</span>mysqld<span style="color:#f92672">]</span>
default_storage_engine<span style="color:#f92672">=</span>innodb
</code></pre></div><blockquote>
<p>建议将MySQL的存储引擎设置为InnoDB，MySQL 5.1之后的版本默认存储引擎均为InnoDB。</p>
</blockquote>
<hr>
<h2 id="innodb的特性">
  InnoDB的特性
  <a class="anchor" href="#innodb%e7%9a%84%e7%89%b9%e6%80%a7">#</a>
</h2>
<blockquote>
<p>MySQL InnoDB官方介绍：
  <a href="https://dev.mysql.com/doc/refman/8.0/en/innodb-storage-engine.html">MySQL :: MySQL 8.0 Reference Manual :: 15 The InnoDB Storage Engine</a></p>
</blockquote>
<table>
<thead>
<tr>
<th style="text-align:center">功能</th>
<th style="text-align:center">是否支持</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">存储限制</td>
<td style="text-align:center">64TB</td>
</tr>
<tr>
<td style="text-align:center"><strong>MVCC</strong></td>
<td style="text-align:center"><strong>是</strong></td>
</tr>
<tr>
<td style="text-align:center">B树索引</td>
<td style="text-align:center">是</td>
</tr>
<tr>
<td style="text-align:center"><strong>群集索引（聚簇索引）</strong></td>
<td style="text-align:center">是</td>
</tr>
<tr>
<td style="text-align:center">压缩数据</td>
<td style="text-align:center">是</td>
</tr>
<tr>
<td style="text-align:center">加密数据</td>
<td style="text-align:center">是</td>
</tr>
<tr>
<td style="text-align:center"><strong>查询高速缓存</strong></td>
<td style="text-align:center">是</td>
</tr>
<tr>
<td style="text-align:center"><strong>事务</strong></td>
<td style="text-align:center"><strong>是</strong></td>
</tr>
<tr>
<td style="text-align:center"><strong>锁定粒度</strong></td>
<td style="text-align:center"><strong>是（行级）</strong></td>
</tr>
<tr>
<td style="text-align:center"><strong>外键</strong></td>
<td style="text-align:center">是</td>
</tr>
<tr>
<td style="text-align:center">文件格式管理</td>
<td style="text-align:center">是</td>
</tr>
<tr>
<td style="text-align:center"><strong>多个缓冲区池</strong></td>
<td style="text-align:center"><strong>是</strong></td>
</tr>
<tr>
<td style="text-align:center"><strong>更改缓冲（Change Buffer）</strong></td>
<td style="text-align:center"><strong>是</strong></td>
</tr>
<tr>
<td style="text-align:center">索引高速缓存</td>
<td style="text-align:center">是</td>
</tr>
<tr>
<td style="text-align:center">数据告诉缓存</td>
<td style="text-align:center">是</td>
</tr>
<tr>
<td style="text-align:center"><strong>自适应散列索引</strong></td>
<td style="text-align:center"><strong>是</strong></td>
</tr>
<tr>
<td style="text-align:center"><strong>复制</strong></td>
<td style="text-align:center"><strong>是</strong></td>
</tr>
<tr>
<td style="text-align:center"><strong>更新数据字典</strong></td>
<td style="text-align:center"><strong>是</strong></td>
</tr>
<tr>
<td style="text-align:center">地理空间数据类型</td>
<td style="text-align:center">是</td>
</tr>
<tr>
<td style="text-align:center">地理空间索引</td>
<td style="text-align:center">是</td>
</tr>
<tr>
<td style="text-align:center">全文搜索引擎</td>
<td style="text-align:center">是</td>
</tr>
<tr>
<td style="text-align:center">群集数据库</td>
<td style="text-align:center">是</td>
</tr>
<tr>
<td style="text-align:center"><strong>备份和恢复</strong></td>
<td style="text-align:center"><strong>是</strong></td>
</tr>
<tr>
<td style="text-align:center">快速索引创建</td>
<td style="text-align:center">是</td>
</tr>
<tr>
<td style="text-align:center">PERFORMANCE_SCHEMA</td>
<td style="text-align:center">是</td>
</tr>
<tr>
<td style="text-align:center"><strong>自动故障恢复</strong></td>
<td style="text-align:center"><strong>是</strong></td>
</tr>
</tbody>
</table>
<blockquote>
<p><strong>MVCC（Multi-Version Concurrency Control）</strong>：多版本并发控制，MVCC的实现，是通过保存数据在某个时间点的快照来实现的。InnoDB的MVCC是通过在每行记录后面保存2个隐藏的列来实现的，一列保存了行的创建时间，一列保存了行的过期时间(或删除时间)，但它们都存储的是系统版本号。MVCC最大的作用是:  实现了非阻塞的读操作，写操作也只锁定了必要的行。</p>
<p><strong>群集索引（Cluster Index）</strong>：又称之为聚簇索引。</p>
<p>索引体系结构分为集群或非集群。</p>
<p>集群索引是这样的索引：其在数据页面中的行的顺序对应于索引中的行的顺序。此顺序是任何表中只能存在一个集群索引的原因，而该表中可存在大量非集群索引。在某些数据库系统中，集群索引的叶节点对应于实际数据，而不是对应于指向在其他位置上找到的数据的指针。</p>
<p>集群索引和非集群索引都只包含索引结构中的键和记录标识。这些记录标识始终指向数据页面中的行。在使用集群索引的情况下，数据库管理器会尝试按照相应的键在索引页面中的顺序来将数据保存在数据页面中。因此，数据库管理器会尝试将具有相似键的行插入到相同页面上。如果对表进行了重组，那么会按照索引键的顺序将数据插入数据页面中。数据库管理器不会维护数据的任何顺序（与非集群索引的对应键的顺序相比时）。</p>
<p>重组具有所选索引的表会重新集群数据。建立了集群的索引对于带有范围谓词的列非常有用，因为它允许对表中的数据作更有效的顺序访问。因此，由于相似的值在同一数据页面上，系统会访存更少页面。</p>
<p>通常，表中只有一个索引可以具有较高的集群度。如果集群索引是唯一的，那么集群维护起来就更有效率。</p>
<p>由于集群索引使存储在页面中的数据的访问路径更线性化，因此它们可提高大多数查询操作的性能。此外，由于具有相似索引键值的行都存储在一起，因而在使用集群索引时顺序检测预取效率更高。</p>
<p>不能将集群索引指定为与 CREATE TABLE 语句配合使用的表定义的一部分。相反，只通过运行指定了 CLUSTER 选项的 CREATE INDEX 语句来创建集群索引。如果要针对主键集群表，那么 ALTER TABLE 语句必须用来在表上添加与创建的集群索引对应的主键。然后，会将此集群索引用作表的主键索引。</p>
</blockquote>
<p>看到Day8-7</p>
<hr>
<h1 id="mysql日志管理">
  MySQL日志管理
  <a class="anchor" href="#mysql%e6%97%a5%e5%bf%97%e7%ae%a1%e7%90%86">#</a>
</h1>
<hr>
<h2 id="错误日志">
  错误日志
  <a class="anchor" href="#%e9%94%99%e8%af%af%e6%97%a5%e5%bf%97">#</a>
</h2>
<hr>
<p>记录从MySQL启动开始，所有的状态、警告和错误。可以为管理员定位数据库出现问题的原因。默认为开启状态，默认路径为:<code>datadir/hostname.err</code>，也可以通过<code>my.cnf</code>自定义错误日志文件的存储路径。</p>
<hr>
<h2 id="二进制日志binlog">
  二进制日志（binlog）
  <a class="anchor" href="#%e4%ba%8c%e8%bf%9b%e5%88%b6%e6%97%a5%e5%bf%97binlog">#</a>
</h2>
<hr>
<p>主要应用于数据库备份与恢复、主从复制，二进制日志会记录改变数据库（DDL、DCL、DML）的日志，属于逻辑性质的日志，但在MySQL 8.0以前的版本默认没有开启。建议对数据敏感的生产环境下一定要开启此日志！</p>
<hr>
<h3 id="配置方法">
  配置方法
  <a class="anchor" href="#%e9%85%8d%e7%bd%ae%e6%96%b9%e6%b3%95">#</a>
</h3>
<ul>
<li>
<p>在 <code>/etc/my.cnf</code> 中添加配置信息</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#f92672">[</span>mysqld<span style="color:#f92672">]</span> 
log_bin<span style="color:#f92672">=</span>/opt/mysql/33061/binlog/mysql-bin
server_id<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>
sync_binlog<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>          <span style="color:#75715e"># binlog日志落盘策略，含义为：每次事务提交，立即将binlog落盘，双一中的第二个一</span>
binlog_format<span style="color:#f92672">=</span>row      <span style="color:#75715e"># binlog日志记录格式为row</span>
</code></pre></div></li>
<li>
<p>重启MySQL服务后生效（重启服务后，即可开启binlog日志）</p>
</li>
<li>
<p>在MySQL中查看二进制日志</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#66d9ef">select</span> <span style="color:#f92672">@@</span>log_bin;                                      <span style="color:#75715e"># 查看binlog是否开启，打印 1 为开启
</span><span style="color:#75715e"></span><span style="color:#66d9ef">select</span> <span style="color:#f92672">@@</span>log_bin_basename;                             <span style="color:#75715e"># 查看binlog的文件位置
</span><span style="color:#75715e"></span><span style="color:#66d9ef">show</span> <span style="color:#66d9ef">binary</span> logs;                                      <span style="color:#75715e"># 查看在用的所有binlog日志文件
</span><span style="color:#75715e"></span><span style="color:#66d9ef">show</span> master status;                                    <span style="color:#75715e"># 查看当前在用的binlog日志文件状态
</span><span style="color:#75715e"></span><span style="color:#66d9ef">show</span> binlog events <span style="color:#66d9ef">in</span> <span style="color:#e6db74">&#39;当前在用的binlog日志文件名称&#39;</span>;      <span style="color:#75715e"># 查看当前在用的binlog日志文件内容
</span></code></pre></div></li>
<li>
<p>将<code>binlog</code>日志文件内容导出到<code>sql</code>文件</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$&gt; mysqlbinlog mysql-bin.000002 &gt; /opt/data/log/mysql-bin.000002.sql
$&gt; cat /opt/data/log/mysql-bin.000002.sql

<span style="color:#75715e"># 查看DML的操作需要添加参数对内容进行翻译</span>
$&gt; mysqlbinlog --base64-output<span style="color:#f92672">=</span>decode-rows -vvv mysql-bin.000002 &gt; /opt/data/log/mysql-bin.000002.sql
cat /opt/data/log/mysql-bin.000002.sql
</code></pre></div></li>
</ul>
<blockquote>
<p><code>event</code> 事件：</p>
<p><code>event</code> 是二进制日志中的最小记录单元，对于DDL、DCL语句，一条语句就是一个<code>event</code>，<strong>而对于DML语句，只记录已提交的事务</strong>。</p>
<p><code>event</code> 由三部分组成：事件的开始标识（<code>begin;</code>）、事件内容和事件的结束标志（<code>commit;</code>），为了方便截取事件，每个部分都有自己的<code>Position</code>（位置）号，<code>Position</code>号包含开始标识（Pos）和结束标识（End_log_pos）。</p>
</blockquote>
<ul>
<li>
<p>截取<code>binlog</code>日志文件并导出到<code>sql</code>文件（通过增加<code>-d</code>参数，可以指定数据库）</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$&gt; mysqlbinlog --start-position<span style="color:#f92672">=</span>开始位置标识 --stop--position<span style="color:#f92672">=</span>结束位置标识 mysql-bin.000002 &gt; /opt/data/log/mysql-bin.000002.sql
</code></pre></div></li>
<li>
<p>使用截取的<code>binlog</code>日志文件恢复数据库</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$&gt; set sql_log_bin<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>                           <span style="color:#75715e"># 在当前会话临时关闭binlog日志的记录</span>
$&gt; source /opt/data/log/mysql-bin.000002.sql   <span style="color:#75715e"># 执行sql文件恢复数据库</span>
$&gt; set sql_log_bin<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>                           <span style="color:#75715e"># 在当前会话开启binlog日志的记录</span>
</code></pre></div></li>
</ul>
<hr>
<h3 id="维护操作">
  维护操作
  <a class="anchor" href="#%e7%bb%b4%e6%8a%a4%e6%93%8d%e4%bd%9c">#</a>
</h3>
<ul>
<li>
<p>日志滚动</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#75715e"># 手工触发滚动日志
</span><span style="color:#75715e"></span><span style="color:#66d9ef">flush</span> logs;

<span style="color:#75715e"># 查看binlog日志大小限制，超过此限制自动滚动
</span><span style="color:#75715e"></span><span style="color:#66d9ef">select</span> <span style="color:#f92672">@@</span>max_binlog_size;
</code></pre></div><blockquote>
<p>数据库重启也会触发日志滚动</p>
</blockquote>
</li>
<li>
<p>日志删除</p>
<blockquote>
<p>切记不要使用系统的 <code>rm</code> 命令删除日志！<code>rm</code> 命令不是数据库的操作，会造成数据库异常。</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#75715e"># 查看日志保留时间，默认是0，表示永不删除（日志保留时间最小阈值一般设置为：至少2个全备周期+1）
</span><span style="color:#75715e"></span><span style="color:#66d9ef">select</span> <span style="color:#f92672">@@</span>expire_logs_days;

<span style="color:#75715e"># 手工删除日志
</span><span style="color:#75715e"></span><span style="color:#66d9ef">purge</span> <span style="color:#66d9ef">binary</span> logs <span style="color:#66d9ef">to</span> <span style="color:#e6db74">&#39;mysql-bin.000002&#39;</span>;          <span style="color:#75715e"># 删除指定binlog日志之前的所有binlog日志
</span><span style="color:#75715e"></span><span style="color:#66d9ef">purge</span> <span style="color:#66d9ef">binary</span> logs <span style="color:#66d9ef">before</span> <span style="color:#e6db74">&#39;2021-01-01 00:00:00&#39;</span>;   <span style="color:#75715e"># 删除指定时间之前的所有binlog日志
</span><span style="color:#75715e"></span>reset master;     <span style="color:#75715e"># 慎用！清空所有日志，所有日志从头开始计数。在主库进行此操作，主从必宕！
</span></code></pre></div></li>
<li>
<p><code>binlog</code>的GTID模式</p>
<blockquote>
<p>GTID（Global Transaction ID，全局事务ID）是MySQL 5.6版本之后为了主从而新加入的功能，它是一个已提交事务的编号，并且是一个全局唯一的编号。</p>
<p>官方定义如下：</p>
<p><code>GTID = server_uuid : transaction_id</code></p>
<p>查询<code>server_uuid</code>的命令：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#66d9ef">select</span> <span style="color:#f92672">@@</span>server_uuid;
</code></pre></div><p>或者查看<code>/opt/mysql/data/auto.cnf</code>文件也可以获取<code>server_uuid</code></p>
</blockquote>
<p>开启GTID需要在配置文件<code>/etc/my.cnf</code>中添加如下内容</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">gtid-mode<span style="color:#f92672">=</span>on
enforce-gtid-consistency<span style="color:#f92672">=</span>true
</code></pre></div><p>重启MySQL</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$&gt; /etc/init.d/msyql.server restart
</code></pre></div><p>验证GTID是否开启</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#66d9ef">select</span> <span style="color:#f92672">@@</span>gtid_mode;
</code></pre></div></li>
<li>
<p>通过<code>binlog</code>的GTID截取并恢复日志</p>
<blockquote>
<p>GTID的幂等性：幂等性就是用户对于同一操作发起的一次请求或者多次请求的结果是一致的，不会因多次点击而产生副作用。因此，开启GTID后，MySQL恢复<code>binlog</code>时，重复GTID的事务不会再执行了。</p>
<p>如果想恢复时避免GTID的幂等性，需要在截取日志时增加参数：<code>--skip-gtids</code></p>
<p>如果需要排除某些GTID，需要在截取日志时增加参数：<code>--exclude-gtids</code></p>
</blockquote>
<p>获取想要恢复日志的起点和终点</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#66d9ef">show</span> binlog events <span style="color:#66d9ef">in</span> <span style="color:#e6db74">&#39;mysql-bin.00000x&#39;</span>;
</code></pre></div><p>通过获取到的GTID(起点：5，终点：200)和Binlog文件进行截取</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$&gt; mysqlbinlog --skip-gtids --icloude-gtids<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;server_uuid:5-200&#39;</span> mysql-bin.000002 mysql-bin.000003 mysql-bin.000004 &gt; /opt/mysql/log/gtid.sql
</code></pre></div></li>
</ul>
<hr>
<h2 id="慢日志slowlog">
  慢日志（slowlog）
  <a class="anchor" href="#%e6%85%a2%e6%97%a5%e5%bf%97slowlog">#</a>
</h2>
<hr>
<p>慢日志（slowlog）主要用来记录MySQL运行过程中较慢的语句，是帮助管理对SQL语句进行优化的一个工具日志。</p>
<hr>
<h3 id="配置方法-1">
  配置方法
  <a class="anchor" href="#%e9%85%8d%e7%bd%ae%e6%96%b9%e6%b3%95-1">#</a>
</h3>
<p>默认慢日志是没有开启的，查看方法如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#66d9ef">select</span> <span style="color:#f92672">@@</span>slow_query_log;                      <span style="color:#75715e"># 查看慢日志是否开启，0表示未开启，1表示开启
</span><span style="color:#75715e"></span><span style="color:#66d9ef">select</span> <span style="color:#f92672">@@</span>slow_query_log_file;                 <span style="color:#75715e"># 查看慢日志的文件路径
</span><span style="color:#75715e"></span><span style="color:#66d9ef">select</span> <span style="color:#f92672">@@</span>long_query_time;                     <span style="color:#75715e"># 查看评估慢语句的时间标准
</span><span style="color:#75715e"></span><span style="color:#66d9ef">select</span> <span style="color:#f92672">@@</span>log_queries_not_using_indexes;       <span style="color:#75715e"># 查看不使用索引的语句记录是否开启，0表示未开启，1表示开启
</span></code></pre></div><p>开启慢日志，需要在<code>/etc/my.cnf</code>中加入以下配置项：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">slow_query_log<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>
slow_query_log_file<span style="color:#f92672">=</span>/opt/mysql/log/mysql-slow.log
long_query_time<span style="color:#f92672">=</span><span style="color:#ae81ff">10</span>
log_queries_not_using_indexes<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>
</code></pre></div><p>重启数据库生效</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">/etc.init.d/mysql.server restart
</code></pre></div><p>查看与分析慢日志</p>
<blockquote>
<p>MySQL提供了慢日志的查看与分析工具：<code>mysqldumpslow</code>，生产环境中还可以使用<code>pt-query-digest</code>+<code>Amemometer</code>生成可视化展示平台。</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$&gt; mysqldumpslow -s c -t <span style="color:#ae81ff">10</span> /data/log/mysql-slow.log
</code></pre></div><hr>
<h1 id="mysql备份与恢复">
  MySQL备份与恢复
  <a class="anchor" href="#mysql%e5%a4%87%e4%bb%bd%e4%b8%8e%e6%81%a2%e5%a4%8d">#</a>
</h1>
<hr>
<blockquote>
<p>MySQL备份与回复官方介绍：
  <a href="https://dev.mysql.com/doc/refman/8.0/en/backup-and-recovery.html">MySQL :: MySQL 8.0 Reference Manual :: 7 Backup and Recovery</a></p>
</blockquote>
<hr>
<h2 id="dba备份与恢复的职责">
  DBA备份与恢复的职责
  <a class="anchor" href="#dba%e5%a4%87%e4%bb%bd%e4%b8%8e%e6%81%a2%e5%a4%8d%e7%9a%84%e8%81%8c%e8%b4%a3">#</a>
</h2>
<ul>
<li>设计备份策略（包括：备份工具的选择、备份周期、备份监控）</li>
<li>设计容灾策略（抵御灾难的方式，是使用备份还是高可用）</li>
<li>定期检查备份与容灾的文件</li>
<li>定期对备份与容灾进行故障恢复演练</li>
<li>业务数据损坏时的快速、准确的恢复数据</li>
<li>数据迁移</li>
</ul>
<hr>
<h2 id="mysql常用备份工具">
  MySQL常用备份工具
  <a class="anchor" href="#mysql%e5%b8%b8%e7%94%a8%e5%a4%87%e4%bb%bd%e5%b7%a5%e5%85%b7">#</a>
</h2>
<hr>
<h3 id="逻辑备份方式">
  逻辑备份方式
  <a class="anchor" href="#%e9%80%bb%e8%be%91%e5%a4%87%e4%bb%bd%e6%96%b9%e5%bc%8f">#</a>
</h3>
<ul>
<li>
<p>mysqldump（简称：MDP，必须要连接MySQL后才能进行备份，查看mysqldump备份的参数：<code>mysqldump --help</code>）</p>
<blockquote>
<p><code>InnoDB</code> 表的备份，原理是开启一个独立的事务，获取当前最新的一致性快照，将快照数据放在一个临时表中，然后把快照数据转换成创建数据库（CREATE DATABASE）、创建数据表（CREATE TABLE）、插入数据（INSERT ）等的SQL语句，保存到一个后缀为 <code>.sql</code> 的文件中。</p>
<p>非<code>InnoDB</code>表的备份，需要锁表备份，触发<code>FTWRL</code>（全局锁表），然后再转换成SQL语句，保存到一个后缀为 <code>.sql</code> 的文件中。</p>
<p>优点：可读性强、压缩比高、节省空间</p>
<p>缺点：备份时间相对于物理备份长、恢复时间长</p>
<p>应用场景：数据量较小（100G以内）的数据，建议使用<code>mysqldump</code>。在分布式架构中，可以采用<code>mysqldump</code>备份</p>
</blockquote>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># 备份所有数据库（参数 -A）</span>
$&gt; mysqldump -uroot -p密码 -S /tmp/mysql.sock -A &gt; /data/backup/文件名称.sql

<span style="color:#75715e"># 备份一个或多个指定的数据库（参数 -B）</span>
$&gt; mysqldump -uroot -p密码 -S /tmp/mysql.sock -B 数据库1名称 数据库2名称 &gt; /data/backup/文件名称.sql

<span style="color:#75715e"># 备份一个或多个指定的数据表（不加参数）</span>
$&gt; mysqldump -uroot -p密码 -S /tmp/mysql.sock 数据库名称 表1名称 表2名称 &gt; /data/backup/文件名称.sql

<span style="color:#75715e"># 在进行“全备 + binlog”恢复数据库的时候为获取全备时binlog的起点（位置点），使用mysqldump进行备份时需要增加参数 --master-data=2</span>
$&gt; mysqldump -uroot -p密码 -S /tmp/mysql.sock -A --master-data<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span> &gt; /data/backup/文件名称.sql

<span style="color:#75715e"># 在进行备份的时候，通过转储所有表来创建一致性快照，减少锁表时间，且具备自动锁定、解锁表功能，需要增加参数 --single-transaction</span>
$&gt; mysqldump -uroot -p密码 -S /tmp/mysql.sock -A --master-data<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span> --single-transaction &gt; /data/backup/文件名称.sql
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># 正式生产环境中MySQL的备份</span>
$&gt; mysqldump -uroot -p -S /tmp/mysql.sock -A -R -E --master-data<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span> --single-transaction --triggers --max_allowed_packet<span style="color:#f92672">=</span>128M &gt; /opt/mysql/backup/full_backup_<span style="color:#e6db74">`</span>date +%F_%H:%M:%S<span style="color:#e6db74">`</span>.sql
</code></pre></div><blockquote>
<p>如果不想在终端上输入用户名和密码，可以创建隐藏文件：<code>~/.my.cnf</code>，文件内容如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#f92672">[</span>mysql<span style="color:#f92672">]</span>
user<span style="color:#f92672">=</span>root
pasword<span style="color:#f92672">=</span><span style="color:#ae81ff">123</span>
<span style="color:#f92672">[</span>mysqldump<span style="color:#f92672">]</span>
user<span style="color:#f92672">=</span>root
password<span style="color:#f92672">=</span><span style="color:#ae81ff">123</span>
</code></pre></div></blockquote>
<ul>
<li>mydumper（自行扩展，不做介绍）</li>
<li>load data in file（自行扩展，不做介绍）</li>
<li>主从方式（replication）</li>
</ul>
<hr>
<h3 id="物理备份方式">
  物理备份方式
  <a class="anchor" href="#%e7%89%a9%e7%90%86%e5%a4%87%e4%bb%bd%e6%96%b9%e5%bc%8f">#</a>
</h3>
<ul>
<li>
<p><strong>MySQL社区版：Percona Xtrabackup（简称：PBK或XBK）</strong></p>
<blockquote>
<p>Percona Xtrabackup 8仅支持MySQL 8.0，Percona Xtrabackup 7支持MySQL 5.7</p>
<p>Percona Xtrabackup是一个运行在服务端的工具，而不是运行在客户端的工具</p>
</blockquote>
<p><strong>安装</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$&gt; wget https://repo.percona.com/apt/percona-release_latest.<span style="color:#66d9ef">$(</span>lsb_release -sc<span style="color:#66d9ef">)</span>_all.deb
$&gt; dpkg -i percona-release_latest.<span style="color:#66d9ef">$(</span>lsb_release -sc<span style="color:#66d9ef">)</span>_all.deb
$&gt; percona-release enable-only tools release
$&gt; apt-get update
$&gt; apt-get install percona-xtrabackup-80
$&gt; apt-get install qpress
</code></pre></div><p>修改<code>/etc/my.cnf</code>文件</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># 增加以下内容</span>
<span style="color:#f92672">[</span>client<span style="color:#f92672">]</span>
socket<span style="color:#f92672">=</span>/tmp/mysql.sock
</code></pre></div><p><strong>使用 Percona Xtrabackup 对MySQL进行全量备份</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$&gt; innobackupex --user<span style="color:#f92672">=</span>root --password<span style="color:#f92672">=</span><span style="color:#ae81ff">123</span> --no-timestamp /opt/mysql/data/backup/xbk/full_backup_<span style="color:#e6db74">`</span>date +%F<span style="color:#e6db74">`</span>
</code></pre></div><blockquote>
<p>备份结果中有两个文件比较重要</p>
<p>xtrabackup_binlog_info：记录备份后的binlog位置点信息，方便获取binlog日志的起点</p>
<p>xtrabackup_checkpoints：备份过程中的LSN记录，方便做增量备份</p>
</blockquote>
<p><strong>使用 Percona Xtrabackup 对MySQL进行备份恢复</strong></p>
<blockquote>
<p>使用 Percona Xtrabackup 进行恢复时，需要目标目录为空目录</p>
</blockquote>
<p>对备份的文件进行处理（prepare）</p>
<blockquote>
<p>实际上就是对redo的前滚和undo的回滚，模仿CSR的过程</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$&gt; innobackupex --apply-log /opt/mysql/data/backup/xbk/full_backup_2021-11-30/
</code></pre></div><p>恢复备份</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$&gt; cp -a /opt/mysql/data/backup/xbk/full_backup_2021-11-30/* /opt/mysql/data/
$&gt; chown -R mysql.mysql /opt/mysql/data/*
</code></pre></div></li>
</ul>
<hr>
<ul>
<li>MySQL企业版：MySQL Enterprise Backup</li>
</ul>
<hr>
<h2 id="mysql备份恢复">
  MySQL备份恢复
  <a class="anchor" href="#mysql%e5%a4%87%e4%bb%bd%e6%81%a2%e5%a4%8d">#</a>
</h2>
<hr>
<blockquote>
<p>恢复思路：</p>
<ul>
<li>挂维护页</li>
<li>找测试库，恢复全备</li>
<li>截取全备至数据库出问题之前的binlog，并恢复</li>
<li>测试业务功能是否正常</li>
<li>恢复业务</li>
</ul>
</blockquote>
<hr>
<h3 id="检查全备">
  检查全备
  <a class="anchor" href="#%e6%a3%80%e6%9f%a5%e5%85%a8%e5%a4%87">#</a>
</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$&gt; vim /opt/mysql/backup/full_back_2021-11-29.sql
<span style="color:#75715e"># 记录下如下信息：</span>
-- CHANGE MASTER TO MASTER_LOG_FILE<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;mysql-bin.000003&#39;</span>, MASTER_LOG_POS<span style="color:#f92672">=</span>5308689;
</code></pre></div><hr>
<h3 id="恢复全备">
  恢复全备
  <a class="anchor" href="#%e6%81%a2%e5%a4%8d%e5%85%a8%e5%a4%87">#</a>
</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$&gt; set sql_log_bin<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>      <span style="color:#75715e"># 开了GTID就不用设置此步骤了</span>
$&gt; source /opt/mysql/backup/full_back_2021-11-29.sql
</code></pre></div><hr>
<h3 id="截取二进制日志binlog">
  截取二进制日志（binlog）
  <a class="anchor" href="#%e6%88%aa%e5%8f%96%e4%ba%8c%e8%bf%9b%e5%88%b6%e6%97%a5%e5%bf%97binlog">#</a>
</h3>
<p>获取起点：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">vim /opt/mysql/backup/full_back_2021-11-29.sql
<span style="color:#75715e"># 获取到如下信息：</span>
-- CHANGE MASTER TO MASTER_LOG_FILE<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;mysql-bin.000003&#39;</span>, MASTER_LOG_POS<span style="color:#f92672">=</span>5308689;    <span style="color:#75715e"># MASTER_LOG_POS作为position起点</span>
SET @@GLOBAL.GTID_PURGED<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;server_uuid : 5&#39;</span>;                           <span style="color:#75715e"># 6为GTID起点</span>
</code></pre></div><p>获取终点方式一（基于position截取终点）：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#75715e"># 连接数据库，输入以下语句
</span><span style="color:#75715e"></span><span style="color:#66d9ef">show</span> binlog events <span style="color:#66d9ef">in</span> <span style="color:#e6db74">&#39;mysql-bin.000003&#39;</span>;      <span style="color:#75715e"># 获取到数据库出问题之前的position为：5308754
</span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># 截取binlog日志</span>
$&gt; mysqlbinlog --skip-gtids --start-position<span style="color:#f92672">=</span><span style="color:#ae81ff">5308689</span> --stop-position<span style="color:#f92672">=</span><span style="color:#ae81ff">5308754</span> ll /opt/mysql/log/mysql-bin.000003 &gt; /opt/mysql/log/binlog.sql
</code></pre></div><p>获取终点方式二（基于GTID截取终点）：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#75715e"># 连接数据库，输入以下语句
</span><span style="color:#75715e"></span><span style="color:#66d9ef">show</span> binlog events <span style="color:#66d9ef">in</span> <span style="color:#e6db74">&#39;mysql-bin.000003&#39;</span>;      <span style="color:#75715e"># 获取到数据库出问题之前的GTID为：&#39;server_uuid : 200&#39;
</span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># 截取binlog日志</span>
$&gt; mysqlbinlog --skip-gtids --icloude-gtids<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;server_uuid:5-200&#39;</span> mysql-bin.000003 &gt; /opt/mysql/log/binlog.sql
</code></pre></div><hr>
<h3 id="恢复二进制日志binlog">
  恢复二进制日志（binlog）
  <a class="anchor" href="#%e6%81%a2%e5%a4%8d%e4%ba%8c%e8%bf%9b%e5%88%b6%e6%97%a5%e5%bf%97binlog">#</a>
</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$&gt; source /opt/mysql/log/binlog.sql
$&gt; set sql_log_bin<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>      <span style="color:#75715e"># 开了GTID就不用设置此步骤了</span>
</code></pre></div><hr>
<h1 id="主从复制">
  主从复制
  <a class="anchor" href="#%e4%b8%bb%e4%bb%8e%e5%a4%8d%e5%88%b6">#</a>
</h1>
<hr>
<blockquote>
<p>主从复制（Replication）MySQL官方介绍：
  <a href="https://dev.mysql.com/doc/refman/8.0/en/replication.html">MySQL :: MySQL 8.0 Reference Manual :: 17 Replication</a></p>
</blockquote>
<hr>
<p>通俗来说，主从复制就是两个或两个以上数据库实例之间通过二进制日志（binlog）实现数据的同步效果（其工作模式为异步）</p>
<hr>
<h2 id="部署主从复制">
  部署主从复制
  <a class="anchor" href="#%e9%83%a8%e7%bd%b2%e4%b8%bb%e4%bb%8e%e5%a4%8d%e5%88%b6">#</a>
</h2>
<hr>
<ul>
<li>准备两台或两台以上可以通过网络互相访问的数据库实例</li>
<li>时间同步</li>
<li>两台或两台以上的数据库实例<code>server_id</code>不同</li>
</ul>
<blockquote>
<p>设置方法（略）</p>
<p>检查命令：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$&gt; mysql -u用户名 -p密码 -e <span style="color:#e6db74">&#34;select @@server_id&#34;</span>
</code></pre></div></blockquote>
<ul>
<li>在主数据库开启<code>binlog</code></li>
</ul>
<blockquote>
<p>设置方法（略）</p>
<p>检查命令：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$&gt; mysql -u用户名 -p密码 -e <span style="color:#e6db74">&#34;select @@log_bin&#34;</span>
</code></pre></div></blockquote>
<ul>
<li>在主数据库建立复制用户</li>
</ul>
<blockquote>
<p>注意：复制用户有明确的权限规定，必须为<code>replication slave</code></p>
<p>创建命令：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#75715e"># 创建用户：repl，并设置密码为：123
</span><span style="color:#75715e"></span><span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">USER</span> repl<span style="color:#f92672">@</span><span style="color:#e6db74">&#39;%&#39;</span> <span style="color:#66d9ef">IDENTIFIED</span> <span style="color:#66d9ef">BY</span> <span style="color:#e6db74">&#39;123&#39;</span>;
<span style="color:#75715e"># 给用户repl授权replication slave权限
</span><span style="color:#75715e"></span><span style="color:#66d9ef">GRANT</span> replication slave <span style="color:#66d9ef">ON</span> <span style="color:#f92672">*</span>.<span style="color:#f92672">*</span> <span style="color:#66d9ef">TO</span> repl<span style="color:#f92672">@</span><span style="color:#e6db74">&#39;%&#39;</span>;
</code></pre></div></blockquote>
<ul>
<li>将主库备份恢复到从库</li>
</ul>
<blockquote>
<p>备份主库（略）</p>
<p>将主库恢复到从库命令：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$&gt; mysql -u用户名 -p密码 &lt;/opt/mysql/backup/主库备份.sql
</code></pre></div></blockquote>
<ul>
<li>告知从库复制信息</li>
</ul>
<blockquote>
<p>在从库中通过<code>CHANGE MASTER TO</code>命令可以告知从库连接主库的信息（在数据库中执行）</p>
<p>在数据库中通过<code>help change master to</code>命令可以查看相关命令信息</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#66d9ef">CHANGE</span> MASTER <span style="color:#66d9ef">TO</span>
  MASTER_HOST<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;source2.example.com&#39;</span>,
  MASTER_USER<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;replication&#39;</span>,
  MASTER_PASSWORD<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;password&#39;</span>,
  MASTER_PORT<span style="color:#f92672">=</span><span style="color:#ae81ff">3306</span>,
  MASTER_LOG_FILE<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;source2-bin.001&#39;</span>,
  MASTER_LOG_POS<span style="color:#f92672">=</span><span style="color:#ae81ff">4</span>,
  MASTER_CONNECT_RETRY<span style="color:#f92672">=</span><span style="color:#ae81ff">10</span>;
</code></pre></div><p>在主库中，通过<code>grep &quot;\-- CHANGE MASTER TO&quot;  /opt/mysql/backup/主库备份.sql</code>命令可以查看到<code>MASTER_LOG_FILE</code>和<code>MASTER_LOG_POS</code>信息</p>
</blockquote>
<ul>
<li>开启专用的复制线程</li>
</ul>
<blockquote>
<p>在从库中开启专用的复制线程命令</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql">START SLAVE;
</code></pre></div></blockquote>
<ul>
<li>检查主从复制状态</li>
</ul>
<blockquote>
<p>通过在从库上检查专用的复制线程状态，用以检查主从复制状态</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#66d9ef">SHOW</span> SLAVE STATUS;
</code></pre></div></blockquote>
<hr>
<h2 id="清空主从复制">
  清空主从复制
  <a class="anchor" href="#%e6%b8%85%e7%a9%ba%e4%b8%bb%e4%bb%8e%e5%a4%8d%e5%88%b6">#</a>
</h2>
<hr>
<p>在从库的数据库中关闭专用的复制线程</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql">STOP SLAVE;
</code></pre></div><p>在从库的数据库中清除从库的同步复制信息</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql">RESET SLAVE <span style="color:#66d9ef">ALL</span>;
</code></pre></div><hr>
<h2 id="主从复制原理">
  主从复制原理
  <a class="anchor" href="#%e4%b8%bb%e4%bb%8e%e5%a4%8d%e5%88%b6%e5%8e%9f%e7%90%86">#</a>
</h2>
<hr>
<h3 id="主从复制的中涉及到的资源">
  主从复制的中涉及到的资源
  <a class="anchor" href="#%e4%b8%bb%e4%bb%8e%e5%a4%8d%e5%88%b6%e7%9a%84%e4%b8%ad%e6%b6%89%e5%8f%8a%e5%88%b0%e7%9a%84%e8%b5%84%e6%ba%90">#</a>
</h3>
<hr>
<p><strong>文件资源</strong></p>
<ul>
<li>主库（master）：<code>binlog</code>文件</li>
<li>从库（slave）：<code>relay-log</code>文件、<code>relay-log.info</code>文件、<code>master.info</code>文件</li>
</ul>
<blockquote>
<p><code>relay-log</code>：主要用于存储接收的<code>binlog</code>日志内容。主库的<code>binlog</code>文件内容从主库发送到从库，从库使用<code>relay-log</code>文件将主库的<code>binlog</code>文件内容接收、保存下来。<code>relay-log</code>默认存储在从库的数据目录下，以文件名称<code>db**-relay-bin.******</code>进行保存，通过在从库的MySQL配置文件中增加<code>relay_log_basename=存储路径</code>可以修改<code>relay-log</code>的默认存储路径。</p>
<p><code>relay-log.info</code>：主要用于记录<code>relay-log</code>回放到的位置点信息。避免从库因某些原因造成日志回放中断时再从头进行重复回放。<code>relay-log.info</code>默认也是存储在从库的数据目录下，<code>relay-log.info</code>除了可以存储为文件，还可以存储在数据表中，通过在从库的MySQL配置文件中增加<code>relay_log_info=file/table</code>可以切换<code>relay-log.info</code>的存储方式，存储在数据表中可以提高性能。</p>
<p><code>master.info</code>：主要用于存放连接主库的信息和已经接收<code>binlog</code>的位置点信息。<code>master.info</code>默认也是存储在从库的数据目录下，<code>master.info</code>除了可以存储为文件，还可以存储在数据表中，通过在从库的MySQL配置文件中增加<code>master_info_repository=file/table</code>可以切换<code>master.info</code>的存储方式，存储在数据表中可以提高性能。</p>
</blockquote>
<hr>
<p><strong>线程资源</strong></p>
<ul>
<li>
<p>主库（master）：<code>Binlog_Dump</code>线程</p>
<blockquote>
<p>Binlog_Dump线程（<code>Binlog_Dump Thread</code>）：主要用来接收从库请求，并投递<code>binlog</code>日志给从库。在主库中通过<code>SHOW PROCESSLIST;</code>可以查看到<code>Binlog_Dump Thread</code>。</p>
</blockquote>
</li>
<li>
<p>从库（slave）：<code>IO</code>线程、<code>SQL</code>线程</p>
<blockquote>
<p>IO线程（<code>IO Thread</code>）：主要用于请求<code>binlog</code>日志和接收<code>binlog</code>日志。</p>
<p>SQL线程（<code>SQL Thread</code>）：主要用于回放<code>relay-log</code>日志。</p>
</blockquote>
</li>
</ul>
<hr>
<h3 id="主从复制工作原理的描述">
  主从复制工作原理的描述
  <a class="anchor" href="#%e4%b8%bb%e4%bb%8e%e5%a4%8d%e5%88%b6%e5%b7%a5%e4%bd%9c%e5%8e%9f%e7%90%86%e7%9a%84%e6%8f%8f%e8%bf%b0">#</a>
</h3>
<hr>
<p>主从复制工作原理的描述将以从库连接主库开始</p>
<p>第一步：从库（slave）通过<code>CHANGE MASTER TO</code>命令获取主库的连接信息（IP地址、端口号、用户名、密码、binlog日志及位置点），这些信息将被写入到从库的<code>master.info</code>文件中。</p>
<p>第二步：从库（slave）通过执行<code>start slave</code>命令启动专用的复制线程（<code>IO Thread</code>和<code>SQL Thread</code>），通过<code>IO Thread</code>从第一步获取到的信息连接主库（master）。</p>
<p>第三步：主库（master）与从库（slave）建立连接后，主库（master）开启<code>Binlog_Dump Thread</code>与从库（slave）的<code>IO Thread</code>进行交互（接收从库请求并投递<code>binlog</code>日志）。详细来说，主库（master）的<code>Binlog_Dump Thread</code>会监测本地<code>binlog</code>的变化，一旦发生改变，会通过<code>Binlog_Dump Thread</code>给从库（slave）的<code>IO Thread</code>发送信号（signal）。</p>
<p>第四步：从库（slave）的<code>IO Thread</code>向主库（master）的<code>Binlog_Dump Thread</code>请求新的<code>binlog</code>日志。</p>
<p>第五步：主库（master）的<code>Binlog_Dump Thread</code>接收到<code>binlog</code>日志请求后，会分析并截取<code>binlog</code>日志返回给从库（slave）的<code>IO Thread</code>。</p>
<p>第六步：从库（slave）的<code>IO Thread</code>通过<code>TCP/IP</code>接收并缓存返回的<code>binlog</code>日志后，写入至<code>relay-log</code>文件中，同时<code>master.info</code>文件也会被更新。</p>
<p>第七步：从库（slave）的<code>SQL Thread</code>开始工作，<code>SQL Thread</code>先读取<code>relay-log.info</code>文件，获取上次执行回放位置点，根据获取到的位置点向后执行<code>relay-log</code>文件的日志，执行完毕后，更新<code>relay-log.info</code>，记录执行回放的位置点。</p>
<p>第八步：从库（slave）如果设定了参数<code>relay_log_purge=on</code>，应用过的<code>relay-log</code>会自动被删除。</p>
<hr>
<h2 id="主从复制的状态监控">
  主从复制的状态监控
  <a class="anchor" href="#%e4%b8%bb%e4%bb%8e%e5%a4%8d%e5%88%b6%e7%9a%84%e7%8a%b6%e6%80%81%e7%9b%91%e6%8e%a7">#</a>
</h2>
<hr>
<p>一般来说，MySQL的主从复制状态的监控会放在从库，并且监控项都会加入到Zabbix监控系统中</p>
<hr>
<p><strong>主库（master）</strong></p>
<p>在主库（master）中，一般通过以下两条命令检查主从复制状态</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#75715e"># 显示正在运行的线程
</span><span style="color:#75715e"></span><span style="color:#66d9ef">SHOW</span> processlist;

<span style="color:#75715e"># 显示已连接的从主机
</span><span style="color:#75715e"></span><span style="color:#66d9ef">SHOW</span> slave hosts;
</code></pre></div><hr>
<p><strong>从库（slave）</strong></p>
<p>在从库（slave）中，一般会通过以下命令检查主从复制状态</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#66d9ef">SHOW</span> slave status;
</code></pre></div><blockquote>
<p>主库相关信息</p>
<hr>
<p>Master_Host：10.0.0.10</p>
<p>Master_User：repl</p>
<p>Master_Port：3306</p>
<p>Connect_Retry：10</p>
<p>Master_Log_File：mysql-bin.000002</p>
<p>Read_Master_Log_Pos：888</p>
<hr>
<p>从库<code>relay-log</code>的执行情况，来自于<code>relay-log.info</code>文件，<strong>一般用来判断主从延时</strong></p>
<hr>
<p>Relay_Log_File：master-relay-bin.000002</p>
<p>Relay_Log_Pos：666</p>
<p>Relay_Master_Log_File：mysql-bin.000002</p>
<p>Read_Master_Log_Pos：600</p>
<hr>
<p>从库线程状态以及具体报错信息</p>
<hr>
<p>Slave_IO_Running：YES</p>
<p>Slave_SQL_Running：YES</p>
<p>Last_IO_Errno：0</p>
<p>Last_IO_Error：</p>
<p>Last_SQL_Errno：0</p>
<p>Last_SQL_Error：</p>
<hr>
<p>过滤复制信息</p>
<hr>
<p>Replicate_Do_DB：</p>
<p>Replicate_Ignore_DB：</p>
<p>Replicate_Do_Table：</p>
<p>Replicate_Ignore_Table：</p>
<p>Replicate_Wild_Do_Table：</p>
<p>Replicate_Wild_Ignore_Table：</p>
<hr>
<p>延迟从库的配置信息（注意：不是从库延时，延时从库是人为想要将从库与主库数据同步延时多长时间）</p>
<hr>
<p>SQL_Delay：0</p>
<p>SQL_Remaining_Delay：NULL</p>
<hr>
<p>GTID相关复制信息</p>
<hr>
<p>Retrieved_Gtid_Set：</p>
<p>Executed_Gtid_Set：</p>
</blockquote>
<hr>
<h2 id="主从故障分析及处理">
  主从故障分析及处理
  <a class="anchor" href="#%e4%b8%bb%e4%bb%8e%e6%95%85%e9%9a%9c%e5%88%86%e6%9e%90%e5%8f%8a%e5%a4%84%e7%90%86">#</a>
</h2>
<hr>
<h3 id="io线程故障">
  IO线程故障
  <a class="anchor" href="#io%e7%ba%bf%e7%a8%8b%e6%95%85%e9%9a%9c">#</a>
</h3>
<ul>
<li>
<p>从库（slave）无法连接主库（master）：在从库（slave）上使用<code>SHOW slave status;</code>查看<code>Slave_IO_Running</code>的状态为：<code>Connecting</code>。</p>
<blockquote>
<p>故障原因：主库（slave）的IP地址、端口号、用户名、密码等连接信息填写错误，或者防火墙、网络连接、网络连接数上限等原因引起。</p>
<p>处理故障思路：先排查网络连接是否正常，是否可以在从库（slave）正常连接到主库，再排查连接主库（slave）的信息是否正确。</p>
</blockquote>
</li>
<li>
<p>请求和接收binlog日志故障：在从库（slave）上使用<code>SHOW slave status;</code>查看<code>Slave_IO_Running</code>的状态为：<code>No</code>。</p>
<blockquote>
<p>故障原因：主库日志损坏或丢失。例如：在主库执行<code>reset master;</code>命令后，主从复制会立刻瘫痪。</p>
<p>处理故障思路：</p>
<ul>
<li>在从库（slave）上先停掉专用的主从复制线程：<code>stop slave;</code></li>
<li>在从库（slave）上重置所有的主从复制信息：<code>reset slave all;</code></li>
<li>在从库上，使用<code>CHANGE MASTER TO</code>命令重新搭建主从复制，然后使用<code>start slave;</code>命令启动专用的主从复制线程。</li>
</ul>
</blockquote>
</li>
</ul>
<hr>
<h3 id="sql线程故障">
  SQL线程故障
  <a class="anchor" href="#sql%e7%ba%bf%e7%a8%8b%e6%95%85%e9%9a%9c">#</a>
</h3>
<ul>
<li>
<p>从库（slave）无法同步主库（master）</p>
<blockquote>
<p>故障原因：</p>
<ul>
<li>从库（slave）读写<code>relay-log.info</code>时，发现<code>relay-log</code>不完整、丢失或者损坏。</li>
<li><code>relay-log</code>中的SQL语句不能在从库中回放。主要原因有：
<ul>
<li>主、从数据库版本有差异或<code>SQL MODE</code>的差异导致同一条SQL的语义不同</li>
<li>需要创建的数据库对象在从库中已经存在，或需要修改或删除的数据库对象在从库中不存在</li>
<li>DML语句不符合表定义及约束，例如：主键约束、唯一键约束等。</li>
</ul>
</li>
</ul>
<p>处理故障思路：在处理主从故障时把握一个原则：一切以主库为标准。因此，最安全的做法就是重构主从复制。SQL线程故障的原因大多来自从库被人为进行了写入操作。因此，可以在从库使用<code>set global read_only=1</code>命令或在从库的配置文件中加入<code>read_only=1</code>，设置从库只读（对普通用户生效，管理员无效）。或者在主从复制之上加入中间件，形成读写分离架构，让写入操作落到主库上，读取操作落到从库上，就可以有效规避SQL线程故障。</p>
</blockquote>
</li>
</ul>
<hr>
<h2 id="主从延迟分析及处理">
  主从延迟分析及处理
  <a class="anchor" href="#%e4%b8%bb%e4%bb%8e%e5%bb%b6%e8%bf%9f%e5%88%86%e6%9e%90%e5%8f%8a%e5%a4%84%e7%90%86">#</a>
</h2>
<hr>
<p>主从延迟一般表现为主库的数据发生变更后，从库的数据很长时间才能同步一致。</p>
<hr>
<h3 id="主库master原因">
  主库（master）原因
  <a class="anchor" href="#%e4%b8%bb%e5%ba%93master%e5%8e%9f%e5%9b%a0">#</a>
</h3>
<ul>
<li>
<p>主库（master）的数据库操作没有及时写入到<code>binlog</code>二进制日志上。</p>
<blockquote>
<p>解决思路：在主库（master）的配置文件中写入<code>sync_binlog=1</code>，让主库（master）的数据操作及时写入到<code>binlog</code>上。</p>
</blockquote>
</li>
<li>
<p>MySQL 5.7版本之前的主从复制中，主库（master）的<code>Binlog_Dump</code>线程是以事件作为单元，以串行的方式通过网络将<code>binlog</code>发送给从库（slave），因此，当主库（master）并发事务量大的时候，在网络状况不佳的情况下，通过串行发送给从库（slave）的<code>binlog</code>会有较为明显的延迟。</p>
<blockquote>
<p>解决思路：MySQL 5.6加入了GTID的功能，即全局事务ID (global transaction identifier), 其保证为每一个在主库上提交的事务在从库（slave）中可以生成一个唯一的ID，实现了GC（Group Commit）机制。从MySQL 5.7开始，即使不开启GTID，MySQL也会自动维护匿名GTID，但生产中仍然建议手工开启GTID。同时，将大事务拆成多个小事务，也可以有效减少主从延时。</p>
</blockquote>
</li>
</ul>
<hr>
<h3 id="从库slave原因">
  从库（slave）原因
  <a class="anchor" href="#%e4%bb%8e%e5%ba%93slave%e5%8e%9f%e5%9b%a0">#</a>
</h3>
<ul>
<li>
<p>默认情况下，从库（slave）只有一个SQL线程执行回放日志，当面对主库（master）高并发执行事务时，从库（slave）串行执行事务必然导致延迟。</p>
<blockquote>
<p>解决思路：MySQL 5.6 开启了GTID后，拥有开启多SQL线程的特性，但只能针对不同库（database）下的事务进行并发回放。而MySQL 5.7开启GTID后，在binlog中加入了seq_no，在多SQL线程方面，真正的实现了基于逻辑时钟（Logical_Clock）的并发事务，这种技术称之为MTS（Multi-Threaded Slave）</p>
</blockquote>
</li>
<li>
<p>当主库（master）发生了较大的事务，从库在回放较大的事务时，也会阻塞后续事务的回放，导致延迟。</p>
<blockquote>
<p>解决思路：在MySQL中没有太好的方案，只能将较大的事务拆成较小的事务。</p>
</blockquote>
</li>
</ul>
<hr>
<h2 id="特殊从库的应用">
  特殊从库的应用
  <a class="anchor" href="#%e7%89%b9%e6%ae%8a%e4%bb%8e%e5%ba%93%e7%9a%84%e5%ba%94%e7%94%a8">#</a>
</h2>
<hr>
<h3 id="延时从库">
  延时从库
  <a class="anchor" href="#%e5%bb%b6%e6%97%b6%e4%bb%8e%e5%ba%93">#</a>
</h3>
<p>延时从库时一种根据业务需要，人为配置的从库（slave）与主库（master）延迟同步一段时间。一般来说，延时从库不承接日常业务。</p>
<p>**使用延时从库的意义：**主从复制用来解决的是主库（master）物理损坏时，从库（slave）可以快速承接业务，而面对逻辑故障（例如：误删数据库、数据表或数据行等人为因素产生的故障）主从复制时没有办法解决的，因此，需要使用延时从库（slave）来解决主库（master）的逻辑故障，缩短业务恢复的时间。</p>
<p>**配置延迟从库的思路：**让从库（slave）的正常接收主库的<code>binlog</code>，但人为的让SQL线程晚一些回放<code>relay-log</code>，一般生产环境中，建议延迟3至6个小时，具体需要看运维人员对故障的反应时间。</p>
<p><strong>配置延迟从库：</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-MYSQL" data-lang="MYSQL">stop slave;
<span style="color:#66d9ef">CHANGE</span> MASTER <span style="color:#66d9ef">TO</span> MASTER_DELAY <span style="color:#f92672">=</span> <span style="color:#ae81ff">21600</span>;
start slave;
<span style="color:#66d9ef">show</span> slave status;
</code></pre></div><p>**主库逻辑故障的恢复思路：**发现主库发生逻辑故障之后，立即停止延时从库的SQL线程，挂维护页面，截取从库（slave）的<code>relay-log</code>，起点为停止SQL线程的位置点，终点为逻辑故障发生时的位置，将截取的日志恢复到延时从库（slave），解除延时从库的从库身份，提升为主库。</p>
<p><strong>主库逻辑故障恢复方法：</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#75715e"># 在延时从库上停掉SQL线程
</span><span style="color:#75715e"></span>stop slave sql_thread;
<span style="color:#75715e"># 获取Relay_Log_File和Relay_Log_Pos的信息作为relay-log的起点
</span><span style="color:#75715e"></span><span style="color:#66d9ef">show</span> slave status;
<span style="color:#75715e"># 获取获取事件信息的POS作为relay-log的终点
</span><span style="color:#75715e"></span><span style="color:#66d9ef">show</span> relaylog events <span style="color:#66d9ef">in</span> <span style="color:#e6db74">&#39;dbxx-relay-bin.xxxxxx&#39;</span>;
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># 截取relay-log日志</span>
$&gt; mysqlbinlog --start-position<span style="color:#f92672">=</span><span style="color:#ae81ff">666</span> --stop-position<span style="color:#f92672">=</span><span style="color:#ae81ff">888</span> /data/dbxx-relay-bin.xxxxxx &gt; /tmp/relay.sql
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#75715e"># 在延迟从库中恢复截取的relay-log日志
</span><span style="color:#75715e"></span><span style="color:#66d9ef">set</span> sql_log_bin<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>;  <span style="color:#75715e">#设为0后，在Master数据库上执行的语句都不记录binlog
</span><span style="color:#75715e"></span>source <span style="color:#f92672">/</span>tmp<span style="color:#f92672">/</span>relay.<span style="color:#66d9ef">sql</span>;
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#75715e"># 解除延时从库的从库身份，提升为主库
</span><span style="color:#75715e"></span>stop slave;
reset slave <span style="color:#66d9ef">all</span>;
</code></pre></div><hr>
<h3 id="半同步复制">
  半同步复制
  <a class="anchor" href="#%e5%8d%8a%e5%90%8c%e6%ad%a5%e5%a4%8d%e5%88%b6">#</a>
</h3>
<p>半同步复制（Semi-Synchronous Replication）用来解决主从数据一致性的问题，主要用于对主从数据一致性有高要求的环境。半同步复制在MySQL 5.5中出现，在MySQL 5.6中增强，在MySQL 5.7中完善，但由于性能较差，被5.7中出现的数据库高可用与高扩展的解决方案MGR（MySQL Group Replication，又被称为无损复制）替代。</p>
<hr>
<h3 id="过滤复制">
  过滤复制
  <a class="anchor" href="#%e8%bf%87%e6%bb%a4%e5%a4%8d%e5%88%b6">#</a>
</h3>
<p>过滤复制是指主库（master）中有多个数据库，而在复制的过程中并不是将所有的数据库都复制到从库（slave），而是有选择的将数据库复制到从库（slave）。过滤复制在实际业务中经常会被用到。</p>
<p>过滤复制在主库（master）和从库（slave）中都可以进行控制，通过主库（master）进行过滤复制，只有复制的数据库才会记录<code>binlog</code>，不复制的数据库不会记录<code>binlog</code>，因此，在生产环境中一般会在从库中进行控制。</p>
<p><strong>主库（master）控制过滤复制的参数：</strong></p>
<ul>
<li>Binlog_Do_DB            # 相当于白名单</li>
<li>Binlog_Ignore_DB      # 相当于黑名单</li>
</ul>
<p><strong>从库（slave）控制过滤复制的参数：</strong></p>
<ul>
<li>Replicate_Do_DB</li>
<li>Replicate_Ignore_DB</li>
<li>Replicate_Do_Table</li>
<li>Replicate_Ignore_Table</li>
<li>Replicate_Wild_Do_Table</li>
<li>Replicate_Wild_Ignore_Table</li>
</ul>
<p><strong>在从库配置过滤复制</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># 在配置文件中加入参数</span>
replicate_do_db<span style="color:#f92672">=</span>数据库名称1
replicate_do_db<span style="color:#f92672">=</span>数据库名称2
</code></pre></div><hr>
<h3 id="gtid复制">
  GTID复制
  <a class="anchor" href="#gtid%e5%a4%8d%e5%88%b6">#</a>
</h3>
<p>GTID（Global Transaction ID）由主库上生成的与事务绑定的唯一标识，这个标识不仅在主库上是唯一的，在MySQL集群内也是唯一的。相对于之前版本基于<code>Binlog</code>+<code>Position</code>的主从复制，基于GTID的主从复制，数据一致性更高，主从数据复制更健壮，主从切换、故障切换不易出错，很少需要人为介入处理。</p>
<p>主库（master）开启GTID需要在配置文件<code>/etc/my.cnf</code>中添加如下内容</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">gtid-mode<span style="color:#f92672">=</span>on
enforce-gtid-consistency<span style="color:#f92672">=</span>true
</code></pre></div><p>主库（master）重启MySQL</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$&gt; /etc/init.d/msyql.server restart
</code></pre></div><p>主库（master）验证GTID是否开启</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#66d9ef">select</span> <span style="color:#f92672">@@</span>gtid_mode;
</code></pre></div><p>从库（slave）配置文件<code>/etc/my.cnf</code>中添加如下内容</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">log-slave-update<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>
</code></pre></div><p>从库（slave）执行<code>change master to</code>命令</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#66d9ef">CHANGE</span> MASTER <span style="color:#66d9ef">TO</span>
MASTER_HOST<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;source2.example.com&#39;</span>,
MASTER_USER<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;replication&#39;</span>,
MASTER_PASSWORD<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;password&#39;</span>,
MASTER_PORT<span style="color:#f92672">=</span><span style="color:#ae81ff">3306</span>,
MASTER_AUTO_POSITION<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>;  <span style="color:#75715e"># 如果主从复制同步搭建的时候可以写这条命令，如果主库运行很长时间了才开始搭建主从复制，则仍然需要使用全备的方式
</span></code></pre></div><p>从库（slave）开启专用的复制线程</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql">START SLAVE;
</code></pre></div><blockquote>
<p>GTID主从复制与传统的主从复制的区别：</p>
<p>从库（slave）在执行<code>change master to</code>的时候不在需要<code>binlog</code>文件名和<code>position</code>号了，直接通过<code>MASTER_AUTO_POSITION=1</code>就可以使从库（slave）连接上主库（master），在复制过程中，从库也不再依赖<code>master.info</code>文件，而是直接读取最后一个<code>relay-log</code>的GTID号。</p>
<p>在主库（master）使用<code>mysqldump</code>进行备份时，默认会在备份中包含事务操作，以<code>SET @@GLOBAL.GTID_PURGED='8s89d87aa-6e66-34i8-8765-3244dfd33346:1';</code>告知从库（slave）备份中已经包含的事务操作，直接从下一个GTID开始请求<code>binlog</code>。</p>
</blockquote>
<hr>
<h2 id="主从复制架构演变">
  主从复制架构演变
  <a class="anchor" href="#%e4%b8%bb%e4%bb%8e%e5%a4%8d%e5%88%b6%e6%9e%b6%e6%9e%84%e6%bc%94%e5%8f%98">#</a>
</h2>
<hr>
<p>主从复制基础架构（不需要第三方软件支持）一般分为：1主1从、1主多从、双主机构、多级主从、循环复制等。</p>
<p>在主从复制的基础架构上又演变出<strong>高可用架构</strong>、<strong>高性能架构</strong>和<strong>分布式架构</strong>等高级架构（需要其他第三方软件支持）。</p>
<p><strong>高可用架构：</strong></p>
<ul>
<li>单活：MMM（Keepalived+2主1从），MHA（1主2从），TMHA（1主1从）</li>
<li>多活：NDB Cluster（收费），InnoDB Cluster，PXC（Percona XtraDB Cluster，国内用的较少），MGC（MariaDB Galera Cluster ）</li>
</ul>
<p><strong>高性能架构：</strong></p>
<ul>
<li>读写分离架构：Atlas（360开发的，已停止维护），Cobar，ProxySQL（Percona），MySQL Router（Oracle），Maxscale，Mycat</li>
</ul>
<p>**分布式架构：**Mycat，TDDL（阿里巴巴开发的）</p>
<hr>
<h2 id="高可用架构">
  高可用架构
  <a class="anchor" href="#%e9%ab%98%e5%8f%af%e7%94%a8%e6%9e%b6%e6%9e%84">#</a>
</h2>
<hr>
<blockquote>
<p>MHA Github：
  <a href="https://github.com/yoshinorim/mha4mysql-manager/wiki/Installation">Installation · yoshinorim/mha4mysql-manager Wiki · GitHub</a></p>
<p>MHA是“一次性”的高可用功能，每次出现主库宕机后，MHA的Manager节点都会将其从配置文件中删掉，节点恢复后需要手动将恢复后的主库节点信息再加入到配置文件中。</p>
</blockquote>
<hr>
<h3 id="mha高可用架构软件构成">
  MHA高可用架构软件构成
  <a class="anchor" href="#mha%e9%ab%98%e5%8f%af%e7%94%a8%e6%9e%b6%e6%9e%84%e8%bd%af%e4%bb%b6%e6%9e%84%e6%88%90">#</a>
</h3>
<ul>
<li>
<p>Manager工具包主要包括以下几个工具（脚本）：</p>
<p><code>masterha_manger</code>：用于启动MHA Manager的脚本</p>
<p><code>masterha_stop</code>：用于关闭MHA Manager的脚本</p>
<p><code>masterha_check_ssh</code>：检查MHA的SSH配置状况</p>
<p><code>masterha_check_repl</code>：检查MySQL复制状况</p>
<p><code>masterha_master_monitor</code>：检测Master是否宕机</p>
<p><code>masterha_check_status</code>：检测当前MHA运行状态</p>
<p><code>masterha_master_switch</code>：控制故障转移（自动或者手动）</p>
<p><code>masterha_conf_host</code>：添加或删除配置的Server信息</p>
</li>
<li>
<p>Node工具包主要包括以下几个工具：</p>
<blockquote>
<p>这些工具通常由MHA Manager的脚本触发，无需人为操作</p>
</blockquote>
<p><code>save_binary_logs</code>：保存和复制master的二进制日志 
<code>apply_diff_relay_logs</code>：识别差异的中继日志事件并将其差异的事件应用于其他的
<code>purge_relay_logs</code>：清除中继日志（不会阻塞SQL线程）</p>
</li>
</ul>
<hr>
<h3 id="mha高可用架构工作原理">
  MHA高可用架构工作原理
  <a class="anchor" href="#mha%e9%ab%98%e5%8f%af%e7%94%a8%e6%9e%b6%e6%9e%84%e5%b7%a5%e4%bd%9c%e5%8e%9f%e7%90%86">#</a>
</h3>
<ul>
<li>通过MHA配置文件获取所有节点的信息，监控节点的网络、操作系统、SSH软件的连通性和主从状态。</li>
<li>主库选举：如果主库（Master）宕机，MHA架构将会在2个从库之间进行主库的选举，通过从库（Salve）<code>show slave status;</code>命令查询到的<code>Position</code>或<code>GTID</code>与<code>relay-log</code>进行对比，当2个从库（Slave）与主库（Master）的的数据一致时，按照MHA配置文件的顺序进行主库的选举；当2个从库（Slave）与主库（Master）的数据有差异时，选择数据最接近主库的从库（Slave）为备选主库。如果在MHA配置文件中设定了从库的权重<code>candidate_master=1</code>，则按照权重强制指定相应的从库（Slave）为备选主库。默认情况下，如果一个从库（Slave）落后主库（Master）100M的<code>relay-log</code>，即使有权重也会失效；但如果<code>check_repl_delay=0</code>,即使落后很多日志，也会强制选择其为备选主机。</li>
<li>数据补偿：当SSH能连接到主库（Master）时，从库（Slave）对比主库（Master）的<code>Position</code>或<code>GTID</code>，如果数据不一致，从库的<code>save_binary_logs</code>脚本会将主库的<code>binlog</code>获取到本地；当SSH不能连接到主库（Master）时，从库的<code>apply_diff_relay_logs</code>脚本将检查与<code>relay-log</code>的差异。</li>
<li>故障切换（Failover）：将备选主库切换成主库（Master），开始对外提供服务，其余从库（Slave）和新主库确认新的主从关系。</li>
<li>应用透明（VIP）</li>
<li>故障切换通知（report_script）</li>
<li>二次数据补偿（单独设置一台Binlog_Server，记录主库的binlog日志）</li>
</ul>
<hr>
<h3 id="部署mha高可用架构">
  部署MHA高可用架构
  <a class="anchor" href="#%e9%83%a8%e7%bd%b2mha%e9%ab%98%e5%8f%af%e7%94%a8%e6%9e%b6%e6%9e%84">#</a>
</h3>
<ul>
<li>
<p>搭建主从复制（1主2从），确保主从复制状态正常。</p>
</li>
<li>
<p>如果MySQL没有安装在<code>/usr/bin</code>目录下，需要创建软连接（MHA脚本中写入的是绝对路径）。</p>
</li>
<li>
<p>配置个节点互信</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$&gt; rm -rf /root/.ssh
$&gt; ssh-keygen
$&gt; cd /root/.ssh
$&gt; mv id_rsa.pub authorized_keys
$&gt; scp -r /root/.ssh/authorized_keys 从库1（Slave）IP:/root
$&gt; scp -r /root/.ssh/authorized_keys 从库2（Slave）IP:/root
</code></pre></div></li>
<li>
<p>在三个节点上均安装Node软件</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># 安装环境依赖</span>
$&gt; yum install -y perl-DBD-MySQL

<span style="color:#75715e"># 安装Node（需提前下载）</span>
$&gt; rpm -ivh mha4mysql-node-0.56-0.el6.noarch.rpm
</code></pre></div></li>
<li>
<p>在主库（master）上安装Manager软件</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># 安装环境依赖</span>
$&gt; yum install -y perl-Config-Tiny epel-release perl-Log-Dispatch perl-Parallel-ForkManager perl-Time-HiRes

<span style="color:#75715e"># 安装Master（需提前下载）</span>
$&gt; rpm -ivh mha4mysql-manager-0.56-0.el6.noarch.rpm
</code></pre></div></li>
<li>
<p>在主库（Master）上创建MHA监控管理用户</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#75715e"># 创建用户的同时创建密码
</span><span style="color:#75715e"></span><span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">USER</span> mha<span style="color:#f92672">@</span><span style="color:#e6db74">&#39;10.0.0.%&#39;</span> <span style="color:#66d9ef">IDENTIFIED</span> <span style="color:#66d9ef">BY</span> <span style="color:#e6db74">&#39;mha&#39;</span>;
<span style="color:#75715e"># 对mha用户进行授权
</span><span style="color:#75715e"></span><span style="color:#66d9ef">GRANT</span> <span style="color:#66d9ef">ALL</span> <span style="color:#66d9ef">PRIVILEGES</span> <span style="color:#66d9ef">ON</span> <span style="color:#f92672">*</span>.<span style="color:#f92672">*</span> <span style="color:#66d9ef">TO</span> mha<span style="color:#f92672">@</span><span style="color:#e6db74">&#39;10.0.0.%&#39;</span>;
</code></pre></div></li>
<li>
<p>在主库（Master）上准备MHA配置文件</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># 创建配置文件目录</span>
$&gt; mkdir -p /etc/mha

<span style="color:#75715e"># 创建日志目录</span>
$&gt; mkdir -p /var/log/mha/app1

<span style="color:#75715e"># 编辑 /etc/mha/app1.cnf 文件，内容如下：</span>
<span style="color:#f92672">[</span>server default<span style="color:#f92672">]</span>
manager_log<span style="color:#f92672">=</span>/var/log/mha/app1/manager
manager_workdir<span style="color:#f92672">=</span>/var/log/mha/app1
master_binlog_dir<span style="color:#f92672">=</span>/data/mysql/binlog
user<span style="color:#f92672">=</span>mha
password<span style="color:#f92672">=</span>mha
ping_interval<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>
repl_user<span style="color:#f92672">=</span>repl
repl_password<span style="color:#f92672">=</span><span style="color:#ae81ff">123</span>
ssh_user<span style="color:#f92672">=</span>root
<span style="color:#f92672">[</span>server1<span style="color:#f92672">]</span>
hostname<span style="color:#f92672">=</span>10.0.0.x
port<span style="color:#f92672">=</span><span style="color:#ae81ff">3306</span>
<span style="color:#f92672">[</span>server2<span style="color:#f92672">]</span>
hostname<span style="color:#f92672">=</span>10.0.0.x
port<span style="color:#f92672">=</span><span style="color:#ae81ff">3306</span>
</code></pre></div></li>
<li>
<p>检查节点的SSH互信状态</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$&gt; masterha_check_ssh --conf<span style="color:#f92672">=</span>/etc/mha/app1.cnf
</code></pre></div></li>
<li>
<p>检查主从状态</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$&gt; masterha_check_repl --conf<span style="color:#f92672">=</span>/etc/mha/app1.cnf
</code></pre></div></li>
<li>
<p>启动MHA的Manager</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$&gt; nohup masterha_manager --conf<span style="color:#f92672">=</span>/etc/mha/app1.cnf --remove_dead_master_conf --ignore_last_failover &lt;/dev/null&gt; /var/log/mha/app1/manager.log 2&gt;&amp;<span style="color:#ae81ff">1</span> &amp;
</code></pre></div></li>
<li>
<p>检查MHA状态</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$&gt; masterha_check_status --conf<span style="color:#f92672">=</span>/etc/mha/app1.cnf
</code></pre></div></li>
</ul>
<hr>
<h3 id="mha的应用透明vip">
  MHA的应用透明（VIP）
  <a class="anchor" href="#mha%e7%9a%84%e5%ba%94%e7%94%a8%e9%80%8f%e6%98%8evip">#</a>
</h3>
<ul>
<li>
<p>准备<code>master_ip_failover</code>脚本</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-perl" data-lang="perl"><span style="color:#75715e">#!/usr/bin/env perl</span>

<span style="color:#75715e">#  Copyright (C) 2011 DeNA Co.,Ltd.</span>
<span style="color:#75715e">#</span>
<span style="color:#75715e">#  This program is free software; you can redistribute it and/or modify</span>
<span style="color:#75715e">#  it under the terms of the GNU General Public License as published by</span>
<span style="color:#75715e">#  the Free Software Foundation; either version 2 of the License, or</span>
<span style="color:#75715e">#  (at your option) any later version.</span>
<span style="color:#75715e">#</span>
<span style="color:#75715e">#  This program is distributed in the hope that it will be useful,</span>
<span style="color:#75715e">#  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span style="color:#75715e">#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span style="color:#75715e">#  GNU General Public License for more details.</span>
<span style="color:#75715e">#</span>
<span style="color:#75715e">#  You should have received a copy of the GNU General Public License</span>
<span style="color:#75715e">#   along with this program; if not, write to the Free Software</span>
<span style="color:#75715e">#  Foundation, Inc.,</span>
<span style="color:#75715e">#  51 Franklin Street, Fifth Floor, Boston, MA  02110-1301  USA</span>

<span style="color:#75715e">## Note: This is a sample script and is not complete. Modify the script based on your environment.</span>

<span style="color:#66d9ef">use</span> strict;
<span style="color:#66d9ef">use</span> warnings FATAL <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;all&#39;</span>;

<span style="color:#66d9ef">use</span> Getopt::Long;
<span style="color:#66d9ef">use</span> MHA::DBHelper;

<span style="color:#66d9ef">my</span> (
  $command,        $ssh_user,         $orig_master_host,
  $orig_master_ip, $orig_master_port, $new_master_host,
  $new_master_ip,  $new_master_port,  $new_master_user,
  $new_master_password
);
<span style="color:#66d9ef">my</span> $vip <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;192.168.168.100/24&#39;</span>;
<span style="color:#66d9ef">my</span> $key <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;1&#34;</span>;
<span style="color:#66d9ef">my</span> $ssh_start_vip <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;/sbin/ifconfig ens33:$key $vip&#34;</span>;
<span style="color:#66d9ef">my</span> $ssh_stop_vip <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;/sbin/ifconfig ens33:$key down&#34;</span>;

GetOptions(
  <span style="color:#e6db74">&#39;command=s&#39;</span>             <span style="color:#f92672">=&gt;</span> <span style="color:#f92672">\</span>$command,
  <span style="color:#e6db74">&#39;ssh_user=s&#39;</span>            <span style="color:#f92672">=&gt;</span> <span style="color:#f92672">\</span>$ssh_user,
  <span style="color:#e6db74">&#39;orig_master_host=s&#39;</span>    <span style="color:#f92672">=&gt;</span> <span style="color:#f92672">\</span>$orig_master_host,
  <span style="color:#e6db74">&#39;orig_master_ip=s&#39;</span>      <span style="color:#f92672">=&gt;</span> <span style="color:#f92672">\</span>$orig_master_ip,
  <span style="color:#e6db74">&#39;orig_master_port=i&#39;</span>    <span style="color:#f92672">=&gt;</span> <span style="color:#f92672">\</span>$orig_master_port,
  <span style="color:#e6db74">&#39;new_master_host=s&#39;</span>     <span style="color:#f92672">=&gt;</span> <span style="color:#f92672">\</span>$new_master_host,
  <span style="color:#e6db74">&#39;new_master_ip=s&#39;</span>       <span style="color:#f92672">=&gt;</span> <span style="color:#f92672">\</span>$new_master_ip,
  <span style="color:#e6db74">&#39;new_master_port=i&#39;</span>     <span style="color:#f92672">=&gt;</span> <span style="color:#f92672">\</span>$new_master_port,
  <span style="color:#e6db74">&#39;new_master_user=s&#39;</span>     <span style="color:#f92672">=&gt;</span> <span style="color:#f92672">\</span>$new_master_user,
  <span style="color:#e6db74">&#39;new_master_password=s&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#f92672">\</span>$new_master_password,
);

exit <span style="color:#f92672">&amp;</span>main();

<span style="color:#66d9ef">sub</span> <span style="color:#a6e22e">main</span> {
  <span style="color:#66d9ef">if</span> ( $command <span style="color:#f92672">eq</span> <span style="color:#e6db74">&#34;stop&#34;</span> <span style="color:#f92672">||</span> $command <span style="color:#f92672">eq</span> <span style="color:#e6db74">&#34;stopssh&#34;</span> ) {

    <span style="color:#75715e"># $orig_master_host, $orig_master_ip, $orig_master_port are passed.</span>
    <span style="color:#75715e"># If you manage master ip address at global catalog database,</span>
    <span style="color:#75715e"># invalidate orig_master_ip here.</span>
    <span style="color:#66d9ef">my</span> $exit_code <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
    eval {

      <span style="color:#75715e"># updating global catalog, etc</span>
      $exit_code <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    };
    <span style="color:#66d9ef">if</span> ($@) {
      warn <span style="color:#e6db74">&#34;Got Error: $@\n&#34;</span>;
      exit $exit_code;
    }
    exit $exit_code;
  }
    <span style="color:#66d9ef">elsif</span> ( $command <span style="color:#f92672">eq</span> <span style="color:#e6db74">&#34;start&#34;</span> ) {
        <span style="color:#75715e"># all arguments are passed.</span>
        <span style="color:#75715e"># If you manage master ip address at global catalog database,</span>
        <span style="color:#75715e"># activate new_master_ip here.</span>
        <span style="color:#75715e"># You can also grant write access (create user, set read_only=0, etc) here.</span>
        <span style="color:#66d9ef">my</span> $exit_code <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>;
        eval {
            <span style="color:#66d9ef">print</span> <span style="color:#e6db74">&#34;Enabling the VIP - $vip on the new master - $new_master_host \n&#34;</span>;
            <span style="color:#f92672">&amp;</span>start_vip();
            <span style="color:#f92672">&amp;</span>stop_vip();
            $exit_code <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
        };
        <span style="color:#66d9ef">if</span> ($@) {
            warn $@;
            exit $exit_code;
        }
        exit $exit_code;
    }
    <span style="color:#66d9ef">elsif</span> ( $command <span style="color:#f92672">eq</span> <span style="color:#e6db74">&#34;status&#34;</span> ) {
        <span style="color:#66d9ef">print</span> <span style="color:#e6db74">&#34;Checking the Status of the script.. OK \n&#34;</span>;
        <span style="color:#e6db74">`ssh $ssh_user\@$orig_master_host \&#34; $ssh_start_vip \&#34;`</span>;
        exit <span style="color:#ae81ff">0</span>;
    }
    <span style="color:#66d9ef">else</span> {
        <span style="color:#f92672">&amp;</span>usage();
        exit <span style="color:#ae81ff">1</span>;
    }
}

<span style="color:#66d9ef">sub</span> <span style="color:#a6e22e">start_vip</span>() {
    <span style="color:#e6db74">`ssh $ssh_user\@$new_master_host \&#34; $ssh_start_vip \&#34;`</span>;
}
<span style="color:#75715e"># A simple system call that disable the VIP on the old_master </span>
<span style="color:#66d9ef">sub</span> <span style="color:#a6e22e">stop_vip</span>() {
   <span style="color:#e6db74">`ssh $ssh_user\@$orig_master_host \&#34; $ssh_stop_vip \&#34;`</span>;
}

<span style="color:#66d9ef">sub</span> <span style="color:#a6e22e">usage</span> {
  <span style="color:#66d9ef">print</span>
<span style="color:#e6db74">&#34;Usage: master_ip_failover --command=start|stop|stopssh|status --orig_master_host=host --orig_master_ip=ip --orig_master_port=port --new_master_host=host --new_master_ip=ip --new_master_port=port\n&#34;</span>;
}
</code></pre></div></li>
<li>
<p>将<code>master_ip_failover</code>脚本上传至MHA Manager的<code>/usr/local/bin</code>中，并赋予执行权限</p>
</li>
<li>
<p>在MHA Manager的<code>/etc/mha/app1.cnf</code>配置文件中增加如下内容，调用脚本文件</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">master_ip_failover_script<span style="color:#f92672">=</span>/usr/local/bin/master_ip_failover
</code></pre></div></li>
<li>
<p>第一次配置VIP的时候，需要在主库（Master）上手动生成VIP</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$&gt; ifconfig ens33:1 192.168.168.100
</code></pre></div></li>
<li>
<p>在MHA Manager上重启Manager</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$&gt; masterha_stop --conf<span style="color:#f92672">=</span>/etc/mha/app1.cnf
$&gt; nohup masterha_manager --conf<span style="color:#f92672">=</span>/etc/mha/app1.cnf --remove_dead_master_conf --ignore_last_failover &lt;/dev/null&gt; /var/log/mha/app1/manager.log 2&gt;&amp;<span style="color:#ae81ff">1</span> &amp;
</code></pre></div></li>
</ul>
<hr>
<h3 id="mha故障提醒">
  MHA故障提醒
  <a class="anchor" href="#mha%e6%95%85%e9%9a%9c%e6%8f%90%e9%86%92">#</a>
</h3>
<ul>
<li>
<p>准备<code>report_script</code>脚本文件</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-perl" data-lang="perl"><span style="color:#75715e">#!/usr/bin/perl</span>

<span style="color:#75715e">#  Copyright (C) 2011 DeNA Co.,Ltd.</span>
<span style="color:#75715e">#</span>
<span style="color:#75715e">#  This program is free software; you can redistribute it and/or modify</span>
<span style="color:#75715e">#  it under the terms of the GNU General Public License as published by</span>
<span style="color:#75715e">#  the Free Software Foundation; either version 2 of the License, or</span>
<span style="color:#75715e">#  (at your option) any later version.</span>
<span style="color:#75715e">#</span>
<span style="color:#75715e">#  This program is distributed in the hope that it will be useful,</span>
<span style="color:#75715e">#  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span style="color:#75715e">#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span style="color:#75715e">#  GNU General Public License for more details.</span>
<span style="color:#75715e">#</span>
<span style="color:#75715e">#  You should have received a copy of the GNU General Public License</span>
<span style="color:#75715e">#   along with this program; if not, write to the Free Software</span>
<span style="color:#75715e">#  Foundation, Inc.,</span>
<span style="color:#75715e">#  51 Franklin Street, Fifth Floor, Boston, MA  02110-1301  USA</span>

<span style="color:#75715e">## Note: This is a sample script and is not complete. Modify the script based on your environment.</span>

<span style="color:#66d9ef">use</span> strict;
<span style="color:#66d9ef">use</span> warnings FATAL <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;all&#39;</span>;
<span style="color:#66d9ef">use</span> Mail::Sender;
<span style="color:#66d9ef">use</span> Getopt::Long;

<span style="color:#75715e">#new_master_host and new_slave_hosts are set only when recovering master succeeded</span>
<span style="color:#66d9ef">my</span> ( $dead_master_host, $new_master_host, $new_slave_hosts, $subject, $body );

<span style="color:#66d9ef">my</span> $smtp<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;smtp.163.com&#39;</span>;　　<span style="color:#75715e"># 这里的smtp可以查看要使用的邮箱的smtp值, 或者百度</span>
<span style="color:#66d9ef">my</span> $mail_from<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;from@163.com&#39;</span>;　　<span style="color:#75715e"># 填写邮箱</span>
<span style="color:#66d9ef">my</span> $mail_user<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;from@163.com&#39;</span>;　　<span style="color:#75715e"># 填写邮箱</span>
<span style="color:#66d9ef">my</span> $mail_pass<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;password&#39;</span>;　　<span style="color:#75715e"># 注意这里的密码是邮箱开启smtp服务时设定的密码, 不是邮箱的登陆密码</span>
<span style="color:#75715e">#my $mail_to=[&#39;to1@qq.com&#39;,&#39;to2@qq.com&#39;];</span>
<span style="color:#66d9ef">my</span> $mail_to<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;to@qq.com&#39;</span>;　　<span style="color:#75715e"># 接受邮件的邮箱</span>

GetOptions(
  <span style="color:#e6db74">&#39;orig_master_host=s&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#f92672">\</span>$dead_master_host,
  <span style="color:#e6db74">&#39;new_master_host=s&#39;</span>  <span style="color:#f92672">=&gt;</span> <span style="color:#f92672">\</span>$new_master_host,
  <span style="color:#e6db74">&#39;new_slave_hosts=s&#39;</span>  <span style="color:#f92672">=&gt;</span> <span style="color:#f92672">\</span>$new_slave_hosts,
  <span style="color:#e6db74">&#39;subject=s&#39;</span>          <span style="color:#f92672">=&gt;</span> <span style="color:#f92672">\</span>$subject,
  <span style="color:#e6db74">&#39;body=s&#39;</span>             <span style="color:#f92672">=&gt;</span> <span style="color:#f92672">\</span>$body,
);

<span style="color:#75715e"># Do whatever you want here</span>
mailToContacts($smtp,$mail_from,$mail_user,$mail_pass,$mail_to,$subject,$body);

<span style="color:#66d9ef">sub</span> <span style="color:#a6e22e">mailToContacts</span> {
    <span style="color:#66d9ef">my</span> ($smtp, $mail_from, $mail_user, $mail_pass, $mail_to, $subject, $msg ) <span style="color:#f92672">=</span> @_;
    open <span style="color:#66d9ef">my</span> $DEBUG, <span style="color:#e6db74">&#34;&gt;/var/log/masterha/app1/mail.log&#34;</span>　　<span style="color:#75715e"># 这里的路径需要修改,改成一个真是存在的路径即可</span>
        <span style="color:#f92672">or</span> die <span style="color:#e6db74">&#34;Can&#39;t open the debug    file:$!\n&#34;</span>;
    <span style="color:#66d9ef">my</span> $sender <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Mail::Sender {
        ctype        <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;text/plain;charset=utf-8&#39;</span>,
        encoding    <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;utf-8&#39;</span>,
        smtp        <span style="color:#f92672">=&gt;</span> $smtp,
        from        <span style="color:#f92672">=&gt;</span> $mail_from,
        auth        <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;LOGIN&#39;</span>,
        TLS_allowed    <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;0&#39;</span>,
        authid        <span style="color:#f92672">=&gt;</span> $mail_user,
        authpwd        <span style="color:#f92672">=&gt;</span> $mail_pass,
        to        <span style="color:#f92672">=&gt;</span> $mail_to,
        subject        <span style="color:#f92672">=&gt;</span> $subject,
        debug        <span style="color:#f92672">=&gt;</span> $DEBUG
    };
    $sender<span style="color:#f92672">-&gt;</span>MailMsg(
        {
            msg <span style="color:#f92672">=&gt;</span> $msg,
            debug <span style="color:#f92672">=&gt;</span> $DEBUG
        }
    ) <span style="color:#f92672">or</span> <span style="color:#66d9ef">print</span> $Mail::Sender::Error;
    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>;
}

exit <span style="color:#ae81ff">0</span>;
</code></pre></div></li>
<li>
<p>将<code>report_script</code>脚本上传至MHA Manager的<code>/usr/local/bin</code>中，并赋予执行权限</p>
</li>
<li>
<p>在MHA Manager的<code>/etc/mha/app1.cnf</code>配置文件中增加如下内容，调用脚本文件</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">report_script<span style="color:#f92672">=</span>/usr/local/bin/report_script
</code></pre></div></li>
<li>
<p>在MHA Manager上重启Manager</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$&gt; masterha_stop --conf<span style="color:#f92672">=</span>/etc/mha/app1.cnf
$&gt; nohup masterha_manager --conf<span style="color:#f92672">=</span>/etc/mha/app1.cnf --remove_dead_master_conf --ignore_last_failover &lt;/dev/null&gt; /var/log/mha/app1/manager.log 2&gt;&amp;<span style="color:#ae81ff">1</span> &amp;
</code></pre></div></li>
</ul>
<hr>
<h3 id="二次数据补偿">
  二次数据补偿
  <a class="anchor" href="#%e4%ba%8c%e6%ac%a1%e6%95%b0%e6%8d%ae%e8%a1%a5%e5%81%bf">#</a>
</h3>
<ul>
<li>
<p>如果使用其中一个从库作为Binlog_Server，需要提前建立好备份<code>binlog</code>的文件夹，在MHA Manager的<code>/etc/mha/app1.cnf</code>配置文件中增加如下内容</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#f92672">[</span>binlog1<span style="color:#f92672">]</span>
no_master<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>
hostname<span style="color:#f92672">=</span>x.x.x.x
master_binlog_dir<span style="color:#f92672">=</span>/data/mysql/binlog
</code></pre></div></li>
<li>
<p>进入<code>binlog</code>的备份文件夹，拉取主库的<code>binlog</code>日志</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$&gt; mysqlbinlog -R --host<span style="color:#f92672">=</span>x.x.x.x --user<span style="color:#f92672">=</span>mha --password<span style="color:#f92672">=</span>mha --raw --stop-nnever mysql-bin.000001 &amp;
</code></pre></div></li>
<li>
<p>在MHA Manager上重启Manager</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$&gt; masterha_stop --conf<span style="color:#f92672">=</span>/etc/mha/app1.cnf
$&gt; nohup masterha_manager --conf<span style="color:#f92672">=</span>/etc/mha/app1.cnf --remove_dead_master_conf --ignore_last_failover &lt;/dev/null&gt; /var/log/mha/app1/manager.log 2&gt;&amp;<span style="color:#ae81ff">1</span> &amp;
</code></pre></div></li>
</ul>
<hr>
<h2 id="高性能架构读写分离">
  高性能架构（读写分离）
  <a class="anchor" href="#%e9%ab%98%e6%80%a7%e8%83%bd%e6%9e%b6%e6%9e%84%e8%af%bb%e5%86%99%e5%88%86%e7%a6%bb">#</a>
</h2>
<hr>
<p>MyCAT官网：
  <a href="http://www.mycat.org.cn/">Mycat2</a></p>
<h2 id="分布式架构">
  分布式架构
  <a class="anchor" href="#%e5%88%86%e5%b8%83%e5%bc%8f%e6%9e%b6%e6%9e%84">#</a>
</h2>
<hr>
<p>MyCAT官网：
  <a href="http://www.mycat.org.cn/">Mycat2</a></p>
</article>
 
      

      <footer class="book-footer">
        
  <div class="flex flex-wrap justify-between">





</div>



  <script>(function(){function a(c){const a=window.getSelection(),b=document.createRange();b.selectNodeContents(c),a.removeAllRanges(),a.addRange(b)}document.querySelectorAll("pre code").forEach(b=>{b.addEventListener("click",function(c){a(b.parentElement),navigator.clipboard&&navigator.clipboard.writeText(b.parentElement.textContent)})})})()</script>


 
        
      </footer>

      
  
  <div class="book-comments">

</div>
  
 

      <label for="menu-control" class="hidden book-menu-overlay"></label>
    </div>

    
    <aside class="book-toc">
      <div class="book-toc-content">
        
  
<nav id="TableOfContents">
  <ul>
    <li><a href="#mysql相关产品介绍">MySQL相关产品介绍</a></li>
    <li><a href="#mysql版本介绍">MySQL版本介绍</a></li>
    <li><a href="#mysql安装">MySQL安装</a>
      <ul>
        <li><a href="#安装版本的选择">安装版本的选择</a></li>
        <li><a href="#二进制文件安装">二进制文件安装</a></li>
        <li><a href="#环境准备">环境准备</a>
          <ul>
            <li><a href="#清理历史环境">清理历史环境</a></li>
            <li><a href="#安装mysql依赖">安装MySQL依赖</a></li>
            <li><a href="#创建用户和组">创建用户和组</a></li>
            <li><a href="#创建相关目录">创建相关目录</a></li>
          </ul>
        </li>
        <li><a href="#安装软件">安装软件</a>
          <ul>
            <li><a href="#软件下载">软件下载</a></li>
            <li><a href="#设置环境变量">设置环境变量</a></li>
            <li><a href="#初始化mysql">初始化MySQL</a></li>
            <li><a href="#配置文件">配置文件</a></li>
          </ul>
        </li>
        <li><a href="#启动服务">启动服务</a>
          <ul>
            <li><a href="#准备mysql的启动脚本">准备MySQL的启动脚本</a></li>
            <li><a href="#启动mysql服务">启动MySQL服务</a></li>
            <li><a href="#修改mysql初始密码">修改MySQL初始密码</a></li>
            <li><a href="#允许root用户远程访问">允许ROOT用户远程访问</a></li>
            <li><a href="#关闭mysql服务">关闭MySQL服务</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#mysql体系结构">MySQL体系结构</a>
      <ul>
        <li><a href="#mysql登录方式">MySQL登录方式</a></li>
        <li><a href="#mysql实例">MySQL实例</a></li>
        <li><a href="#管理工具和服务management-serveices--utilities">管理工具和服务（Management Serveices &amp; Utilities）</a></li>
        <li><a href="#连接池connection-pool">连接池（Connection Pool）</a></li>
        <li><a href="#sql接口sql-interface">SQL接口（SQL Interface）</a></li>
        <li><a href="#解析器parser">解析器（Parser）</a></li>
        <li><a href="#查询优化器optimizer">查询优化器（Optimizer）</a></li>
        <li><a href="#缓存器caches--buffers">缓存器（Caches &amp; Buffers）</a></li>
        <li><a href="#存储引擎pluggable-storage-engines">存储引擎（Pluggable Storage Engines）</a></li>
        <li><a href="#文件系统file-system">文件系统（File System）</a></li>
      </ul>
    </li>
    <li><a href="#mysql基础管理">MySQL基础管理</a>
      <ul>
        <li><a href="#用户管理">用户管理</a></li>
        <li><a href="#用户授权">用户授权</a>
          <ul>
            <li><a href="#查看系统权限">查看系统权限</a></li>
            <li><a href="#对用户授权">对用户授权</a></li>
            <li><a href="#破解管理员密码">破解管理员密码</a></li>
          </ul>
        </li>
        <li><a href="#连接管理">连接管理</a>
          <ul>
            <li><a href="#本地连接">本地连接</a></li>
            <li><a href="#远程连接">远程连接</a></li>
            <li><a href="#免交互执行sql语句">免交互执行SQL语句</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#mysql多实例">MySQL多实例</a>
      <ul>
        <li><a href="#相同mysql版本的多实例">相同MySQL版本的多实例</a>
          <ul>
            <li><a href="#规划">规划</a></li>
            <li><a href="#配置过程">配置过程</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#mysql基础语句">MySQL基础语句</a>
      <ul>
        <li><a href="#mysql语言结构">MySQL语言结构</a></li>
        <li><a href="#mysql中字符集和排序规则">MySQL中字符集和排序规则</a></li>
        <li><a href="#mysql数据类型">MySQL数据类型</a></li>
        <li><a href="#mysql约束">MySQL约束</a></li>
        <li><a href="#mysql数据类型默认值和注释">MySQL数据类型默认值和注释</a></li>
        <li><a href="#ddl数据定义语言">DDL：数据定义语言</a>
          <ul>
            <li><a href="#数据库定义">数据库定义</a></li>
            <li><a href="#数据表定义">数据表定义</a></li>
          </ul>
        </li>
        <li><a href="#dcl数据控制语言">DCL：数据控制语言</a></li>
        <li><a href="#dml数据操作语言">DML：数据操作语言</a></li>
        <li><a href="#dql数据查询语言">DQL：数据查询语言</a>
          <ul>
            <li><a href="#select">SELECT</a></li>
            <li><a href="#show">SHOW</a></li>
            <li><a href="#union和union-all">UNION和UNION ALL</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#mysql索引">MySQL索引</a>
      <ul>
        <li><a href="#主键索引">主键索引</a></li>
        <li><a href="#辅助索引">辅助索引</a>
          <ul>
            <li><a href="#普通索引">普通索引</a></li>
            <li><a href="#联合索引">联合索引</a></li>
            <li><a href="#前缀索引">前缀索引</a></li>
            <li><a href="#唯一索引">唯一索引</a></li>
          </ul>
        </li>
        <li><a href="#执行计划">执行计划</a>
          <ul>
            <li><a href="#查看执行计划">查看执行计划</a></li>
            <li><a href="#执行计划结果">执行计划结果</a></li>
          </ul>
        </li>
        <li><a href="#索引应用规范">索引应用规范</a></li>
        <li><a href="#创建索引的原则">创建索引的原则</a></li>
        <li><a href="#导致索引失效的常见原因">导致索引失效的常见原因</a></li>
        <li><a href="#优化器针对索引的算法介绍">优化器针对索引的算法介绍</a>
          <ul>
            <li><a href="#ahiadaptive-hash-index-自适应-hash-索引">AHI（Adaptive Hash Index） 自适应 Hash 索引</a></li>
            <li><a href="#change-buffer">Change Buffer</a></li>
            <li><a href="#icpindex-condition-pushdown索引下推">ICP（Index Condition Pushdown）索引下推</a></li>
            <li><a href="#mrr算法">MRR算法</a></li>
            <li><a href="#snlj算法">SNLJ算法</a></li>
            <li><a href="#bnlj算法">BNLJ算法</a></li>
            <li><a href="#bka算法">BKA算法</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#mysql存储引擎">MySQL存储引擎</a>
      <ul>
        <li><a href="#innodb的特性">InnoDB的特性</a></li>
      </ul>
    </li>
    <li><a href="#mysql日志管理">MySQL日志管理</a>
      <ul>
        <li><a href="#错误日志">错误日志</a></li>
        <li><a href="#二进制日志binlog">二进制日志（binlog）</a>
          <ul>
            <li><a href="#配置方法">配置方法</a></li>
            <li><a href="#维护操作">维护操作</a></li>
          </ul>
        </li>
        <li><a href="#慢日志slowlog">慢日志（slowlog）</a>
          <ul>
            <li><a href="#配置方法-1">配置方法</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#mysql备份与恢复">MySQL备份与恢复</a>
      <ul>
        <li><a href="#dba备份与恢复的职责">DBA备份与恢复的职责</a></li>
        <li><a href="#mysql常用备份工具">MySQL常用备份工具</a>
          <ul>
            <li><a href="#逻辑备份方式">逻辑备份方式</a></li>
            <li><a href="#物理备份方式">物理备份方式</a></li>
          </ul>
        </li>
        <li><a href="#mysql备份恢复">MySQL备份恢复</a>
          <ul>
            <li><a href="#检查全备">检查全备</a></li>
            <li><a href="#恢复全备">恢复全备</a></li>
            <li><a href="#截取二进制日志binlog">截取二进制日志（binlog）</a></li>
            <li><a href="#恢复二进制日志binlog">恢复二进制日志（binlog）</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#主从复制">主从复制</a>
      <ul>
        <li><a href="#部署主从复制">部署主从复制</a></li>
        <li><a href="#清空主从复制">清空主从复制</a></li>
        <li><a href="#主从复制原理">主从复制原理</a>
          <ul>
            <li><a href="#主从复制的中涉及到的资源">主从复制的中涉及到的资源</a></li>
            <li><a href="#主从复制工作原理的描述">主从复制工作原理的描述</a></li>
          </ul>
        </li>
        <li><a href="#主从复制的状态监控">主从复制的状态监控</a></li>
        <li><a href="#主从故障分析及处理">主从故障分析及处理</a>
          <ul>
            <li><a href="#io线程故障">IO线程故障</a></li>
            <li><a href="#sql线程故障">SQL线程故障</a></li>
          </ul>
        </li>
        <li><a href="#主从延迟分析及处理">主从延迟分析及处理</a>
          <ul>
            <li><a href="#主库master原因">主库（master）原因</a></li>
            <li><a href="#从库slave原因">从库（slave）原因</a></li>
          </ul>
        </li>
        <li><a href="#特殊从库的应用">特殊从库的应用</a>
          <ul>
            <li><a href="#延时从库">延时从库</a></li>
            <li><a href="#半同步复制">半同步复制</a></li>
            <li><a href="#过滤复制">过滤复制</a></li>
            <li><a href="#gtid复制">GTID复制</a></li>
          </ul>
        </li>
        <li><a href="#主从复制架构演变">主从复制架构演变</a></li>
        <li><a href="#高可用架构">高可用架构</a>
          <ul>
            <li><a href="#mha高可用架构软件构成">MHA高可用架构软件构成</a></li>
            <li><a href="#mha高可用架构工作原理">MHA高可用架构工作原理</a></li>
            <li><a href="#部署mha高可用架构">部署MHA高可用架构</a></li>
            <li><a href="#mha的应用透明vip">MHA的应用透明（VIP）</a></li>
            <li><a href="#mha故障提醒">MHA故障提醒</a></li>
            <li><a href="#二次数据补偿">二次数据补偿</a></li>
          </ul>
        </li>
        <li><a href="#高性能架构读写分离">高性能架构（读写分离）</a></li>
        <li><a href="#分布式架构">分布式架构</a></li>
      </ul>
    </li>
  </ul>
</nav>


 
      </div>
    </aside>
    
  </main>

  
</body>
</html>












