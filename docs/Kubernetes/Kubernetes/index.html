<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="Kubernetes（K8S）# Kubernetes的基本概念# Pod# Pod是Kubernetes中能够被运行的最小逻辑单元（原子单元），一个Pod里面可以运行多个容器，他们共享UTS&#43;NET&#43;IPC名称空间，可以把Pod理解成豌豆荚，而同一个Pod中的每一个容器都是一颗颗的豌豆，一个Pod中运行多个容器，又叫边车（SideCar）模式。（边车就是侉子摩托）
 Pod控制器# Pod控制器是Pod启动的一种模式，用来保证在Kubernetes中启动的Pod应始终按照预期运行（副本数、生命周期和健康状态检查等）。
虽然Pod可以不通过Pod控制器，单独启动并运行在Kubernetes中，但在生产环境中强烈建议使用Pod控制器控制Pod。
Kubernetes中提供了众多的Pod控制器，常用的有以下几种：
 Deployment DeamonSet ReplicaSet StatefulSet Job Cronjob   Name# 由于Kubernetes内部使用“资源”来定义每一种逻辑概念（功能），故每种“资源”都应该有自己的名称。
“资源”有API版本（API Version）、类别（kind）、元数据（metadata）、定义清单（spec）、状态（status）等配置信息。
“名称”通常定义在“资源”的“元数据（metadata）”信息里。
 Namespace# 随着项目的增多、人员的增加、集群规模的扩大，需要一种能够隔离Kubernetes内各种“资源”的方法，这就是Namcespace（名称空间）。
Namespace可以理解为把Kubernetes的内部资源进行了分组，类似于一个公司的各个部门（行政、人力、财务、研发、销售等）。
不同Namespace内的“资源”，名称可以相同，相同Namespace内的同种“资源”，“名称”不能相同（可以理解为A机房中的服务器不能有相同的编号，但是B机房中的服务器可以跟A机房中的服务器的编号相同）。
合理的使用Kubernetes的Namespace，使得集群管理源能够更好的对交付到Kubernetes中的服务进行分类管理和浏览。
Kubernetes中默认存在的Namespace有：default、kube-system、kube-public。
查询Kubernetes中特定的“资源”要带上相应的Namespace。
 Label# 标签是Kubernetes特色的管理方式，便于分类管理资源对象。
一个标签可以对应多个资源，一个资源也可以有多个标签，他们是多对多的关心。
一个资源拥有多个标签，可以实现不同维度的管理。
标签的组成：key = value
与标签类似的，还有一种“注解（annotaions）”
 Lable选择器# 给资源打上标签后，可以使用标签选择器过滤指定标签。
标签选择器目前有两个：基于等值关系（等于、不等于）和基于合关系（属于、不属于、存在）。
许多资源支持内嵌标签选择字段：
 matchLable matchExpressions   Service# 在Kubernetes的世界里，虽然每一个Pod都会被分配一个单独的IP地址，但这个IP地址会随着Pod的销毁而消失，Pod是有生命周期的，每一次Pod的变更，其IP地址都会随之而变，随之而来的问题就是其流量如何调度，而Service（服务）就是用来解决这个问题的。">
<meta name="theme-color" content="#FFFFFF">
<meta name="color-scheme" content="light dark"><meta property="og:title" content="" />
<meta property="og:description" content="Kubernetes（K8S）# Kubernetes的基本概念# Pod# Pod是Kubernetes中能够被运行的最小逻辑单元（原子单元），一个Pod里面可以运行多个容器，他们共享UTS&#43;NET&#43;IPC名称空间，可以把Pod理解成豌豆荚，而同一个Pod中的每一个容器都是一颗颗的豌豆，一个Pod中运行多个容器，又叫边车（SideCar）模式。（边车就是侉子摩托）
 Pod控制器# Pod控制器是Pod启动的一种模式，用来保证在Kubernetes中启动的Pod应始终按照预期运行（副本数、生命周期和健康状态检查等）。
虽然Pod可以不通过Pod控制器，单独启动并运行在Kubernetes中，但在生产环境中强烈建议使用Pod控制器控制Pod。
Kubernetes中提供了众多的Pod控制器，常用的有以下几种：
 Deployment DeamonSet ReplicaSet StatefulSet Job Cronjob   Name# 由于Kubernetes内部使用“资源”来定义每一种逻辑概念（功能），故每种“资源”都应该有自己的名称。
“资源”有API版本（API Version）、类别（kind）、元数据（metadata）、定义清单（spec）、状态（status）等配置信息。
“名称”通常定义在“资源”的“元数据（metadata）”信息里。
 Namespace# 随着项目的增多、人员的增加、集群规模的扩大，需要一种能够隔离Kubernetes内各种“资源”的方法，这就是Namcespace（名称空间）。
Namespace可以理解为把Kubernetes的内部资源进行了分组，类似于一个公司的各个部门（行政、人力、财务、研发、销售等）。
不同Namespace内的“资源”，名称可以相同，相同Namespace内的同种“资源”，“名称”不能相同（可以理解为A机房中的服务器不能有相同的编号，但是B机房中的服务器可以跟A机房中的服务器的编号相同）。
合理的使用Kubernetes的Namespace，使得集群管理源能够更好的对交付到Kubernetes中的服务进行分类管理和浏览。
Kubernetes中默认存在的Namespace有：default、kube-system、kube-public。
查询Kubernetes中特定的“资源”要带上相应的Namespace。
 Label# 标签是Kubernetes特色的管理方式，便于分类管理资源对象。
一个标签可以对应多个资源，一个资源也可以有多个标签，他们是多对多的关心。
一个资源拥有多个标签，可以实现不同维度的管理。
标签的组成：key = value
与标签类似的，还有一种“注解（annotaions）”
 Lable选择器# 给资源打上标签后，可以使用标签选择器过滤指定标签。
标签选择器目前有两个：基于等值关系（等于、不等于）和基于合关系（属于、不属于、存在）。
许多资源支持内嵌标签选择字段：
 matchLable matchExpressions   Service# 在Kubernetes的世界里，虽然每一个Pod都会被分配一个单独的IP地址，但这个IP地址会随着Pod的销毁而消失，Pod是有生命周期的，每一次Pod的变更，其IP地址都会随之而变，随之而来的问题就是其流量如何调度，而Service（服务）就是用来解决这个问题的。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://Huang-CH.github.io/docs/Kubernetes/Kubernetes/" /><meta property="article:section" content="docs" />



<title>Kubernetes | 黄 超 | H&amp;C</title>
<link rel="manifest" href="/manifest.json">
<link rel="icon" href="/favicon.png" type="image/x-icon">
<link rel="stylesheet" href="/book.min.95d69eb6bad8b9707ff2b5d8d9e31ce70a1b84f2ed7ffaf665ffcf00aa7993bd.css" integrity="sha256-ldaetrrYuXB/8rXY2eMc5wobhPLtf/r2Zf/PAKp5k70=" crossorigin="anonymous">
  <script defer src="/flexsearch.min.js"></script>
  <script defer src="/en.search.min.ebf517841b1caf464361f60e5414ab69bc928672fcf4ef0d8ae52ebfd5f92ce6.js" integrity="sha256-6/UXhBscr0ZDYfYOVBSrabyShnL89O8NiuUuv9X5LOY=" crossorigin="anonymous"></script>

  <script defer src="/sw.min.6f6f90fcb8eb1c49ec389838e6b801d0de19430b8e516902f8d75c3c8bd98739.js" integrity="sha256-b2&#43;Q/LjrHEnsOJg45rgB0N4ZQwuOUWkC&#43;NdcPIvZhzk=" crossorigin="anonymous"></script>
<!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->
  
</head>
<body dir="ltr">
  <input type="checkbox" class="hidden toggle" id="menu-control" />
  <input type="checkbox" class="hidden toggle" id="toc-control" />
  <main class="container flex">
    <aside class="book-menu">
      <div class="book-menu-content">
        
  <nav>
<h2 class="book-brand">
  <a class="flex align-center" href="/"><span>黄 超 | H&amp;C</span>
  </a>
</h2>


<div class="book-search">
  <input type="text" id="book-search-input" placeholder="Search" aria-label="Search" maxlength="64" data-hotkeys="s/" />
  <div class="book-search-spinner hidden"></div>
  <ul id="book-search-results"></ul>
</div>












  



  
  <ul>
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-3ca9a5c09bd1884bf69ade02a8e53628" class="toggle"  />
    <label for="section-3ca9a5c09bd1884bf69ade02a8e53628" class="flex justify-between">
      <a role="button" class="">Linux</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-30329090b70c299db66b1665fc9cdf79" class="toggle"  />
    <label for="section-30329090b70c299db66b1665fc9cdf79" class="flex justify-between">
      <a role="button" class="">Linux运维基础</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Linux/Basic-Operation/Rsync/" class="">Rsync</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Linux/Basic-Operation/NFS/" class="">NFS</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Linux/Basic-Operation/Nginx/" class="">Nginx</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Linux/Basic-Operation/Firewalld%E9%98%B2%E7%81%AB%E5%A2%99%E5%9F%BA%E7%A1%80/" class="">Firewalld防火墙基础</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Linux/Basic-Operation/Linux%E7%A3%81%E7%9B%98%E7%9A%84%E6%93%8D%E4%BD%9C/" class="">Linux磁盘的操作</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Linux/Basic-Operation/NetworkManager/" class="">NetworkManager</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Linux/Basic-Operation/%E5%80%9F%E5%8A%A9%E7%B3%BB%E7%BB%9F%E5%AD%98%E5%82%A8%E7%AE%A1%E7%90%86%E5%99%A8%E7%AE%A1%E7%90%86LVM/" class="">借助系统存储管理器管理LVM</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Linux/Basic-Operation/Linux%E5%AE%9E%E7%8E%B0SSH%E5%85%8D%E5%AF%86%E7%99%BB%E9%99%86/" class="">Linux实现SSH免密登录</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Linux/Basic-Operation/%E8%A7%A3%E5%86%B3OpenMediaVault%E4%B8%ADFTP%E4%B9%B1%E7%A0%81%E9%97%AE%E9%A2%98/" class="">解决OpenMediaVault中FTP乱码问题</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-b8ab17e00886c44c945c0ebf9036be5e" class="toggle"  />
    <label for="section-b8ab17e00886c44c945c0ebf9036be5e" class="flex justify-between">
      <a role="button" class="">CentOS</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Linux/CentOS/CentOS-7%E5%80%9F%E5%8A%A9%E7%B3%BB%E7%BB%9F%E5%AD%98%E5%82%A8%E7%AE%A1%E7%90%86%E5%99%A8%E7%AE%A1%E7%90%86LVM/" class="">CentOS 7借助系统存储管理器管理LVM</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Linux/CentOS/CentOS-7%E6%90%AD%E5%BB%BAFTP%E6%9C%8D%E5%8A%A1%E5%99%A8/" class="">CentOS 7搭建FTP服务器</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Linux/CentOS/CentOS-7%E6%90%AD%E5%BB%BAGit%E6%9C%8D%E5%8A%A1%E5%99%A8/" class="">CentOS 7搭建Git服务器</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Linux/CentOS/CentOS-7%E6%90%AD%E5%BB%BASamba%E6%9C%8D%E5%8A%A1%E5%99%A8/" class="">CentOS 7搭建Samba服务器</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Linux/CentOS/CentOS-7%E6%90%AD%E5%BB%BA%E7%A6%BB%E7%BA%BFYum%E6%BA%90/" class="">CentOS 7搭建离线YUM源服务器</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Linux/CentOS/CentOS-7%E9%85%8D%E7%BD%AE%E6%9C%AC%E5%9C%B0%E5%85%89%E7%9B%98%E6%BA%90/" class="">CentOS 7配置本地光盘源</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Linux/CentOS/CentOS-7%E9%9D%99%E9%BB%98%E5%AE%89%E8%A3%85Oracle-19c/" class="">CentOS 7静默安装Oracle 19c</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-35013df187ba109d617f6614b484064f" class="toggle"  />
    <label for="section-35013df187ba109d617f6614b484064f" class="flex justify-between">
      <a role="button" class="">Debian</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Linux/Debian/Debian%E6%90%AD%E5%BB%BAAPT%E6%9C%8D%E5%8A%A1%E5%99%A8/" class="">Debian搭建APT服务器</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Linux/Debian/Debian%E7%B3%BB%E7%BB%9F%E5%B8%B8%E7%94%A8%E9%85%8D%E7%BD%AE/" class="">Debian系统常用配置</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-8ca541663a7d7fd63c79c6ce40ab5b81" class="toggle"  />
    <label for="section-8ca541663a7d7fd63c79c6ce40ab5b81" class="flex justify-between">
      <a role="button" class="">Python</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Python/Python%E4%B9%8B%E5%9F%BA%E7%A1%80%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B/" class="">Python之基础数据类型</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Python/Python%E4%B9%8B%E5%AD%97%E7%AC%A6%E7%BC%96%E7%A0%81/" class="">Python之字符编码</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Python/Python%E4%B9%8B%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C/" class="">Python之文件操作</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Python/Python%E4%B9%8B%E5%90%8D%E7%A7%B0%E7%A9%BA%E9%97%B4%E4%B8%8E%E4%BD%9C%E7%94%A8%E5%9F%9F/" class="">Python之名称空间与作用域</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Python/Python%E4%B9%8B%E5%87%BD%E6%95%B0/" class="">Python之函数</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Python/Python%E4%B9%8B%E8%BF%AD%E4%BB%A3%E5%99%A8/" class="">Python之迭代器</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Python/Python%E4%B9%8B%E7%94%9F%E6%88%90%E5%99%A8/" class="">Python之生成器</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Python/Python%E4%B9%8B%E6%A8%A1%E5%9D%97/" class="">Python之模块</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Python/Python%E4%B9%8B%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/" class="">Python之正则表达式</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Python/Python%E4%B9%8Bre%E6%A8%A1%E5%9D%97/" class="">Python之re模块</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Python/%E9%9D%A2%E5%90%91%E8%BF%87%E7%A8%8B%E4%B8%8E%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1/" class="">面向过程与面向对象</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Python/Python%E4%B9%8B%E7%B1%BB%E4%B8%8E%E5%AF%B9%E8%B1%A1/" class="">Python之类与对象</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Python/Python%E4%B9%8B%E7%BB%84%E5%90%88/" class="">Python之组合</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Python/Python%E4%B9%8B%E7%BB%A7%E6%89%BF%E5%B0%81%E8%A3%85%E5%92%8C%E5%A4%9A%E6%80%81/" class="">Python之继承、封装和多态</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Python/Python%E4%B9%8B%E5%8F%8D%E5%B0%84/" class="">Python之反射</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Python/Python%E4%B9%8B%E5%85%83%E7%B1%BB/" class="">Python之元类</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Python/Python%E4%B9%8B%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86/" class="">Python之异常处理</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Python/Python%E5%86%85%E7%BD%AE%E7%9A%84%E9%AD%94%E6%9C%AF%E6%96%B9%E6%B3%95/" class="">Python内置的魔术方法</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Python/Python%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/" class="">Python网络编程</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Python/Python%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B%E4%B9%8Bsocketserver%E6%A8%A1%E5%9D%97/" class="">Python网络编程之socketserver模块</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Python/Python%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8B%E8%BF%9B%E7%A8%8B/" class="">Python并发编程之进程</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Python/Python%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8B%E7%BA%BF%E7%A8%8B/" class="">Python并发编程之线程</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Python/Python%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8B%E5%8D%8F%E7%A8%8B/" class="">Python并发编程之协程</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Python/%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B%E5%92%8C%E5%8D%8F%E7%A8%8B%E7%9A%84%E5%AF%B9%E6%AF%94/" class="">进程、线程和协程的对比</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Python/%E7%94%9F%E4%BA%A7%E8%80%85%E6%B6%88%E8%B4%B9%E8%80%85%E6%A8%A1%E5%9E%8B%E8%BF%9B%E7%A8%8B/" class="">生产者消费者模型（进程）</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Python/Python%E4%B9%8B%E6%93%8D%E4%BD%9CMySQL%E6%95%B0%E6%8D%AE%E5%BA%93/" class="">Python之操作MySQL数据库</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-ab6241a9c9348727e1ed30d9d7253a0e" class="toggle"  />
    <label for="section-ab6241a9c9348727e1ed30d9d7253a0e" class="flex justify-between">
      <a role="button" class="">Golang</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Golang/Go%E8%AF%AD%E8%A8%80%E7%BC%96%E7%A8%8B%E5%9F%BA%E7%A1%80/" class="">Go语言编程基础</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Golang/Go%E8%AF%AD%E8%A8%80WEB%E5%BC%80%E5%8F%91/" class="">Go语言WEB开发</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Golang/Go%E8%AF%AD%E8%A8%80%E7%9A%84ORM%E6%A1%86%E6%9E%B6/" class="">Go语言的ORM框架</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-a6af99c5c0ad1c9aeaecde8920e3b5e8" class="toggle"  />
    <label for="section-a6af99c5c0ad1c9aeaecde8920e3b5e8" class="flex justify-between">
      <a role="button" class="">C&#43;&#43;</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/C&#43;&#43;/C&#43;&#43;%E7%BC%96%E7%A8%8B%E5%9F%BA%E7%A1%80/" class="">C&#43;&#43;编程基础</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-270a210b43b4f0ee7cd55855f0b534f3" class="toggle"  />
    <label for="section-270a210b43b4f0ee7cd55855f0b534f3" class="flex justify-between">
      <a role="button" class="">MySQL</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/MySQL/MySQL/" class="">MySQL</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-9fdacdda397d9ceae1a912b9128fe9e2" class="toggle"  />
    <label for="section-9fdacdda397d9ceae1a912b9128fe9e2" class="flex justify-between">
      <a role="button" class="">PostgreSQL</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/PostgreSQL/PostgreSQL/" class="">PostgreSQL</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-42f4d133c66bcfbca3d930dc56eb7d01" class="toggle"  />
    <label for="section-42f4d133c66bcfbca3d930dc56eb7d01" class="flex justify-between">
      <a href="https://Huang-CH.github.io/docs/OceanBase/" class="">OceanBase</a>
    </label>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-0f85b1f743da7f4e4cb9fca119fef7be" class="toggle"  />
    <label for="section-0f85b1f743da7f4e4cb9fca119fef7be" class="flex justify-between">
      <a role="button" class="">Docker</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Docker/Docker%E5%8D%83%E9%94%8B%E6%95%99%E8%82%B2/" class="">Docker基础</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Docker/%E6%BA%90%E7%A0%81%E5%AE%89%E8%A3%85Docker/" class="">源码安装Docker</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-6e638f9230da561f7c487c298451b1ed" class="toggle" checked />
    <label for="section-6e638f9230da561f7c487c298451b1ed" class="flex justify-between">
      <a role="button" class="">Kubernetes</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Kubernetes/Kubernetes/" class=" active">Kubernetes</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-ec36ec3492308dbc4bfcaa14eb72fa33" class="toggle"  />
    <label for="section-ec36ec3492308dbc4bfcaa14eb72fa33" class="flex justify-between">
      <a role="button" class="">Git</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Git/git%E5%9F%BA%E7%A1%80/" class="">Git基础</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-2044dd8220b6eb6abc8d4889684aa060" class="toggle"  />
    <label for="section-2044dd8220b6eb6abc8d4889684aa060" class="flex justify-between">
      <a role="button" class="">KVM</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/KVM/KVM/" class="">KVM</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>











  
<ul>
  
  <li>
    <a href="https://github.com/Huang-CH" target="_blank" rel="noopener">
        My Github
      </a>
  </li>
  
</ul>






</nav>




  <script>(function(){var a=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(b){localStorage.setItem("menu.scrollTop",a.scrollTop)}),a.scrollTop=localStorage.getItem("menu.scrollTop")})()</script>


 
      </div>
    </aside>

    <div class="book-page">
      <header class="book-header">
        
  <div class="flex align-center justify-between">
  <label for="menu-control">
    <img src="/svg/menu.svg" class="book-icon" alt="Menu" />
  </label>

  <strong>Kubernetes</strong>

  <label for="toc-control">
    
    <img src="/svg/toc.svg" class="book-icon" alt="Table of Contents" />
    
  </label>
</div>


  
  <aside class="hidden clearfix">
    
  
<nav id="TableOfContents">
  <ul>
    <li><a href="#kubernetesk8s">Kubernetes（K8S）</a>
      <ul>
        <li><a href="#kubernetes的基本概念">Kubernetes的基本概念</a>
          <ul>
            <li><a href="#pod">Pod</a></li>
            <li><a href="#pod控制器">Pod控制器</a></li>
            <li><a href="#name">Name</a></li>
            <li><a href="#namespace">Namespace</a></li>
            <li><a href="#label">Label</a></li>
            <li><a href="#lable选择器">Lable选择器</a></li>
            <li><a href="#service">Service</a></li>
            <li><a href="#ingress">Ingress</a></li>
            <li><a href="#rbac">RBAC</a></li>
          </ul>
        </li>
        <li><a href="#kubernetes的核心组件">Kubernetes的核心组件</a>
          <ul>
            <li><a href="#配置存储中心">配置存储中心</a></li>
            <li><a href="#主控节点master">主控节点（master）</a></li>
            <li><a href="#运算节点node">运算节点（node）</a></li>
            <li><a href="#cli客户端">CLI客户端</a></li>
          </ul>
        </li>
        <li><a href="#kubernetes的附加组件">Kubernetes的附加组件</a>
          <ul>
            <li><a href="#cni网络插件">CNI网络插件</a></li>
            <li><a href="#服务发现用插件">服务发现用插件</a></li>
            <li><a href="#服务暴露用插件">服务暴露用插件</a></li>
            <li><a href="#gui管理插件">GUI管理插件</a></li>
          </ul>
        </li>
        <li><a href="#kubernetes核心资源管理方法crud">Kubernetes核心资源管理方法（CRUD）</a>
          <ul>
            <li><a href="#陈述式资源管理">陈述式资源管理</a></li>
            <li><a href="#声明式资源管理">声明式资源管理</a></li>
          </ul>
        </li>
        <li><a href="#kubernetes实验架构">Kubernetes实验架构</a>
          <ul>
            <li><a href="#主机配置基础优化">主机配置（基础优化）</a></li>
            <li><a href="#搭建dns服务">搭建DNS服务</a></li>
            <li><a href="#搭建证书签发环境">搭建证书签发环境</a></li>
            <li><a href="#搭建docker环境">搭建Docker环境</a></li>
            <li><a href="#搭建私有镜像仓库harbor">搭建私有镜像仓库Harbor</a></li>
            <li><a href="#部署主控master节点服务">部署主控（Master）节点服务</a></li>
            <li><a href="#部署计算node节点服务">部署计算（Node）节点服务</a></li>
            <li><a href="#验证kubenetes集群">验证Kubenetes集群</a></li>
            <li><a href="#部署cni网络插件flannel">部署CNI网络插件（Flannel）</a></li>
            <li><a href="#部署服务发现插件coredns">部署服务发现插件（CoreDNS）</a></li>
            <li><a href="#部署服务暴露插件ingress">部署服务暴露插件（Ingress）</a></li>
            <li><a href="#部署gui资源管理插件仪表盘">部署GUI资源管理插件（仪表盘）</a></li>
            <li><a href="#kubernetes集群node节点平滑升级">Kubernetes集群Node节点平滑升级</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>



  </aside>
  
 
      </header>

      
      
  <article class="markdown"><h1 id="kubernetesk8s">
  Kubernetes（K8S）
  <a class="anchor" href="#kubernetesk8s">#</a>
</h1>
<hr>
<h2 id="kubernetes的基本概念">
  Kubernetes的基本概念
  <a class="anchor" href="#kubernetes%e7%9a%84%e5%9f%ba%e6%9c%ac%e6%a6%82%e5%bf%b5">#</a>
</h2>
<hr>
<h3 id="pod">
  Pod
  <a class="anchor" href="#pod">#</a>
</h3>
<hr>
<p>Pod是Kubernetes中能够被运行的最小逻辑单元（原子单元），一个Pod里面可以运行多个容器，他们共享UTS+NET+IPC名称空间，可以把Pod理解成豌豆荚，而同一个Pod中的每一个容器都是一颗颗的豌豆，一个Pod中运行多个容器，又叫边车（SideCar）模式。（边车就是侉子摩托）</p>
<hr>
<h3 id="pod控制器">
  Pod控制器
  <a class="anchor" href="#pod%e6%8e%a7%e5%88%b6%e5%99%a8">#</a>
</h3>
<hr>
<p>Pod控制器是Pod启动的一种模式，用来保证在Kubernetes中启动的Pod应始终按照预期运行（副本数、生命周期和健康状态检查等）。</p>
<p>虽然Pod可以不通过Pod控制器，单独启动并运行在Kubernetes中，但在生产环境中强烈建议使用Pod控制器控制Pod。</p>
<p>Kubernetes中提供了众多的Pod控制器，常用的有以下几种：</p>
<ul>
<li><strong>Deployment</strong></li>
<li><strong>DeamonSet</strong></li>
<li>ReplicaSet</li>
<li>StatefulSet</li>
<li>Job</li>
<li>Cronjob</li>
</ul>
<hr>
<h3 id="name">
  Name
  <a class="anchor" href="#name">#</a>
</h3>
<hr>
<p>由于Kubernetes内部使用“资源”来定义每一种逻辑概念（功能），故每种“资源”都应该有自己的名称。</p>
<p>“资源”有API版本（API Version）、类别（kind）、元数据（metadata）、定义清单（spec）、状态（status）等配置信息。</p>
<p>“名称”通常定义在“资源”的“元数据（metadata）”信息里。</p>
<hr>
<h3 id="namespace">
  Namespace
  <a class="anchor" href="#namespace">#</a>
</h3>
<hr>
<p>随着项目的增多、人员的增加、集群规模的扩大，需要一种能够隔离Kubernetes内各种“资源”的方法，这就是Namcespace（名称空间）。</p>
<p>Namespace可以理解为把Kubernetes的内部资源进行了分组，类似于一个公司的各个部门（行政、人力、财务、研发、销售等）。</p>
<p>不同Namespace内的“资源”，名称可以相同，相同Namespace内的同种“资源”，“名称”不能相同（可以理解为A机房中的服务器不能有相同的编号，但是B机房中的服务器可以跟A机房中的服务器的编号相同）。</p>
<p>合理的使用Kubernetes的Namespace，使得集群管理源能够更好的对交付到Kubernetes中的服务进行分类管理和浏览。</p>
<p>Kubernetes中默认存在的Namespace有：default、kube-system、kube-public。</p>
<p>查询Kubernetes中特定的“资源”要带上相应的Namespace。</p>
<hr>
<h3 id="label">
  Label
  <a class="anchor" href="#label">#</a>
</h3>
<hr>
<p>标签是Kubernetes特色的管理方式，便于分类管理资源对象。</p>
<p>一个标签可以对应多个资源，一个资源也可以有多个标签，他们是多对多的关心。</p>
<p>一个资源拥有多个标签，可以实现不同维度的管理。</p>
<p>标签的组成：key = value</p>
<p>与标签类似的，还有一种“注解（annotaions）”</p>
<hr>
<h3 id="lable选择器">
  Lable选择器
  <a class="anchor" href="#lable%e9%80%89%e6%8b%a9%e5%99%a8">#</a>
</h3>
<hr>
<p>给资源打上标签后，可以使用标签选择器过滤指定标签。</p>
<p>标签选择器目前有两个：基于等值关系（等于、不等于）和基于合关系（属于、不属于、存在）。</p>
<p>许多资源支持内嵌标签选择字段：</p>
<ul>
<li>matchLable</li>
<li>matchExpressions</li>
</ul>
<hr>
<h3 id="service">
  Service
  <a class="anchor" href="#service">#</a>
</h3>
<hr>
<p>在Kubernetes的世界里，虽然每一个Pod都会被分配一个单独的IP地址，但这个IP地址会随着Pod的销毁而消失，Pod是有生命周期的，每一次Pod的变更，其IP地址都会随之而变，随之而来的问题就是其流量如何调度，而Service（服务）就是用来解决这个问题的。</p>
<p>一个Service可以看作一组提供相同服务Pod的对外访问接口，而Service作用于哪些Pod是通过标签选择器来定义的。</p>
<p>Service工作在OSI网路参考模型的第四层，只能进行第四层的网络调度，表现形式是：IP+端口。</p>
<hr>
<h3 id="ingress">
  Ingress
  <a class="anchor" href="#ingress">#</a>
</h3>
<hr>
<p>Ingress是Kubernetes集群里工作在OSI网路参考模型的第七层，对外暴露的接口是应用层接口，而Service只能进行第四层的网络调度，Ingress可以调度不同业务域、不同URL访问路径的业务流量。</p>
<p>Ingress是kubernetes的标准资源类型之一，也是一种核心资源，它其实就是一组基于域名和URL路径，把用户的请求转发至指定Service资源的一种规则。</p>
<p>Ingress可以将集群外部的请求流量转发至集群内部，从而实现服务暴露。</p>
<p>Ingress控制器能够监听Ingress资源，然后根据Ingress规则匹配路由、调度流量的一个组件。</p>
<p>常用的Ingress控制器的实现软件：</p>
<ul>
<li>Ingress-nginx</li>
<li>HAProxy</li>
<li><strong>Traefik</strong></li>
<li>……</li>
</ul>
<hr>
<h3 id="rbac">
  RBAC
  <a class="anchor" href="#rbac">#</a>
</h3>
<hr>
<p>Kubernetes自1.6版本起默认使用基于角色的访问控制（RBAC），相较于ABAC（基于属性的访问控制）和WebHook等鉴权机制。RBAC对集群中的资源权限实现了完整覆盖，同时支持权限的动态调整，无需重启apiserver</p>
<hr>
<p>权限</p>
<ul>
<li>get：读</li>
<li>write：写</li>
<li>update：更新</li>
<li>list：列出</li>
<li>watch：监视</li>
<li>……</li>
</ul>
<hr>
<p>账户</p>
<blockquote>
<p>注意：账户不能直接被分配权限，需要先绑定一个角色，然后给角色分配权限</p>
</blockquote>
<ul>
<li>UserAccount：用户账户</li>
<li>ServiceAccount：服务账户。所有交付到Kubernetes中的pod，都必须有拥有一个服务账户。</li>
</ul>
<hr>
<p>角色</p>
<ul>
<li>Role：普通角色。只能应用于特定的名称空间下。</li>
<li>ClusterRole：集群角色。应用于整个集群。</li>
</ul>
<hr>
<p>绑定角色的操作</p>
<ul>
<li>RoleBinding</li>
<li>ClusterRoleBinding</li>
</ul>
<hr>
<p>RBAC的YAML文件一般包含如下内容：</p>
<ul>
<li>创建账户</li>
<li>定义角色并赋予角色相应的权限</li>
<li>将账户绑定到相应的角色上</li>
</ul>
<hr>
<h2 id="kubernetes的核心组件">
  Kubernetes的核心组件
  <a class="anchor" href="#kubernetes%e7%9a%84%e6%a0%b8%e5%bf%83%e7%bb%84%e4%bb%b6">#</a>
</h2>
<hr>
<h3 id="配置存储中心">
  配置存储中心
  <a class="anchor" href="#%e9%85%8d%e7%bd%ae%e5%ad%98%e5%82%a8%e4%b8%ad%e5%bf%83">#</a>
</h3>
<hr>
<p>Kubernetes的配置存储中心是<code>etcd</code>服务</p>
<blockquote>
<p>etcd服务也是一种数据库，拥有自己的高可用机制和通信方式，并且拥有自己组织数据的结构和方法（etcd使用键值对，MySQL使用二维表）。</p>
<p>etcd服务主要用于存储集群的元数据信息。</p>
<p>etcd服务应该有奇数个（3、5、7、9……），因为etcd的高可用是投票机制（选举机制），当leader死后，会留遗言，将leader给指定的etcd（平日里与leader通信延迟低、响应快的）。而参与投票etcd都会选择自己，因此只有基数个etcd才会选出新的leader。</p>
</blockquote>
<hr>
<h3 id="主控节点master">
  主控节点（master）
  <a class="anchor" href="#%e4%b8%bb%e6%8e%a7%e8%8a%82%e7%82%b9master">#</a>
</h3>
<hr>
<p>kube-apiserver 服务</p>
<blockquote>
<p>apiserver是整个Kubernetes集群的大脑，主要提供了以下功能：</p>
<ul>
<li>
<p>集群管理的REST API接口（包括鉴权、数据校验以及集群状态的变更）</p>
</li>
<li>
<p>负责其他模块之间的数据交互，承担通信枢纽的功能</p>
</li>
<li>
<p>是资源配额控制的入口</p>
</li>
<li>
<p>为集群提供完备的安全机制</p>
</li>
</ul>
</blockquote>
<hr>
<p>kube-controller-manager 服务</p>
<blockquote>
<p>controller-manager被称为控制器管理器，用于管理一系列的控制器，通过apiserver监控整个集群的状态，并确保集群处于预期的工作状态。</p>
<p>controller-manager所管理的控制器主要有：</p>
<ul>
<li>Node Controller（节点控制器）</li>
<li>Deployment Controller（Pod控制器）</li>
<li>Service Controller（服务控制器）</li>
<li>Volume Controller（存储卷控制器）</li>
<li>Endpoint Controller（接入点控制器）</li>
<li>Garbage Controller（垃圾回收控制器）</li>
<li>Namespace Controller（名称空间控制器）</li>
<li>Job Controller（任务控制器）</li>
<li>Resoure Quta Controller（资源配额控制器）</li>
<li>&hellip;&hellip;</li>
</ul>
</blockquote>
<hr>
<p>kube-scheduler 服务</p>
<blockquote>
<p>scheduler主要功能是接收并调度Pod到适合的运算节点上，scheduler在为Pod选择节点时主要有两种策略：</p>
<ul>
<li>
<p>预算策略（predict）</p>
</li>
<li>
<p>优选策略（priorities）</p>
</li>
</ul>
</blockquote>
<hr>
<h3 id="运算节点node">
  运算节点（node）
  <a class="anchor" href="#%e8%bf%90%e7%ae%97%e8%8a%82%e7%82%b9node">#</a>
</h3>
<hr>
<p>kube-kubelet服务</p>
<blockquote>
<p>kublet（苦逼老父亲）是真正干活儿的服务，简单的说，kubelet的主要功能有：</p>
<ul>
<li>定制从某个地方获取节点上Pod的期望状态（运行什么容器、运行的副本数量、网络或者存储如何配置等），并调用对应容器平台的接口（Docker接口）达到这个状态</li>
<li>定时汇报当前节点的状态给apiserver，由apiserver将状态写道etcd中，以供调度的时候使用</li>
<li>完成镜像和容器的清理工作，保证节点上镜像不会占满磁盘空间，推出的容器不会占用太多资源</li>
</ul>
</blockquote>
<hr>
<p>kube-proxy服务</p>
<blockquote>
<p>kube-proxy是Kubernetes在每个节点上运行的网络代理，是service资源的载体，kube-proxy在集群网络和Pod网络间建立关系（clusterip -&gt; podip），注意，是建立关系，并不是提供网络，网络是由netns提供。</p>
<ul>
<li>kube-proxy常用的三种流量调用模式：
<ul>
<li>Userspace（已经废弃）</li>
<li>Iptables（目前在用，但濒临废弃）</li>
<li>Ipvs（推荐使用的流量调用模式）</li>
</ul>
</li>
<li>负责建立和删除更新调度规则、通知apiserver自己的更新，或者从apiserver那里获取其他kube-proxy的调度规则，同时更新自己现有的规则</li>
<li>Kubernetes中有三种网络：宿主机节点网路（10.0.0.0/24）、Service网络（172.16.0.0/16）和Pod网络（192.168.0.0/16）</li>
</ul>
</blockquote>
<hr>
<h3 id="cli客户端">
  CLI客户端
  <a class="anchor" href="#cli%e5%ae%a2%e6%88%b7%e7%ab%af">#</a>
</h3>
<hr>
<p>kubectl</p>
<p>Kubernetes管理核心资源依托于kubectl和dashboard，主要有以下三种方式：</p>
<ul>
<li>陈述式管理：主要依赖命令行工具（CLI）进行管理</li>
<li>声明式管理：主要依赖统一资源配置清单（manifest）进行管理</li>
<li>GUI图形用户界面式管理：主要依赖图形化操作界面（WEB界面）进行管理</li>
</ul>
<blockquote>
<p>这三种对核心资源管理的方式各有特点，属于互相依托、协同工作的关系</p>
</blockquote>
<hr>
<h2 id="kubernetes的附加组件">
  Kubernetes的附加组件
  <a class="anchor" href="#kubernetes%e7%9a%84%e9%99%84%e5%8a%a0%e7%bb%84%e4%bb%b6">#</a>
</h2>
<hr>
<blockquote>
<p>Kubernetes addons</p>
</blockquote>
<hr>
<h3 id="cni网络插件">
  CNI网络插件
  <a class="anchor" href="#cni%e7%bd%91%e7%bb%9c%e6%8f%92%e4%bb%b6">#</a>
</h3>
<blockquote>
<p>Kubernetes设计了网络模型，但却将它的实现交给了网络插件，CNI网络插件最主要的功能就是实现pod资源能够跨宿主机进行通信。</p>
<p>常见的CNI网络插件：</p>
<ul>
<li>Flannel</li>
<li>Calico</li>
<li>Cannal</li>
<li>Contiv</li>
<li>OpenContrail</li>
<li>NSX-T</li>
<li>Kube-router</li>
</ul>
</blockquote>
<p>Flannel/Calico</p>
<ul>
<li>flannel利用Kubernetes API或者etcd，用于存储整个集群的网络配置，其中最主要的功能是设置集群的网络地址空间。例如，设定整个集群内所有容器的IP都取自网段“10.1.0.0/16”。</li>
<li>flannel在每个主机中运行flanneld作为agent，它会为所在主机集群的网络地址空间中，获取一个小的网段subnet，本主机中所有容器的IP地址都将从subnet中分配。</li>
<li>flanneld将本主机获取的subnet以及用于主机间通信的Public IP，通过kubernetes API或者etcd存储起来。</li>
<li>flannel利用各种backend mechanism，例如udp，vxlan等等，跨主机转发容器间的网络流量，完成容器间的跨主机通信。</li>
</ul>
<hr>
<h3 id="服务发现用插件">
  服务发现用插件
  <a class="anchor" href="#%e6%9c%8d%e5%8a%a1%e5%8f%91%e7%8e%b0%e7%94%a8%e6%8f%92%e4%bb%b6">#</a>
</h3>
<hr>
<blockquote>
<ul>
<li>
<p>服务发现就是服务（应用之间互相定位的过程）</p>
</li>
<li>
<p>服务发现并非云计算时代独有的，传统架构时代也会用到，一般来说，在服务（应用）的动态性强、更新发布频繁、需要支持自动伸缩的场景下需要服务发现</p>
</li>
<li>
<p>在Kubernetes集群里，pod的IP地址是在不断变化的，如何“以不变应万变”呢？</p>
<ul>
<li>抽象出了Service资源，通过标签选择器，关联一组pod</li>
<li>抽象出了集群网络，通过相对固定的“集群IP”，使服务接入点固定</li>
</ul>
</li>
<li>
<p>在Kuberntes v1.2至v1.10是使用Kube-dns进行自动关联Service资源的“名称”和“集群网络IP”，从而达到服务被集群自动发现的目的。在Kubernetes v1.11以后，就改用Coredns了。</p>
</li>
</ul>
<p>注意：在Kubernetes中的DNS不是万能的，它只负责自动维护“服务名称”和“集群网络IP地址”的关系</p>
</blockquote>
<p>CoreDNS</p>
<ul>
<li>集群网络：Cluster IP</li>
<li>Service资源：Service Name</li>
<li>Coredns：实现了Service Name和Cluster IP的自动关联</li>
</ul>
<hr>
<h3 id="服务暴露用插件">
  服务暴露用插件
  <a class="anchor" href="#%e6%9c%8d%e5%8a%a1%e6%9a%b4%e9%9c%b2%e7%94%a8%e6%8f%92%e4%bb%b6">#</a>
</h3>
<blockquote>
<p>Ingress资源：专用于暴露7层应用到K8S集群外的一种核心资源（http/https）</p>
<p>Ingress控制器：通过Traefik软件实现的Ingress控制器，简单来说，Ingress控制器就是一个简化版的Nginx（调度流量）+ Go语言脚本（动态识别YAML）</p>
</blockquote>
<p>Traefik</p>
<hr>
<h3 id="gui管理插件">
  GUI管理插件
  <a class="anchor" href="#gui%e7%ae%a1%e7%90%86%e6%8f%92%e4%bb%b6">#</a>
</h3>
<hr>
<p>Dashboard</p>
<hr>
<h2 id="kubernetes核心资源管理方法crud">
  Kubernetes核心资源管理方法（CRUD）
  <a class="anchor" href="#kubernetes%e6%a0%b8%e5%bf%83%e8%b5%84%e6%ba%90%e7%ae%a1%e7%90%86%e6%96%b9%e6%b3%95crud">#</a>
</h2>
<hr>
<blockquote>
<ul>
<li>陈述式资源管理：基于kubectl命令</li>
<li>声明式资源管理：基于K8S资源配置清单</li>
<li>GUI式资源管理：基于K8S仪表盘（Dashboard）</li>
</ul>
</blockquote>
<hr>
<h3 id="陈述式资源管理">
  陈述式资源管理
  <a class="anchor" href="#%e9%99%88%e8%bf%b0%e5%bc%8f%e8%b5%84%e6%ba%90%e7%ae%a1%e7%90%86">#</a>
</h3>
<hr>
<blockquote>
<ul>
<li>
<p>Kubenetes集群管理其集群资源的唯一入口是通过相应的方法调用apiserver的接口</p>
</li>
<li>
<p>kubectl是官方的CLI命令行工具，用于与apiserver进行通信，将用户在命令行输入的命令组织并转化为apiserver可以识别的命令，是实现管理Kubenetes各种资源的一种有效的方式</p>
</li>
<li>
<p>kubectl的命令大全</p>
<ul>
<li>kubectl &ndash;help</li>
<li>
  <a href="http://docs.kubernetes.org.cn">http://docs.kubernetes.org.cn</a></li>
</ul>
</li>
<li>
<p>陈述式资源管理方法可以满足90%以上的资源管理需求，但它的缺点也很明显</p>
<ul>
<li>命令冗长、负载、难以记忆</li>
<li>特定场景下、无法实现管理需求</li>
<li>对资源的增、删、查操作比较容易，而对改操作比较麻烦</li>
</ul>
</li>
</ul>
</blockquote>
<hr>
<h4 id="管理名称空间资源">
  管理名称空间资源
  <a class="anchor" href="#%e7%ae%a1%e7%90%86%e5%90%8d%e7%a7%b0%e7%a9%ba%e9%97%b4%e8%b5%84%e6%ba%90">#</a>
</h4>
<hr>
<p>查看名称空间</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl get namespaces
</code></pre></div><hr>
<p>查看指定名称空间内的资源</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl get all -n &lt;名称空间的名称&gt;
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl get pods -n &lt;名称空间的名称&gt;
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl get nodes -n &lt;名称空间的名称&gt;
</code></pre></div><blockquote>
<p>查询命名空间中的资源，使用<code>-n</code>指定名称空间，如果不使用<code>-n</code>指定名称空间，则默认查询的是<code>default</code>的名称空间</p>
</blockquote>
<hr>
<p>创建名称空间</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl create namespace &lt;名称空间&gt;
</code></pre></div><hr>
<p>删除名称空间</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl create namespace &lt;名称空间&gt;
</code></pre></div><hr>
<h4 id="管理deployment资源">
  管理Deployment资源
  <a class="anchor" href="#%e7%ae%a1%e7%90%86deployment%e8%b5%84%e6%ba%90">#</a>
</h4>
<hr>
<p>创建deployment类型的pod控制器</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl create deployment &lt;pod控制器资源名称&gt; --image<span style="color:#f92672">=</span>&lt;镜像地址&gt; -n &lt;名称空间&gt;
</code></pre></div><p>示例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl create deployment nginx-dp --image<span style="color:#f92672">=</span>harbor.k8s.com/public/nginx:v1.7.0 -n kube-public
</code></pre></div><hr>
<p>查看deployment类型的pod控制器或者pod概览信息</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl get deploy -n kube-public
<span style="color:#75715e"># 加上 -o wide 可查看扩展信息</span>
kubectl get deploy -o wide -n kube-public
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl get pod -o wide -n kube-public
</code></pre></div><hr>
<p>查看pod控制器、pod、service等资源的详细信息</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl describe &lt;资源类型&gt; &lt;pod控制器名称&gt; -n &lt;名称空间&gt;
</code></pre></div><p>示例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl describe deploy nginx-dp -n kube-public
kubectl describe pod nginx-dp-5dfc689474-4bhfh -n kube-public
kubectl describe svc nginx-dp -n kube-public　
</code></pre></div><hr>
<p>进入pod容器（也可以使用<code>docker exec</code>命令进入容器）</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl exec -ti &lt;pod容器名称&gt; /bin/bash -n &lt;名称空间&gt;
</code></pre></div><p>示例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl exec -ti nginx-dp-7975769c4c-pz8bh /bin/bash -n kube-public
</code></pre></div><hr>
<p>扩容pod容器</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl scale deployment &lt;pod容器名称&gt; --replicas<span style="color:#f92672">=</span>&lt;数量&gt; -n 名称空间&gt;
</code></pre></div><p>示例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl scale deployment nginx-dp --replicas<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span> -n kube-public
</code></pre></div><hr>
<p>删除pod容器</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl delete pods &lt;pod容器名称&gt; -n &lt;名称空间&gt; <span style="color:#f92672">[</span>--force --grace-period<span style="color:#f92672">=</span>0<span style="color:#f92672">]</span>
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># 示例</span>
kubectl delete pods nginx-dp-5dfc689474-4bhfh -n kube-public
</code></pre></div><blockquote>
<p>注意：此删除，只是删除了pod容器，并没有删除pod控制器，此操作删除pod后，pod控制器会再拉起一个新的pod，所以删除pod是重启pod的一个重要方法，想要完全删除pod，需要删除pod控制器。当无法删除pod的时候，还可以使用强制删除参数：<code>--force --grace-period=0</code></p>
</blockquote>
<hr>
<p>删除deployment（pod控制器）</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl delete deploy &lt;pod控制器名称&gt; -n &lt;名称空间&gt;
</code></pre></div><p>示例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl delete deploy nginx-dp -n kube-public
</code></pre></div><blockquote>
<p>当我们删除了pod控制器以后，pod容器也会被随之删除。</p>
</blockquote>
<hr>
<h4 id="管理service资源">
  管理Service资源
  <a class="anchor" href="#%e7%ae%a1%e7%90%86service%e8%b5%84%e6%ba%90">#</a>
</h4>
<hr>
<blockquote>
<p>Service资源为Pod资源提供稳定的接入点</p>
<p>资源包括(不区分大小写)：</p>
<p>Pod（po），Service（svc），Replication Controller（rc），Deployment（deploy），Replica Set（rs）</p>
</blockquote>
<hr>
<p>将资源暴露为新的Service</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl expose &lt;资源类型&gt; &lt;资源名称&gt; --port<span style="color:#f92672">=</span>&lt;Service端口号&gt; --target-port<span style="color:#f92672">=</span>&lt;容器的端口号&gt; -n &lt;名称空间&gt;
</code></pre></div><p>示例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl expose deploy nginx-dp --port<span style="color:#f92672">=</span><span style="color:#ae81ff">80</span> -n kube-public
</code></pre></div><hr>
<p>查看Service</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl discribe svc nginx-dp -n kube-public
<span style="color:#75715e"># 查看资源配置清单详细信息：-o yaml</span>
kubectl discribe svc nginx-dp -o yaml -n kube-public
</code></pre></div><hr>
<h3 id="声明式资源管理">
  声明式资源管理
  <a class="anchor" href="#%e5%a3%b0%e6%98%8e%e5%bc%8f%e8%b5%84%e6%ba%90%e7%ae%a1%e7%90%86">#</a>
</h3>
<hr>
<blockquote>
<ul>
<li>声明式资源管理方法依赖于资源配置清单（yaml/json）</li>
<li>更改配置清单使用声明式资源管理比较好</li>
</ul>
</blockquote>
<hr>
<p>查看资源配置清单</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl get &lt;资源类型&gt; &lt;资源名称&gt; -o yaml -n &lt;名称空间&gt;
</code></pre></div><hr>
<p>解释资源配置清单或资源配置清单中关键字的作用</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl explain &lt;资源类型&gt;.&lt;关键字&gt;
</code></pre></div><p>示例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl explain service.metadata
</code></pre></div><hr>
<p>创建资源配置清单</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">vim /root/nginx-ds-svc.yaml
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Service</span>
<span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">labels</span>:
    <span style="color:#f92672">app</span>: <span style="color:#ae81ff">nginx-ds</span>
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx-ds</span>
  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default</span>
<span style="color:#f92672">spec</span>:
  <span style="color:#f92672">ports</span>:
  - <span style="color:#f92672">port</span>: <span style="color:#ae81ff">80</span>
    <span style="color:#f92672">protocol</span>: <span style="color:#ae81ff">TCP</span>
    <span style="color:#f92672">targetPort</span>: <span style="color:#ae81ff">80</span>
  <span style="color:#f92672">selector</span>:
    <span style="color:#f92672">app</span>: <span style="color:#ae81ff">nginx-ds</span>
  <span style="color:#f92672">sessionAffinity</span>: <span style="color:#ae81ff">None</span>
  <span style="color:#f92672">type</span>: <span style="color:#ae81ff">ClusterIP</span>
</code></pre></div><hr>
<p>应用资源配置清单</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl apply -f nginx-ds-svc.yaml
</code></pre></div><hr>
<p>修改资源配置清单并应用</p>
<blockquote>
<p>修改资源配置清单分为在线修改和离线修改，推荐离线修改</p>
</blockquote>
<ul>
<li>
<p>在线修改</p>
<p>直接使用<code>kubectl edit service nginx-ds</code>在线编辑资源配置清单并保存生效</p>
</li>
<li>
<p>离线修改</p>
<p>修改<code>nginx-ds-svc.yaml</code>文件，并使用<code>kubectl apply -f nginx-ds-svc.yaml</code>命令使配置文件生效</p>
</li>
</ul>
<hr>
<p>删除资源配置清单</p>
<ul>
<li>
<p>陈述式删除</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl delete svc nginx-ds
</code></pre></div></li>
<li>
<p>声明式删除</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl delete -f nginx-dp-svc.yaml
</code></pre></div></li>
</ul>
<hr>
<h2 id="kubernetes实验架构">
  Kubernetes实验架构
  <a class="anchor" href="#kubernetes%e5%ae%9e%e9%aa%8c%e6%9e%b6%e6%9e%84">#</a>
</h2>
<hr>
<h3 id="主机配置基础优化">
  主机配置（基础优化）
  <a class="anchor" href="#%e4%b8%bb%e6%9c%ba%e9%85%8d%e7%bd%ae%e5%9f%ba%e7%a1%80%e4%bc%98%e5%8c%96">#</a>
</h3>
<hr>
<blockquote>
<p>Linux系统内核3.8以上</p>
</blockquote>
<hr>
<p>更改主机名称</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">hostnamectl set-hostname xxx.host.com
</code></pre></div><hr>
<p>关闭selinux服务</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">setenforce <span style="color:#ae81ff">0</span>
</code></pre></div><hr>
<p>关闭firewalld服务</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">systemctl stop firewalld <span style="color:#f92672">&amp;&amp;</span> systemctl disable firewalld
</code></pre></div><hr>
<p>调整Base源</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">mv /etc/yum.repos.d/CentOS-Base.repo /etc/yum.repos.d/CentOS-Base.repo.backup
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">wget http://mirrors.aliyun.com/repo/Centos-7.repo -O /etc/yum.repos.d/CentOS-Base.repo 
</code></pre></div><hr>
<p>安装epel源</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">yum update -y <span style="color:#f92672">&amp;&amp;</span> yum install epel-release -y
</code></pre></div><hr>
<p>安装常用工具</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">yum install -y bash-completion vim wget net-tools telnet htop tree nmap sysstat lrzsz dos2unix bind-utils
</code></pre></div><hr>
<p>时间同步</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">yum install -y chronyd
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">echo <span style="color:#e6db74">&#39;server ntp1.aliyun.com iburst&#39;</span> &gt;&gt; /etc/chrony.conf
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">systemctl start chronyd <span style="color:#f92672">&amp;&amp;</span> systemctl enable chronyd
</code></pre></div><hr>
<h3 id="搭建dns服务">
  搭建DNS服务
  <a class="anchor" href="#%e6%90%ad%e5%bb%badns%e6%9c%8d%e5%8a%a1">#</a>
</h3>
<hr>
<blockquote>
<p>在<code>10.0.0.11</code>上通过<code>bind</code>搭建DNS服务</p>
</blockquote>
<hr>
<p>安装bind软件</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">yum install -y bind
</code></pre></div><hr>
<p>配置bind</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">vim /etc/named.conf
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"> options <span style="color:#f92672">{</span>
          listen-on port <span style="color:#ae81ff">53</span> <span style="color:#f92672">{</span> 10.0.0.11; <span style="color:#f92672">}</span>;
          directory       <span style="color:#e6db74">&#34;/var/named&#34;</span>;
          dump-file       <span style="color:#e6db74">&#34;/var/named/data/cache_dump.db&#34;</span>;
          statistics-file <span style="color:#e6db74">&#34;/var/named/data/named_stats.txt&#34;</span>;
          memstatistics-file <span style="color:#e6db74">&#34;/var/named/data/named_mem_stats.txt&#34;</span>;
          recursing-file  <span style="color:#e6db74">&#34;/var/named/data/named.recursing&#34;</span>;
          secroots-file   <span style="color:#e6db74">&#34;/var/named/data/named.secroots&#34;</span>;
          allow-query     <span style="color:#f92672">{</span> any; <span style="color:#f92672">}</span>;
          forwarders      <span style="color:#f92672">{</span> 10.0.0.254; <span style="color:#f92672">}</span>;
          
          recursion yes;      
          
          dnssec-enable no;
          dnssec-validation no;
          
include <span style="color:#e6db74">&#34;/etc/named/named.rfc1912.zones&#34;</span>;
</code></pre></div><hr>
<p>配置区域文件</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">vim /etc/named/named.rfc1912.zones
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">zone <span style="color:#e6db74">&#34;host.com&#34;</span> IN <span style="color:#f92672">{</span>
        type master;
        file <span style="color:#e6db74">&#34;host.com.zone&#34;</span>;
        allow-update <span style="color:#f92672">{</span> 10.0.0.11; <span style="color:#f92672">}</span>;
<span style="color:#f92672">}</span>;

zone <span style="color:#e6db74">&#34;k8s.com&#34;</span> IN <span style="color:#f92672">{</span>
        type master;
        file <span style="color:#e6db74">&#34;k8s.com.zone&#34;</span>;
        allow-update <span style="color:#f92672">{</span> 10.0.0.11; <span style="color:#f92672">}</span>;
<span style="color:#f92672">}</span>;
</code></pre></div><hr>
<p>配置区域数据文件</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">vim /var/named/host.com.zone
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ORIGIN host.com.
$TTL <span style="color:#ae81ff">60</span>        ; <span style="color:#ae81ff">1</span> minutes
@              IN    SOA    dns.host.com. dnsadmin.host.com. <span style="color:#f92672">(</span>
                                                    <span style="color:#ae81ff">2020010101</span> ; serial
                                                    <span style="color:#ae81ff">10800</span>      ; refresh <span style="color:#f92672">(</span><span style="color:#ae81ff">3</span> hours<span style="color:#f92672">)</span>
                                                    <span style="color:#ae81ff">900</span>        ; retry <span style="color:#f92672">(</span><span style="color:#ae81ff">15</span> minutes<span style="color:#f92672">)</span>
                                                    <span style="color:#ae81ff">604800</span>     ; expire <span style="color:#f92672">(</span><span style="color:#ae81ff">1</span> week<span style="color:#f92672">)</span>
                                                    <span style="color:#ae81ff">86400</span>      ; minimum <span style="color:#f92672">(</span><span style="color:#ae81ff">1</span> day<span style="color:#f92672">)</span>
                                                    <span style="color:#f92672">)</span>
               NS          dns.host.com.
dns            A           10.0.0.11
host-0-11      A           10.0.0.11
host-0-12      A           10.0.0.12
host-0-21      A           10.0.0.21
host-0-22      A           10.0.0.22
host-0-200     A           10.0.0.200
</code></pre></div><hr>
<p>配置业务域数据文件</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">vim /var/named/k8s.com.zone
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ORIGIN k8s.com.
$TTL <span style="color:#ae81ff">60</span>        ; <span style="color:#ae81ff">1</span> minutes
@            IN    SOA    dns.k8s.com. dnsadmin.k8s.com. <span style="color:#f92672">(</span>
                                                    <span style="color:#ae81ff">2020010101</span> ; serial
                                                    <span style="color:#ae81ff">10800</span>      ; refresh <span style="color:#f92672">(</span><span style="color:#ae81ff">3</span> hours<span style="color:#f92672">)</span>
                                                    <span style="color:#ae81ff">900</span>        ; retry <span style="color:#f92672">(</span><span style="color:#ae81ff">15</span> minutes<span style="color:#f92672">)</span>
                                                    <span style="color:#ae81ff">604800</span>     ; expire <span style="color:#f92672">(</span><span style="color:#ae81ff">1</span> week<span style="color:#f92672">)</span>
                                                    <span style="color:#ae81ff">86400</span>      ; minimum <span style="color:#f92672">(</span><span style="color:#ae81ff">1</span> day<span style="color:#f92672">)</span>
                                                    <span style="color:#f92672">)</span>
             NS          dns.k8s.com.
dns          A           10.0.0.11
</code></pre></div><hr>
<p>检查配置文件</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">named-checkconf
</code></pre></div><hr>
<p>启动服务</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">systemctl start named
</code></pre></div><hr>
<p>设置开机自动启动</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">systemctl enable named
</code></pre></div><hr>
<p>验证DNS解析</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">dig -t A host-0-12.host.com @10.0.0.11 +short
</code></pre></div><hr>
<h3 id="搭建证书签发环境">
  搭建证书签发环境
  <a class="anchor" href="#%e6%90%ad%e5%bb%ba%e8%af%81%e4%b9%a6%e7%ad%be%e5%8f%91%e7%8e%af%e5%a2%83">#</a>
</h3>
<hr>
<blockquote>
<p>cfssl：证书签发的主要工具</p>
<p>cfssl-json：将cfssl生成的证书（json格式）变为文件承载式证书（只是转换了一下格式）</p>
<p>cfssl-certinfo：验证证书的信息</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">cfssl-certinfo -cert &lt;证书名称&gt;
</code></pre></div><p>在运维主机<code>10.0.0.200</code>上安装证书签发服务</p>
</blockquote>
<hr>
<p>安装CFSSL</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">wget http://pkg.cfssl.org/R1.2/cfssl_linux-amd64 -O /usr/bin/cfssl
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">wget http://pkg.cfssl.org/R1.2/cfssljson_linux-amd64 -O /usr/bin/cfssl-json
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">wget http://pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64 -O /usr/bin/cfssl-certinfo
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">chmod +x /usr/bin/cfssl*
</code></pre></div><hr>
<p>创建生成CA证书签名请求（CSR）的JSON配置文件</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">mkdir /opt/certs
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">vim /opt/certs/ca-csr.json
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
	<span style="color:#f92672">&#34;CN&#34;</span>: <span style="color:#e6db74">&#34;k8s&#34;</span>,
	<span style="color:#f92672">&#34;hosts&#34;</span>: [],
	<span style="color:#f92672">&#34;key&#34;</span>: {
		<span style="color:#f92672">&#34;algo&#34;</span>: <span style="color:#e6db74">&#34;rsa&#34;</span>,
		<span style="color:#f92672">&#34;size&#34;</span>: <span style="color:#ae81ff">2048</span>
	},
	<span style="color:#f92672">&#34;names&#34;</span>: [
		{
			<span style="color:#f92672">&#34;C&#34;</span>: <span style="color:#e6db74">&#34;CN&#34;</span>,
			<span style="color:#f92672">&#34;ST&#34;</span>: <span style="color:#e6db74">&#34;beijing&#34;</span>,
			<span style="color:#f92672">&#34;L&#34;</span>: <span style="color:#e6db74">&#34;beijing&#34;</span>,
			<span style="color:#f92672">&#34;O&#34;</span>: <span style="color:#e6db74">&#34;k8s&#34;</span>,
			<span style="color:#f92672">&#34;OU&#34;</span>: <span style="color:#e6db74">&#34;ops&#34;</span>
		}
	],
	<span style="color:#f92672">&#34;ca&#34;</span>: {
		<span style="color:#f92672">&#34;expiry&#34;</span>: <span style="color:#e6db74">&#34;175200h&#34;</span>
	}
}
</code></pre></div><blockquote>
<p>CN: Common Name , 浏览器使用该字段验证网站是否合法，一般写的是域名。非常重要。</p>
<p>C： Country，国家</p>
<p>ST：State，州，省</p>
<p>L：Locality，地区，城市</p>
<p>O：Organization Name，组织名称，公司名称</p>
<p>OU：Organization Unit Name，组织单位名称，公司部门</p>
<p>expiry：证书过期时间</p>
</blockquote>
<hr>
<p>生成CA证书和私钥</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">cd /opt/certs <span style="color:#f92672">&amp;&amp;</span> cfssl gencert -initca ca-csr.json | cfssl-json -bare ca
</code></pre></div><blockquote>
<p>注意：私钥<code>ca-key.pem</code>的权限是600</p>
</blockquote>
<hr>
<h3 id="搭建docker环境">
  搭建Docker环境
  <a class="anchor" href="#%e6%90%ad%e5%bb%badocker%e7%8e%af%e5%a2%83">#</a>
</h3>
<hr>
<blockquote>
<p>在<code>10.0.0.200</code>、<code>10.0.0.21</code>、<code>10.0.0.22</code>上搭建Docker环境</p>
</blockquote>
<hr>
<p>安装Docker</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">curl -fsSL https://get.docker.com | bash -s docker --mirror Aliyun
</code></pre></div><hr>
<p>配置Docker</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">mkdir -p /etc/docker /data/docker
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">vi /etc/docker/daemon.json
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#f92672">{</span>
    <span style="color:#e6db74">&#34;graph&#34;</span>: <span style="color:#e6db74">&#34;/data/docker&#34;</span>,
    <span style="color:#e6db74">&#34;storage-driver&#34;</span>: <span style="color:#e6db74">&#34;overlay2&#34;</span>,
    <span style="color:#e6db74">&#34;insecure-registries&#34;</span>: <span style="color:#f92672">[</span><span style="color:#e6db74">&#34;registry.access.redhat.com&#34;</span>,<span style="color:#e6db74">&#34;quary.io&#34;</span>,<span style="color:#e6db74">&#34;harbor.k8s.com&#34;</span><span style="color:#f92672">]</span>,
    <span style="color:#e6db74">&#34;registry-mirrors&#34;</span>: <span style="color:#f92672">[</span><span style="color:#e6db74">&#34;https://q2gr04ke.mirror.aliyuncs.com&#34;</span><span style="color:#f92672">]</span>,
    <span style="color:#e6db74">&#34;bip&#34;</span>: <span style="color:#e6db74">&#34;172.16.200.1/24&#34;</span>,    <span style="color:#75715e"># 根据主机IP进行配置21.1 22.1 200.1</span>
    <span style="color:#e6db74">&#34;exec-opts&#34;</span>: <span style="color:#f92672">[</span><span style="color:#e6db74">&#34;native.cgroupdriver=systemd&#34;</span><span style="color:#f92672">]</span>,
    <span style="color:#e6db74">&#34;live-restore&#34;</span>: true
<span style="color:#f92672">}</span>
</code></pre></div><hr>
<p>启动Docker</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">systemctl start docker <span style="color:#f92672">&amp;&amp;</span> systemctl enable docker
</code></pre></div><hr>
<p>安装Docker-Compose（harbor依赖Docker-Compose做单机编排）</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">yum install -y docker-compose
</code></pre></div><hr>
<p>验证Docker-Compose</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">rpm -qa docker-compose
</code></pre></div><hr>
<h3 id="搭建私有镜像仓库harbor">
  搭建私有镜像仓库Harbor
  <a class="anchor" href="#%e6%90%ad%e5%bb%ba%e7%a7%81%e6%9c%89%e9%95%9c%e5%83%8f%e4%bb%93%e5%ba%93harbor">#</a>
</h3>
<hr>
<blockquote>
<p>harbor下载地址：https://github.com/goharbor/harbor/releases</p>
<p>在10.0.0.200上搭建Docker私有仓库harbor</p>
</blockquote>
<hr>
<p>下载harbor</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">mkdir /opt/installed <span style="color:#f92672">&amp;&amp;</span> cd /opt/installed
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">wget https://github.com/goharbor/harbor/releases/download/v1.10.4/harbor-offline-installer-v1.10.4.tgz
</code></pre></div><hr>
<p>解压harbor</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">tar -xvf /opt/installed/harbor-offline-installer-v1.10.4.tgz -C /opt/
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">mv /opt/harbor/ /opt/harbor-v1.10.4
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">ln -s /opt/harbor-v1.10.4/ /opt/harbor
</code></pre></div><hr>
<p>配置harbor</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">vim /opt/harbor/harbor.yml
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yml" data-lang="yml"><span style="color:#75715e"># 修改以下内容</span>
<span style="color:#f92672">hostname</span>: <span style="color:#ae81ff">harbor.k8s.com</span>

<span style="color:#f92672">http</span>:
  <span style="color:#f92672">port</span>: <span style="color:#ae81ff">8000</span>
  
<span style="color:#75715e"># 注释掉https，不然会报错[ERROR:root:Error: The protocol is https but attribute ssl_cert is not set]</span>
<span style="color:#75715e"># https:</span>
  <span style="color:#75715e"># port: 443</span>
  <span style="color:#75715e"># certificate: /your/certificate/path</span>
  <span style="color:#75715e"># private_key: /your/private/key/path</span>
  
<span style="color:#f92672">data_volume</span>: <span style="color:#ae81ff">/data/harbor</span>

<span style="color:#f92672">log</span>:
  <span style="color:#f92672">level</span>: <span style="color:#ae81ff">info</span>
  <span style="color:#f92672">local</span>:
    <span style="color:#f92672">rotate_count</span>: <span style="color:#ae81ff">50</span>
    <span style="color:#f92672">rotate_size</span>: <span style="color:#ae81ff">200M</span>
    <span style="color:#f92672">location</span>: <span style="color:#ae81ff">/data/harbor/logs</span>
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">mkdir -p /data/harbor/logs
</code></pre></div><hr>
<p>安装harbor</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">/opt/harbor/install.sh 
</code></pre></div><hr>
<p>验证harbor</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">docker-compose ps
</code></pre></div><hr>
<p>安装Nginx（反向代理harbor）</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">yum install -y nginx
</code></pre></div><hr>
<p>验证Nginx</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">rpm -qa nginx
</code></pre></div><hr>
<p>配置Nginx</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">vim /etc/nginx/conf.d/harbor.k8s.conf
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">server <span style="color:#f92672">{</span>
    listen	80;
    server_name		harbor.k8s.com;
	
    client_max_body_size	1000m;
	
    location / <span style="color:#f92672">{</span>
        proxy_pass http://127.0.0.1:8000;
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">nginx -t
</code></pre></div><hr>
<p>启动Nginx</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">systemctl start nginx
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">systemctl enable nginx
</code></pre></div><hr>
<p>在10.0.0.11中添加harbor的DNS解析</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">vim /var/named/k8s.com.zone
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ORIGIN k8s.com.
$TTL <span style="color:#ae81ff">60</span>        ; <span style="color:#ae81ff">1</span> minutes
@            IN    SOA    dns.k8s.com. dnsadmin.k8s.com. <span style="color:#f92672">(</span>
                                                    <span style="color:#ae81ff">2020010102</span> ; serial
                                                    <span style="color:#ae81ff">10800</span>      ; refresh <span style="color:#f92672">(</span><span style="color:#ae81ff">3</span> hours<span style="color:#f92672">)</span>
                                                    <span style="color:#ae81ff">900</span>        ; retry <span style="color:#f92672">(</span><span style="color:#ae81ff">15</span> minutes<span style="color:#f92672">)</span>
                                                    <span style="color:#ae81ff">604800</span>     ; expire <span style="color:#f92672">(</span><span style="color:#ae81ff">1</span> week<span style="color:#f92672">)</span>
                                                    <span style="color:#ae81ff">86400</span>      ; minimum <span style="color:#f92672">(</span><span style="color:#ae81ff">1</span> day<span style="color:#f92672">)</span>
                                                    <span style="color:#f92672">)</span>
             NS          dns.k8s.com.
dns          A           10.0.0.11
harbor       A           10.0.0.200
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">systemctl restart named
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">dig -t A harbor.k8s.com +short
<span style="color:#75715e"># 返回：10.0.0.200</span>
</code></pre></div><hr>
<p>更改宿主机的本地网卡和VMnet8的网卡DNS为10.0.0.11</p>
<hr>
<p>浏览器打开<code>harbor.k8s.com</code>，默认用户名：<code>admin</code>，默认密码：<code>Harbor12345</code></p>
<hr>
<p>在<code>项目</code>中，点击<code>新建项目</code>，项目名称设置为<code>public</code>，访问级别设置为：<code>公开</code></p>
<hr>
<p>在<code>10.0.0.200</code>上，下载镜像</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">docker pull nginx:1.7.9
</code></pre></div><hr>
<p>在<code>10.0.0.200</code>上，给镜像打标签</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">docker tag 84581e99d807 harbor.k8s.com/public/nginx:v1.7.9
</code></pre></div><hr>
<p>在<code>10.0.0.200</code>上，将<code>Nginx</code>镜像推送到harbor私有镜像仓库</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">docker login harbor.k8s.com
<span style="color:#75715e"># 输入harbor的用户名和密码</span>
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">docker push harbor.k8s.com/public/nginx:v1.7.9
</code></pre></div><hr>
<h3 id="部署主控master节点服务">
  部署主控（Master）节点服务
  <a class="anchor" href="#%e9%83%a8%e7%bd%b2%e4%b8%bb%e6%8e%a7master%e8%8a%82%e7%82%b9%e6%9c%8d%e5%8a%a1">#</a>
</h3>
<hr>
<h4 id="部署etcd集群">
  部署etcd集群
  <a class="anchor" href="#%e9%83%a8%e7%bd%b2etcd%e9%9b%86%e7%be%a4">#</a>
</h4>
<hr>
<blockquote>
<p>在<code>10.0.0.12</code>、<code>10.0.0.21</code>和<code>10.0.0.22</code>上安装<code>etcd</code>服务</p>
<table>
<thead>
<tr>
<th>主机名</th>
<th>角色</th>
<th>IP地址</th>
</tr>
</thead>
<tbody>
<tr>
<td>host-0-12.host.com</td>
<td>etcd lead</td>
<td>10.0.0.12</td>
</tr>
<tr>
<td>host-0-21.host.com</td>
<td>etcd follow</td>
<td>10.0.0.21</td>
</tr>
<tr>
<td>host-0-22.host.com</td>
<td>etcd follow</td>
<td>10.0.0.22</td>
</tr>
</tbody>
</table>
</blockquote>
<hr>
<p>由于<code>etcd</code>之间的通讯基于SSL，因此部署<code>etcd</code>之前，首先在<code>10.0.0.200</code>上创建基于根证书的配置文件</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">vim /opt/certs/ca-config.json
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
	<span style="color:#f92672">&#34;signing&#34;</span>: {
		<span style="color:#f92672">&#34;default&#34;</span>: {
			<span style="color:#f92672">&#34;expiry&#34;</span>: <span style="color:#e6db74">&#34;175200h&#34;</span>
		},
		<span style="color:#f92672">&#34;profiles&#34;</span>: {
			<span style="color:#f92672">&#34;server&#34;</span>: {
				<span style="color:#f92672">&#34;expiry&#34;</span>: <span style="color:#e6db74">&#34;175200h&#34;</span>,
				<span style="color:#f92672">&#34;usages&#34;</span>: [
					<span style="color:#e6db74">&#34;signing&#34;</span>,
					<span style="color:#e6db74">&#34;key encipherment&#34;</span>,
					<span style="color:#e6db74">&#34;server auth&#34;</span>
				]
			},
			<span style="color:#f92672">&#34;client&#34;</span>: {
				<span style="color:#f92672">&#34;expiry&#34;</span>: <span style="color:#e6db74">&#34;175200h&#34;</span>,
				<span style="color:#f92672">&#34;usages&#34;</span>: [
					<span style="color:#e6db74">&#34;signing&#34;</span>,
					<span style="color:#e6db74">&#34;key encipherment&#34;</span>,
					<span style="color:#e6db74">&#34;client auth&#34;</span>
				]
			},
			<span style="color:#f92672">&#34;peer&#34;</span>: {
				<span style="color:#f92672">&#34;expiry&#34;</span>: <span style="color:#e6db74">&#34;175200h&#34;</span>,
				<span style="color:#f92672">&#34;usages&#34;</span>: [
					<span style="color:#e6db74">&#34;signing&#34;</span>,
					<span style="color:#e6db74">&#34;key encipherment&#34;</span>,
					<span style="color:#e6db74">&#34;server auth&#34;</span>,
					<span style="color:#e6db74">&#34;client auth&#34;</span>
				]
			}
		}
	}
}
</code></pre></div><blockquote>
<p>证书类型:</p>
<p>client certificate：客户端使用，用于服务端认证客户端，例如：etcdctl、etcd proxy、fleetctl、docker客户端</p>
<p>server certificate：服务端使用，客户端以此验证服务端身份，例如：docker服务端、kube-apiserver</p>
<p>peer certificate：双向证书，用于etcd集群成员间通信</p>
</blockquote>
<hr>
<p>在<code>10.0.0.200</code>上创建生成自签证书签名请求（csr）的JSON配置文件</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">vim /opt/certs/etcd-peer-csr.json
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
	<span style="color:#f92672">&#34;CN&#34;</span>: <span style="color:#e6db74">&#34;k8s-etcd&#34;</span>,
	<span style="color:#f92672">&#34;hosts&#34;</span>: [
		<span style="color:#e6db74">&#34;10.0.0.11&#34;</span>,
		<span style="color:#e6db74">&#34;10.0.0.12&#34;</span>,
		<span style="color:#e6db74">&#34;10.0.0.21&#34;</span>,
		<span style="color:#e6db74">&#34;10.0.0.22&#34;</span>
	],
	<span style="color:#f92672">&#34;key&#34;</span>: {
		<span style="color:#f92672">&#34;algo&#34;</span>: <span style="color:#e6db74">&#34;rsa&#34;</span>,
		<span style="color:#f92672">&#34;size&#34;</span>: <span style="color:#ae81ff">2048</span>
	},
	<span style="color:#f92672">&#34;names&#34;</span>: [
		{
			<span style="color:#f92672">&#34;C&#34;</span>: <span style="color:#e6db74">&#34;CN&#34;</span>,
			<span style="color:#f92672">&#34;ST&#34;</span>: <span style="color:#e6db74">&#34;beijing&#34;</span>,
			<span style="color:#f92672">&#34;L&#34;</span>: <span style="color:#e6db74">&#34;beijing&#34;</span>,
			<span style="color:#f92672">&#34;O&#34;</span>: <span style="color:#e6db74">&#34;k8s&#34;</span>,
			<span style="color:#f92672">&#34;OU&#34;</span>: <span style="color:#e6db74">&#34;k8s&#34;</span>
		}
	]
}
</code></pre></div><hr>
<p>在<code>10.0.0.200</code>上签发<code>etcd</code>证书和私钥</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">cd /opt/certs
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">cfssl gencert -ca<span style="color:#f92672">=</span>ca.pem -ca-key<span style="color:#f92672">=</span>ca-key.pem -config<span style="color:#f92672">=</span>ca-config.json -profile<span style="color:#f92672">=</span>peer /opt/certs/etcd-peer-csr.json | cfssl-json -bare etcd-peer
</code></pre></div><hr>
<p>在<code>10.0.0.200</code>上检查签发的证书和私钥</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">ls -l | grep etcd
</code></pre></div><blockquote>
<p>注意：私钥<code>etcd-peer-key.pem</code>的权限是600</p>
</blockquote>
<hr>
<p>在<code>10.0.0.12</code>、<code>10.0.0.21</code>和<code>10.0.0.22</code>上创建<code>etcd</code>用户</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">useradd -s /sbin/nologin -M etcd
</code></pre></div><hr>
<p>在<code>10.0.0.12</code>、<code>10.0.0.21</code>和<code>10.0.0.22</code>上创建安装文件存储目录</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">mkdir /opt/installed <span style="color:#f92672">&amp;&amp;</span> cd /opt/installed/
</code></pre></div><hr>
<p>在<code>10.0.0.12</code>、<code>10.0.0.21</code>和<code>10.0.0.22</code>上,下载<code>etcd</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">wget https://github.com/etcd-io/etcd/releases/download/v3.1.20/etcd-v3.1.20-linux-amd64.tar.gz
</code></pre></div><hr>
<p>在<code>10.0.0.12</code>、<code>10.0.0.21</code>和<code>10.0.0.22</code>上解压<code>etcd</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">tar -zxvf etcd-v3.1.20-linux-amd64.tar.gz -C /opt/
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">mv /opt/etcd-v3.1.20-linux-amd64/ /opt/etcd-v3.1.20
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">ln -s /opt/etcd-v3.1.20 /opt/etcd
</code></pre></div><hr>
<p>在<code>10.0.0.12</code>、<code>10.0.0.21</code>和<code>10.0.0.22</code>上创建证书目录</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">mkdir -p /opt/etcd/certs /data/etcd /data/logs/etcd-server
</code></pre></div><hr>
<p>将运维主机<code>10.0.0.200</code>生成的<code>ca.pem</code>、<code>etcd-peer-key.pem</code>、<code>etcd-peer.pem</code>拷贝到<code>10.0.0.12</code>、<code>10.0.0.21</code>和<code>10.0.0.22</code>上的<code>/opt/etcd/certs</code>目录中</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">scp root@10.0.0.200:/opt/certs/ca.pem /opt/etcd/certs/
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">scp root@10.0.0.200:/opt/certs/etcd-peer-key.pem /opt/etcd/certs/
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">scp root@10.0.0.200:/opt/certs/etcd-peer.pem /opt/etcd/certs/
</code></pre></div><hr>
<p>在<code>10.0.0.12</code>、<code>10.0.0.21</code>和<code>10.0.0.22</code>创建<code>etcd</code>服务启动脚本</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">vim /opt/etcd/etcd-server-startup.sh
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e">#!/bin/bash
</span><span style="color:#75715e"></span>./etcd --name etcd-server-0-12 <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>       --data-dir /data/etcd/etcd-server <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>       --listen-peer-urls https://10.0.0.12:2380 <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>       --listen-client-urls https://10.0.0.12:2379,http://127.0.0.1:2379 <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>       --quota-backend-bytes <span style="color:#ae81ff">8000000000</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>       --initial-advertise-peer-urls https://10.0.0.12:2380 <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>       --advertise-client-urls https://10.0.0.12:2379,http://127.0.0.1:2379 <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>       --initial-cluster etcd-server-0-12<span style="color:#f92672">=</span>https://10.0.0.12:2380,etcd-server-0-21<span style="color:#f92672">=</span>https://10.0.0.21:2380,etcd-server-0-22<span style="color:#f92672">=</span>https://10.0.0.22:2380 <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>       --ca-file ./certs/ca.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>       --cert-file ./certs/etcd-peer.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>       --key-file ./certs/etcd-peer-key.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>       --client-cert-auth <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>       --trusted-ca-file ./certs/ca.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>       --peer-ca-file ./certs/ca.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>       --peer-cert-file ./certs/etcd-peer.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>       --peer-key-file ./certs/etcd-peer-key.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>       --peer-client-cert-auth <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>       --peer-trusted-ca-file ./certs/ca.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>       --log-output stdout
</code></pre></div><blockquote>
<p>注意：etcd集群中各主机的启动脚本略有不同，部署其他节点时注意修改</p>
</blockquote>
<hr>
<p>在<code>10.0.0.12</code>、<code>10.0.0.21</code>和<code>10.0.0.22</code>上修改<code>etcd-server-startup.sh</code>权限</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">chmod +x /opt/etcd/etcd-server-startup.sh
</code></pre></div><hr>
<p>在<code>10.0.0.12</code>、<code>10.0.0.21</code>和<code>10.0.0.22</code>上修改<code>/opt/etcd-v3.1.20</code>、<code>/data/etcd</code>、<code>/data/logs/etcd-server</code>目录的属主和属组</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">chown -R etcd:etcd /opt/etcd-v3.1.20 /data/etcd /data/logs/etcd-server
</code></pre></div><hr>
<p>在<code>10.0.0.12</code>、<code>10.0.0.21</code>和<code>10.0.0.22</code>安装并启动<code>supervisor</code>，将<code>etcd</code>通过<code>supervisor</code>变成后台进程</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">yum install -y supervisor
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">systemctl start supervisord <span style="color:#f92672">&amp;&amp;</span> systemctl enable supervisord
</code></pre></div><blockquote>
<p>Supervisor是用Python开发的一套通用的进程管理程序，能将一个普通的命令行进程变为后台daemon，并监控进程状态，异常退出时能自动重启。它是通过fork/exec的方式把这些被管理的进程当作supervisor的子进程来启动，这样只要在supervisor的配置文件中，把要管理的进程的可执行文件的路径写进去即可。也实现当子进程挂掉的时候，父进程可以准确获取子进程挂掉的信息的，可以选择是否自己启动和报警。supervisor还提供了一个功能，可以为supervisord或者每个子进程，设置一个非root的user，这个user就可以管理它对应的进程。</p>
</blockquote>
<hr>
<p>在<code>10.0.0.12</code>、<code>10.0.0.21</code>和<code>10.0.0.22</code>上创建<code>etcd-server</code>的启动配置文件</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">vim /etc/supervisord.d/etcd-server.ini
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ini" data-lang="ini"><span style="color:#66d9ef">[program:etcd-server-0-12]</span>
<span style="color:#a6e22e">command</span><span style="color:#f92672">=</span><span style="color:#e6db74">/opt/etcd/etcd-server-startup.sh</span>
<span style="color:#a6e22e">numprocs</span><span style="color:#f92672">=</span><span style="color:#e6db74">1</span>
<span style="color:#a6e22e">directory</span><span style="color:#f92672">=</span><span style="color:#e6db74">/opt/etcd</span>
<span style="color:#a6e22e">autostart</span><span style="color:#f92672">=</span><span style="color:#e6db74">true</span>
<span style="color:#a6e22e">autorestart</span><span style="color:#f92672">=</span><span style="color:#e6db74">true</span>
<span style="color:#a6e22e">startsecs</span><span style="color:#f92672">=</span><span style="color:#e6db74">30</span>
<span style="color:#a6e22e">startretries</span><span style="color:#f92672">=</span><span style="color:#e6db74">3</span>
<span style="color:#a6e22e">exitcodes</span><span style="color:#f92672">=</span><span style="color:#e6db74">0,2</span>
<span style="color:#a6e22e">stopsignal</span><span style="color:#f92672">=</span><span style="color:#e6db74">QUIT</span>
<span style="color:#a6e22e">stopwaitsecs</span><span style="color:#f92672">=</span><span style="color:#e6db74">10</span>
<span style="color:#a6e22e">user</span><span style="color:#f92672">=</span><span style="color:#e6db74">etcd</span>
<span style="color:#a6e22e">redirect_stderr</span><span style="color:#f92672">=</span><span style="color:#e6db74">true</span>
<span style="color:#a6e22e">stdout_logfile</span><span style="color:#f92672">=</span><span style="color:#e6db74">/data/logs/etcd-server/etcd.stdout.log</span>
<span style="color:#a6e22e">stdout_logfile_maxbytes</span><span style="color:#f92672">=</span><span style="color:#e6db74">64MB</span>
<span style="color:#a6e22e">stdout_logfile_backups</span><span style="color:#f92672">=</span><span style="color:#e6db74">4</span>
<span style="color:#a6e22e">stdout_capture_maxbytes</span><span style="color:#f92672">=</span><span style="color:#e6db74">1MB</span>
<span style="color:#a6e22e">stdout_events_enabled</span><span style="color:#f92672">=</span><span style="color:#e6db74">false</span>
</code></pre></div><blockquote>
<p>注意：etcd集群中各主机的启动脚本略有不同，部署其他节点时注意修改</p>
</blockquote>
<hr>
<p>在<code>10.0.0.12</code>、<code>10.0.0.21</code>和<code>10.0.0.22</code>上通过<code>supervisor</code>启动<code>etcd-server</code>，并检查启动状态</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">supervisorctl update
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">supervisorctl status
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">netstat -lntup | grep etcd
</code></pre></div><hr>
<p>在任意一台部署的<code>etcd</code>服务器上，使用<code>etcdctl</code>检测集群的健康状态</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">/opt/etcd/etcdctl cluster-health
<span style="color:#75715e"># 或者使用以下命令：</span>
/opt/etcd/etcdctl member list
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># 出现以下信息说明集群状态正确</span>
member 6cbdd801d2c800d9 is healthy: got healthy result from http://127.0.0.1:2379
member 74538ef5dc383e39 is healthy: got healthy result from http://127.0.0.1:2379
member f7a9c20602b8532e is healthy: got healthy result from http://127.0.0.1:2379
cluster is healthy
</code></pre></div><hr>
<h4 id="部署kube-apiserver集群">
  部署kube-apiserver集群
  <a class="anchor" href="#%e9%83%a8%e7%bd%b2kube-apiserver%e9%9b%86%e7%be%a4">#</a>
</h4>
<hr>
<blockquote>
<p>集群规划</p>
<table>
<thead>
<tr>
<th>主机名</th>
<th>角色</th>
<th>IP地址</th>
</tr>
</thead>
<tbody>
<tr>
<td>host-0-21.host.com</td>
<td>kube-apiserver</td>
<td>10.0.0.21</td>
</tr>
<tr>
<td>host-0-22.host.com</td>
<td>kube-apiserver</td>
<td>10.0.0.22</td>
</tr>
<tr>
<td>host-0-11.host.com</td>
<td>Nginx 4层负载均衡</td>
<td>10.0.0.11</td>
</tr>
<tr>
<td>host-0-12.host.com</td>
<td>Nginx 4层负载均衡</td>
<td>10.0.0.12</td>
</tr>
</tbody>
</table>
<p>在<code>10.0.0.11</code>和<code>10.0.0.12</code>上使用Nginx做4层负载均衡器，用Keepalived跑一个VIP：<code>10.0.0.10</code>，代理两个<code>kube-apiserver</code>实现高可用</p>
</blockquote>
<hr>
<p>在<code>10.0.0.21</code>、<code>10.0.0.22</code>上，下载Kubernetes的Server Binaries</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">cd /opt/installed/ <span style="color:#f92672">&amp;&amp;</span> wget https://dl.k8s.io/v1.18.6/kubernetes-server-linux-amd64.tar.gz
</code></pre></div><hr>
<p>在<code>10.0.0.21</code>、<code>10.0.0.22</code>上，解压Kubernetes的Server Binaries</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">tar -zxvf kubernetes-server-linux-amd64.tar.gz -C /opt/
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">mv /opt/kubernetes/ /opt/kubernetes-v1.18.6
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">ln -s /opt/kubernetes-v1.18.6/ /opt/kubernetes
</code></pre></div><hr>
<p>在<code>10.0.0.200</code>上签发client证书（apiserver与etcd集群通信时使用的证书，apiserver是客户端，etcd集群是服务端）</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">vim /opt/certs/apiserver-to-etcd-csr.json
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
	<span style="color:#f92672">&#34;CN&#34;</span>: <span style="color:#e6db74">&#34;k8s-node&#34;</span>,
	<span style="color:#f92672">&#34;hosts&#34;</span>: [],
	<span style="color:#f92672">&#34;key&#34;</span>: {
		<span style="color:#f92672">&#34;algo&#34;</span>: <span style="color:#e6db74">&#34;rsa&#34;</span>,
		<span style="color:#f92672">&#34;size&#34;</span>: <span style="color:#ae81ff">2048</span>
	},
	<span style="color:#f92672">&#34;names&#34;</span>: [
		{
			<span style="color:#f92672">&#34;C&#34;</span>: <span style="color:#e6db74">&#34;CN&#34;</span>,
			<span style="color:#f92672">&#34;ST&#34;</span>: <span style="color:#e6db74">&#34;beijing&#34;</span>,
			<span style="color:#f92672">&#34;L&#34;</span>: <span style="color:#e6db74">&#34;beijing&#34;</span>,
			<span style="color:#f92672">&#34;O&#34;</span>: <span style="color:#e6db74">&#34;k8s&#34;</span>,
			<span style="color:#f92672">&#34;OU&#34;</span>: <span style="color:#e6db74">&#34;ops&#34;</span>
		}
	]
}
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">cfssl gencert -ca<span style="color:#f92672">=</span>ca.pem -ca-key<span style="color:#f92672">=</span>ca-key.pem -config<span style="color:#f92672">=</span>ca-config.json -profile<span style="color:#f92672">=</span>client apiserver-to-etcd-csr.json | cfssl-json -bare apiserver-to-etcd
</code></pre></div><hr>
<p>在<code>10.0.0.200</code>上签发<code>kube-apiserver</code>的证书（其他组件与apiserver通信时所需要的证书）</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">vim /opt/certs/apiserver-csr.json
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
	<span style="color:#f92672">&#34;CN&#34;</span>: <span style="color:#e6db74">&#34;k8s-apiserver&#34;</span>,
	<span style="color:#f92672">&#34;hosts&#34;</span>: [
		<span style="color:#e6db74">&#34;127.0.0.1&#34;</span>,
		<span style="color:#e6db74">&#34;192.168.0.1&#34;</span>,
		<span style="color:#e6db74">&#34;kubernetes.default&#34;</span>,
		<span style="color:#e6db74">&#34;kubernetes.default.svc&#34;</span>,
		<span style="color:#e6db74">&#34;kubernetes.default.svc.cluster&#34;</span>,
		<span style="color:#e6db74">&#34;kubernetes.default.svc.cluster.local&#34;</span>,
		<span style="color:#e6db74">&#34;10.0.0.10&#34;</span>,
		<span style="color:#e6db74">&#34;10.0.0.21&#34;</span>,
		<span style="color:#e6db74">&#34;10.0.0.22&#34;</span>,
		<span style="color:#e6db74">&#34;10.0.0.23&#34;</span>
	],
	<span style="color:#f92672">&#34;key&#34;</span>: {
		<span style="color:#f92672">&#34;algo&#34;</span>: <span style="color:#e6db74">&#34;rsa&#34;</span>,
		<span style="color:#f92672">&#34;size&#34;</span>: <span style="color:#ae81ff">2048</span>
	},
	<span style="color:#f92672">&#34;names&#34;</span>: [
		{
			<span style="color:#f92672">&#34;C&#34;</span>: <span style="color:#e6db74">&#34;CN&#34;</span>,
			<span style="color:#f92672">&#34;ST&#34;</span>: <span style="color:#e6db74">&#34;beijing&#34;</span>,
			<span style="color:#f92672">&#34;L&#34;</span>: <span style="color:#e6db74">&#34;beijing&#34;</span>,
			<span style="color:#f92672">&#34;O&#34;</span>: <span style="color:#e6db74">&#34;k8s&#34;</span>,
			<span style="color:#f92672">&#34;OU&#34;</span>: <span style="color:#e6db74">&#34;ops&#34;</span>
		}
	]
}
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">cfssl gencert -ca<span style="color:#f92672">=</span>ca.pem -ca-key<span style="color:#f92672">=</span>ca-key.pem -config<span style="color:#f92672">=</span>ca-config.json -profile<span style="color:#f92672">=</span>server apiserver-csr.json | cfssl-json -bare apiserver
</code></pre></div><hr>
<p>在<code>10.0.0.21</code>、<code>10.0.0.22</code>上创建证书目录</p>
<pre tabindex="0"><code>mkdir -p /opt/kubernetes/server/bin/certs
</code></pre><hr>
<p>在<code>10.0.0.21</code>、<code>10.0.0.22</code>上从<code>10.0.0.200</code>上将证书和私钥下载到证书目录中</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">cd /opt/kubernetes/server/bin/certs
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">scp root@10.0.0.200:/opt/certs/ca.pem /opt/kubernetes/server/bin/certs
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">scp root@10.0.0.200:/opt/certs/ca-key.pem /opt/kubernetes/server/bin/certs
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">scp root@10.0.0.200:/opt/certs/apiserver.pem /opt/kubernetes/server/bin/certs
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">scp root@10.0.0.200:/opt/certs/apiserver-key.pem /opt/kubernetes/server/bin/certs
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">scp root@10.0.0.200:/opt/certs/apiserver-to-etcd.pem /opt/kubernetes/server/bin/certs
</code></pre></div><pre tabindex="0"><code>scp root@10.0.0.200:/opt/certs/apiserver-to-etcd-key.pem /opt/kubernetes/server/bin/certs
</code></pre><hr>
<p>在<code>10.0.0.21</code>、<code>10.0.0.22</code>上创建<code>kube-apiserver</code>的审计策略配置文件</p>
<blockquote>
<p>Kubernetes 审计功能提供了与安全相关的按时间顺序排列的记录集，记录单个用户、管理员或系统其他组件影响系统的活动顺序。 它能帮助集群管理员处理以下问题：</p>
<ul>
<li>发生了什么？</li>
<li>什么时候发生的？</li>
<li>谁触发的？</li>
<li>为什么发生？</li>
<li>在哪观察到的？</li>
<li>它从哪触发的？</li>
<li>它将产生什么后果？</li>
</ul>
<p>审计政策定义了关于应记录哪些事件以及应包含哪些数据的规则。处理事件时，将按顺序与规则列表进行比较。第一个匹配规则设置事件的 
  <a href="https://github.com/kubernetes/community/blob/master/contributors/design-proposals/api-machinery/auditing.md#levels">审计级别</a>。 审计策略对象结构在 
  <a href="https://github.com/kubernetes/kubernetes/blob/master/staging/src/k8s.io/apiserver/pkg/apis/audit/v1beta1/types.go">audit.k8s.io API 组</a> 中定义。</p>
<p>您可以使用 &ndash;audit-policy-file 标志将包含策略的文件传递给 
  <a href="http://docs.kubernetes.org.cn/31.html">kube-apiserver</a>。如果不设置该标志，则不记录事件。 注意： kind 和 apiVersion 字段以及 rules 必须 在审计策略文件中提供。没有（0）规则的策略或者不提供有效的 apiVersion 和 kind 值的策略将被视为非法配置。</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">mkdir /opt/kubernetes/server/bin/conf
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">vim /opt/kubernetes/server/bin/conf/audit-policy.yaml
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">audit.k8s.io/v1beta1</span> <span style="color:#75715e"># This is required.</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Policy</span>
<span style="color:#75715e"># Don&#39;t generate audit events for all requests in RequestReceived stage.</span>
<span style="color:#f92672">omitStages</span>:
  - <span style="color:#e6db74">&#34;RequestReceived&#34;</span>
<span style="color:#f92672">rules</span>:
  <span style="color:#75715e"># Log pod changes at RequestResponse level</span>
  - <span style="color:#f92672">level</span>: <span style="color:#ae81ff">RequestResponse</span>
    <span style="color:#f92672">resources</span>:
    - <span style="color:#f92672">group</span>: <span style="color:#e6db74">&#34;&#34;</span>
      <span style="color:#75715e"># Resource &#34;pods&#34; doesn&#39;t match requests to any subresource of pods,</span>
      <span style="color:#75715e"># which is consistent with the RBAC policy.</span>
      <span style="color:#f92672">resources</span>: [<span style="color:#e6db74">&#34;pods&#34;</span>]
  <span style="color:#75715e"># Log &#34;pods/log&#34;, &#34;pods/status&#34; at Metadata level</span>
  - <span style="color:#f92672">level</span>: <span style="color:#ae81ff">Metadata</span>
    <span style="color:#f92672">resources</span>:
    - <span style="color:#f92672">group</span>: <span style="color:#e6db74">&#34;&#34;</span>
      <span style="color:#f92672">resources</span>: [<span style="color:#e6db74">&#34;pods/log&#34;</span>, <span style="color:#e6db74">&#34;pods/status&#34;</span>]

  <span style="color:#75715e"># Don&#39;t log requests to a configmap called &#34;controller-leader&#34;</span>
  - <span style="color:#f92672">level</span>: <span style="color:#ae81ff">None</span>
    <span style="color:#f92672">resources</span>:
    - <span style="color:#f92672">group</span>: <span style="color:#e6db74">&#34;&#34;</span>
      <span style="color:#f92672">resources</span>: [<span style="color:#e6db74">&#34;configmaps&#34;</span>]
      <span style="color:#f92672">resourceNames</span>: [<span style="color:#e6db74">&#34;controller-leader&#34;</span>]

  <span style="color:#75715e"># Don&#39;t log watch requests by the &#34;system:kube-proxy&#34; on endpoints or services</span>
  - <span style="color:#f92672">level</span>: <span style="color:#ae81ff">None</span>
    <span style="color:#f92672">users</span>: [<span style="color:#e6db74">&#34;system:kube-proxy&#34;</span>]
    <span style="color:#f92672">verbs</span>: [<span style="color:#e6db74">&#34;watch&#34;</span>]
    <span style="color:#f92672">resources</span>:
    - <span style="color:#f92672">group</span>: <span style="color:#e6db74">&#34;&#34;</span> <span style="color:#75715e"># core API group</span>
      <span style="color:#f92672">resources</span>: [<span style="color:#e6db74">&#34;endpoints&#34;</span>, <span style="color:#e6db74">&#34;services&#34;</span>]

  <span style="color:#75715e"># Don&#39;t log authenticated requests to certain non-resource URL paths.</span>
  - <span style="color:#f92672">level</span>: <span style="color:#ae81ff">None</span>
    <span style="color:#f92672">userGroups</span>: [<span style="color:#e6db74">&#34;system:authenticated&#34;</span>]
    <span style="color:#f92672">nonResourceURLs</span>:
    - <span style="color:#e6db74">&#34;/api*&#34;</span> <span style="color:#75715e"># Wildcard matching.</span>
    - <span style="color:#e6db74">&#34;/version&#34;</span>

  <span style="color:#75715e"># Log the request body of configmap changes in kube-system.</span>
  - <span style="color:#f92672">level</span>: <span style="color:#ae81ff">Request</span>
    <span style="color:#f92672">resources</span>:
    - <span style="color:#f92672">group</span>: <span style="color:#e6db74">&#34;&#34;</span> <span style="color:#75715e"># core API group</span>
      <span style="color:#f92672">resources</span>: [<span style="color:#e6db74">&#34;configmaps&#34;</span>]
    <span style="color:#75715e"># This rule only applies to resources in the &#34;kube-system&#34; namespace.</span>
    <span style="color:#75715e"># The empty string &#34;&#34; can be used to select non-namespaced resources.</span>
    <span style="color:#f92672">namespaces</span>: [<span style="color:#e6db74">&#34;kube-system&#34;</span>]

  <span style="color:#75715e"># Log configmap and secret changes in all other namespaces at the Metadata level.</span>
  - <span style="color:#f92672">level</span>: <span style="color:#ae81ff">Metadata</span>
    <span style="color:#f92672">resources</span>:
    - <span style="color:#f92672">group</span>: <span style="color:#e6db74">&#34;&#34;</span> <span style="color:#75715e"># core API group</span>
      <span style="color:#f92672">resources</span>: [<span style="color:#e6db74">&#34;secrets&#34;</span>, <span style="color:#e6db74">&#34;configmaps&#34;</span>]

  <span style="color:#75715e"># Log all other resources in core and extensions at the Request level.</span>
  - <span style="color:#f92672">level</span>: <span style="color:#ae81ff">Request</span>
    <span style="color:#f92672">resources</span>:
    - <span style="color:#f92672">group</span>: <span style="color:#e6db74">&#34;&#34;</span> <span style="color:#75715e"># core API group</span>
    - <span style="color:#f92672">group</span>: <span style="color:#e6db74">&#34;extensions&#34;</span> <span style="color:#75715e"># Version of group should NOT be included.</span>

  <span style="color:#75715e"># A catch-all rule to log all other requests at the Metadata level.</span>
  - <span style="color:#f92672">level</span>: <span style="color:#ae81ff">Metadata</span>
    <span style="color:#75715e"># Long-running requests like watches that fall under this rule will not</span>
    <span style="color:#75715e"># generate an audit event in RequestReceived.</span>
    <span style="color:#f92672">omitStages</span>:
      - <span style="color:#e6db74">&#34;RequestReceived&#34;</span>
</code></pre></div><hr>
<p>在<code>10.0.0.21</code>、<code>10.0.0.22</code>上创建<code>kube-apiserver</code>的启动脚本</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">vim /opt/kubernetes/server/bin/kube-apiserver.sh
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e">#!/bin/bash
</span><span style="color:#75715e"></span>./kube-apiserver <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --apiserver-count <span style="color:#ae81ff">2</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --audit-log-path /data/logs/kubernetes/kube-apiserver/audit-policy-log <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --audit-policy-file ./conf/audit-policy.yaml <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --authorization-mode RBAC <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --client-ca-file ./certs/ca.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --requestheader-client-ca-file ./certs/ca.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --enable-admission-plugins NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,MutatingAdmissionWebhook,ValidatingAdmissionWebhook,ResourceQuota <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --etcd-cafile ./certs/ca.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --etcd-certfile ./certs/apiserver-to-etcd.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --etcd-keyfile ./certs/apiserver-to-etcd-key.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --etcd-servers https://10.0.0.12:2379,https://10.0.0.21:2379,https://10.0.0.22:2379 <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --service-account-key-file ./certs/ca-key.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --service-cluster-ip-range 192.168.0.0/16 <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --service-node-port-range 3000-29999 <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --target-ram-mb<span style="color:#f92672">=</span><span style="color:#ae81ff">1024</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --kubelet-client-certificate ./certs/apiserver-to-etcd.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --kubelet-client-key ./certs/apiserver-to-etcd-key.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --log-dir /data/logs/kubernetes/kube-apiserver <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --tls-cert-file ./certs/apiserver.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --tls-private-key-file ./certs/apiserver-key.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --v <span style="color:#ae81ff">2</span>
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">chmod +x /opt/kubernetes/server/bin/kube-apiserver.sh
</code></pre></div><hr>
<p>在<code>10.0.0.21</code>、<code>10.0.0.22</code>上的<code>supervisor</code>中创建<code>kube-apiserver</code>的启动配置文件</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">vim /etc/supervisord.d/kube-apiserver.ini
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ini" data-lang="ini"><span style="color:#66d9ef">[program:kube-apiserver-0-21]</span>
<span style="color:#a6e22e">command</span><span style="color:#f92672">=</span><span style="color:#e6db74">/opt/kubernetes/server/bin/kube-apiserver.sh</span>
<span style="color:#a6e22e">numprocs</span><span style="color:#f92672">=</span><span style="color:#e6db74">1</span>
<span style="color:#a6e22e">directory</span><span style="color:#f92672">=</span><span style="color:#e6db74">/opt/kubernetes/server/bin</span>
<span style="color:#a6e22e">autostart</span><span style="color:#f92672">=</span><span style="color:#e6db74">true</span>
<span style="color:#a6e22e">autorestart</span><span style="color:#f92672">=</span><span style="color:#e6db74">true</span>
<span style="color:#a6e22e">startsecs</span><span style="color:#f92672">=</span><span style="color:#e6db74">30</span>
<span style="color:#a6e22e">startretries</span><span style="color:#f92672">=</span><span style="color:#e6db74">3</span>
<span style="color:#a6e22e">exitcodes</span><span style="color:#f92672">=</span><span style="color:#e6db74">0,2</span>
<span style="color:#a6e22e">stopsignal</span><span style="color:#f92672">=</span><span style="color:#e6db74">QUIT</span>
<span style="color:#a6e22e">stopwaitsecs</span><span style="color:#f92672">=</span><span style="color:#e6db74">10</span>
<span style="color:#a6e22e">user</span><span style="color:#f92672">=</span><span style="color:#e6db74">root</span>
<span style="color:#a6e22e">redirect_stderr</span><span style="color:#f92672">=</span><span style="color:#e6db74">true</span>
<span style="color:#a6e22e">stdout_logfile</span><span style="color:#f92672">=</span><span style="color:#e6db74">/data/logs/kubernetes/kube-apiserver/kube-apiserver.stdout.log</span>
<span style="color:#a6e22e">stdout_logfile_maxbytes</span><span style="color:#f92672">=</span><span style="color:#e6db74">64MB</span>
<span style="color:#a6e22e">stdout_logfile_backups</span><span style="color:#f92672">=</span><span style="color:#e6db74">4</span>
<span style="color:#a6e22e">stdout_capture_maxbytes</span><span style="color:#f92672">=</span><span style="color:#e6db74">1MB</span>
<span style="color:#a6e22e">stdout_events_enabled</span><span style="color:#f92672">=</span><span style="color:#e6db74">false</span>
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">mkdir -p /data/logs/kubernetes/kube-apiserver
</code></pre></div><hr>
<p>在<code>10.0.0.21</code>、<code>10.0.0.22</code>上通过<code>supervisor</code>启动<code>kube-apiserver</code>，并检查启动状态</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">supervisorctl update
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">supervisorctl status
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">netstat -lntup | grep kube-apiserv
</code></pre></div><hr>
<p>在<code>10.0.0.11</code>、<code>10.0.0.12</code>上，安装<code>Nginx</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">yum install -y nginx
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">rpm -qa nginx
</code></pre></div><hr>
<p>在<code>10.0.0.11</code>、<code>10.0.0.12</code>上，配置4层反向代理（由于是四层反向代理，因此不能配置在Nginx配置文件的<code>http{}</code>里，需要配置在最后）</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">vim /etc/nginx/nginx.conf
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># kube-apiserver的四层反向代理</span>
stream<span style="color:#f92672">{</span>
	upstream kube-apiserver <span style="color:#f92672">{</span>
		server 10.0.0.21:6443	max_fails<span style="color:#f92672">=</span>3	fail_timeout<span style="color:#f92672">=</span>30s;
		server 10.0.0.22:6443	max_fails<span style="color:#f92672">=</span>3	fail_timeout<span style="color:#f92672">=</span>30s;
	<span style="color:#f92672">}</span>
	server <span style="color:#f92672">{</span>
		listen 7443;
		proxy_connect_timeout 2s;
		proxy_timeout 900s;
		proxy_pass kube-apiserver;
	<span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><hr>
<p>在<code>10.0.0.11</code>、<code>10.0.0.12</code>上，启动<code>Nginx</code>并设置开机启动</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">nginx -t
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">systemctl start nginx <span style="color:#f92672">&amp;&amp;</span> systemctl enable nginx
</code></pre></div><hr>
<p>在<code>10.0.0.11</code>、<code>10.0.0.12</code>上， 安装<code>Keepalived</code>高可用</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">yum install -y keepalived
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">rpm -qa keepalived
</code></pre></div><hr>
<p>在<code>10.0.0.11</code>、<code>10.0.0.12</code>上，制作<code>Keepalived</code>的监听脚本</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">vim /etc/keepalived/check_port.sh
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e">#!/bin/bash
</span><span style="color:#75715e"></span><span style="color:#75715e"># keepalived 监控端口脚本</span>
<span style="color:#75715e"># 使用方法：</span>
<span style="color:#75715e"># 在keepalived的配置文件中：</span>
<span style="color:#75715e"># vrrp_script check_port {</span>
<span style="color:#75715e">#     script &#34;/etc/keepalived/check_port.sh 6379&#34;    # 配置监听的端口</span>
<span style="color:#75715e">#     interval 2    # 检查脚本的频率，单位（秒）</span>
<span style="color:#75715e"># }</span>

CHK_PORT<span style="color:#f92672">=</span>$1
<span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> -n <span style="color:#e6db74">&#34;</span>$CHK_PORT<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">]</span>;<span style="color:#66d9ef">then</span>
	PORT_PROCESS<span style="color:#f92672">=</span><span style="color:#e6db74">`</span>ss -lnt|grep $CHK_PORT|wc -l<span style="color:#e6db74">`</span>
	<span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> $PORT_PROCESS -eq <span style="color:#ae81ff">0</span> <span style="color:#f92672">]</span>;<span style="color:#66d9ef">then</span>
		echo <span style="color:#e6db74">&#34;Port </span>$CHK_PORT<span style="color:#e6db74"> is Not Used，End.&#34;</span>
		exit <span style="color:#ae81ff">1</span>
    <span style="color:#66d9ef">fi</span>
<span style="color:#66d9ef">else</span>
	echo <span style="color:#e6db74">&#34;Check Port Can&#39;t Be Empty!&#34;</span>
<span style="color:#66d9ef">fi</span>
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">chmod +x /etc/keepalived/check_port.sh
</code></pre></div><hr>
<p>在<code>10.0.0.11</code>上，配置<code>keepalived</code>（主）（将<code>keepalived.conf</code>中的内容全部删除）</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">vim /etc/keepalived/keepalived.conf
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">! Configuration File <span style="color:#66d9ef">for</span> keepalived

global_defs <span style="color:#f92672">{</span>
	router_id 10.0.0.11
<span style="color:#f92672">}</span>

vrrp_script chk_nginx <span style="color:#f92672">{</span>
	script <span style="color:#e6db74">&#34;/etc/keepalived/check_port.sh 7443&#34;</span>
	interval <span style="color:#ae81ff">2</span>
	weight -20
<span style="color:#f92672">}</span>

vrrp_instance VI_1 <span style="color:#f92672">{</span>
	state MASTER
	interface eth0    <span style="color:#75715e"># 注意根据网卡名称进行修改</span>
	virtual_router_id <span style="color:#ae81ff">251</span>
	priority <span style="color:#ae81ff">100</span>
	advert_int <span style="color:#ae81ff">1</span>
	mcast_src_ip 10.0.0.11
	nopreempt
	
	authentication <span style="color:#f92672">{</span>
		auth_type PASS
		auth_pass <span style="color:#ae81ff">11111111</span>
	<span style="color:#f92672">}</span>
	
	track_script <span style="color:#f92672">{</span>
		chk_nginx
	<span style="color:#f92672">}</span>
	
	virtual_ipaddress <span style="color:#f92672">{</span>
		10.0.0.10
	<span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><hr>
<p>在<code>10.0.0.12</code>上，配置<code>keepalived</code>（从）（将<code>keepalived.conf</code>中的内容全部删除）</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">vim /etc/keepalived/keepalived.conf
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">! Configuration File <span style="color:#66d9ef">for</span> keepalived

global_defs <span style="color:#f92672">{</span>
	router_id 10.0.0.12
<span style="color:#f92672">}</span>

vrrp_script chk_nginx <span style="color:#f92672">{</span>
	script <span style="color:#e6db74">&#34;/etc/keepalived/check_port.sh 7443&#34;</span>
	interval <span style="color:#ae81ff">2</span>
	weight -20
<span style="color:#f92672">}</span>

vrrp_instance VI_1 <span style="color:#f92672">{</span>
	state BACKUP
	interface eth0    <span style="color:#75715e"># 注意根据网卡名称进行修改</span>
	virtual_router_id <span style="color:#ae81ff">251</span>
	priority <span style="color:#ae81ff">90</span>
	advert_int <span style="color:#ae81ff">1</span>
	mcast_src_ip 10.0.0.12
	
	authentication <span style="color:#f92672">{</span>
		auth_type PASS
		auth_pass <span style="color:#ae81ff">11111111</span>
	<span style="color:#f92672">}</span>
	
	track_script <span style="color:#f92672">{</span>
		chk_nginx
	<span style="color:#f92672">}</span>
	
	virtual_ipaddress <span style="color:#f92672">{</span>
		10.0.0.10
	<span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><hr>
<p>在<code>10.0.0.11</code>、<code>10.0.0.12</code>上，启动<code>keepalived</code>并设置开机启动</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">systemctl start keepalived <span style="color:#f92672">&amp;&amp;</span> systemctl enable keepalived
</code></pre></div><hr>
<p>在<code>10.0.0.11</code>、<code>10.0.0.12</code>上，检查keepalived启动情况</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">ip addr
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">netstat -lntup | grep <span style="color:#ae81ff">7443</span>
</code></pre></div><hr>
<h4 id="部署kube-controller-manager集群">
  部署kube-controller-manager集群
  <a class="anchor" href="#%e9%83%a8%e7%bd%b2kube-controller-manager%e9%9b%86%e7%be%a4">#</a>
</h4>
<hr>
<blockquote>
<p><em>kube-controller-manager不用签证书</em></p>
<p>集群规划</p>
<table>
<thead>
<tr>
<th>主机名</th>
<th>角色</th>
<th>IP地址</th>
</tr>
</thead>
<tbody>
<tr>
<td>host-0-21.host.com</td>
<td>kube-controller-manager</td>
<td>10.0.0.21</td>
</tr>
<tr>
<td>host-0-22.host.com</td>
<td>kube-controller-manager</td>
<td>10.0.0.22</td>
</tr>
</tbody>
</table>
</blockquote>
<hr>
<p>在<code>10.0.0.21</code>、<code>10.0.0.22</code>上创建<code>kube-controller-manager</code>启动脚本</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">vim /opt/kubernetes/server/bin/kube-controller-manager.sh
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e">#!/bin/bash
</span><span style="color:#75715e"></span>./kube-controller-manager <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>	--cluster-cidr 172.168.0.0/16 <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>	--leader-elect true <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>	--log-dir /data/logs/kubernetes/kube-controller-manager <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>	--master http://127.0.0.1:8080 <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>	--service-account-private-key-file ./certs/ca-key.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>	--service-cluster-ip-range 192.168.0.0/16 <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>	--root-ca-file ./certs/ca.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>	--v <span style="color:#ae81ff">2</span>
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">chmod +x /opt/kubernetes/server/bin/kube-controller-manager.sh
</code></pre></div><hr>
<p>在<code>10.0.0.21</code>、<code>10.0.0.22</code>上创建<code>kube-controller-manager</code>启动脚本的相关目录</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">mkdir -p /data/logs/kubernetes/kube-controller-manager
</code></pre></div><hr>
<p>在<code>10.0.0.21</code>、<code>10.0.0.22</code>上的<code>supervisor</code>中创建<code>kube-controller-manager</code>的启动配置文件</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">vim /etc/supervisord.d/kube-conntroller-manager.ini
</code></pre></div><pre tabindex="0"><code>[program:kube-controller-manager-0-21]
command=/opt/kubernetes/server/bin/kube-controller-manager.sh
numprocs=1
directory=/opt/kubernetes/server/bin
autostart=true
autorestart=true
startsecs=30
startretries=3
exitcodes=0,2
stopsignal=QUIT
stopwaitsecs=10
user=root
redirect_stderr=true
stdout_logfile=/data/logs/kubernetes/kube-controller-manager/kube-controller-manager.stdout.log
stdout_logfile_maxbytes=64MB
stdout_logfile_backups=4
stdout_capture_maxbytes=1MB
stdout_events_enabled=false
</code></pre><hr>
<p>在<code>10.0.0.21</code>、<code>10.0.0.22</code>上通过<code>supervisor</code>启动<code>kube-controller-manager</code>，并检查启动状态</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">supervisorctl update
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">supervisorctl status
</code></pre></div><hr>
<h4 id="部署kube-scheduler集群">
  部署kube-scheduler集群
  <a class="anchor" href="#%e9%83%a8%e7%bd%b2kube-scheduler%e9%9b%86%e7%be%a4">#</a>
</h4>
<hr>
<blockquote>
<p><em>kube-controller-manager不用签证书</em></p>
<p>集群规划</p>
<table>
<thead>
<tr>
<th>主机名</th>
<th>角色</th>
<th>IP地址</th>
</tr>
</thead>
<tbody>
<tr>
<td>host-0-21.host.com</td>
<td>kube-controller-manager</td>
<td>10.0.0.21</td>
</tr>
<tr>
<td>host-0-22.host.com</td>
<td>kube-controller-manager</td>
<td>10.0.0.22</td>
</tr>
</tbody>
</table>
</blockquote>
<hr>
<p>在<code>10.0.0.21</code>、<code>10.0.0.22</code>上创建<code>kube-scheduler</code>启动脚本</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">vim /opt/kubernetes/server/bin/kube-scheduler.sh
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e">#!/bin/bash
</span><span style="color:#75715e"></span>./kube-scheduler <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>	--leader-elect <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>	--log-dir /data/logs/kubernetes/kube-scheduler <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>	--master http://127.0.0.1:8080 <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>	--v <span style="color:#ae81ff">2</span>
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">chmod +x /opt/kubernetes/server/bin/kube-scheduler.sh
</code></pre></div><hr>
<p>创建kube-scheduler启动脚本中的相关文件目录</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">mkdir -p /data/logs/kubernetes/kube-scheduler
</code></pre></div><hr>
<p>在<code>10.0.0.21</code>、<code>10.0.0.22</code>上的<code>supervisor</code>中创建<code>kube-scheduler</code>的启动配置文件</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">vim /etc/supervisord.d/kube-scheduler.ini
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#f92672">[</span>program:kube-scheduler-0-21<span style="color:#f92672">]</span>
command<span style="color:#f92672">=</span>/opt/kubernetes/server/bin/kube-scheduler.sh
numprocs<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>
directory<span style="color:#f92672">=</span>/opt/kubernetes/server/bin
autostart<span style="color:#f92672">=</span>true
autorestart<span style="color:#f92672">=</span>true
startsecs<span style="color:#f92672">=</span><span style="color:#ae81ff">30</span>
startretries<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>
exitcodes<span style="color:#f92672">=</span>0,2
stopsignal<span style="color:#f92672">=</span>QUIT
stopwaitsecs<span style="color:#f92672">=</span><span style="color:#ae81ff">10</span>
user<span style="color:#f92672">=</span>root
redirect_stderr<span style="color:#f92672">=</span>true
stdout_logfile<span style="color:#f92672">=</span>/data/logs/kubernetes/kube-controller-manager/kube-scheduler.stdout.log
stdout_logfile_maxbytes<span style="color:#f92672">=</span>64MB
stdout_logfile_backups<span style="color:#f92672">=</span><span style="color:#ae81ff">4</span>
stdout_capture_maxbytes<span style="color:#f92672">=</span>1MB
stdout_events_enabled<span style="color:#f92672">=</span>false
</code></pre></div><hr>
<p>在<code>10.0.0.21</code>、<code>10.0.0.22</code>上通过<code>supervisor</code>启动<code>kube-scheduler</code>，并检查启动状态</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">supervisorctl update
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">supervisorctl status
</code></pre></div><hr>
<h4 id="检查集群健康状态">
  检查集群健康状态
  <a class="anchor" href="#%e6%a3%80%e6%9f%a5%e9%9b%86%e7%be%a4%e5%81%a5%e5%ba%b7%e7%8a%b6%e6%80%81">#</a>
</h4>
<hr>
<p>将<code>kubectl</code>添加到环境变量中</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">ln -s /opt/kubernetes/server/bin/kubectl /usr/bin/kubectl
</code></pre></div><hr>
<p>检查集群的健康状态</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl get cs
</code></pre></div><hr>
<h3 id="部署计算node节点服务">
  部署计算（Node）节点服务
  <a class="anchor" href="#%e9%83%a8%e7%bd%b2%e8%ae%a1%e7%ae%97node%e8%8a%82%e7%82%b9%e6%9c%8d%e5%8a%a1">#</a>
</h3>
<hr>
<h4 id="部署kubelet集群">
  部署kubelet集群
  <a class="anchor" href="#%e9%83%a8%e7%bd%b2kubelet%e9%9b%86%e7%be%a4">#</a>
</h4>
<hr>
<blockquote>
<p>集群规划</p>
<table>
<thead>
<tr>
<th>主机名</th>
<th>角色</th>
<th>IP地址</th>
</tr>
</thead>
<tbody>
<tr>
<td>host-0-21.host.com</td>
<td>kubelet</td>
<td>10.0.0.21</td>
</tr>
<tr>
<td>host-0-22.host.com</td>
<td>kubelet</td>
<td>10.0.0.22</td>
</tr>
</tbody>
</table>
</blockquote>
<hr>
<p>在<code>10.0.0.200</code>上制作签发<code>kubelet</code>证书的JSON请求文件</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">vim /opt/certs/kubelet-csr.json
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
	<span style="color:#f92672">&#34;CN&#34;</span>: <span style="color:#e6db74">&#34;k8s-kubelet&#34;</span>,
	<span style="color:#f92672">&#34;hosts&#34;</span>: [
		<span style="color:#e6db74">&#34;127.0.0.1&#34;</span>,
		<span style="color:#e6db74">&#34;10.0.0.10&#34;</span>,
		<span style="color:#e6db74">&#34;10.0.0.11&#34;</span>,
		<span style="color:#e6db74">&#34;10.0.0.12&#34;</span>,
		<span style="color:#e6db74">&#34;10.0.0.21&#34;</span>,
		<span style="color:#e6db74">&#34;10.0.0.22&#34;</span>,
		<span style="color:#e6db74">&#34;10.0.0.23&#34;</span>,
		<span style="color:#e6db74">&#34;10.0.0.24&#34;</span>,
		<span style="color:#e6db74">&#34;10.0.0.25&#34;</span>,
		<span style="color:#e6db74">&#34;10.0.0.26&#34;</span>,
		<span style="color:#e6db74">&#34;10.0.0.27&#34;</span>,
		<span style="color:#e6db74">&#34;10.0.0.28&#34;</span>,
		<span style="color:#e6db74">&#34;10.0.0.29&#34;</span>
	],
	<span style="color:#f92672">&#34;key&#34;</span>: {
		<span style="color:#f92672">&#34;algo&#34;</span>: <span style="color:#e6db74">&#34;rsa&#34;</span>,
		<span style="color:#f92672">&#34;size&#34;</span>: <span style="color:#ae81ff">2048</span>
	},
	<span style="color:#f92672">&#34;names&#34;</span>: [
		{
			<span style="color:#f92672">&#34;C&#34;</span>: <span style="color:#e6db74">&#34;CN&#34;</span>,
			<span style="color:#f92672">&#34;ST&#34;</span>: <span style="color:#e6db74">&#34;beijing&#34;</span>,
			<span style="color:#f92672">&#34;L&#34;</span>: <span style="color:#e6db74">&#34;beijing&#34;</span>,
			<span style="color:#f92672">&#34;O&#34;</span>: <span style="color:#e6db74">&#34;k8s&#34;</span>,
			<span style="color:#f92672">&#34;OU&#34;</span>: <span style="color:#e6db74">&#34;ops&#34;</span>
		}
	]
}
</code></pre></div><hr>
<p>在<code>10.0.0.200</code>签发<code>kubelet</code>证书和私钥（其他组件与<code>kebelet</code>通信时的证书）</p>
<pre tabindex="0"><code>cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=server kubelet-csr.json | cfssl-json -bare kubelet
</code></pre><hr>
<p>在<code>10.0.0.200</code>上检查签发的证书和私钥</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">ls -l | grep kubelet
</code></pre></div><hr>
<p>在<code>10.0.0.21</code>、<code>10.0.0.22</code>上拷贝<code>10.0.0.200</code>签发的kubelet证书和私钥（分发证书）</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">scp root@10.0.0.200:/opt/certs/kubelet.pem /opt/kubernetes/server/bin/certs/
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">scp root@10.0.0.200:/opt/certs/kubelet-key.pem /opt/kubernetes/server/bin/certs/
</code></pre></div><hr>
<p>在<code>10.0.0.21</code>上为<code>kubelet</code>创建配置文件</p>
<blockquote>
<p><code>kubeconfig</code>文件是一个K8S用户的配置文件，它里面包含证书信息，证书过期或更换，需要同步替换该文件</p>
</blockquote>
<ul>
<li>
<p>set-cluster</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">cd /opt/kubernetes/server/bin/conf
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># 直接执行如下命令：</span>
kubectl config set-cluster myk8s <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>--certificate-authority<span style="color:#f92672">=</span>/opt/kubernetes/server/bin/certs/ca.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>--embed-certs<span style="color:#f92672">=</span>true <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>--server<span style="color:#f92672">=</span>https://10.0.0.10:7443 <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>--kubeconfig<span style="color:#f92672">=</span>kubelet.kubeconfig

<span style="color:#75715e"># 输出结果：Cluster &#34;myk8s&#34; set.</span>
</code></pre></div></li>
<li>
<p>set-credentials</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">cd /opt/kubernetes/server/bin/conf
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># 直接执行如下命令：</span>
kubectl config set-credentials k8s-node <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>--client-certificate<span style="color:#f92672">=</span>/opt/kubernetes/server/bin/certs/apiserver-to-etcd.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>--client-key<span style="color:#f92672">=</span>/opt/kubernetes/server/bin/certs/apiserver-to-etcd-key.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>--embed-certs<span style="color:#f92672">=</span>true <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>--kubeconfig<span style="color:#f92672">=</span>kubelet.kubeconfig

<span style="color:#75715e"># 输出结果：User &#34;k8s-node&#34; set.</span>
</code></pre></div></li>
<li>
<p>set-contest</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">cd /opt/kubernetes/server/bin/conf
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># 直接执行如下命令：</span>
kubectl config set-context myk8s-context <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>--cluster<span style="color:#f92672">=</span>myk8s <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>--user<span style="color:#f92672">=</span>k8s-node <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>--kubeconfig<span style="color:#f92672">=</span>kubelet.kubeconfig

<span style="color:#75715e"># 输出结果：Context &#34;myk8s-context&#34; created.</span>
</code></pre></div></li>
<li>
<p>use-context</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">cd /opt/kubernetes/server/bin/conf
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># 直接执行如下命令：</span>
kubectl config use-context myk8s-context --kubeconfig<span style="color:#f92672">=</span>kubelet.kubeconfig

<span style="color:#75715e"># 输出结果：Switched to context &#34;myk8s-context&#34;.</span>
</code></pre></div></li>
</ul>
<hr>
<p>在<code>10.0.0.21</code>上RBAC建权，角色绑定</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">vim /opt/kubernetes/server/bin/conf/k8s-node.yaml
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io/v1</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ClusterRoleBinding</span>
<span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">k8s-node</span>
<span style="color:#f92672">roleRef</span>:
  <span style="color:#f92672">apiGroup</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io</span>
  <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ClusterRole</span>
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">system:node</span>
<span style="color:#f92672">subjects</span>:
- <span style="color:#f92672">apiGroup</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io</span>
  <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">User</span>
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">k8s-node</span>
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># 应用资源配置文件</span>
kubectl create -f k8s-node.yaml

<span style="color:#75715e"># 输出结果：clusterrolebinding.rbac.authorization.k8s.io/k8s-node created</span>
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># 检查应用资源配置</span>
kubectl get clusterrolebinding k8s-node
</code></pre></div><hr>
<p>在<code>10.0.0.22</code>上，拷贝<code>10.0.0.21</code>上的<code>kubelet.kubeconfig</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">scp root@10.0.0.21:/opt/kubernetes/server/bin/conf/kubelet.kubeconfig /opt/kubernetes/server/bin/conf/
</code></pre></div><hr>
<p>在<code>10.0.0.21</code>、<code>10.0.0.22</code>上验证<code>kubelet.kubeconfig</code>的MD5值</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">md5sum /opt/kubernetes/server/bin/conf/kubelet.kubeconfig
</code></pre></div><hr>
<p>在<code>10.0.0.200</code>上准备pause基础镜像</p>
<blockquote>
<p>在kubernetes的Pod启动时，pause的容器最先启动，然后才启动其他业务容器。</p>
<p>在Kubernetes中，pause容器主要负责：</p>
<ul>
<li>pause容器创建的命名空间作为基础，与pod中的其他容器共享</li>
<li>pause容器在PID namespace中是PID为1的init进程，也是Pod中其他容器的父进程，负责回收pod内的僵尸子进程</li>
</ul>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">docker pull kubernetes/pause
</code></pre></div><hr>
<p>将<code>10.0.0.200</code>上的pause基础镜像提交至私有仓库（harbor）中</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">docker tag f9d5de079539 harbor.k8s.com/public/pause:latest
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">docker login harbor.k8s.com
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">docker push harbor.k8s.com/public/pause:latest
</code></pre></div><hr>
<p>在<code>10.0.0.21</code>、<code>10.0.0.22</code>上创建<code>kubelet</code>启动脚本</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">vim /opt/kubernetes/server/bin/kubelet.sh
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e">#!/bin/bash
</span><span style="color:#75715e"></span>./kubelet <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --anonymous-auth<span style="color:#f92672">=</span>false <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --cgroup-driver systemd <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --cluster-dns 192.168.0.2 <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --cluster-domain cluster.local <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --runtime-cgroups<span style="color:#f92672">=</span>/systemd/system.slice <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --kubelet-cgroups<span style="color:#f92672">=</span>/systemd/system.slice <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --fail-swap-on<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;false&#34;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --client-ca-file ./certs/ca.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --tls-cert-file ./certs/kubelet.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --tls-private-key-file ./certs/kubelet-key.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --hostname-override host-0-21.host.com <span style="color:#ae81ff">\ </span>   <span style="color:#75715e"># 根据不同主机进行修改</span>
  --image-gc-high-threshold <span style="color:#ae81ff">20</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --image-gc-low-threshold <span style="color:#ae81ff">10</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --kubeconfig ./conf/kubelet.kubeconfig <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --log-dir /data/logs/kubernetes/kube-kubelet <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --pod-infra-container-image harbor.k8s.com/public/pause:latest <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --root-dir /data/kubelet
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">chmod +x /opt/kubernetes/server/bin/kubelet.sh
</code></pre></div><hr>
<p>在<code>10.0.0.21</code>、<code>10.0.0.22</code>上创建<code>kubelet</code>启动脚本所需要的目录</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">mkdir -p /data/logs/kubernetes/kube-kubelet /data/kubelet
</code></pre></div><hr>
<p>在<code>10.0.0.21</code>、<code>10.0.0.22</code>上的<code>supervisor</code>中创建<code>kubelet</code>的启动配置文件</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">vim /etc/supervisord.d/kube-kubelet.ini
</code></pre></div><pre tabindex="0"><code>[program:kube-kubelet-0-21]    # 根据不同主机进行修改
command=/opt/kubernetes/server/bin/kubelet.sh
numprocs=1
directory=/opt/kubernetes/server/bin
autostart=true
autorestart=true
startsecs=30
startretries=3
exitcodes=0,2
stopsignal=QUIT
stopwaitsecs=10
user=root
redirect_stderr=true
stdout_logfile=/data/logs/kubernetes/kube-kubelet/kube-kubelet.stdout.log
stdout_logfile_maxbytes=64MB
stdout_logfile_backups=4
stdout_capture_maxbytes=1MB
stdout_events_enabled=false
</code></pre><hr>
<p>在<code>10.0.0.21</code>、<code>10.0.0.22</code>上通过<code>supervisor</code>启动<code>kubelet</code>，并检查启动状态</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">supervisorctl update
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">supervisorctl status
</code></pre></div><hr>
<p>在<code>10.0.0.21</code>、<code>10.0.0.22</code>上检查<code>Node</code>节点是否加入到集群</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl get nodes
</code></pre></div><hr>
<p>在<code>10.0.0.21</code>、<code>10.0.0.22</code>上给<code>Node</code>打<code>tag</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl label node host-0-21.host.com node-role.kubernetes.io/master<span style="color:#f92672">=</span>
</code></pre></div><pre tabindex="0"><code>kubectl label node host-0-21.host.com node-role.kubernetes.io/node=
</code></pre><hr>
<h4 id="部署kube-proxy集群">
  部署kube-proxy集群
  <a class="anchor" href="#%e9%83%a8%e7%bd%b2kube-proxy%e9%9b%86%e7%be%a4">#</a>
</h4>
<hr>
<blockquote>
<p>集群规划</p>
<table>
<thead>
<tr>
<th>主机名</th>
<th>角色</th>
<th>IP地址</th>
</tr>
</thead>
<tbody>
<tr>
<td>host-0-21.host.com</td>
<td>kube-proxy</td>
<td>10.0.0.21</td>
</tr>
<tr>
<td>Host-0-22.host.com</td>
<td>Kube-proxy</td>
<td>10.0.0.22</td>
</tr>
</tbody>
</table>
</blockquote>
<hr>
<p>在<code>10.0.0.200</code>上制作签发<code>kube-proxy</code>证书的JSON请求文件</p>
<pre tabindex="0"><code>vim /opt/certs/kube-proxy-client-csr.json
</code></pre><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
    <span style="color:#f92672">&#34;CN&#34;</span>: <span style="color:#e6db74">&#34;system:kube-proxy&#34;</span>,
    <span style="color:#f92672">&#34;key&#34;</span>: {
        <span style="color:#f92672">&#34;algo&#34;</span>: <span style="color:#e6db74">&#34;rsa&#34;</span>,
        <span style="color:#f92672">&#34;size&#34;</span>: <span style="color:#ae81ff">2048</span>
    },
    <span style="color:#f92672">&#34;names&#34;</span>: [
        {
            <span style="color:#f92672">&#34;C&#34;</span>: <span style="color:#e6db74">&#34;CN&#34;</span>,
            <span style="color:#f92672">&#34;ST&#34;</span>: <span style="color:#e6db74">&#34;beijing&#34;</span>,
            <span style="color:#f92672">&#34;L&#34;</span>: <span style="color:#e6db74">&#34;beijing&#34;</span>,
            <span style="color:#f92672">&#34;O&#34;</span>: <span style="color:#e6db74">&#34;od&#34;</span>,
            <span style="color:#f92672">&#34;OU&#34;</span>: <span style="color:#e6db74">&#34;ops&#34;</span>
        }
    ]
}
</code></pre></div><hr>
<p>在<code>10.0.0.200</code>签发<code>kube-proxy</code>证书和私钥（<code>kube-proxy</code>的client证书与其他client证书不通用）</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">cfssl gencert -ca<span style="color:#f92672">=</span>ca.pem -ca-key<span style="color:#f92672">=</span>ca-key.pem -config<span style="color:#f92672">=</span>ca-config.json -profile<span style="color:#f92672">=</span>client kube-proxy-client-csr.json |cfssl-json -bare kube-proxy-client
</code></pre></div><hr>
<p>在<code>10.0.0.200</code>上检查签发的证书和私钥</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">ls -l | grep kube-proxy
</code></pre></div><hr>
<p>在<code>10.0.0.21</code>、<code>10.0.0.22</code>上拷贝<code>10.0.0.200</code>签发的kubelet证书和私钥（分发证书）</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">scp root@10.0.0.200:/opt/certs/kube-proxy-client.pem /opt/kubernetes/server/bin/certs/
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">scp root@10.0.0.200:/opt/certs/kube-proxy-client-key.pem /opt/kubernetes/server/bin/certs/
</code></pre></div><hr>
<p>在<code>10.0.0.21</code>上为<code>kube-proxy</code>创建配置文件</p>
<ul>
<li>
<p>set-cluster</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">cd /opt/kubernetes/server/bin/conf
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl config set-cluster myk8s <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --certificate-authority<span style="color:#f92672">=</span>/opt/kubernetes/server/bin/certs/ca.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --embed-certs<span style="color:#f92672">=</span>true <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --server<span style="color:#f92672">=</span>https://10.0.0.10:7443 <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --kubeconfig<span style="color:#f92672">=</span>kube-proxy.kubeconfig
</code></pre></div></li>
<li>
<p>set-credentials</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">cd /opt/kubernetes/server/bin/conf
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl config set-credentials kube-proxy <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --client-certificate<span style="color:#f92672">=</span>/opt/kubernetes/server/bin/certs/kube-proxy-client.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --client-key<span style="color:#f92672">=</span>/opt/kubernetes/server/bin/certs/kube-proxy-client-key.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --embed-certs<span style="color:#f92672">=</span>true <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --kubeconfig<span style="color:#f92672">=</span>kube-proxy.kubeconfig
</code></pre></div></li>
<li>
<p>set-contest</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">cd /opt/kubernetes/server/bin/conf
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl config set-context myk8s-context <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --cluster<span style="color:#f92672">=</span>myk8s <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --user<span style="color:#f92672">=</span>kube-proxy <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --kubeconfig<span style="color:#f92672">=</span>kube-proxy.kubeconfig
</code></pre></div></li>
<li>
<p>use-context（kubeconfig是k8s用户的配置文件）</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl config use-context myk8s-context --kubeconfig<span style="color:#f92672">=</span>kube-proxy.kubeconfig
</code></pre></div></li>
</ul>
<hr>
<p>在<code>10.0.0.22</code>上，拷贝<code>10.0.0.21</code>上的<code>kube-proxy.kubeconfig</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">scp root@10.0.0.21:/opt/kubernetes/server/bin/conf/kube-proxy.kubeconfig /opt/kubernetes/server/bin/conf/
</code></pre></div><hr>
<p>在<code>10.0.0.21</code>、<code>10.0.0.22</code>上制作加载ipvs模块的脚本</p>
<pre tabindex="0"><code>vim /root/ipvs.sh
</code></pre><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e">#!/bin/bash
</span><span style="color:#75715e"></span>ipvs_mods_dir<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/usr/lib/modules/</span><span style="color:#66d9ef">$(</span>uname -r<span style="color:#66d9ef">)</span><span style="color:#e6db74">/kernel/net/netfilter/ipvs&#34;</span>
<span style="color:#66d9ef">for</span> i in <span style="color:#66d9ef">$(</span>ls $ipvs_mods_dir|grep -o <span style="color:#e6db74">&#34;^[^.]*&#34;</span><span style="color:#66d9ef">)</span>
<span style="color:#66d9ef">do</span>
  /sbin/modinfo -F filename $i &amp;&gt;/dev/null
  <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> $? -eq <span style="color:#ae81ff">0</span> <span style="color:#f92672">]</span>;<span style="color:#66d9ef">then</span>
    /sbin/modprobe $i
  <span style="color:#66d9ef">fi</span>
<span style="color:#66d9ef">done</span>
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">chmod +x /root/ipvs.sh 
</code></pre></div><hr>
<p>在<code>10.0.0.21</code>、<code>10.0.0.22</code>上加载ipvs模块</p>
<pre tabindex="0"><code>bash /root/ipvs.sh
</code></pre><hr>
<p>在<code>10.0.0.21</code>、<code>10.0.0.22</code>上验证模块加载是否成功</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">lsmod | grep ip_vs
</code></pre></div><hr>
<p>在<code>10.0.0.21</code>、<code>10.0.0.22</code>上创建<code>kube-proxy</code>启动脚本</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">vim /opt/kubernetes/server/bin/kube-proxy.sh
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e">#!/bin/sh
</span><span style="color:#75715e"></span>./kube-proxy <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --cluster-cidr 172.16.0.0/16 <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --hostname-override host-0-21.host.com <span style="color:#ae81ff">\ </span>   <span style="color:#75715e"># 根据不同主机进行修改</span>
  --proxy-mode<span style="color:#f92672">=</span>ipvs <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --ipvs-scheduler<span style="color:#f92672">=</span>nq <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --kubeconfig ./conf/kube-proxy.kubeconfig
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">chmod +x /opt/kubernetes/server/bin/kube-proxy.sh
</code></pre></div><hr>
<p>在<code>10.0.0.21</code>、<code>10.0.0.22</code>上的<code>supervisor</code>中创建<code>kubelet</code>的启动配置文件</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">vim /etc/supervisord.d/kube-proxy.ini
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#f92672">[</span>program:kube-proxy-0-21<span style="color:#f92672">]</span>
command<span style="color:#f92672">=</span>/opt/kubernetes/server/bin/kube-proxy.sh    ; the program <span style="color:#f92672">(</span>relative uses PATH, can take args<span style="color:#f92672">)</span>
numprocs<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>                                          ; number of processes copies to start <span style="color:#f92672">(</span>def 1<span style="color:#f92672">)</span>
directory<span style="color:#f92672">=</span>/opt/kubernetes/server/bin                ; directory to cwd to before exec <span style="color:#f92672">(</span>def no cwd<span style="color:#f92672">)</span>
autostart<span style="color:#f92672">=</span>true                                      ; start at supervisord start <span style="color:#f92672">(</span>default: true<span style="color:#f92672">)</span>
autorestart<span style="color:#f92672">=</span>true                                    ; retstart at unexpected quit <span style="color:#f92672">(</span>default: true<span style="color:#f92672">)</span>
startsecs<span style="color:#f92672">=</span><span style="color:#ae81ff">30</span>                                        ; number of secs prog must stay running <span style="color:#f92672">(</span>def. 1<span style="color:#f92672">)</span>
startretries<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>                                      ; max <span style="color:#75715e"># of serial start failures (default 3)</span>
exitcodes<span style="color:#f92672">=</span>0,2                                       ; <span style="color:#e6db74">&#39;expected&#39;</span> exit codes <span style="color:#66d9ef">for</span> process <span style="color:#f92672">(</span>default 0,2<span style="color:#f92672">)</span>
stopsignal<span style="color:#f92672">=</span>QUIT                                     ; signal used to kill process <span style="color:#f92672">(</span>default TERM<span style="color:#f92672">)</span>
stopwaitsecs<span style="color:#f92672">=</span><span style="color:#ae81ff">10</span>                                     ; max num secs to wait b4 SIGKILL <span style="color:#f92672">(</span>default 10<span style="color:#f92672">)</span>
user<span style="color:#f92672">=</span>root                                           ; setuid to this UNIX account to run the program
redirect_stderr<span style="color:#f92672">=</span>true                                ; redirect proc stderr to stdout <span style="color:#f92672">(</span>default false<span style="color:#f92672">)</span>
stdout_logfile<span style="color:#f92672">=</span>/data/logs/kubernetes/kube-proxy/proxy.stdout.log     ; stderr log path, NONE <span style="color:#66d9ef">for</span> none; default AUTO
stdout_logfile_maxbytes<span style="color:#f92672">=</span>64MB                        ; max <span style="color:#75715e"># logfile bytes b4 rotation (default 50MB)</span>
stdout_logfile_backups<span style="color:#f92672">=</span><span style="color:#ae81ff">4</span>                            ; <span style="color:#75715e"># of stdout logfile backups (default 10)</span>
stdout_capture_maxbytes<span style="color:#f92672">=</span>1MB                         ; number of bytes in <span style="color:#e6db74">&#39;capturemode&#39;</span> <span style="color:#f92672">(</span>default 0<span style="color:#f92672">)</span>
stdout_events_enabled<span style="color:#f92672">=</span>false                         ; emit events on stdout writes <span style="color:#f92672">(</span>default false<span style="color:#f92672">)</span>
</code></pre></div><hr>
<p>在<code>10.0.0.21</code>、<code>10.0.0.22</code>上创建<code>kube-proxy</code>启动脚本所需要的目录</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">mkdir -p /data/logs/kubernetes/kube-proxy
</code></pre></div><hr>
<p>在<code>10.0.0.21</code>、<code>10.0.0.22</code>上通过<code>supervisor</code>启动<code>kubelet</code>，并检查启动状态</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">supervisorctl update
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">supervisorctl status
</code></pre></div><hr>
<p>在<code>10.0.0.21</code>、<code>10.0.0.22</code>上安装<code>ipvsadm</code>（此步骤可跳过）</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">yum install -y ipvsadm
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">ipvsadm -Ln
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl get svc
</code></pre></div><hr>
<h3 id="验证kubenetes集群">
  验证Kubenetes集群
  <a class="anchor" href="#%e9%aa%8c%e8%af%81kubenetes%e9%9b%86%e7%be%a4">#</a>
</h3>
<hr>
<p>在任意一个计算（Node）节点上，创建一个资源配置清单</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">vim /root/nginx-ds.yaml
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">DaemonSet</span>
<span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx-ds</span>
  <span style="color:#f92672">labels</span>:
    <span style="color:#f92672">app</span>: <span style="color:#ae81ff">nginx-ds</span>
<span style="color:#f92672">spec</span>:
  <span style="color:#f92672">selector</span>:
    <span style="color:#f92672">matchLabels</span>:
      <span style="color:#f92672">app</span>: <span style="color:#ae81ff">nginx-ds</span>
  <span style="color:#f92672">template</span>:
    <span style="color:#f92672">metadata</span>:
      <span style="color:#f92672">labels</span>:
        <span style="color:#f92672">app</span>: <span style="color:#ae81ff">nginx-ds</span>
    <span style="color:#f92672">spec</span>:
      <span style="color:#f92672">containers</span>:
      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">my-nginx</span>
        <span style="color:#f92672">image</span>: <span style="color:#ae81ff">harbor.od.com/public/nginx:v1.7.9</span>
        <span style="color:#f92672">ports</span>:
        - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">80</span>
</code></pre></div><hr>
<p>应用资源配置并检查</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl create -f /root/nginx-ds.yaml
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl get pods 
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl get pods -o wide
</code></pre></div><hr>
<h3 id="部署cni网络插件flannel">
  部署CNI网络插件（Flannel）
  <a class="anchor" href="#%e9%83%a8%e7%bd%b2cni%e7%bd%91%e7%bb%9c%e6%8f%92%e4%bb%b6flannel">#</a>
</h3>
<hr>
<blockquote>
<p>
  <a href="https://github.com/coreos/flannel/releases">https://github.com/coreos/flannel/releases</a></p>
<p>集群规划</p>
<table>
<thead>
<tr>
<th>主机名</th>
<th>角色</th>
<th>IP地址</th>
</tr>
</thead>
<tbody>
<tr>
<td>host-0-21.host.com</td>
<td>flannel</td>
<td>10.0.0.21</td>
</tr>
<tr>
<td>host-0-22.host.com</td>
<td>flannel</td>
<td>10.0.0.22</td>
</tr>
</tbody>
</table>
</blockquote>
<hr>
<p>在<code>10.0.0.21</code>、<code>10.0.0.22</code>上，下载<code>flannel</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">wget https://github.com/coreos/flannel/releases/download/v0.11.0/flannel-v0.11.0-linux-amd64.tar.gz -P /opt/installed
</code></pre></div><hr>
<p>在<code>10.0.0.21</code>、<code>10.0.0.22</code>上，解压<code>flannel</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">mkdir /opt/flannel-v0.11.0
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">tar -zxvf /opt/installed/flannel-v0.11.0-linux-amd64.tar.gz -C /opt/flannel-v0.11.0/
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">ln -s /opt/flannel-v0.11.0/ /opt/flannel
</code></pre></div><hr>
<p>在<code>10.0.0.21</code>、<code>10.0.0.22</code>上，创建证书目录</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"> mkdir /opt/flannel/certs
</code></pre></div><hr>
<p>在<code>10.0.0.21</code>、<code>10.0.0.22</code>上，将<code>10.0.0.200</code>上的<code>apiserver</code>访问<code>etcd</code>的客户端证书拷贝至本地</p>
<blockquote>
<p><code>flannel</code>默认使用<code>etcd</code>进行存储和配置，而<code>flannel</code>不能直接访问<code>etcd</code>，需要通过<code>apiserver</code>与<code>etcd</code>进行通讯，因此需要拷贝<code>apiserver</code>访问<code>etcd</code>的客户端证书。</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">scp root@10.0.0.200:/opt/certs/ca.pem /opt/flannel/certs
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">scp root@10.0.0.200:/opt/certs/apiserver-to-etcd.pem /opt/flannel/certs
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">scp root@10.0.0.200:/opt/certs/apiserver-to-etcd-key.pem /opt/flannel/certs
</code></pre></div><hr>
<p>在<code>10.0.0.21</code>、<code>10.0.0.22</code>上，编辑<code>flannel</code>环境变量<code>env</code>文件</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">vim /opt/flannel/subnet.env
</code></pre></div><pre tabindex="0"><code>FLANNEL_NETWORK=172.16.0.0/16
FLANNEL_SUBNET=172.16.21.1/24    # 注意根据不同主机修改不同IP
FLANNEL_MTU=1500
FLANNEL_IPMASQ=false
</code></pre><hr>
<p>在<code>10.0.0.21</code>、<code>10.0.0.22</code>上，创建启动脚本</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">vim /opt/flannel/flanneld.sh
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e">#!/bin/bash
</span><span style="color:#75715e"></span>./flanneld <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --public-ip<span style="color:#f92672">=</span>10.0.0.21 <span style="color:#ae81ff">\ </span>   <span style="color:#75715e"># 注意根据不同主机修改不同IP地址</span>
  --etcd-endpoints<span style="color:#f92672">=</span>https://10.0.0.12:2379,https://10.0.0.21:2379,https://10.0.0.22:2379 <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --etcd-keyfile<span style="color:#f92672">=</span>./certs/apiserver-to-etcd-key.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --etcd-certfile<span style="color:#f92672">=</span>./certs/apiserver-to-etcd.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --etcd-cafile<span style="color:#f92672">=</span>./certs/ca.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --iface<span style="color:#f92672">=</span>ens33 <span style="color:#ae81ff">\ </span>   <span style="color:#75715e"># 注意根据实际网卡名称填写</span>
  --subnet-file<span style="color:#f92672">=</span>./subnet.env <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --healthz-port<span style="color:#f92672">=</span><span style="color:#ae81ff">2401</span>
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">chmod +x /opt/flannel/flanneld.sh
</code></pre></div><hr>
<p>在<code>10.0.0.21</code>、<code>10.0.0.22</code>上的etcd中，增加<code>host-gw</code>模型的网络配置信息</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">/opt/etcd/etcdctl set /coreos.com/network/config <span style="color:#e6db74">&#39;{&#34;Network&#34;: &#34;172.16.0.0/16&#34;, &#34;Backend&#34;: {&#34;Type&#34;: &#34;host-gw&#34;}}&#39;</span>
</code></pre></div><blockquote>
<p><code>host-gw</code>模型（添加静态路由）适用在宿主机在同一网段的局域网中。</p>
<p><code>flannel</code>的其他网络模型：</p>
<ul>
<li>
<p><code>VxLAN</code>模型</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">/opt/etcd/etcdctl set /coreos.com/network/config  <span style="color:#e6db74">&#39;{&#34;Network&#34;: &#34;172.16.0.0/16&#34;, &#34;Backend&#34;: {&#34;Type&#34;: &#34;vxlan&#34;}}&#39;</span>
</code></pre></div></li>
<li>
<p><code>host-gw</code>与<code>VxLAN</code>混合模型（根据实际情况自动选择<code>host-gw</code>或<code>VxLAN</code>模型）</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">/opt/etcd/etcdctl set /coreos.com/network/config  <span style="color:#e6db74">&#39;{&#34;Network&#34;: &#34;172.7.0.0/16&#34;, &#34;Backend&#34;: {&#34;Type&#34;: &#34;vxlan&#34;,&#34;Directrouting&#34;: true}}&#39;</span>
</code></pre></div></li>
</ul>
</blockquote>
<hr>
<p>在<code>10.0.0.21</code>、<code>10.0.0.22</code>上的etcd中，查看网络配置信息</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">/opt/etcd/etcdctl get /coreos.com/network/config
</code></pre></div><hr>
<p>在<code>10.0.0.21</code>、<code>10.0.0.22</code>上的<code>supervisor</code>中，创建<code>flannel</code>的启动配置文件</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">vim /etc/supervisord.d/flannel.ini
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ini" data-lang="ini"><span style="color:#a6e22e">[program:flanneld-0-21]    # 注意根据不同主机IP进行更改</span>
<span style="color:#a6e22e">command</span><span style="color:#f92672">=</span><span style="color:#e6db74">/opt/flannel/flanneld.sh        ; the program (relative uses PATH, can take args)</span>
<span style="color:#a6e22e">numprocs</span><span style="color:#f92672">=</span><span style="color:#e6db74">1                              ; number of processes copies to start (def 1)</span>
<span style="color:#a6e22e">directory</span><span style="color:#f92672">=</span><span style="color:#e6db74">/opt/flannel                  ; directory to cwd to before exec (def no cwd)</span>
<span style="color:#a6e22e">autostart</span><span style="color:#f92672">=</span><span style="color:#e6db74">true                          ; start at supervisord start (default: true)</span>
<span style="color:#a6e22e">autorestart</span><span style="color:#f92672">=</span><span style="color:#e6db74">true                        ; retstart at unexpected quit (default: true)</span>
<span style="color:#a6e22e">startsecs</span><span style="color:#f92672">=</span><span style="color:#e6db74">30                            ; number of secs prog must stay running (def. 1)</span>
<span style="color:#a6e22e">startretries</span><span style="color:#f92672">=</span><span style="color:#e6db74">3                          ; max # of serial start failures (default 3)</span>
<span style="color:#a6e22e">exitcodes</span><span style="color:#f92672">=</span><span style="color:#e6db74">0,2                           ; &#39;expected&#39; exit codes for process (default 0,2)</span>
<span style="color:#a6e22e">stopsignal</span><span style="color:#f92672">=</span><span style="color:#e6db74">QUIT                         ; signal used to kill process (default TERM)</span>
<span style="color:#a6e22e">stopwaitsecs</span><span style="color:#f92672">=</span><span style="color:#e6db74">10                         ; max num secs to wait b4 SIGKILL (default 10)</span>
<span style="color:#a6e22e">user</span><span style="color:#f92672">=</span><span style="color:#e6db74">root                               ; setuid to this UNIX account to run the program</span>
<span style="color:#a6e22e">redirect_stderr</span><span style="color:#f92672">=</span><span style="color:#e6db74">true                    ; redirect proc stderr to stdout (default false)</span>
<span style="color:#a6e22e">stdout_logfile</span><span style="color:#f92672">=</span><span style="color:#e6db74">/data/logs/flanneld/flanneld.stdout.log    ; stderr log path, NONE for none; default AUTO</span>
<span style="color:#a6e22e">stdout_logfile_maxbytes</span><span style="color:#f92672">=</span><span style="color:#e6db74">64MB            ; max # logfile bytes b4 rotation (default 50MB)</span>
<span style="color:#a6e22e">stdout_logfile_backups</span><span style="color:#f92672">=</span><span style="color:#e6db74">4                ; # of stdout logfile backups (default 10)</span>
<span style="color:#a6e22e">stdout_capture_maxbytes</span><span style="color:#f92672">=</span><span style="color:#e6db74">1MB             ; number of bytes in &#39;capturemode&#39; (default 0)</span>
<span style="color:#a6e22e">stdout_events_enabled</span><span style="color:#f92672">=</span><span style="color:#e6db74">false             ; emit events on stdout writes (default false)</span>
</code></pre></div><hr>
<p>在<code>10.0.0.21</code>、<code>10.0.0.22</code>上的<code>supervisor</code>中，创建<code>flannel</code>的启动配置中所需要的文件目录</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">mkdir /data/logs/flanneld/
</code></pre></div><hr>
<p>在<code>10.0.0.21</code>、<code>10.0.0.22</code>上，通过<code>supervisor</code>启动<code>flannel</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">supervisorctl update
</code></pre></div><hr>
<p>在<code>10.0.0.21</code>、<code>10.0.0.22</code>上，优化<code>iptables</code>的<code>SNAT</code>规则</p>
<blockquote>
<p>由于在同一<code>node</code>访问容器时，访问记录是<code>node</code>节点的IP地址：10.0.0.x，而不是pod集群内部IP地址：172.16.21.x，我们不希望在相同的node节点中的容器之间相互访问经过node节点网卡，因此，需要优化<code>iptables</code>的<code>SNAT</code>规则</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># 安装iptables-services</span>
yum install -y iptables-services

<span style="color:#75715e"># 启动iptables并设置开机自动启动</span>
systemctl start iptables <span style="color:#f92672">&amp;&amp;</span> systemctl enable iptables

<span style="color:#75715e"># 删除默认的规则（所有不是从docker0出来的流量，均被NAT转换）</span>
iptables -t nat -D POSTROUTING -s 172.16.21.0/24 ! -o docker0 -j MASQUERADE

<span style="color:#75715e"># 添加新规则（所有目标地址不是172.16.0.0/16和不是从docker0出来的流量，均被NAT转换）</span>
iptables -t nat -I POSTROUTING -s 172.16.21.0/24 ! -d 172.16.0.0/16 ! -o docker0 -j MASQUERADE

<span style="color:#75715e"># 删除入口过滤规则</span>
iptables -t filter -D INPUT -j REJECT --reject-with icmp-host-prohibited

<span style="color:#75715e"># 删除出口过滤规则</span>
iptables -t filter -D FORWARD -j REJECT --reject-with icmp-host-prohibited

<span style="color:#75715e"># 检查规则是否生效</span>
iptables-save | grep -i postrouting

<span style="color:#75715e"># 保存当前规则</span>
iptables-save &gt; /etc/iptables_save
</code></pre></div><hr>
<p>在<code>10.0.0.21</code>、<code>10.0.0.22</code>上，重启Docker</p>
<blockquote>
<p>修改宿主机上的<code>iptables</code>后会影响到<code>docker</code>原本的<code>iptables</code>链的规则，所以需要重启<code>docker</code>服务</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">systemctl restart docker
</code></pre></div><hr>
<h3 id="部署服务发现插件coredns">
  部署服务发现插件（CoreDNS）
  <a class="anchor" href="#%e9%83%a8%e7%bd%b2%e6%9c%8d%e5%8a%a1%e5%8f%91%e7%8e%b0%e6%8f%92%e4%bb%b6coredns">#</a>
</h3>
<hr>
<h4 id="部署k8s内网资源http服务">
  部署K8S内网资源HTTP服务
  <a class="anchor" href="#%e9%83%a8%e7%bd%b2k8s%e5%86%85%e7%bd%91%e8%b5%84%e6%ba%90http%e6%9c%8d%e5%8a%a1">#</a>
</h4>
<hr>
<blockquote>
<p>在运维主机<code>10.0.0.200</code>上，配置一个<code>Nginx</code>虚拟主机，用以提供Kubernetes统一的资源配置清单访问入口</p>
</blockquote>
<hr>
<p>在<code>10.0.0.200</code>上，配置<code>Nginx</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">vim /etc/nginx/conf.d/k8s-yaml.k8s.com.conf
</code></pre></div><pre tabindex="0"><code>server {
    listen    80;
    server_name   k8s-yaml.k8s.com;
    
    location / {
        autoindex on;
        default_type text/plain;
        root /data/k8s-yaml;
    }
}
</code></pre><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">mkdir /data/k8s-yaml
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">nginx -t
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">nginx -s reload
</code></pre></div><hr>
<p>在<code>10.0.0.11</code>上，添加<code>k8s-yaml.k8s.com</code>与<code>10.0.0.200</code>的地址解析</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">vim /var/named/k8s.com.zone
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ORIGIN k8s.com.
$TTL <span style="color:#ae81ff">60</span>        ; <span style="color:#ae81ff">1</span> minutes
@            IN    SOA    dns.k8s.com. dnsadmin.k8s.com. <span style="color:#f92672">(</span>
                                                    <span style="color:#ae81ff">2020010103</span> ; serial
                                                    <span style="color:#ae81ff">10800</span>      ; refresh <span style="color:#f92672">(</span><span style="color:#ae81ff">3</span> hours<span style="color:#f92672">)</span>
                                                    <span style="color:#ae81ff">900</span>        ; retry <span style="color:#f92672">(</span><span style="color:#ae81ff">15</span> minutes<span style="color:#f92672">)</span>
                                                    <span style="color:#ae81ff">604800</span>     ; expire <span style="color:#f92672">(</span><span style="color:#ae81ff">1</span> week<span style="color:#f92672">)</span>
                                                    <span style="color:#ae81ff">86400</span>      ; minimum <span style="color:#f92672">(</span><span style="color:#ae81ff">1</span> day<span style="color:#f92672">)</span>
                                                    <span style="color:#f92672">)</span>
             NS          dns.k8s.com.
dns          A           10.0.0.11
harbor       A           10.0.0.200
k8s-yaml     A           10.0.0.200
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">systemctl restart named
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">dig -t A k8s-yaml.k8s.com @10.0.0.11 +short
</code></pre></div><hr>
<h4 id="部署coredns">
  部署CoreDNS
  <a class="anchor" href="#%e9%83%a8%e7%bd%b2coredns">#</a>
</h4>
<hr>
<blockquote>
<p>官网：https://coredns.io</p>
<p>GitHub：https://github.com/coredns/coredns</p>
<p>Docker Hub：https://hub.docker.com/r/coredns/coredns/tags</p>
<p>接下来部署CoreDNS，就不再用之前的二进制安装的方式进行了，我们会用容器的方式向Kubernetes交付CoreDNS。</p>
</blockquote>
<hr>
<p>在<code>10.0.0.200</code>上，创建<code>CoreDNS</code>的目录</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">mkdir /data/k8s-yaml/coredns
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">cd /data/k8s-yaml/coredns
</code></pre></div><hr>
<p>在<code>10.0.0.200</code>上，从<code>Docker Hub</code>上拉取<code>CoreDNS</code>镜像</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">docker pull coredns/coredns:1.7.0
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">docker images | grep coredns
</code></pre></div><hr>
<p>在<code>10.0.0.200</code>上，给从<code>Docker Hub</code>上拉取<code>CoreDNS</code>镜像打<code>tag</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">docker tag bfe3a36ebd25 harbor.k8s.com/public/coredns:v1.7.0
</code></pre></div><hr>
<p>在<code>10.0.0.200</code>上，将<code>coredns:v1.7.0</code>镜像推送到harbor私有镜像仓库中</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">docker login harbor.k8s.com
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">docker push harbor.k8s.com/public/coredns:v1.7.0
</code></pre></div><hr>
<p>在<code>10.0.0.200</code>上，创建<code>CoreDNS</code>的资源配置清单</p>
<blockquote>
<p>CoreDNS资源配置清单模板：</p>
<p>
  <a href="https://github.com/kubernetes/kubernetes/blob/master/cluster/addons/dns/coredns/coredns.yaml.base">https://github.com/kubernetes/kubernetes/blob/master/cluster/addons/dns/coredns/coredns.yaml.base</a></p>
<p>官方把配置清单写在了一起，我们把配置清单做个分类，使用起来更清晰</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">vim /data/k8s-yaml/coredns/rbac.yaml
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ServiceAccount</span>
<span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">coredns</span>
  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">kube-system</span>
  <span style="color:#f92672">labels</span>:
      <span style="color:#f92672">kubernetes.io/cluster-service</span>: <span style="color:#e6db74">&#34;true&#34;</span>
      <span style="color:#f92672">addonmanager.kubernetes.io/mode</span>: <span style="color:#ae81ff">Reconcile</span>
---
<span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io/v1</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ClusterRole</span>
<span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">labels</span>:
    <span style="color:#f92672">kubernetes.io/bootstrapping</span>: <span style="color:#ae81ff">rbac-defaults</span>
    <span style="color:#f92672">addonmanager.kubernetes.io/mode</span>: <span style="color:#ae81ff">Reconcile</span>
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">system:coredns</span>
<span style="color:#f92672">rules</span>:
- <span style="color:#f92672">apiGroups</span>:
  - <span style="color:#e6db74">&#34;&#34;</span>
  <span style="color:#f92672">resources</span>:
  - <span style="color:#ae81ff">endpoints</span>
  - <span style="color:#ae81ff">services</span>
  - <span style="color:#ae81ff">pods</span>
  - <span style="color:#ae81ff">namespaces</span>
  <span style="color:#f92672">verbs</span>:
  - <span style="color:#ae81ff">list</span>
  - <span style="color:#ae81ff">watch</span>
---
<span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io/v1</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ClusterRoleBinding</span>
<span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">annotations</span>:
    <span style="color:#f92672">rbac.authorization.kubernetes.io/autoupdate</span>: <span style="color:#e6db74">&#34;true&#34;</span>
  <span style="color:#f92672">labels</span>:
    <span style="color:#f92672">kubernetes.io/bootstrapping</span>: <span style="color:#ae81ff">rbac-defaults</span>
    <span style="color:#f92672">addonmanager.kubernetes.io/mode</span>: <span style="color:#ae81ff">EnsureExists</span>
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">system:coredns</span>
<span style="color:#f92672">roleRef</span>:
  <span style="color:#f92672">apiGroup</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io</span>
  <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ClusterRole</span>
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">system:coredns</span>
<span style="color:#f92672">subjects</span>:
- <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ServiceAccount</span>
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">coredns</span>
  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">kube-system</span>
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">vim /data/k8s-yaml/coredns/ConfigMap.yaml
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ConfigMap</span>
<span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">coredns</span>
  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">kube-system</span>
<span style="color:#f92672">data</span>:
  <span style="color:#f92672">Corefile</span>: |<span style="color:#e6db74">
</span><span style="color:#e6db74">    .:53 {
</span><span style="color:#e6db74">        errors
</span><span style="color:#e6db74">        log
</span><span style="color:#e6db74">        health
</span><span style="color:#e6db74">        ready
</span><span style="color:#e6db74">        kubernetes cluster.local 192.168.0.0/16
</span><span style="color:#e6db74">        forward . 10.0.0.11
</span><span style="color:#e6db74">        cache 30
</span><span style="color:#e6db74">        loop
</span><span style="color:#e6db74">        reload
</span><span style="color:#e6db74">        loadbalance
</span><span style="color:#e6db74">       }</span>    
</code></pre></div><blockquote>
<p>kubernetes cluster.local 192.168.0.0/16：Cluster网段（该网段就是service ip地址范围）</p>
<p>forward . 10.4.7.11：制定上级dns服务器地址</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">vim /data/k8s-yaml/coredns/Deployment.yaml
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Deployment</span>
<span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">coredns</span>
  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">kube-system</span>
  <span style="color:#f92672">labels</span>:
    <span style="color:#f92672">k8s-app</span>: <span style="color:#ae81ff">coredns</span>
    <span style="color:#f92672">kubernetes.io/name</span>: <span style="color:#e6db74">&#34;CoreDNS&#34;</span>
<span style="color:#f92672">spec</span>:
  <span style="color:#f92672">replicas</span>: <span style="color:#ae81ff">1</span>
  <span style="color:#f92672">selector</span>:
    <span style="color:#f92672">matchLabels</span>:
      <span style="color:#f92672">k8s-app</span>: <span style="color:#ae81ff">coredns</span>
  <span style="color:#f92672">template</span>:
    <span style="color:#f92672">metadata</span>:
      <span style="color:#f92672">labels</span>:
        <span style="color:#f92672">k8s-app</span>: <span style="color:#ae81ff">coredns</span>
    <span style="color:#f92672">spec</span>:
      <span style="color:#f92672">priorityClassName</span>: <span style="color:#ae81ff">system-cluster-critical</span>
      <span style="color:#f92672">serviceAccountName</span>: <span style="color:#ae81ff">coredns</span>
      <span style="color:#f92672">containers</span>:
      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">coredns</span>
        <span style="color:#f92672">image</span>: <span style="color:#ae81ff">harbor.k8s.com/public/coredns:v1.7.0</span>
        <span style="color:#f92672">args</span>:
        - -<span style="color:#ae81ff">conf</span>
        - <span style="color:#ae81ff">/etc/coredns/Corefile</span>
        <span style="color:#f92672">volumeMounts</span>:
        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">config-volume</span>
          <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/etc/coredns</span>
        <span style="color:#f92672">ports</span>:
        - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">53</span>
          <span style="color:#f92672">name</span>: <span style="color:#ae81ff">dns</span>
          <span style="color:#f92672">protocol</span>: <span style="color:#ae81ff">UDP</span>
        - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">53</span>
          <span style="color:#f92672">name</span>: <span style="color:#ae81ff">dns-tcp</span>
          <span style="color:#f92672">protocol</span>: <span style="color:#ae81ff">TCP</span>
        - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">9153</span>
          <span style="color:#f92672">name</span>: <span style="color:#ae81ff">metrics</span>
          <span style="color:#f92672">protocol</span>: <span style="color:#ae81ff">TCP</span>
        <span style="color:#f92672">livenessProbe</span>:
          <span style="color:#f92672">httpGet</span>:
            <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/health</span>
            <span style="color:#f92672">port</span>: <span style="color:#ae81ff">8080</span>
            <span style="color:#f92672">scheme</span>: <span style="color:#ae81ff">HTTP</span>
          <span style="color:#f92672">initialDelaySeconds</span>: <span style="color:#ae81ff">60</span>
          <span style="color:#f92672">timeoutSeconds</span>: <span style="color:#ae81ff">5</span>
          <span style="color:#f92672">successThreshold</span>: <span style="color:#ae81ff">1</span>
          <span style="color:#f92672">failureThreshold</span>: <span style="color:#ae81ff">5</span>
      <span style="color:#f92672">dnsPolicy</span>: <span style="color:#ae81ff">Default</span>
      <span style="color:#f92672">volumes</span>:
        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">config-volume</span>
          <span style="color:#f92672">configMap</span>:
            <span style="color:#f92672">name</span>: <span style="color:#ae81ff">coredns</span>
            <span style="color:#f92672">items</span>:
            - <span style="color:#f92672">key</span>: <span style="color:#ae81ff">Corefile</span>
              <span style="color:#f92672">path</span>: <span style="color:#ae81ff">Corefile</span>
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">vim /data/k8s-yaml/coredns/Service.yaml
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Service</span>
<span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">coredns</span>
  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">kube-system</span>
  <span style="color:#f92672">labels</span>:
    <span style="color:#f92672">k8s-app</span>: <span style="color:#ae81ff">coredns</span>
    <span style="color:#f92672">kubernetes.io/cluster-service</span>: <span style="color:#e6db74">&#34;true&#34;</span>
    <span style="color:#f92672">kubernetes.io/name</span>: <span style="color:#e6db74">&#34;CoreDNS&#34;</span>
<span style="color:#f92672">spec</span>:
  <span style="color:#f92672">selector</span>:
    <span style="color:#f92672">k8s-app</span>: <span style="color:#ae81ff">coredns</span>
  <span style="color:#f92672">clusterIP</span>: <span style="color:#ae81ff">192.168.0.2</span>
  <span style="color:#f92672">ports</span>:
  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">dns</span>
    <span style="color:#f92672">port</span>: <span style="color:#ae81ff">53</span>
    <span style="color:#f92672">protocol</span>: <span style="color:#ae81ff">UDP</span>
  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">dns-tcp</span>
    <span style="color:#f92672">port</span>: <span style="color:#ae81ff">53</span>
  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">metrics</span>
    <span style="color:#f92672">port</span>: <span style="color:#ae81ff">9153</span>
    <span style="color:#f92672">protocol</span>: <span style="color:#ae81ff">TCP</span>
</code></pre></div><blockquote>
<p><code>clusterIP: 192.168.0.2</code> 指定了<code>coredns</code>的server cluster ip地址（必须要和<code>kubelet</code>的<code>--cluster-dns ip</code>一致）</p>
</blockquote>
<hr>
<p>在<code>10.0.0.21</code>上，应用<code>10.0.0.200</code>创建的<code>CoreDNS</code>资源配置清单</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl apply -f http://k8s-yaml.k8s.com/coredns/rbac.yaml
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl apply -f http://k8s-yaml.k8s.com/coredns/ConfigMap.yaml
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl apply -f http://k8s-yaml.k8s.com/coredns/Deployment.yaml
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl apply -f http://k8s-yaml.k8s.com/coredns/Service.yaml
</code></pre></div><hr>
<p>在<code>kube-system</code>的名称空间下，查看根据<code>CoreDNS</code>资源配置清单创建的<code>pod</code>和<code>service</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl get pods -n kube-system
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">ubectl get svc -n kube-system
</code></pre></div><hr>
<p>检测<code>CoreDNS</code>解析是否正常</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">dig -t A host-0-200.host.com @192.168.0.2 +short
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">dig -t A www.badiu.com @192.168.0.2 +short
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">dig -t A nginx-dp.kube-public.svc.cluster.local @192.168.0.2 +short
</code></pre></div><hr>
<p>Kubernetes的DNS实现了服务在集群内被自动发现，那如何使得服务在kubernetes集群外被使用和访问呢？</p>
<ul>
<li>
<p>使用NodePort的Service</p>
<p>注意：无法使用kube-proxy的ipvs模型，只能使用iptables模型</p>
</li>
<li>
<p>使用Ingress的Service（生产上推荐用Ingress）</p>
<p>注意：Ingress只能调度并暴露7层协议的应用，特指http和https</p>
</li>
</ul>
<hr>
<h3 id="部署服务暴露插件ingress">
  部署服务暴露插件（Ingress）
  <a class="anchor" href="#%e9%83%a8%e7%bd%b2%e6%9c%8d%e5%8a%a1%e6%9a%b4%e9%9c%b2%e6%8f%92%e4%bb%b6ingress">#</a>
</h3>
<hr>
<h4 id="部署ingress">
  部署Ingress
  <a class="anchor" href="#%e9%83%a8%e7%bd%b2ingress">#</a>
</h4>
<hr>
<p>在<code>10.0.0.200</code>上，创建<code>Traefik</code>的目录</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">mkdir /data/k8s-yaml/traefik
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">cd /data/k8s-yaml/traefik
</code></pre></div><hr>
<p>在<code>10.0.0.200</code>上，从<code>Docker Hub</code>上拉取<code>Traefik</code>镜像</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">docker pull traefik:v1.7.2-alpine
</code></pre></div><pre tabindex="0"><code>docker images | grep traefik
</code></pre><hr>
<p>在<code>10.0.0.200</code>上，给从<code>Docker Hub</code>上拉取<code>Traefik</code>镜像打tag</p>
<pre tabindex="0"><code>docker tag add5fac61ae5 harbor.k8s.com/public/traefik:v1.7.2
</code></pre><hr>
<p>在<code>10.0.0.200</code>上，将<code>traefik:v1.7.2</code>镜像推送到harbor私有镜像仓库中</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">docker login harbor.k8s.com
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">docker push harbor.k8s.com/public/traefik:v1.7.2
</code></pre></div><hr>
<p>在<code>10.0.0.200</code>上，创建<code>Traefik</code>的资源配置清单</p>
<blockquote>
<p>Traefik资源配置清单模板：</p>
<p>
  <a href="https://github.com/containous/traefik/tree/v1.7/examples/k8s">https://github.com/containous/traefik/tree/v1.7/examples/k8s</a></p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">vim /data/k8s-yaml/traefik/rbac.yaml
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ServiceAccount</span>
<span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">traefik-ingress-controller</span>
  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">kube-system</span>
---
<span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io/v1beta1</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ClusterRole</span>
<span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">traefik-ingress-controller</span>
<span style="color:#f92672">rules</span>:
  - <span style="color:#f92672">apiGroups</span>:
      - <span style="color:#e6db74">&#34;&#34;</span>
    <span style="color:#f92672">resources</span>:
      - <span style="color:#ae81ff">services</span>
      - <span style="color:#ae81ff">endpoints</span>
      - <span style="color:#ae81ff">secrets</span>
    <span style="color:#f92672">verbs</span>:
      - <span style="color:#ae81ff">get</span>
      - <span style="color:#ae81ff">list</span>
      - <span style="color:#ae81ff">watch</span>
  - <span style="color:#f92672">apiGroups</span>:
      - <span style="color:#ae81ff">extensions</span>
    <span style="color:#f92672">resources</span>:
      - <span style="color:#ae81ff">ingresses</span>
    <span style="color:#f92672">verbs</span>:
      - <span style="color:#ae81ff">get</span>
      - <span style="color:#ae81ff">list</span>
      - <span style="color:#ae81ff">watch</span>
---
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ClusterRoleBinding</span>
<span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io/v1beta1</span>
<span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">traefik-ingress-controller</span>
<span style="color:#f92672">roleRef</span>:
  <span style="color:#f92672">apiGroup</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io</span>
  <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ClusterRole</span>
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">traefik-ingress-controller</span>
<span style="color:#f92672">subjects</span>:
- <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ServiceAccount</span>
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">traefik-ingress-controller</span>
  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">kube-system</span>
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">vim /data/k8s-yaml/traefik/DaemonSet.yaml
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">extensions/v1beta1</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">DaemonSet</span>
<span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">traefik-ingress</span>
  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">kube-system</span>
  <span style="color:#f92672">labels</span>:
    <span style="color:#f92672">k8s-app</span>: <span style="color:#ae81ff">traefik-ingress</span>
<span style="color:#f92672">spec</span>:
  <span style="color:#f92672">template</span>:
    <span style="color:#f92672">metadata</span>:
      <span style="color:#f92672">labels</span>:
        <span style="color:#f92672">k8s-app</span>: <span style="color:#ae81ff">traefik-ingress</span>
        <span style="color:#f92672">name</span>: <span style="color:#ae81ff">traefik-ingress</span>
    <span style="color:#f92672">spec</span>:
      <span style="color:#f92672">serviceAccountName</span>: <span style="color:#ae81ff">traefik-ingress-controller</span>
      <span style="color:#f92672">terminationGracePeriodSeconds</span>: <span style="color:#ae81ff">60</span>
      <span style="color:#f92672">containers</span>:
      - <span style="color:#f92672">image</span>: <span style="color:#ae81ff">harbor.k8s.com/public/traefik:v1.7.2</span>
        <span style="color:#f92672">name</span>: <span style="color:#ae81ff">traefik-ingress</span>
        <span style="color:#f92672">ports</span>:
        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">controller</span>
          <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">80</span>
          <span style="color:#f92672">hostPort</span>: <span style="color:#ae81ff">81</span>
        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">admin-web</span>
          <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">8080</span>
        <span style="color:#f92672">securityContext</span>:
          <span style="color:#f92672">capabilities</span>:
            <span style="color:#f92672">drop</span>:
            - <span style="color:#ae81ff">ALL</span>
            <span style="color:#f92672">add</span>:
            - <span style="color:#ae81ff">NET_BIND_SERVICE</span>
        <span style="color:#f92672">args</span>:
        - --<span style="color:#ae81ff">api</span>
        - --<span style="color:#ae81ff">kubernetes</span>
        - --<span style="color:#ae81ff">logLevel=INFO</span>
        - --<span style="color:#ae81ff">insecureskipverify=true</span>
        - --<span style="color:#ae81ff">kubernetes.endpoint=https://10.0.0.10:7443</span>
        - --<span style="color:#ae81ff">accesslog</span>
        - --<span style="color:#ae81ff">accesslog.filepath=/var/log/traefik_access.log</span>
        - --<span style="color:#ae81ff">traefiklog</span>
        - --<span style="color:#ae81ff">traefiklog.filepath=/var/log/traefik.log</span>
        - --<span style="color:#ae81ff">metrics.prometheus</span>
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">vi /data/k8s-yaml/traefik/Service.yaml
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Service</span>
<span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
<span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">traefik-ingress-service</span>
  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">kube-system</span>
<span style="color:#f92672">spec</span>:
  <span style="color:#f92672">selector</span>:
    <span style="color:#f92672">k8s-app</span>: <span style="color:#ae81ff">traefik-ingress</span>
  <span style="color:#f92672">ports</span>:
    - <span style="color:#f92672">protocol</span>: <span style="color:#ae81ff">TCP</span>
      <span style="color:#f92672">port</span>: <span style="color:#ae81ff">80</span>
      <span style="color:#f92672">name</span>: <span style="color:#ae81ff">controller</span>
    - <span style="color:#f92672">protocol</span>: <span style="color:#ae81ff">TCP</span>
      <span style="color:#f92672">port</span>: <span style="color:#ae81ff">8080</span>
      <span style="color:#f92672">name</span>: <span style="color:#ae81ff">admin-web</span>
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">vim /data/k8s-yaml/traefik/Ingress.yaml
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">extensions/v1beta1</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Ingress</span>
<span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">traefik-web-ui</span>
  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">kube-system</span>
  <span style="color:#f92672">annotations</span>:
    <span style="color:#f92672">kubernetes.io/ingress.class</span>: <span style="color:#ae81ff">traefik</span>
<span style="color:#f92672">spec</span>:
  <span style="color:#f92672">rules</span>:
  - <span style="color:#f92672">host</span>: <span style="color:#ae81ff">traefik.k8s.com</span>
    <span style="color:#f92672">http</span>:
      <span style="color:#f92672">paths</span>:
      - <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/</span>
        <span style="color:#f92672">backend</span>:
          <span style="color:#f92672">serviceName</span>: <span style="color:#ae81ff">traefik-ingress-service</span>
          <span style="color:#f92672">servicePort</span>: <span style="color:#ae81ff">8080</span>
</code></pre></div><hr>
<p>在<code>10.0.0.21</code>上，应用<code>10.0.0.200</code>创建的<code>Traefik</code>资源配置清单</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl create -f http://k8s-yaml.k8s.com/traefik/rbac.yaml
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl create -f http://k8s-yaml.k8s.com/traefik/DaemonSet.yaml
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl create -f http://k8s-yaml.k8s.com/traefik/Service.yaml
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl create -f http://k8s-yaml.k8s.com/traefik/Ingress.yaml
</code></pre></div><hr>
<p>在<code>kube-system</code>的名称空间下，查看根据<code>Treafik</code>资源配置清单创建的<code>pod</code>和<code>service</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl get pods -n kube-system
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl get svc -n kube-system
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl get ingress -n kube-system
</code></pre></div><hr>
<p>在<code>10.0.0.11</code>上，添加<code>treafik</code>与<code>10.0.0.10</code>的地址解析</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">vim /var/named/k8s.com.zone
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ORIGIN k8s.com.
$TTL <span style="color:#ae81ff">60</span>        ; <span style="color:#ae81ff">1</span> minutes
@            IN    SOA    dns.k8s.com. dnsadmin.k8s.com. <span style="color:#f92672">(</span>
                                                    <span style="color:#ae81ff">2020010104</span> ; serial
                                                    <span style="color:#ae81ff">10800</span>      ; refresh <span style="color:#f92672">(</span><span style="color:#ae81ff">3</span> hours<span style="color:#f92672">)</span>
                                                    <span style="color:#ae81ff">900</span>        ; retry <span style="color:#f92672">(</span><span style="color:#ae81ff">15</span> minutes<span style="color:#f92672">)</span>
                                                    <span style="color:#ae81ff">604800</span>     ; expire <span style="color:#f92672">(</span><span style="color:#ae81ff">1</span> week<span style="color:#f92672">)</span>
                                                    <span style="color:#ae81ff">86400</span>      ; minimum <span style="color:#f92672">(</span><span style="color:#ae81ff">1</span> day<span style="color:#f92672">)</span>
                                                    <span style="color:#f92672">)</span>
             NS          dns.k8s.com.
dns          A           10.0.0.11
harbor       A           10.0.0.200
k8s-yaml     A           10.0.0.200
traefik      A           10.0.0.10
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">systemctl restart named
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">dig -t A traefik.k8s.com @10.0.0.11 +short
</code></pre></div><hr>
<p>在<code>10.0.0.11</code>和<code>10.0.0.12</code>上，配置反向代理（可以使用ansible进行统一配置管理）</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">vim /etc/nginx/conf.d/k8s.com.conf
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">upstream default_backend_traefik <span style="color:#f92672">{</span>
    server 10.0.0.21:81    max_fails<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span> fail_timeout<span style="color:#f92672">=</span>10s;
    server 10.0.0.22:81    max_fails<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span> fail_timeout<span style="color:#f92672">=</span>10s;
<span style="color:#f92672">}</span>
server <span style="color:#f92672">{</span>
    server_name *.k8s.com;
  
    location / <span style="color:#f92672">{</span>
        proxy_pass http://default_backend_traefik;
        proxy_set_header Host       $http_host;
        proxy_set_header x-forwarded-for $proxy_add_x_forwarded_for;
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">nginx -t
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">nginx -s reload
</code></pre></div><hr>
<p>在集群外访问http://traefik.k8s.com，测试是否可以正常访问</p>
<hr>
<h3 id="部署gui资源管理插件仪表盘">
  部署GUI资源管理插件（仪表盘）
  <a class="anchor" href="#%e9%83%a8%e7%bd%b2gui%e8%b5%84%e6%ba%90%e7%ae%a1%e7%90%86%e6%8f%92%e4%bb%b6%e4%bb%aa%e8%a1%a8%e7%9b%98">#</a>
</h3>
<hr>
<h4 id="部署kubernetes-dashboard">
  部署Kubernetes-dashboard
  <a class="anchor" href="#%e9%83%a8%e7%bd%b2kubernetes-dashboard">#</a>
</h4>
<hr>
<blockquote>
<p>Github：https://github.com/kubernetes/dashboard</p>
</blockquote>
<hr>
<p>在<code>10.0.0.200</code>上，创建<code>Dashboard</code>的目录</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">mkdir /data/k8s-yaml/dashboard
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">cd /data/k8s-yaml/dashboard
</code></pre></div><hr>
<p>在10.0.0.200上，从<code>Docker Hub</code>上拉取<code>Kubernetes-dashboard</code>镜像</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">docker pull kubernetesui/dashboard:v2.0.3
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">docker images | grep dashboard
</code></pre></div><hr>
<p>在<code>10.0.0.200</code>上，给从<code>Docker Hub</code>上拉取<code>Kubernetes-dashboard</code>镜像打tag</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">docker tag 503bc4b7440b harbor.k8s.com/public/dashboard:v2.0.3
</code></pre></div><hr>
<p>在<code>10.0.0.200</code>上，将<code>dashboard:v1.8.3</code>镜像推送到harbor私有镜像仓库中</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">docker login harbor.k8s.com
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">docker push harbor.k8s.com/public/dashboard:v2.0.3
</code></pre></div><hr>
<p>在<code>10.0.0.200</code>上，创建<code>Dashboard</code>的资源配置清单</p>
<blockquote>
<p>Dashboard资源配置清单模板：</p>
<p>
  <a href="https://github.com/kubernetes/kubernetes/tree/master/cluster/addons/dashboard">https://github.com/kubernetes/kubernetes/tree/master/cluster/addons/dashboard</a></p>
</blockquote>
<hr>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">vim /data/k8s-yaml/dashboard/rbac.yaml
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ServiceAccount</span>
<span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">labels</span>:
    <span style="color:#f92672">k8s-app</span>: <span style="color:#ae81ff">kubernetes-dashboard</span>
    <span style="color:#f92672">addonmanager.kubernetes.io/mode</span>: <span style="color:#ae81ff">Reconcile</span>
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">kubernetes-dashboard-admin</span>
  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">kube-system</span>
---
<span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io/v1</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ClusterRoleBinding</span>
<span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">kubernetes-dashboard-admin</span>
  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">kube-system</span>
  <span style="color:#f92672">labels</span>:
    <span style="color:#f92672">k8s-app</span>: <span style="color:#ae81ff">kubernetes-dashboard</span>
    <span style="color:#f92672">addonmanager.kubernetes.io/mode</span>: <span style="color:#ae81ff">Reconcile</span>
<span style="color:#f92672">roleRef</span>:
  <span style="color:#f92672">apiGroup</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io</span>
  <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ClusterRole</span>
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">cluster-admin</span>
<span style="color:#f92672">subjects</span>:
- <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ServiceAccount</span>
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">kubernetes-dashboard-admin</span>
  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">kube-system</span>
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">vim /data/k8s-yaml/dashboard/Deployment.yaml
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Deployment</span>
<span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">kubernetes-dashboard</span>
  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">kube-system</span>
  <span style="color:#f92672">labels</span>:
    <span style="color:#f92672">k8s-app</span>: <span style="color:#ae81ff">kubernetes-dashboard</span>
    <span style="color:#f92672">kubernetes.io/cluster-service</span>: <span style="color:#e6db74">&#34;true&#34;</span>
    <span style="color:#f92672">addonmanager.kubernetes.io/mode</span>: <span style="color:#ae81ff">Reconcile</span>
<span style="color:#f92672">spec</span>:
  <span style="color:#f92672">selector</span>:
    <span style="color:#f92672">matchLabels</span>:
      <span style="color:#f92672">k8s-app</span>: <span style="color:#ae81ff">kubernetes-dashboard</span>
  <span style="color:#f92672">template</span>:
    <span style="color:#f92672">metadata</span>:
      <span style="color:#f92672">labels</span>:
        <span style="color:#f92672">k8s-app</span>: <span style="color:#ae81ff">kubernetes-dashboard</span>
      <span style="color:#f92672">annotations</span>:
        <span style="color:#f92672">scheduler.alpha.kubernetes.io/critical-pod</span>: <span style="color:#e6db74">&#39;&#39;</span>
    <span style="color:#f92672">spec</span>:
      <span style="color:#f92672">priorityClassName</span>: <span style="color:#ae81ff">system-cluster-critical</span>
      <span style="color:#f92672">containers</span>:
      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">kubernetes-dashboard</span>
        <span style="color:#f92672">image</span>: <span style="color:#ae81ff">harbor.k8s.com/public/dashboard:v2.0.3</span>
        <span style="color:#f92672">resources</span>:
          <span style="color:#f92672">limits</span>:
            <span style="color:#f92672">cpu</span>: <span style="color:#ae81ff">100m</span>
            <span style="color:#f92672">memory</span>: <span style="color:#ae81ff">300Mi</span>
          <span style="color:#f92672">requests</span>:
            <span style="color:#f92672">cpu</span>: <span style="color:#ae81ff">50m</span>
            <span style="color:#f92672">memory</span>: <span style="color:#ae81ff">100Mi</span>
        <span style="color:#f92672">ports</span>:
        - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">8443</span>
          <span style="color:#f92672">protocol</span>: <span style="color:#ae81ff">TCP</span>
        <span style="color:#f92672">args</span>:
          <span style="color:#75715e"># PLATFORM-SPECIFIC ARGS HERE</span>
          - --<span style="color:#ae81ff">auto-generate-certificates</span>
        <span style="color:#f92672">volumeMounts</span>:
        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">tmp-volume</span>
          <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/tmp</span>
        <span style="color:#f92672">livenessProbe</span>:
          <span style="color:#f92672">httpGet</span>:
            <span style="color:#f92672">scheme</span>: <span style="color:#ae81ff">HTTPS</span>
            <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/</span>
            <span style="color:#f92672">port</span>: <span style="color:#ae81ff">8443</span>
          <span style="color:#f92672">initialDelaySeconds</span>: <span style="color:#ae81ff">30</span>
          <span style="color:#f92672">timeoutSeconds</span>: <span style="color:#ae81ff">30</span>
      <span style="color:#f92672">volumes</span>:
      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">tmp-volume</span>
        <span style="color:#f92672">emptyDir</span>: {}
      <span style="color:#f92672">serviceAccountName</span>: <span style="color:#ae81ff">kubernetes-dashboard-admin</span>
      <span style="color:#f92672">tolerations</span>:
      - <span style="color:#f92672">key</span>: <span style="color:#e6db74">&#34;CriticalAddonsOnly&#34;</span>
        <span style="color:#f92672">operator</span>: <span style="color:#e6db74">&#34;Exists&#34;</span>
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">vim /data/k8s-yaml/dashboard/Service.yaml
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Service</span>
<span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">kubernetes-dashboard</span>
  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">kube-system</span>
  <span style="color:#f92672">labels</span>:
    <span style="color:#f92672">k8s-app</span>: <span style="color:#ae81ff">kubernetes-dashboard</span>
    <span style="color:#f92672">kubernetes.io/cluster-service</span>: <span style="color:#e6db74">&#34;true&#34;</span>
    <span style="color:#f92672">addonmanager.kubernetes.io/mode</span>: <span style="color:#ae81ff">Reconcile</span>
<span style="color:#f92672">spec</span>:
  <span style="color:#f92672">selector</span>:
    <span style="color:#f92672">k8s-app</span>: <span style="color:#ae81ff">kubernetes-dashboard</span>
  <span style="color:#f92672">ports</span>:
  - <span style="color:#f92672">port</span>: <span style="color:#ae81ff">443</span>
    <span style="color:#f92672">targetPort</span>: <span style="color:#ae81ff">8443</span>
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">vim /data/k8s-yaml/dashboard/Ingress.yaml
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">extensions/v1beta1</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Ingress</span>
<span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">kubernetes-dashboard</span>
  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">kube-system</span>
  <span style="color:#f92672">annotations</span>:
    <span style="color:#f92672">kubernetes.io/ingress.class</span>: <span style="color:#ae81ff">traefik</span>
<span style="color:#f92672">spec</span>:
  <span style="color:#f92672">rules</span>:
  - <span style="color:#f92672">host</span>: <span style="color:#ae81ff">dashboard.k8s.com</span>
    <span style="color:#f92672">http</span>:
      <span style="color:#f92672">paths</span>:
      - <span style="color:#f92672">backend</span>:
          <span style="color:#f92672">serviceName</span>: <span style="color:#ae81ff">kubernetes-dashboard</span>
          <span style="color:#f92672">servicePort</span>: <span style="color:#ae81ff">443</span>
</code></pre></div><hr>
<p>在<code>10.0.0.21</code>上，应用<code>10.0.0.200</code>创建的<code>Dashboard</code>资源配置清单</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl create -f http://k8s-yaml.k8s.com/dashboard/rbac.yaml
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl create -f http://k8s-yaml.k8s.com/dashboard/Deployment.yaml
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl create -f http://k8s-yaml.k8s.com/dashboard/Service.yaml
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl create -f http://k8s-yaml.k8s.com/dashboard/Ingress.yaml
</code></pre></div><hr>
<p>在<code>kube-system</code>的名称空间下，查看根据<code>Dashboard</code>资源配置清单创建的<code>pod</code>、<code>service</code>和<code>ingress</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl get pods -n kube-system
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl get svc -n kube-system
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl get ingress -n kube-system
</code></pre></div><hr>
<p>在<code>10.0.0.11</code>上，添加<code>dashboard</code>与<code>10.0.0.10</code>的地址解析</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">vim /var/named/k8s.com.zone
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ORIGIN k8s.com.
$TTL <span style="color:#ae81ff">60</span>        ; <span style="color:#ae81ff">1</span> minutes
@            IN    SOA    dns.k8s.com. dnsadmin.k8s.com. <span style="color:#f92672">(</span>
                                                    <span style="color:#ae81ff">2020010105</span> ; serial
                                                    <span style="color:#ae81ff">10800</span>      ; refresh <span style="color:#f92672">(</span><span style="color:#ae81ff">3</span> hours<span style="color:#f92672">)</span>
                                                    <span style="color:#ae81ff">900</span>        ; retry <span style="color:#f92672">(</span><span style="color:#ae81ff">15</span> minutes<span style="color:#f92672">)</span>
                                                    <span style="color:#ae81ff">604800</span>     ; expire <span style="color:#f92672">(</span><span style="color:#ae81ff">1</span> week<span style="color:#f92672">)</span>
                                                    <span style="color:#ae81ff">86400</span>      ; minimum <span style="color:#f92672">(</span><span style="color:#ae81ff">1</span> day<span style="color:#f92672">)</span>
                                                    <span style="color:#f92672">)</span>
             NS          dns.k8s.com.
dns          A           10.0.0.11
harbor       A           10.0.0.200
k8s-yaml     A           10.0.0.200
traefik      A           10.0.0.10
dashboard    A           10.0.0.10
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">systemctl restart named
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">dig -t A dashboard.k8s.com @10.0.0.11 +short
</code></pre></div><hr>
<p>在集群外访问http://dashboard.k8s.com，测试是否可以正常访问</p>
<hr>
<h4 id="使用openssl签发dashbord证书">
  使用OpenSSL签发Dashbord证书
  <a class="anchor" href="#%e4%bd%bf%e7%94%a8openssl%e7%ad%be%e5%8f%91dashbord%e8%af%81%e4%b9%a6">#</a>
</h4>
<hr>
<p>在<code>10.0.0.200</code>上，使用<code>OpenSSL</code>创建<code>Dashbord</code>私钥</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">cd /opt/certs/
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#f92672">(</span>umask 077; openssl genrsa -out dashboard.k8s.com.key 2048<span style="color:#f92672">)</span>
</code></pre></div><hr>
<p>在<code>10.0.0.200</code>上，使用<code>OpenSSL</code>制作证书签发的请求文件</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">openssl req -new -key dashboard.k8s.com.key -out dashboard.k8s.com.csr -subj <span style="color:#e6db74">&#34;/CN=dashboard.k8s.com/C=CN/ST=BJ/L=Beijing/O=k8s/OU=ops&#34;</span>
</code></pre></div><hr>
<p>在<code>10.0.0.200</code>上，使用<code>OpenSSL</code>签发证书</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">openssl x509 -req -in dashboard.k8s.com.csr -CA ca.pem -CAkey ca-key.pem -CAcreateserial -out dashboard.k8s.com.crt -days <span style="color:#ae81ff">7300</span>
</code></pre></div><hr>
<p>在<code>10.0.0.11</code>上，将<code>10.0.0.200</code>上制作好的<code>Dashboard</code>证书拷贝到<code>Nginx</code>中</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">mkdir /etc/nginx/certs
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">scp root@10.0.0.200:/opt/certs/dashboard.k8s.com.crt /etc/nginx/certs/
</code></pre></div><hr>
<p>在<code>10.0.0.11</code>上，卸载证书</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">vim /etc/nginx/conf.d/dashboard.k8s.com.conf
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">server <span style="color:#f92672">{</span>
    listen       80;
    server_name  dashboard.k8s.com;

    rewrite ^<span style="color:#f92672">(</span>.*<span style="color:#f92672">)</span>$ https://<span style="color:#e6db74">${</span>server_name<span style="color:#e6db74">}</span>$1 permanent;
<span style="color:#f92672">}</span>
server <span style="color:#f92672">{</span>
    listen       <span style="color:#ae81ff">443</span> ssl;
    server_name  dashboard.k8s.com;

    ssl_certificate <span style="color:#e6db74">&#34;certs/dashboard.k8s.com.crt&#34;</span>;
    ssl_certificate_key <span style="color:#e6db74">&#34;certs/dashboard.k8s.com.key&#34;</span>;
    ssl_session_cache shared:SSL:1m;
    ssl_session_timeout  10m;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;

    location / <span style="color:#f92672">{</span>
        proxy_pass http://default_backend_traefik;
        proxy_set_header Host       $http_host;
        proxy_set_header x-forwarded-for $proxy_add_x_forwarded_for;
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">nginx -t
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">nginx -s reload
</code></pre></div><hr>
<p>在<code>10.0.0.21</code>上获取<code>Dashboard</code>的<code>Token</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl get secret -n kube-system
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl describe secret kubernetes-dashboard-admin-token-wbndw -n kube-system
</code></pre></div><hr>
<p>在集群外访问https://dashboard.k8s.com，测试是否可以正常访问</p>
<hr>
<h3 id="kubernetes集群node节点平滑升级">
  Kubernetes集群Node节点平滑升级
  <a class="anchor" href="#kubernetes%e9%9b%86%e7%be%a4node%e8%8a%82%e7%82%b9%e5%b9%b3%e6%bb%91%e5%8d%87%e7%ba%a7">#</a>
</h3>
<hr>
<blockquote>
<p>当我们遇到K8S有漏洞的时候，或者为了满足需求，有时候可能会需要升级或者降级版本，为了减少对业务的影响，尽量选择在业务低谷的时候来升级</p>
</blockquote>
<hr>
<p>首先准备好需要升级的Kubernetes版本文件</p>
<p>然后在<code>10.0.0.11</code>和<code>10.0.0.12</code>的<code>Nginx</code>上摘除（注释掉需要升级的Node节点）<code>api-server</code>的四层均衡负载</p>
<p>查看哪个<code>Node</code>上跑的<code>Pod</code>少</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl get node -o wide
</code></pre></div><p>将需要升级的Node从节点中删除（以<code>10.0.0.21</code>为例）</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl delete node host-0-21.k8s.com
</code></pre></div><p>等所有的Pod都迁移到其他节点上之后，在<code>10.0.0.21</code>上更换Kubernetes的软连接</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">rm -rf kubernetes
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">ln -s /opt/kubernetes-v1.19.0 /opt/kubernetes
</code></pre></div><p>在<code>supervisor</code>重启服务，生产上记得一个一个重启</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">supervisorctl restart all
</code></pre></div><p>启动成功后，查看版本</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl get node -o wide
</code></pre></div><hr>
</article>
 
      

      <footer class="book-footer">
        
  <div class="flex flex-wrap justify-between">





</div>



  <script>(function(){function a(c){const a=window.getSelection(),b=document.createRange();b.selectNodeContents(c),a.removeAllRanges(),a.addRange(b)}document.querySelectorAll("pre code").forEach(b=>{b.addEventListener("click",function(c){a(b.parentElement),navigator.clipboard&&navigator.clipboard.writeText(b.parentElement.textContent)})})})()</script>


 
        
      </footer>

      
  
  <div class="book-comments">

</div>
  
 

      <label for="menu-control" class="hidden book-menu-overlay"></label>
    </div>

    
    <aside class="book-toc">
      <div class="book-toc-content">
        
  
<nav id="TableOfContents">
  <ul>
    <li><a href="#kubernetesk8s">Kubernetes（K8S）</a>
      <ul>
        <li><a href="#kubernetes的基本概念">Kubernetes的基本概念</a>
          <ul>
            <li><a href="#pod">Pod</a></li>
            <li><a href="#pod控制器">Pod控制器</a></li>
            <li><a href="#name">Name</a></li>
            <li><a href="#namespace">Namespace</a></li>
            <li><a href="#label">Label</a></li>
            <li><a href="#lable选择器">Lable选择器</a></li>
            <li><a href="#service">Service</a></li>
            <li><a href="#ingress">Ingress</a></li>
            <li><a href="#rbac">RBAC</a></li>
          </ul>
        </li>
        <li><a href="#kubernetes的核心组件">Kubernetes的核心组件</a>
          <ul>
            <li><a href="#配置存储中心">配置存储中心</a></li>
            <li><a href="#主控节点master">主控节点（master）</a></li>
            <li><a href="#运算节点node">运算节点（node）</a></li>
            <li><a href="#cli客户端">CLI客户端</a></li>
          </ul>
        </li>
        <li><a href="#kubernetes的附加组件">Kubernetes的附加组件</a>
          <ul>
            <li><a href="#cni网络插件">CNI网络插件</a></li>
            <li><a href="#服务发现用插件">服务发现用插件</a></li>
            <li><a href="#服务暴露用插件">服务暴露用插件</a></li>
            <li><a href="#gui管理插件">GUI管理插件</a></li>
          </ul>
        </li>
        <li><a href="#kubernetes核心资源管理方法crud">Kubernetes核心资源管理方法（CRUD）</a>
          <ul>
            <li><a href="#陈述式资源管理">陈述式资源管理</a></li>
            <li><a href="#声明式资源管理">声明式资源管理</a></li>
          </ul>
        </li>
        <li><a href="#kubernetes实验架构">Kubernetes实验架构</a>
          <ul>
            <li><a href="#主机配置基础优化">主机配置（基础优化）</a></li>
            <li><a href="#搭建dns服务">搭建DNS服务</a></li>
            <li><a href="#搭建证书签发环境">搭建证书签发环境</a></li>
            <li><a href="#搭建docker环境">搭建Docker环境</a></li>
            <li><a href="#搭建私有镜像仓库harbor">搭建私有镜像仓库Harbor</a></li>
            <li><a href="#部署主控master节点服务">部署主控（Master）节点服务</a></li>
            <li><a href="#部署计算node节点服务">部署计算（Node）节点服务</a></li>
            <li><a href="#验证kubenetes集群">验证Kubenetes集群</a></li>
            <li><a href="#部署cni网络插件flannel">部署CNI网络插件（Flannel）</a></li>
            <li><a href="#部署服务发现插件coredns">部署服务发现插件（CoreDNS）</a></li>
            <li><a href="#部署服务暴露插件ingress">部署服务暴露插件（Ingress）</a></li>
            <li><a href="#部署gui资源管理插件仪表盘">部署GUI资源管理插件（仪表盘）</a></li>
            <li><a href="#kubernetes集群node节点平滑升级">Kubernetes集群Node节点平滑升级</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>


 
      </div>
    </aside>
    
  </main>

  
</body>
</html>












