<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="Rsync# Rsync是一款开源的、快速的、多功能的、可实现全量及增量的本地或远程数据同步备份的优秀工具。并且可以不进行改变原有数据的属性信息，实现数据的备份迁移特性。Rsync软件适用于Unix/Linux/Windows等多种操作系统平台。
Rsync是一个快速和非常通用的文件复制工具。它能本地复制，远程复制，或者远程守护进程方式复制。它提供了大量的参数来控制其行为的各个方面，并且允许非常灵活的方式来实现文件的传输复制。它以其delta-transfer算法闻名。减少通过网络数据发送数量，利用只发送源文件和目标文件之间的差异信息，从而实现数据的增量同步复制。
Rsync被广泛使用在备份和镜像，以及作为一种改进后的复制命令用于日常应用。
  提示信息：
官方链接资料：http://www.samba.org/ftp/rsync/rsync.html
官方手册资料：man rsync / man rsync.conf
  Rsync的作用# Rsync英文全称为Remote Synchronization，从软件的名称就可以看出来，Rsync具有可使本地和远程两台主机之间的数据快速复制同步镜像、远程备份的功能，这个功能类似SSH的scp命令，但又优于scp命令的功能，scp每次都是全量拷贝，而rsync可以增量拷贝。当然，Rsync还可以在本地主机的不同分区或目录之间全量及增量的复制数据，这又类似cp命令，但同样也优于cp命令，cp每次都是全量拷贝，而raync可以增量拷贝。
Rsync命令除了作为本地和远程复制命令使用以外，还可以作为删除和查看命令被应用，在某种情况下类似于传统的rm和ls命令。 通过上面文字的介绍，可以总结一下rsync命令的主要作用分为以下4种
 实现本地数据同步复制（等价 cp 命令）
# 使用 cp 进行文件拷贝 cp -a /etc/hosts /temp/hosts.bak # 使用 rsync 实现 cp 功能 rsync -a /etc/hosts /temp/hosts.bak # 注意：当使用 rsync 同步目录时如果目录后面带/，则同步的是目录中内容 rsync -a /etc/ /temp/ # 同步的是/etc/下的所有文件到/temp/中 rsync -a /etc /temp/ # 这才是将/etc文件夹备份到/temp/中  实现远程数据同步复制（等价 scp 命令）
# 使用 scp 实现远程数据复制 scp -rp /etc/hosts 192.">
<meta name="theme-color" content="#FFFFFF">
<meta name="color-scheme" content="light dark"><meta property="og:title" content="Rsync" />
<meta property="og:description" content="Rsync# Rsync是一款开源的、快速的、多功能的、可实现全量及增量的本地或远程数据同步备份的优秀工具。并且可以不进行改变原有数据的属性信息，实现数据的备份迁移特性。Rsync软件适用于Unix/Linux/Windows等多种操作系统平台。
Rsync是一个快速和非常通用的文件复制工具。它能本地复制，远程复制，或者远程守护进程方式复制。它提供了大量的参数来控制其行为的各个方面，并且允许非常灵活的方式来实现文件的传输复制。它以其delta-transfer算法闻名。减少通过网络数据发送数量，利用只发送源文件和目标文件之间的差异信息，从而实现数据的增量同步复制。
Rsync被广泛使用在备份和镜像，以及作为一种改进后的复制命令用于日常应用。
  提示信息：
官方链接资料：http://www.samba.org/ftp/rsync/rsync.html
官方手册资料：man rsync / man rsync.conf
  Rsync的作用# Rsync英文全称为Remote Synchronization，从软件的名称就可以看出来，Rsync具有可使本地和远程两台主机之间的数据快速复制同步镜像、远程备份的功能，这个功能类似SSH的scp命令，但又优于scp命令的功能，scp每次都是全量拷贝，而rsync可以增量拷贝。当然，Rsync还可以在本地主机的不同分区或目录之间全量及增量的复制数据，这又类似cp命令，但同样也优于cp命令，cp每次都是全量拷贝，而raync可以增量拷贝。
Rsync命令除了作为本地和远程复制命令使用以外，还可以作为删除和查看命令被应用，在某种情况下类似于传统的rm和ls命令。 通过上面文字的介绍，可以总结一下rsync命令的主要作用分为以下4种
 实现本地数据同步复制（等价 cp 命令）
# 使用 cp 进行文件拷贝 cp -a /etc/hosts /temp/hosts.bak # 使用 rsync 实现 cp 功能 rsync -a /etc/hosts /temp/hosts.bak # 注意：当使用 rsync 同步目录时如果目录后面带/，则同步的是目录中内容 rsync -a /etc/ /temp/ # 同步的是/etc/下的所有文件到/temp/中 rsync -a /etc /temp/ # 这才是将/etc文件夹备份到/temp/中  实现远程数据同步复制（等价 scp 命令）
# 使用 scp 实现远程数据复制 scp -rp /etc/hosts 192." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://Huang-CH.github.io/docs/Linux/Basic-Operation/Rsync/" /><meta property="article:section" content="docs" />



<title>Rsync | 黄 超 | H&amp;C</title>
<link rel="manifest" href="/manifest.json">
<link rel="icon" href="/favicon.png" type="image/x-icon">
<link rel="stylesheet" href="/book.min.95d69eb6bad8b9707ff2b5d8d9e31ce70a1b84f2ed7ffaf665ffcf00aa7993bd.css" integrity="sha256-ldaetrrYuXB/8rXY2eMc5wobhPLtf/r2Zf/PAKp5k70=" crossorigin="anonymous">
  <script defer src="/flexsearch.min.js"></script>
  <script defer src="/en.search.min.dd3ae186349439e3d5153a0ffebedbac921442d5a4b2cd6905b501250eb6bbea.js" integrity="sha256-3TrhhjSUOePVFToP/r7brJIUQtWkss1pBbUBJQ62u&#43;o=" crossorigin="anonymous"></script>

  <script defer src="/sw.min.6f6f90fcb8eb1c49ec389838e6b801d0de19430b8e516902f8d75c3c8bd98739.js" integrity="sha256-b2&#43;Q/LjrHEnsOJg45rgB0N4ZQwuOUWkC&#43;NdcPIvZhzk=" crossorigin="anonymous"></script>
<!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->
  
</head>
<body dir="ltr">
  <input type="checkbox" class="hidden toggle" id="menu-control" />
  <input type="checkbox" class="hidden toggle" id="toc-control" />
  <main class="container flex">
    <aside class="book-menu">
      <div class="book-menu-content">
        
  <nav>
<h2 class="book-brand">
  <a class="flex align-center" href="/"><span>黄 超 | H&amp;C</span>
  </a>
</h2>


<div class="book-search">
  <input type="text" id="book-search-input" placeholder="Search" aria-label="Search" maxlength="64" data-hotkeys="s/" />
  <div class="book-search-spinner hidden"></div>
  <ul id="book-search-results"></ul>
</div>












  



  
  <ul>
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-3ca9a5c09bd1884bf69ade02a8e53628" class="toggle" checked />
    <label for="section-3ca9a5c09bd1884bf69ade02a8e53628" class="flex justify-between">
      <a role="button" class="">Linux</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-30329090b70c299db66b1665fc9cdf79" class="toggle" checked />
    <label for="section-30329090b70c299db66b1665fc9cdf79" class="flex justify-between">
      <a role="button" class="">Linux运维基础</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Linux/Basic-Operation/Keepalived/" class="">Keepalived</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Linux/Basic-Operation/LVS/" class="">LVS</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Linux/Basic-Operation/Nginx/" class="">Nginx</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Linux/Basic-Operation/NFS/" class="">NFS</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Linux/Basic-Operation/Rsync/" class=" active">Rsync</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Linux/Basic-Operation/Ansible/" class="">Ansible</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Linux/Basic-Operation/Supervisor/" class="">Spuervisor</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Linux/Basic-Operation/Linux%E7%9A%84systemd/" class="">Linux的systemd</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Linux/Basic-Operation/Firewalld%E9%98%B2%E7%81%AB%E5%A2%99%E5%9F%BA%E7%A1%80/" class="">Firewalld防火墙基础</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Linux/Basic-Operation/Linux%E7%A3%81%E7%9B%98%E7%9A%84%E6%93%8D%E4%BD%9C/" class="">Linux磁盘的操作</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Linux/Basic-Operation/NetworkManager/" class="">NetworkManager</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Linux/Basic-Operation/%E5%80%9F%E5%8A%A9%E7%B3%BB%E7%BB%9F%E5%AD%98%E5%82%A8%E7%AE%A1%E7%90%86%E5%99%A8%E7%AE%A1%E7%90%86LVM/" class="">借助系统存储管理器管理LVM</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Linux/Basic-Operation/Linux%E5%AE%9E%E7%8E%B0SSH%E5%85%8D%E5%AF%86%E7%99%BB%E9%99%86/" class="">Linux实现SSH免密登录</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Linux/Basic-Operation/Linux%E5%A4%9A%E7%BD%91%E5%8D%A1%E7%BB%91%E5%AE%9ABond/" class="">Linux多网卡绑定Bond</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Linux/Basic-Operation/%E8%A7%A3%E5%86%B3OpenMediaVault%E4%B8%ADFTP%E4%B9%B1%E7%A0%81%E9%97%AE%E9%A2%98/" class="">解决OpenMediaVault中FTP乱码问题</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-b8ab17e00886c44c945c0ebf9036be5e" class="toggle"  />
    <label for="section-b8ab17e00886c44c945c0ebf9036be5e" class="flex justify-between">
      <a role="button" class="">CentOS</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Linux/CentOS/CentOS-7%E5%80%9F%E5%8A%A9%E7%B3%BB%E7%BB%9F%E5%AD%98%E5%82%A8%E7%AE%A1%E7%90%86%E5%99%A8%E7%AE%A1%E7%90%86LVM/" class="">CentOS 7借助系统存储管理器管理LVM</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Linux/CentOS/CentOS-7%E6%90%AD%E5%BB%BAFTP%E6%9C%8D%E5%8A%A1%E5%99%A8/" class="">CentOS 7搭建FTP服务器</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Linux/CentOS/CentOS-7%E6%90%AD%E5%BB%BAGit%E6%9C%8D%E5%8A%A1%E5%99%A8/" class="">CentOS 7搭建Git服务器</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Linux/CentOS/CentOS-7%E6%90%AD%E5%BB%BASamba%E6%9C%8D%E5%8A%A1%E5%99%A8/" class="">CentOS 7搭建Samba服务器</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Linux/CentOS/CentOS-7%E6%90%AD%E5%BB%BA%E7%A6%BB%E7%BA%BFYum%E6%BA%90/" class="">CentOS 7搭建离线YUM源服务器</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Linux/CentOS/CentOS-7%E9%85%8D%E7%BD%AE%E6%9C%AC%E5%9C%B0%E5%85%89%E7%9B%98%E6%BA%90/" class="">CentOS 7配置本地光盘源</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Linux/CentOS/CentOS-7%E9%9D%99%E9%BB%98%E5%AE%89%E8%A3%85Oracle-19c/" class="">CentOS 7静默安装Oracle 19c</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-35013df187ba109d617f6614b484064f" class="toggle"  />
    <label for="section-35013df187ba109d617f6614b484064f" class="flex justify-between">
      <a role="button" class="">Debian</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Linux/Debian/Debian%E6%90%AD%E5%BB%BAAPT%E6%9C%8D%E5%8A%A1%E5%99%A8/" class="">Debian搭建APT服务器</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Linux/Debian/Debian%E7%B3%BB%E7%BB%9F%E5%B8%B8%E7%94%A8%E9%85%8D%E7%BD%AE/" class="">Debian系统常用配置</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-25bdf6accfe3785fbb4a2e3f647c2ece" class="toggle"  />
    <label for="section-25bdf6accfe3785fbb4a2e3f647c2ece" class="flex justify-between">
      <a role="button" class="">Shell</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Shell/Shell-Script/" class="">Shell Script</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Shell/CentOS-7%E5%8D%87%E7%BA%A7SSH%E8%84%9A%E6%9C%AC/" class="">CentOS 7升级SSH脚本</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-8ca541663a7d7fd63c79c6ce40ab5b81" class="toggle"  />
    <label for="section-8ca541663a7d7fd63c79c6ce40ab5b81" class="flex justify-between">
      <a role="button" class="">Python</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Python/Python%E4%B9%8B%E5%9F%BA%E7%A1%80%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B/" class="">Python之基础数据类型</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Python/Python%E4%B9%8B%E5%AD%97%E7%AC%A6%E7%BC%96%E7%A0%81/" class="">Python之字符编码</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Python/Python%E4%B9%8B%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C/" class="">Python之文件操作</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Python/Python%E4%B9%8B%E5%90%8D%E7%A7%B0%E7%A9%BA%E9%97%B4%E4%B8%8E%E4%BD%9C%E7%94%A8%E5%9F%9F/" class="">Python之名称空间与作用域</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Python/Python%E4%B9%8B%E5%87%BD%E6%95%B0/" class="">Python之函数</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Python/Python%E4%B9%8B%E8%BF%AD%E4%BB%A3%E5%99%A8/" class="">Python之迭代器</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Python/Python%E4%B9%8B%E7%94%9F%E6%88%90%E5%99%A8/" class="">Python之生成器</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Python/Python%E4%B9%8B%E6%A8%A1%E5%9D%97/" class="">Python之模块</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Python/Python%E4%B9%8B%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/" class="">Python之正则表达式</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Python/Python%E4%B9%8Bre%E6%A8%A1%E5%9D%97/" class="">Python之re模块</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Python/%E9%9D%A2%E5%90%91%E8%BF%87%E7%A8%8B%E4%B8%8E%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1/" class="">面向过程与面向对象</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Python/Python%E4%B9%8B%E7%B1%BB%E4%B8%8E%E5%AF%B9%E8%B1%A1/" class="">Python之类与对象</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Python/Python%E4%B9%8B%E7%BB%84%E5%90%88/" class="">Python之组合</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Python/Python%E4%B9%8B%E7%BB%A7%E6%89%BF%E5%B0%81%E8%A3%85%E5%92%8C%E5%A4%9A%E6%80%81/" class="">Python之继承、封装和多态</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Python/Python%E4%B9%8B%E5%8F%8D%E5%B0%84/" class="">Python之反射</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Python/Python%E4%B9%8B%E5%85%83%E7%B1%BB/" class="">Python之元类</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Python/Python%E4%B9%8B%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86/" class="">Python之异常处理</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Python/Python%E5%86%85%E7%BD%AE%E7%9A%84%E9%AD%94%E6%9C%AF%E6%96%B9%E6%B3%95/" class="">Python内置的魔术方法</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Python/Python%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/" class="">Python网络编程</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Python/Python%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B%E4%B9%8Bsocketserver%E6%A8%A1%E5%9D%97/" class="">Python网络编程之socketserver模块</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Python/Python%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8B%E8%BF%9B%E7%A8%8B/" class="">Python并发编程之进程</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Python/Python%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8B%E7%BA%BF%E7%A8%8B/" class="">Python并发编程之线程</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Python/Python%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8B%E5%8D%8F%E7%A8%8B/" class="">Python并发编程之协程</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Python/%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B%E5%92%8C%E5%8D%8F%E7%A8%8B%E7%9A%84%E5%AF%B9%E6%AF%94/" class="">进程、线程和协程的对比</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Python/%E7%94%9F%E4%BA%A7%E8%80%85%E6%B6%88%E8%B4%B9%E8%80%85%E6%A8%A1%E5%9E%8B%E8%BF%9B%E7%A8%8B/" class="">生产者消费者模型（进程）</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Python/Python%E4%B9%8B%E6%93%8D%E4%BD%9CMySQL%E6%95%B0%E6%8D%AE%E5%BA%93/" class="">Python之操作MySQL数据库</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-ab6241a9c9348727e1ed30d9d7253a0e" class="toggle"  />
    <label for="section-ab6241a9c9348727e1ed30d9d7253a0e" class="flex justify-between">
      <a role="button" class="">Golang</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Golang/Go%E8%AF%AD%E8%A8%80%E7%BC%96%E7%A8%8B%E5%9F%BA%E7%A1%80/" class="">Go语言编程基础</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Golang/Go%E8%AF%AD%E8%A8%80WEB%E5%BC%80%E5%8F%91/" class="">Go语言WEB开发</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Golang/Go%E8%AF%AD%E8%A8%80%E7%9A%84ORM%E6%A1%86%E6%9E%B6/" class="">Go语言的ORM框架</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-a6af99c5c0ad1c9aeaecde8920e3b5e8" class="toggle"  />
    <label for="section-a6af99c5c0ad1c9aeaecde8920e3b5e8" class="flex justify-between">
      <a role="button" class="">C&#43;&#43;</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/C&#43;&#43;/C&#43;&#43;%E7%BC%96%E7%A8%8B%E5%9F%BA%E7%A1%80/" class="">C&#43;&#43;编程基础</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-270a210b43b4f0ee7cd55855f0b534f3" class="toggle"  />
    <label for="section-270a210b43b4f0ee7cd55855f0b534f3" class="flex justify-between">
      <a role="button" class="">MySQL</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/MySQL/MySQL/" class="">MySQL</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/MySQL/%E6%BA%90%E7%A0%81%E5%AE%89%E8%A3%85MySQL%E8%84%9A%E6%9C%AC/" class="">源码安装MySQL脚本</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-9fdacdda397d9ceae1a912b9128fe9e2" class="toggle"  />
    <label for="section-9fdacdda397d9ceae1a912b9128fe9e2" class="flex justify-between">
      <a role="button" class="">PostgreSQL</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/PostgreSQL/PostgreSQL/" class="">PostgreSQL</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-42f4d133c66bcfbca3d930dc56eb7d01" class="toggle"  />
    <label for="section-42f4d133c66bcfbca3d930dc56eb7d01" class="flex justify-between">
      <a href="https://Huang-CH.github.io/docs/OceanBase/" class="">OceanBase</a>
    </label>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-0f85b1f743da7f4e4cb9fca119fef7be" class="toggle"  />
    <label for="section-0f85b1f743da7f4e4cb9fca119fef7be" class="flex justify-between">
      <a role="button" class="">Docker</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Docker/Docker%E5%8D%83%E9%94%8B%E6%95%99%E8%82%B2/" class="">Docker基础</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Docker/%E6%BA%90%E7%A0%81%E5%AE%89%E8%A3%85Docker/" class="">源码安装Docker</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-6e638f9230da561f7c487c298451b1ed" class="toggle"  />
    <label for="section-6e638f9230da561f7c487c298451b1ed" class="flex justify-between">
      <a role="button" class="">Kubernetes</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Kubernetes/Kubernetes/" class="">Kubernetes</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-753665e91a918a680b2e12427102b0ea" class="toggle"  />
    <label for="section-753665e91a918a680b2e12427102b0ea" class="flex justify-between">
      <a role="button" class="">Prometheus</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Prometheus/Prometheus/" class="">Prometheus</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-ec36ec3492308dbc4bfcaa14eb72fa33" class="toggle"  />
    <label for="section-ec36ec3492308dbc4bfcaa14eb72fa33" class="flex justify-between">
      <a role="button" class="">Git</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/Git/git%E5%9F%BA%E7%A1%80/" class="">Git基础</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-2044dd8220b6eb6abc8d4889684aa060" class="toggle"  />
    <label for="section-2044dd8220b6eb6abc8d4889684aa060" class="flex justify-between">
      <a role="button" class="">KVM</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="https://Huang-CH.github.io/docs/KVM/KVM/" class="">KVM</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>











  
<ul>
  
  <li>
    <a href="https://github.com/Huang-CH" target="_blank" rel="noopener">
        My Github
      </a>
  </li>
  
</ul>






</nav>




  <script>(function(){var a=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(b){localStorage.setItem("menu.scrollTop",a.scrollTop)}),a.scrollTop=localStorage.getItem("menu.scrollTop")})()</script>


 
      </div>
    </aside>

    <div class="book-page">
      <header class="book-header">
        
  <div class="flex align-center justify-between">
  <label for="menu-control">
    <img src="/svg/menu.svg" class="book-icon" alt="Menu" />
  </label>

  <strong>Rsync</strong>

  <label for="toc-control">
    
    <img src="/svg/toc.svg" class="book-icon" alt="Table of Contents" />
    
  </label>
</div>


  
  <aside class="hidden clearfix">
    
  
<nav id="TableOfContents">
  <ul>
    <li><a href="#rsync">Rsync</a></li>
    <li><a href="#rsync的作用">Rsync的作用</a></li>
    <li><a href="#rsync的特性">Rsync的特性</a></li>
    <li><a href="#rsync的复制原理介绍">Rsync的复制原理介绍</a></li>
    <li><a href="#rsync的使用方法">Rsync的使用方法</a></li>
    <li><a href="#rsync守护进程服务部署">Rsync守护进程服务部署</a>
      <ul>
        <li><a href="#服务端部署">服务端部署</a></li>
        <li><a href="#客户端部署">客户端部署</a></li>
      </ul>
    </li>
    <li><a href="#rsync命令参数">Rsync命令参数</a></li>
    <li><a href="#rsync守护进程模式的应用场景">Rsync守护进程模式的应用场景</a></li>
    <li><a href="#rsync守护进程企业中的实际应用">Rsync守护进程企业中的实际应用</a>
      <ul>
        <li><a href="#rsync服务端">Rsync服务端</a></li>
        <li><a href="#rsync客户端">Rsync客户端</a></li>
        <li><a href="#rsync服务端配置邮件系统">Rsync服务端配置邮件系统</a></li>
      </ul>
    </li>
    <li><a href="#rsync守护进程排除功能实践">Rsync守护进程排除功能实践</a></li>
    <li><a href="#rsync守护进程创建备份目录">Rsync守护进程创建备份目录</a></li>
    <li><a href="#rsync守护进程的访问控制">Rsync守护进程的访问控制</a></li>
    <li><a href="#rsync守护进程的无差异同步在企业中慎用">Rsync守护进程的无差异同步（在企业中慎用！）</a></li>
    <li><a href="#rsync守护进程的列表功能">Rsync守护进程的列表功能</a></li>
    <li><a href="#inotify">Inotify</a>
      <ul>
        <li><a href="#inotify简介">Inotify简介</a></li>
        <li><a href="#inotify-tools安装">inotify-tools安装</a></li>
        <li><a href="#inotify-tools使用">inotify-tools使用</a></li>
      </ul>
    </li>
    <li><a href="#实现实时备份">实现实时备份</a></li>
  </ul>
</nav>



  </aside>
  
 
      </header>

      
      
  <article class="markdown"><h1 id="rsync">
  Rsync
  <a class="anchor" href="#rsync">#</a>
</h1>
<hr>
<p>Rsync是一款开源的、快速的、多功能的、可实现全量及增量的本地或远程数据同步备份的优秀工具。并且可以不进行改变原有数据的属性信息，实现数据的备份迁移特性。Rsync软件适用于Unix/Linux/Windows等多种操作系统平台。</p>
<p>Rsync是一个快速和非常通用的文件复制工具。它能本地复制，远程复制，或者远程守护进程方式复制。它提供了大量的参数来控制其行为的各个方面，并且允许非常灵活的方式来实现文件的传输复制。它以其<code>delta-transfer</code>算法闻名。减少通过网络数据发送数量，利用只发送源文件和目标文件之间的差异信息，从而实现数据的增量同步复制。</p>
<p>Rsync被广泛使用在备份和镜像，以及作为一种改进后的复制命令用于日常应用。</p>
<hr>
<blockquote>
<p>提示信息：</p>
<p>官方链接资料：http://www.samba.org/ftp/rsync/rsync.html</p>
<p>官方手册资料：<code>man rsync</code> / <code>man rsync.conf</code></p>
</blockquote>
<hr>
<h1 id="rsync的作用">
  Rsync的作用
  <a class="anchor" href="#rsync%e7%9a%84%e4%bd%9c%e7%94%a8">#</a>
</h1>
<hr>
<p>Rsync英文全称为Remote Synchronization，从软件的名称就可以看出来，Rsync具有可使本地和远程两台主机之间的数据快速复制同步镜像、远程备份的功能，这个功能类似SSH的<code>scp</code>命令，但又优于<code>scp</code>命令的功能，<code>scp</code>每次都是全量拷贝，而<code>rsync</code>可以增量拷贝。当然，Rsync还可以在本地主机的不同分区或目录之间全量及增量的复制数据，这又类似<code>cp</code>命令，但同样也优于<code>cp</code>命令，<code>cp</code>每次都是全量拷贝，而<code>raync</code>可以增量拷贝。</p>
<p>Rsync命令除了作为本地和远程复制命令使用以外，还可以作为删除和查看命令被应用，在某种情况下类似于传统的<code>rm</code>和<code>ls</code>命令。
通过上面文字的介绍，可以总结一下<code>rsync</code>命令的主要作用分为以下4种</p>
<hr>
<p>实现本地数据同步复制（等价 <code>cp</code> 命令）</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e"># 使用 cp 进行文件拷贝</span>
cp -a /etc/hosts /temp/hosts.bak

<span style="color:#75715e"># 使用 rsync 实现 cp 功能</span>
rsync -a /etc/hosts /temp/hosts.bak

<span style="color:#75715e"># 注意：当使用 rsync 同步目录时如果目录后面带/，则同步的是目录中内容</span>
rsync -a /etc/ /temp/   <span style="color:#75715e"># 同步的是/etc/下的所有文件到/temp/中</span>
rsync -a /etc /temp/    <span style="color:#75715e"># 这才是将/etc文件夹备份到/temp/中</span>
</code></pre></div><hr>
<p>实现远程数据同步复制（等价 <code>scp</code> 命令）</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e"># 使用 scp 实现远程数据复制</span>
scp -rp /etc/hosts 192.168.1.100:/temp/hosts_scp

<span style="color:#75715e"># 使用 rsync 实现 scp 功能</span>
rsync -rp /etc/hosts 192.168.1.100:/temp/hosts_rsync
</code></pre></div><hr>
<p>实现数据信息删除功能（等价 <code>rm</code> 命令）</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e"># 使用 rm 删除文件</span>
rm -rf /temp/*

<span style="color:#75715e"># 使用 rsync 实现 rm 功能</span>
<span style="color:#75715e"># 先创建一个空目录</span>
mkdir null
<span style="color:#75715e"># 在将空目录同步到要删除的目录</span>
rsync -a --delete /null/ /temp/
</code></pre></div><hr>
<p>实现数据信息查看功能（等价 <code>ls</code> 命令）</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e"># 使用ls查看文件夹内容</span>
ls /etc

<span style="color:#75715e"># 使用rsync实现ls功能</span>
rsync /etc
</code></pre></div><hr>
<h1 id="rsync的特性">
  Rsync的特性
  <a class="anchor" href="#rsync%e7%9a%84%e7%89%b9%e6%80%a7">#</a>
</h1>
<hr>
<p>Rsync的特性如下（7个特性信息说明）：</p>
<ul>
<li>
<p>支持拷贝普通文件与特殊文件，如链接文件，设备等；</p>
</li>
<li>
<p>可以有排除指定文件或目录同步的功能，相当于打包命令tar的排除功能；</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e"># 在打包/opt/data时排除 temp 命名的目录和文件</span>
tar zcvf data_backup.tar.gz /opt/data
</code></pre></div></li>
<li>
<p>可以做到保持原文件或目录的权限、时间、软硬连接、属主、组等所有属性均不改变(-p)；</p>
</li>
<li>
<p>可以实现增量同步，即只同步发生变化的数据，因此数据传输效率很高（tar -N）；</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e"># 备份 /home 目录自2008-01-01 以来修改过的文件</span>
tar -N 2008-01-01 -zcvf /backup/inc-backup_<span style="color:#66d9ef">$(</span>date + %F<span style="color:#66d9ef">)</span>.tar.gz /home

<span style="color:#75715e"># 备份 /home 目录昨天以来修改过的文件</span>
tar -N <span style="color:#66d9ef">$(</span>date -d yesterday <span style="color:#e6db74">&#34;+%F&#34;</span><span style="color:#66d9ef">)</span> -zcvf /backups/inc-backup_<span style="color:#66d9ef">$(</span>date + %F<span style="color:#66d9ef">)</span>.tar.gz /home

<span style="color:#75715e"># 将所有.gif的文件增加到all.tar的包中。-r表示增加文件的意思</span>
tar -rf all.tar *.gif
</code></pre></div></li>
<li>
<p>可以使用rcp、rsh、ssh等方式来配合进行隧道加密传输文件（rsync本身不对数据加密）；</p>
</li>
<li>
<p>可以通过socket（进程方式）传输文件和数据（服务端和客户端）；</p>
</li>
<li>
<p>支持匿名的或认证（无需系统用户）的进程模式传输，可实现方便安全的进行数据备份及镜像。</p>
</li>
</ul>
<hr>
<h1 id="rsync的复制原理介绍">
  Rsync的复制原理介绍
  <a class="anchor" href="#rsync%e7%9a%84%e5%a4%8d%e5%88%b6%e5%8e%9f%e7%90%86%e4%bb%8b%e7%bb%8d">#</a>
</h1>
<hr>
<p>在同步备份数据时，默认情况下，Rsync通过其独特的“Quick Check”算法，它仅同步大小或者修改时间发生变化的文件或目录，当然，也可以根据权限、属主等属性的变化同步，但需要指定相应的参数，甚至可以实现只同步一个文件里有变化的内容部分，所以可以实现快速的同步备份数据，即采用增量复制方法对数据信息进行同步，与传统的<code>cp</code>、<code>scp</code>拷贝命令的全量拷贝复制截然不同，增量同步复制数据，在效率上远远高于全量复制。</p>
<hr>
<h1 id="rsync的使用方法">
  Rsync的使用方法
  <a class="anchor" href="#rsync%e7%9a%84%e4%bd%bf%e7%94%a8%e6%96%b9%e6%b3%95">#</a>
</h1>
<hr>
<p>一般来说，Rsync大致使用三种主要的传输数据方式。</p>
<hr>
<p><strong>本地数据传输模式</strong></p>
<p>采用此种方式进行数据同步复制，类似于上文中所提到的 <code>cp</code> 本地复制命令功能。</p>
<p>采用本地数据传输模式的语法格式信息为：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">rsync <span style="color:#f92672">[</span>OPTION...<span style="color:#f92672">]</span> SRC... <span style="color:#f92672">[</span>DEST<span style="color:#f92672">]</span>
<span style="color:#75715e"># rsync          ---数据备份命令</span>
<span style="color:#75715e"># [OPTION...]    ---命令参数信息</span>
<span style="color:#75715e"># SRC...         ---要进行同步备份的源文件或目录信息</span>
<span style="color:#75715e"># [DEST]         ---将数据备份同步到本地系统中的目的路径</span>
</code></pre></div><hr>
<p><strong>远程Shell数据传输模式</strong></p>
<p>采用此种方式进行数据同步复制，类似于上文中所提到的 <code>scp</code> 远程复制命令功能。</p>
<p>采用远程数据传输模式语法格式信息为：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e"># Pull（拉）</span>
rsync <span style="color:#f92672">[</span>OPTION...<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>USER@<span style="color:#f92672">]</span>HOST:SRC... <span style="color:#f92672">[</span>DEST<span style="color:#f92672">]</span>
<span style="color:#75715e"># rsync          ---数据备份命令</span>
<span style="color:#75715e"># [OPTION...]    ---命令参数信息</span>
<span style="color:#75715e"># [USER@]        ---以什么用户身份将数据拉取</span>
<span style="color:#75715e"># HOST:SRC       ---从哪个远程主机上，将指定的数据进行备份</span>
<span style="color:#75715e"># [DEST]         ---将远程主机拉取过来的数据保存到本机的什么路径</span>

<span style="color:#75715e"># Push（推）</span>
rsync <span style="color:#f92672">[</span>OPTION...<span style="color:#f92672">]</span> SRC... <span style="color:#f92672">[</span>USER@<span style="color:#f92672">]</span>HOST:DEST
<span style="color:#75715e"># rsync          ---数据备份命令</span>
<span style="color:#75715e"># [OPTION...]    ---命令参数信息</span>
<span style="color:#75715e"># [USER@]        ---以什么用户身份将数据推送</span>
<span style="color:#75715e"># SRC            ---指定本地要推送给备份的数据信息</span>
<span style="color:#75715e"># HOST:DEST      ---将数据信息推送到指定主机相应的目录中</span>
</code></pre></div><hr>
<p><strong>守护进程传输模式</strong></p>
<p>（后面详细介绍）</p>
<hr>
<h1 id="rsync守护进程服务部署">
  Rsync守护进程服务部署
  <a class="anchor" href="#rsync%e5%ae%88%e6%8a%a4%e8%bf%9b%e7%a8%8b%e6%9c%8d%e5%8a%a1%e9%83%a8%e7%bd%b2">#</a>
</h1>
<hr>
<h2 id="服务端部署">
  服务端部署
  <a class="anchor" href="#%e6%9c%8d%e5%8a%a1%e7%ab%af%e9%83%a8%e7%bd%b2">#</a>
</h2>
<hr>
<p>在服务端和客户端均安装 <code>rsync</code> 服务</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e"># 检查rsync是否安装</span>
rpm -qa rsync
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e"># 在客户端和服务端均安装rsync</span>
yum -y install rsync
</code></pre></div><hr>
<p>创建配置文件<code>/etc/rsyncd.conf</code>，并将以下内容写入配置文件</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e"># rsync_config</span>
<span style="color:#75715e"># ---rsyncd.conf start---</span>

<span style="color:#75715e"># -------------------------全局配置（影响所有模块）------------------------- #</span>
<span style="color:#75715e"># 指定rsync服务运行的时候，向磁盘进行读写操作的用户</span>
uid <span style="color:#f92672">=</span> rsync
<span style="color:#75715e"># 指定用户组</span>
gid <span style="color:#f92672">=</span> rsync
<span style="color:#75715e"># 安全相关参数</span>
use chroot <span style="color:#f92672">=</span> no
<span style="color:#75715e"># 将rsync虚拟用户伪装成为一个超级管理员用户，CentOS7不设置则同步后文件权限信息丢失</span>
fake super <span style="color:#f92672">=</span> yes
<span style="color:#75715e"># 最大连接数</span>
max connections <span style="color:#f92672">=</span> <span style="color:#ae81ff">200</span>
<span style="color:#75715e"># 超时时间</span>
timeout <span style="color:#f92672">=</span> <span style="color:#ae81ff">300</span>
<span style="color:#75715e"># 进程对应的进程号文件，用于存放服务运行时进程的ID号（PID）</span>
pid file <span style="color:#f92672">=</span> /var/run/rsyncd.pid
<span style="color:#75715e"># 进程的锁文件</span>
lock file <span style="color:#f92672">=</span> /var/run/rsync.lock
<span style="color:#75715e"># 程序运行的日志文件</span>
log file <span style="color:#f92672">=</span> /var/log/rsyncd.log

<span style="color:#75715e"># -------------------------局部配置（影响本模块）------------------------- #</span>
<span style="color:#f92672">[</span>backup<span style="color:#f92672">]</span>      <span style="color:#75715e">#模块名称</span>
<span style="color:#75715e"># 注释信息</span>
comment <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Backup Dir By Mr.Huang&#34;</span>
<span style="color:#75715e"># 模块对应的位置（路径）</span>
path <span style="color:#f92672">=</span> /home/backup
<span style="color:#75715e"># 忽略错误程序</span>
ignore errors
<span style="color:#75715e"># 是否只读</span>
read only <span style="color:#f92672">=</span> false
<span style="color:#75715e"># 是否可以列表</span>
list <span style="color:#f92672">=</span> false
<span style="color:#75715e"># 允许访问rsync服务器的IP地址（白名单）</span>
hosts allow <span style="color:#f92672">=</span> 192.168.1.0/24
<span style="color:#75715e"># 禁止访问rsync服务器的IP地址（黑名单）</span>
hosts deny <span style="color:#f92672">=</span> 0.0.0.0/32
<span style="color:#75715e"># 认证用户，这些用户操作系统中不存在，仅用于认证</span>
auth users <span style="color:#f92672">=</span> rsync_backup,rsync_user
<span style="color:#75715e"># 设置进行连接认证的密钥文件，不存在的用户进行认证时的密钥文件</span>
secrets file <span style="color:#f92672">=</span> /etc/rsync.password
</code></pre></div><hr>
<p>创建一个备份目录的管理用户（虚拟用户）</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e"># 创建一个备份目录的管理用户</span>
useradd -M -s /sbin/nologin rsync
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e"># 查看是否创建成功</span>
id rsync
</code></pre></div><hr>
<p>创建备份目录</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e"># 在/目录下创建名为backup的备份目录，-p代表命令可以重复执行</span>
mkdir -p /home/backup
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e"># 将备份目录的属主和属组改成rsync用户</span>
chown -R rsync.rsync /home/backup
</code></pre></div><hr>
<p>创建认证用户密码文件</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e"># 将 sync_backup:123456 追加到 /etc/rsync.password 文件的末尾</span>
echo <span style="color:#e6db74">&#34;rsync_backup:123456&#34;</span> &gt;&gt; /etc/rsync.password
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e"># 更改文件权限，确保密码文件安全</span>
chmod <span style="color:#ae81ff">600</span> /etc/rsync.password
</code></pre></div><hr>
<p>启动 <code>rsync</code> 备份服务守护进程</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e"># 启动rsync守护进程</span>
rsync --daemon
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e"># 检查rsync是否启动</span>
ps -ef|grep rsync
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e"># 查看服务端口,rsync服务端口默认为873</span>
netstat -lntup|grep rsync
</code></pre></div><hr>
<h2 id="客户端部署">
  客户端部署
  <a class="anchor" href="#%e5%ae%a2%e6%88%b7%e7%ab%af%e9%83%a8%e7%bd%b2">#</a>
</h2>
<hr>
<p>Pull（拉）：从备份服务器上将数据拉取到本地，主要用于数据恢复</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">rsync <span style="color:#f92672">[</span>OPTION...<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>USER@<span style="color:#f92672">]</span>HOST::SRC... <span style="color:#f92672">[</span>DEST<span style="color:#f92672">]</span>
<span style="color:#75715e"># rsync          ---数据备份命令</span>
<span style="color:#75715e"># [OPTION...]    ---命令参数信息</span>
<span style="color:#75715e"># [USER@]        ---指定进行数据传输的认证用户</span>
<span style="color:#75715e"># HOST::         ---指定备份服务器的IP地址或主机名称</span>
<span style="color:#75715e"># SRC...         ---指定备份服务器上模块名称</span>
<span style="color:#75715e"># [DEST]         ---将数据同步到本地主机的指定路径</span>
</code></pre></div><p>示例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e"># 在本机创建用户认证的密码文件</span>
echo <span style="color:#e6db74">&#34;123456&#34;</span> &gt;&gt; /etc/rsync.password
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e"># 修改文件权限，必须修改，如果权限不是600，rsync服务则不读密码文件</span>
chmod <span style="color:#ae81ff">600</span> /etc/rsync.password
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e"># 将192.168.1.100服务器的默认备份目录(backup模块中的存储路径)中的文件拉取到/home/data目录中</span>
rsync -avzP rsync_backup@192.168.1.100::backup /home/data --password-file<span style="color:#f92672">=</span>/etc/rsync.password
</code></pre></div><blockquote>
<p><code>--password-file=/etc/rsync.password</code>：表示自动传输密码，用于定时任务的免交互</p>
</blockquote>
<hr>
<p>Push（推）：从本机将数据推送到备份服务器，主要用于数据备份</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">rsync <span style="color:#f92672">[</span>OPTION...<span style="color:#f92672">]</span> SRC... <span style="color:#f92672">[</span>USER@<span style="color:#f92672">]</span>HOST::DEST
<span style="color:#75715e"># rsync          ---数据备份命令</span>
<span style="color:#75715e"># [OPTION...]    ---命令参数信息</span>
<span style="color:#75715e"># SRC...         ---指定本地主机上需要备份的数据</span>
<span style="color:#75715e"># [USER@]        ---指定进行数据传输的认证用户</span>
<span style="color:#75715e"># HOST::         ---指定备份服务器的IP地址或主机名称</span>
<span style="color:#75715e"># DEST           ---指定备份服务器上模块名称</span>
</code></pre></div><p>示例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e"># 在本机创建用户认证的密码文件</span>
echo <span style="color:#e6db74">&#34;123456&#34;</span> &gt;&gt; /etc/rsync.password
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e"># 修改文件权限，必须修改，如果权限不是600，rsync服务则不读密码文件</span>
chmod <span style="color:#ae81ff">600</span> /etc/rsync.password
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e"># 将/home/data中的文件备份到192.168.1.100服务器的默认备份目录(backup模块中的存储路径)中</span>
rsync -avzP /home/data rsync_backup@192.168.1.100::backup --password-file<span style="color:#f92672">=</span>/etc/rsync.password
</code></pre></div><blockquote>
<p><code>--password-file=/etc/rsync.password</code>：表示自动传输密码，用于定时任务的免交互</p>
</blockquote>
<hr>
<h1 id="rsync命令参数">
  Rsync命令参数
  <a class="anchor" href="#rsync%e5%91%bd%e4%bb%a4%e5%8f%82%e6%95%b0">#</a>
</h1>
<hr>
<p>Rsync常用的同步命令参数如下：</p>
<table>
<thead>
<tr>
<th style="text-align:center"><strong>命令参数</strong></th>
<th style="text-align:center"><strong>参数说明</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">-v（verbose）</td>
<td style="text-align:center">详细模式，输出进度等信息</td>
</tr>
<tr>
<td style="text-align:center">-z（compress）</td>
<td style="text-align:center">传输时进行压缩以提高传输效率，&ndash;compress-level=NUM可按级别压缩。局域网中一般不压缩。</td>
</tr>
<tr>
<td style="text-align:center">-a（archive）</td>
<td style="text-align:center">归档模式，表示以递归方式传输文件，并保持所有文件属性</td>
</tr>
<tr>
<td style="text-align:center">-r（recursive）（归类于-a）</td>
<td style="text-align:center">子目录递归传输模式</td>
</tr>
<tr>
<td style="text-align:center">-t（times）（归类于-a）</td>
<td style="text-align:center">保持文件时间（文件修改时间）信息</td>
</tr>
<tr>
<td style="text-align:center">-o（owner）（归类于-a）</td>
<td style="text-align:center">保持文件属主信息</td>
</tr>
<tr>
<td style="text-align:center">-p（perms）（归类于-a）</td>
<td style="text-align:center">保持文件权限</td>
</tr>
<tr>
<td style="text-align:center">-g（group）（归类于-a）</td>
<td style="text-align:center">保持文件属组信息</td>
</tr>
<tr>
<td style="text-align:center">-l（links）（归类于-a）</td>
<td style="text-align:center">保留软连接</td>
</tr>
<tr>
<td style="text-align:center">-D（devices）（归类于-a）</td>
<td style="text-align:center">保持设备文件信息</td>
</tr>
<tr>
<td style="text-align:center">-P（progress）</td>
<td style="text-align:center">显示同步的过程及传输时的进度等信息</td>
</tr>
<tr>
<td style="text-align:center">-e（rsh=COMMOND）</td>
<td style="text-align:center">指定使用哪种信道协议，例如：SSH</td>
</tr>
<tr>
<td style="text-align:center">&ndash;exclude=PATTERN</td>
<td style="text-align:center">指定排除不需要传输的文件信息</td>
</tr>
<tr>
<td style="text-align:center">&ndash;exclude-from=file</td>
<td style="text-align:center">文件名所在的目录文件，既可以排除多个文件</td>
</tr>
<tr>
<td style="text-align:center">&ndash;bwlimit=RATE</td>
<td style="text-align:center">传输数据时进行限速</td>
</tr>
<tr>
<td style="text-align:center">&ndash;delete</td>
<td style="text-align:center">使目标目录和源目录数据一致，即无差异同步数据</td>
</tr>
</tbody>
</table>
<hr>
<h1 id="rsync守护进程模式的应用场景">
  Rsync守护进程模式的应用场景
  <a class="anchor" href="#rsync%e5%ae%88%e6%8a%a4%e8%bf%9b%e7%a8%8b%e6%a8%a1%e5%bc%8f%e7%9a%84%e5%ba%94%e7%94%a8%e5%9c%ba%e6%99%af">#</a>
</h1>
<hr>
<p>采用 <code>定时任务</code> + <code>rsync</code> 服务进行数据备份</p>
<p>应用场景：主要用于企业内部人员产生的数据备份。</p>
<hr>
<p>采用 <code>实时同步（inotify）</code> + <code>rsync</code> 服务进行数据备份**（推荐）**</p>
<p>应用场景：主要应用于用户产生的数据备份</p>
<hr>
<h1 id="rsync守护进程企业中的实际应用">
  Rsync守护进程企业中的实际应用
  <a class="anchor" href="#rsync%e5%ae%88%e6%8a%a4%e8%bf%9b%e7%a8%8b%e4%bc%81%e4%b8%9a%e4%b8%ad%e7%9a%84%e5%ae%9e%e9%99%85%e5%ba%94%e7%94%a8">#</a>
</h1>
<hr>
<h2 id="rsync服务端">
  Rsync服务端
  <a class="anchor" href="#rsync%e6%9c%8d%e5%8a%a1%e7%ab%af">#</a>
</h2>
<hr>
<p>安装 <code>rsync</code> 软件</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">yum install -y rsync
</code></pre></div><hr>
<p>创建配置文件 <code>/etc/rsyncd.conf</code>，并将以下内容写入到配置文件</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">uid <span style="color:#f92672">=</span> rsync
gid <span style="color:#f92672">=</span> rsync
use chroot <span style="color:#f92672">=</span> no
fake super <span style="color:#f92672">=</span> yes
max connections <span style="color:#f92672">=</span> <span style="color:#ae81ff">200</span>
timeout <span style="color:#f92672">=</span> <span style="color:#ae81ff">300</span>
pid file <span style="color:#f92672">=</span> /var/run/rsyncd.pid
lock file <span style="color:#f92672">=</span> /var/run/rsync.lock
log file <span style="color:#f92672">=</span> /var/log/rsyncd.log
auth users <span style="color:#f92672">=</span> rsync_backup
secrets file <span style="color:#f92672">=</span> /etc/rsync.password

<span style="color:#f92672">[</span>backup<span style="color:#f92672">]</span>
comment <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Backup Dir By Mr.Huang&#34;</span>
path <span style="color:#f92672">=</span> /data/backup
ignore <span style="color:#f92672">=</span> errors
read only <span style="color:#f92672">=</span> false
list <span style="color:#f92672">=</span> false
hosts allow <span style="color:#f92672">=</span> 10.10.10.0/24
hosts deny <span style="color:#f92672">=</span> 0.0.0.0/32
</code></pre></div><hr>
<p>创建备份目录的管理用户</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">useradd -M -s /sbin/nologin rsync
</code></pre></div><hr>
<p>创建备份目录</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">mkdir -p /data/backup
</code></pre></div><p>对目录进行授权</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">chown -R rsync.rsync /data/backup
</code></pre></div><hr>
<p>创建认证用户密码文件</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">echo <span style="color:#e6db74">&#34;rsync_backup:123456&#34;</span> &gt;&gt; /etc/rsync.password
</code></pre></div><p>修改文件权限，确保密码文件安全</p>
<pre tabindex="0"><code>chmod 600 /etc/rsync.password
</code></pre><hr>
<p>启动 <code>rsync</code> 备份服务守护进程</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">rsync --daemon
</code></pre></div><hr>
<h2 id="rsync客户端">
  Rsync客户端
  <a class="anchor" href="#rsync%e5%ae%a2%e6%88%b7%e7%ab%af">#</a>
</h2>
<hr>
<p>安装 <code>rsync</code> 软件</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">yum install -y rsync
</code></pre></div><hr>
<p>在本机创建用户认证文件</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">echo <span style="color:#e6db74">&#34;123456&#34;</span> &gt;&gt; /etc/rsync.password
</code></pre></div><p>修改文件权限，确保密码文件安全</p>
<pre tabindex="0"><code>chmod 600 /etc/rsync.password
</code></pre><hr>
<p>在  <code>/opt/scripts/</code> 中创建备份脚本文件</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e">#!/bin/bash
</span><span style="color:#75715e"></span><span style="color:#75715e"># Design By HC</span>

<span style="color:#75715e"># 定义变量 IP 接收本地ip地址查询的结果</span>
IP<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>ip address show ens33 | awk -F <span style="color:#e6db74">&#34;[ /]+&#34;</span> <span style="color:#e6db74">&#39;NR==3{print $3}&#39;</span><span style="color:#66d9ef">)</span>

<span style="color:#75715e"># 检查本地备份目录，若没有，则创建</span>
<span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> ! -d /data/backup/$IP <span style="color:#f92672">]</span>
<span style="color:#66d9ef">then</span>
  mkdir -p /data/backup/$IP
  echo <span style="color:#e6db74">&#34;/data/backup/</span>$IP目录已创建<span style="color:#e6db74">！&#34;</span>
<span style="color:#66d9ef">else</span>
  echo <span style="color:#e6db74">&#34;/data/backup/</span>$IP目录已存在<span style="color:#e6db74">！&#34;</span>
<span style="color:#66d9ef">fi</span>

<span style="color:#75715e"># 将数据打包备份</span>
tar zchf /data/backup/$IP/data_backup_<span style="color:#66d9ef">$(</span>date +%F-week%w-%T<span style="color:#66d9ef">)</span>.tar.gz /home/data &amp;&gt;/dev/null

<span style="color:#75715e"># 清除7天以前的历史数据</span>
find /data/backup/$IP/ -type f -name <span style="color:#e6db74">&#34;*.tar.gz&#34;</span> -mtime +7 -delete

<span style="color:#75715e"># 生成数据验证文件</span>
find /data/backup/$IP/ -mmin -10 -name <span style="color:#e6db74">&#34;*.tar.gz&#34;</span> | xargs md5sum &gt; /home/backup/$IP/check.text

<span style="color:#75715e"># 开始rsync传输</span>
rsync -avzP /data/backup/$IP rsync_backup@10.10.10.100::backup --password-file<span style="color:#f92672">=</span>/etc/rsync.password
</code></pre></div><hr>
<h2 id="rsync服务端配置邮件系统">
  Rsync服务端配置邮件系统
  <a class="anchor" href="#rsync%e6%9c%8d%e5%8a%a1%e7%ab%af%e9%85%8d%e7%bd%ae%e9%82%ae%e4%bb%b6%e7%b3%bb%e7%bb%9f">#</a>
</h2>
<hr>
<p>安装 <code>mailx</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">yum install -y mailx
</code></pre></div><hr>
<p>配置邮件服务</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">cat &gt; /etc/mail.rc <span style="color:#e6db74">&lt;&lt; &#39;EOF&#39;
</span><span style="color:#e6db74">set from=mail@mail.com
</span><span style="color:#e6db74">set smtp=smtp://smtp.mail.com:25
</span><span style="color:#e6db74">set smtp-auth-user=mail@mail.com
</span><span style="color:#e6db74">set smtp-auth-password=xxxxxx
</span><span style="color:#e6db74">set smtp-auth=login
</span><span style="color:#e6db74">set ssl-verify=ignore
</span><span style="color:#e6db74">set nss-config-dir=/etc/pki/nssdb
</span><span style="color:#e6db74">EOF</span>
</code></pre></div><hr>
<p>创建脚本的目录</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">mkdir -p /opt/scripts
</code></pre></div><hr>
<p>在 <code>/opt/scripts/</code> 中创建验证脚本文件</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e">#!/bin/bash
</span><span style="color:#75715e"></span><span style="color:#75715e"># Design By HC</span>

<span style="color:#75715e"># 批量检验数据备份的完整性</span>
find /data/backup/ -type f -name <span style="color:#e6db74">&#34;check.txt&#34;</span> | xargs md5sum -c &gt; /var/log/backup_check.log

<span style="color:#75715e"># 发送校验结果信息</span>
mail -s <span style="color:#e6db74">&#34;backup_check&#34;</span> HC@mail.com &lt; /var/log/backup_check.log

<span style="color:#75715e"># 清理30天前的数据信息</span>
find /data/backup/ -type f -mtime +30 -name <span style="color:#e6db74">&#34;*.tar.gz&#34;</span> -delete
</code></pre></div><hr>
<h1 id="rsync守护进程排除功能实践">
  Rsync守护进程排除功能实践
  <a class="anchor" href="#rsync%e5%ae%88%e6%8a%a4%e8%bf%9b%e7%a8%8b%e6%8e%92%e9%99%a4%e5%8a%9f%e8%83%bd%e5%ae%9e%e8%b7%b5">#</a>
</h1>
<hr>
<p>排除指定文件</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e"># 同步/data_dir目录数据到备份服务器的/backup目录中,但/data_dir目录中的a，b目录不需要同步，d目录中的2.txt不需要同步</span>
rsync -avzP /data_dir/ --exclude<span style="color:#f92672">=</span>a --exclude<span style="color:#f92672">=</span>b --exclude<span style="color:#f92672">=</span>d/2.txt rsync_backup@192.168.1.100::nfs_backup --password-file<span style="color:#f92672">=</span>/etc/rsync.password

<span style="color:#75715e"># 同步/data_dir目录数据到备份服务器的/backup目录中,但/data_dir目录中的a，b,c目录不需要同步，d目录中的1.txt不需要同步</span>
rsync -avzP /data_dir/ --exclude<span style="color:#f92672">={</span>a..c<span style="color:#f92672">}</span> --exclude<span style="color:#f92672">=</span>d/2.txt rsync_backup@192.168.1.100::nfs_backup --password-file<span style="color:#f92672">=</span>/etc/rsync.password
</code></pre></div><hr>
<p>把多个排除的信息放在一个文件中</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e"># 同步/data_dir目录数据到备份服务器的/backup目录中,但/data_dir目录中的a，b,c目录不需要同步，d目录中的1.txt不需要同步</span>
cd /data_dir/
<span style="color:#75715e"># 编写排除文件信息</span>
vi exclude.txt
    a
    b
    c
    d/1.txt
    exclude.txt
<span style="color:#75715e"># 执行rsync命令</span>
rsync -avzP /data_dir/ --exclude-from<span style="color:#f92672">=</span>/data_dir/exclude.txt rsync_backup@192.168.1.100::nfs_backup --password-file<span style="color:#f92672">=</span>/etc/rsync.password
</code></pre></div><hr>
<h1 id="rsync守护进程创建备份目录">
  Rsync守护进程创建备份目录
  <a class="anchor" href="#rsync%e5%ae%88%e6%8a%a4%e8%bf%9b%e7%a8%8b%e5%88%9b%e5%bb%ba%e5%a4%87%e4%bb%bd%e7%9b%ae%e5%bd%95">#</a>
</h1>
<hr>
<p>备份文件时可以创建相应的文件夹以分类</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e"># 将data_dir文件夹中的文件备份到192.168.1.100服务器中nsf_backup/20190620_backup文件夹中,注意：不能一次性创建多级目录！</span>
rsync -avzP /data_dir/ rsync_backup@192.168.1.100::nfs_backup/20190620_backup --password-file<span style="color:#f92672">=</span>/etc/rsync.password
</code></pre></div><hr>
<h1 id="rsync守护进程的访问控制">
  Rsync守护进程的访问控制
  <a class="anchor" href="#rsync%e5%ae%88%e6%8a%a4%e8%bf%9b%e7%a8%8b%e7%9a%84%e8%ae%bf%e9%97%ae%e6%8e%a7%e5%88%b6">#</a>
</h1>
<hr>
<p>Rsync配置文件中的访问控制分为三种情况：</p>
<ul>
<li>
<p>只有白名单（hosts allow）时，白名单流量允许通过，其余流量的默认规则是阻止；</p>
</li>
<li>
<p>只有黑名单（hosts deny）时，黑名单流量阻止通过，其余流量的默认规则是允许；</p>
</li>
<li>
<p>既有白名单，又有黑名单时，白名单流量允许通过，黑名单流量阻止通过，其余流量的默认规则时允许。</p>
<p>注意：白名单优先级高于黑名单</p>
</li>
</ul>
<hr>
<p>需求：</p>
<p>内网网段用户（172.16.1.0/24）可以传输数据到backup目录中</p>
<p>外网网段用户（10.0.0.0/24）不可以传输数据到backup目录中</p>
<p>示例：</p>
<p>创建 <code>/etc/rsyncd.conf</code> 配置文件，并将以下内容写入到配置文件中</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e"># rsync_config</span>
<span style="color:#75715e"># ---rsyncd.conf start---</span>

uid <span style="color:#f92672">=</span> rsync
gid <span style="color:#f92672">=</span> rsync
use chroot <span style="color:#f92672">=</span> no
fake super <span style="color:#f92672">=</span> yes
max connections <span style="color:#f92672">=</span> <span style="color:#ae81ff">200</span>
timeout <span style="color:#f92672">=</span> <span style="color:#ae81ff">300</span>
pid file <span style="color:#f92672">=</span> /var/run/rsyncd.pid
lock file <span style="color:#f92672">=</span> /var/run/rsync.lock
log file <span style="color:#f92672">=</span> /var/log/rsyncd.log
ignore errors
read only <span style="color:#f92672">=</span> false
list <span style="color:#f92672">=</span> false

<span style="color:#75715e"># ---------------------访问控制---------------------------------- #</span>
hosts allow <span style="color:#f92672">=</span> 172.16.1.0/24
hosts deny <span style="color:#f92672">=</span> 10.0.0.0/24
<span style="color:#75715e">#--------------------------------------------------------------- #</span>

auth users <span style="color:#f92672">=</span> rsync_backup,rsync_user
secrets file <span style="color:#f92672">=</span> /etc/rsync.password

<span style="color:#f92672">[</span>nfs_backup<span style="color:#f92672">]</span>
comment <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Backup Dir By NFS&#34;</span>
path <span style="color:#f92672">=</span> /data/backup/nfs_backup

<span style="color:#f92672">[</span>mysql_backup<span style="color:#f92672">]</span>
comment <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Backup Dir By MySQL&#34;</span>
path <span style="color:#f92672">=</span> /data/backup/mysql_backup
</code></pre></div><hr>
<h1 id="rsync守护进程的无差异同步在企业中慎用">
  Rsync守护进程的无差异同步（在企业中慎用！）
  <a class="anchor" href="#rsync%e5%ae%88%e6%8a%a4%e8%bf%9b%e7%a8%8b%e7%9a%84%e6%97%a0%e5%b7%ae%e5%bc%82%e5%90%8c%e6%ad%a5%e5%9c%a8%e4%bc%81%e4%b8%9a%e4%b8%ad%e6%85%8e%e7%94%a8">#</a>
</h1>
<hr>
<p>实现本地服务器和备份服务器上的数据信息高度一致，说白了，就是我有你也有，我没有你也不能有。除了实现文件夹内容无差异同步，还能实现文件内容的无差异同步</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">rsync -avzP --delete /data_dir/ rsync_backup@192.168.1.100::nfs_backup --password-file<span style="color:#f92672">=</span>/etc/rsync.password
</code></pre></div><hr>
<h1 id="rsync守护进程的列表功能">
  Rsync守护进程的列表功能
  <a class="anchor" href="#rsync%e5%ae%88%e6%8a%a4%e8%bf%9b%e7%a8%8b%e7%9a%84%e5%88%97%e8%a1%a8%e5%8a%9f%e8%83%bd">#</a>
</h1>
<hr>
<p>rsyncd.conf配置文件中的 list = true 的作用是让客户端可以通过命令获悉服务端的全部模块信息。（建议将list = false）</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">rsync rsync_backup@192.168.1.100::
</code></pre></div><hr>
<h1 id="inotify">
  Inotify
  <a class="anchor" href="#inotify">#</a>
</h1>
<hr>
<p>要实现数据的实时备份，需要实现监控数据信息的变化和将变化的数据信息进行备份传输，监控信息的变化通常使用<code>inotify</code>或<code>sersync</code></p>
<p>实现，将变化的数据信息进行备份传输则使用<code>rsync</code>实现。</p>
<hr>
<h2 id="inotify简介">
  Inotify简介
  <a class="anchor" href="#inotify%e7%ae%80%e4%bb%8b">#</a>
</h2>
<hr>
<p>Inotify是一种强大的、细粒度的异步文件系统事件监控机制，从Linux 2.6.13 内核版本开始，加入了Inotify的支持，通过Inotify可以监控文件系统的添加、删除、修改、移动等各种事件的发生，利用这个内核接口，第三方软件（如：inotify-tools）就可以监控文件系统中文件的变化，国人周洋在金山公司也开发了类似的实时同步软件sersync。</p>
<blockquote>
<p>sersync是在Inotify基础上进行开发的，功能要更加强大，增加了定时重试机制、过滤极致等，提供了接口做CDN，并支持多线程操作。</p>
</blockquote>
<hr>
<h2 id="inotify-tools安装">
  inotify-tools安装
  <a class="anchor" href="#inotify-tools%e5%ae%89%e8%a3%85">#</a>
</h2>
<hr>
<p>安装依赖环境</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">yum -y install epel-release
</code></pre></div><p>安装 Inotify 软件<code>inotify-tools</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">yum -y install inotify-tools
</code></pre></div><blockquote>
<p>注意：CentOS 7安装<code>inotify-tools</code>前，需要安装EPEL源。</p>
<p>使用<code>rpm -ql inotify-tools</code>命令可以查看安装了哪些内容。</p>
<p>其中主要安装了两个程序 <code>inotifywait</code> 和 <code>inotifywatch</code>：</p>
<p><code>inotifywait</code>：用于监控目录或文件信息的变化。（主要使用这个程序）</p>
<p><code>inotifywatch</code>：用于统计目录或文件信息的变化。</p>
</blockquote>
<hr>
<p><code>inotify-tools</code>参数介绍</p>
<table>
<thead>
<tr>
<th style="text-align:center">命令参数</th>
<th style="text-align:center">参数说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">-m</td>
<td style="text-align:center">&ndash;monitor（始终保持事件监听状态）</td>
</tr>
<tr>
<td style="text-align:center">-d</td>
<td style="text-align:center">&ndash;daemon（在后台运行方式始终保持事件监听状态，使用<code>--outfile</code>参数将触发事件记录到指定文件，使用<code>--syslog</code>参数定义程序日志）</td>
</tr>
<tr>
<td style="text-align:center">-r</td>
<td style="text-align:center">&ndash;recursive（递归监控目录中的数据变化）</td>
</tr>
<tr>
<td style="text-align:center">-o</td>
<td style="text-align:center">&ndash;outfile（将程序信息输出到文件中）</td>
</tr>
<tr>
<td style="text-align:center">-s</td>
<td style="text-align:center">&ndash;syslog（将程序中的错误信息输出到文件中）</td>
</tr>
<tr>
<td style="text-align:center">-q</td>
<td style="text-align:center">&ndash;quiet（只输出必要信息，如事件信息）</td>
</tr>
<tr>
<td style="text-align:center">&ndash;excludei</td>
<td style="text-align:center">（排除文件或目录时，不区分大小写）</td>
</tr>
<tr>
<td style="text-align:center">&ndash;timefmt</td>
<td style="text-align:center">（指定时间输出的格式）</td>
</tr>
<tr>
<td style="text-align:center">&ndash;format</td>
<td style="text-align:center">（使用指定字符串格式进行输出）</td>
</tr>
<tr>
<td style="text-align:center">-e</td>
<td style="text-align:center">&ndash;event（监听指定事件，如果省略，则表示所有事件都进行监听）</td>
</tr>
</tbody>
</table>
<hr>
<p><code>inotify-tools</code>监控事件介绍</p>
<table>
<thead>
<tr>
<th style="text-align:center">事件名称</th>
<th style="text-align:center">事件说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">access</td>
<td style="text-align:center">文件或目录内容被读取</td>
</tr>
<tr>
<td style="text-align:center">modify</td>
<td style="text-align:center">文件或目录内容被修改</td>
</tr>
<tr>
<td style="text-align:center">attrib</td>
<td style="text-align:center">文件或目录属性发生改变</td>
</tr>
<tr>
<td style="text-align:center">open</td>
<td style="text-align:center">文件或目录被打开</td>
</tr>
<tr>
<td style="text-align:center">close_write</td>
<td style="text-align:center">通过写入模式打开文件或目录后进行的关闭</td>
</tr>
<tr>
<td style="text-align:center">close_nowrite</td>
<td style="text-align:center">通过只读模式打开文件或目录后进行的关闭</td>
</tr>
<tr>
<td style="text-align:center">close</td>
<td style="text-align:center">以任何模式打开文件或目录后进行的关闭</td>
</tr>
<tr>
<td style="text-align:center">move_to</td>
<td style="text-align:center">文件或目录被移动到监控的目录中</td>
</tr>
<tr>
<td style="text-align:center">move_from</td>
<td style="text-align:center">文件或目录从监控的目录中被移出</td>
</tr>
<tr>
<td style="text-align:center">move</td>
<td style="text-align:center">在监控目录中所有文件或目录的移动都会出发事件</td>
</tr>
<tr>
<td style="text-align:center">create</td>
<td style="text-align:center">在监控目录中创建文件或目录</td>
</tr>
<tr>
<td style="text-align:center">delete</td>
<td style="text-align:center">在监控目录中删除文件或目录</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="inotify-tools使用">
  inotify-tools使用
  <a class="anchor" href="#inotify-tools%e4%bd%bf%e7%94%a8">#</a>
</h2>
<hr>
<p><code>inotify-tools</code>语法格式：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">inotifywait <span style="color:#f92672">[</span>参数<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>监控的文件或目录<span style="color:#f92672">]</span> 
</code></pre></div><p>事件监控示例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">inotifywait -mrq --timefmt <span style="color:#e6db74">&#34;%y-%m-%d %H:%M:%S&#34;</span> --format <span style="color:#e6db74">&#34;%w%f %T 事件信息：%e&#34;</span> /data/
</code></pre></div><p><code>inotify-tools</code>用于实时备份时的监控示例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">inotifywait -mrq --format <span style="color:#e6db74">&#34;%w%f&#34;</span> /data/ -e create,delete,modify,move,close_write
</code></pre></div><hr>
<h1 id="实现实时备份">
  实现实时备份
  <a class="anchor" href="#%e5%ae%9e%e7%8e%b0%e5%ae%9e%e6%97%b6%e5%a4%87%e4%bb%bd">#</a>
</h1>
<hr>
<p>场景：需要将NFS服务器的<code>/data</code>目录备份到备份服务器（10.10.10.100）的<code>/backup</code>目录下</p>
<p>思路：在NFS服务器上，使用<code>inotify-tools</code>监控<code>/data</code>目录，一旦发生变化，则使用<code>rsync</code>命令将<code>/data</code>目录的文件内容同步到备份服务器的<code>/backup</code>目录下。</p>
<hr>
<p><strong>实时备份脚本</strong></p>
<p>无差异增量备份示例（有输出）：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e">#! /bin/bash
</span><span style="color:#75715e"></span>inotifywait -mrq --format <span style="color:#e6db74">&#34;%w%f&#34;</span> /data/ -e create,delete,modify,move,close_write | <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span><span style="color:#66d9ef">while</span> read events
<span style="color:#66d9ef">do</span>
rsync -avzP --delete /home/backup/$IP rsync_backup@10.10.10.100::backup --password-file<span style="color:#f92672">=</span>/etc/rsync.password
down
</code></pre></div><p>无差异增量备份示例（无输出）：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e">#! /bin/bash
</span><span style="color:#75715e"></span><span style="color:#66d9ef">while</span> inotifywait -rqq /data/
<span style="color:#66d9ef">do</span>
rsync -a --delete /home/backup/$IP rsync_backup@10.10.10.100::backup --password-file<span style="color:#f92672">=</span>/etc/rsync.password
down
</code></pre></div><hr>
<p><strong>企业中一般使用sersync实现实时备份</strong></p>
<p>sersync下载地址：https://github.com/wsgzao/sersync</p>
<hr>
</article>
 
      

      <footer class="book-footer">
        
  <div class="flex flex-wrap justify-between">





</div>



  <script>(function(){function a(c){const a=window.getSelection(),b=document.createRange();b.selectNodeContents(c),a.removeAllRanges(),a.addRange(b)}document.querySelectorAll("pre code").forEach(b=>{b.addEventListener("click",function(c){a(b.parentElement),navigator.clipboard&&navigator.clipboard.writeText(b.parentElement.textContent)})})})()</script>


 
        
      </footer>

      
  
  <div class="book-comments">

</div>
  
 

      <label for="menu-control" class="hidden book-menu-overlay"></label>
    </div>

    
    <aside class="book-toc">
      <div class="book-toc-content">
        
  
<nav id="TableOfContents">
  <ul>
    <li><a href="#rsync">Rsync</a></li>
    <li><a href="#rsync的作用">Rsync的作用</a></li>
    <li><a href="#rsync的特性">Rsync的特性</a></li>
    <li><a href="#rsync的复制原理介绍">Rsync的复制原理介绍</a></li>
    <li><a href="#rsync的使用方法">Rsync的使用方法</a></li>
    <li><a href="#rsync守护进程服务部署">Rsync守护进程服务部署</a>
      <ul>
        <li><a href="#服务端部署">服务端部署</a></li>
        <li><a href="#客户端部署">客户端部署</a></li>
      </ul>
    </li>
    <li><a href="#rsync命令参数">Rsync命令参数</a></li>
    <li><a href="#rsync守护进程模式的应用场景">Rsync守护进程模式的应用场景</a></li>
    <li><a href="#rsync守护进程企业中的实际应用">Rsync守护进程企业中的实际应用</a>
      <ul>
        <li><a href="#rsync服务端">Rsync服务端</a></li>
        <li><a href="#rsync客户端">Rsync客户端</a></li>
        <li><a href="#rsync服务端配置邮件系统">Rsync服务端配置邮件系统</a></li>
      </ul>
    </li>
    <li><a href="#rsync守护进程排除功能实践">Rsync守护进程排除功能实践</a></li>
    <li><a href="#rsync守护进程创建备份目录">Rsync守护进程创建备份目录</a></li>
    <li><a href="#rsync守护进程的访问控制">Rsync守护进程的访问控制</a></li>
    <li><a href="#rsync守护进程的无差异同步在企业中慎用">Rsync守护进程的无差异同步（在企业中慎用！）</a></li>
    <li><a href="#rsync守护进程的列表功能">Rsync守护进程的列表功能</a></li>
    <li><a href="#inotify">Inotify</a>
      <ul>
        <li><a href="#inotify简介">Inotify简介</a></li>
        <li><a href="#inotify-tools安装">inotify-tools安装</a></li>
        <li><a href="#inotify-tools使用">inotify-tools使用</a></li>
      </ul>
    </li>
    <li><a href="#实现实时备份">实现实时备份</a></li>
  </ul>
</nav>


 
      </div>
    </aside>
    
  </main>

  
</body>
</html>












